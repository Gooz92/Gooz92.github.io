(()=>{var Y=t=>typeof t=="string";var $=(t,e)=>{j(t,t.findIndex(e))},j=(t,e)=>{e>=0&&t.splice(e,1)},z=(t,e)=>{j(t,t.indexOf(e))},T=(t,e)=>{let n=[];for(let r=0;r<t;r++)n.push(e(r));return n};function U(t,e){if(t===null)throw new Error(e)}var V=t=>{let e=null;return(...n)=>(e!==null||(e=t(...n).finally(()=>{e=null})),e)};var m=(t,...e)=>{let n=document.createElement(t);for(let r of e)Y(r)?n.innerText=r:Array.isArray(r)?n.append(...r):gt(n,r);return n},gt=(t,e)=>{for(let n in e)n==="style"?Object.assign(t.style,e.style):t[n]=e[n]},f=t=>{let e=document.getElementById(t);return U(e,`Element with id '${t}' not found`),e},W=t=>{let e=document.querySelector(t);return U(e,`Element with selector '${t}' not found`),e},Bt=t=>t instanceof HTMLElement,h=(t,e)=>{let n=null;t.addEventListener("mousemove",({target:r})=>{if(r!==n){if(r===t||!Bt(r)){e(null);return}n=r,e(n)}}),t.addEventListener("mouseleave",()=>{n=null,e(null)})},d=(t,e=document)=>{e.querySelectorAll(`.${t}`).forEach(n=>{n.classList.remove(t)})},G=(t,e)=>(t.classList.add(e),new Promise(n=>{t.addEventListener("animationend",()=>{t.classList.remove(e),n()},{once:!0})}));var Et=(t,e)=>{let n=0,r=t,o={readBit:()=>{r===t&&(n=e.next(),r=0);let i=(n>>>t-r-1&1)===1;return++r,i},readBits:i=>T(i,o.readBit),readUint:i=>{let a=0;for(let p=0;p<i;p++)o.readBit()&&(a+=2**p);return a}};return o},X=t=>Et(6,t);var g=t=>Math.floor(Math.log2(t))+1;var It="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ!~",vt=t=>{let e=0;return{next:()=>{if(e>=t.length)throw new Error("Unexpected end of input");let n=t[e],r=It.indexOf(n);if(r===-1)throw new Error(`Unexpected token '${n}' at position ${e+1}`);return++e,r}}};var D=t=>{let e=vt(t);return X(e)};var q=(t,e)=>{let n=t.readUint(3);return n===0?null:{id:n,faction:t.readUint(1),position:t.readUint(e)}},Dt=(t,e)=>{let n=[],r=g(e),o=q(t,r);for(;o!==null;)n.push(o),o=q(t,r);return n},St=t=>{let e=t.readUint(4)+3,n=t.readUint(4)+3,r=e*n,o=t.readBits(r);return{width:e,height:n,tiles:o}},b=t=>{let e=D(t),n=St(e),r=Dt(e,n.tiles.length);return{...n,units:r}};var w=(t,e)=>{let n=t[0];for(let r=1;r<t.length;r++){let o=t[r];e(o,n)&&(n=o)}return n};var J=[0,1],A=([t,e],[n,r])=>{let o=t*r-n*e;if(o===0)return J;let i=e*r,a=yt(o,i);return[o/a,i/a]},yt=(t,e)=>{for(;e!==0;){let n=e;e=t%e,t=n}return t},C=([t,e],[n,r])=>t*r<n*e;var bt=t=>({next:()=>Ct(t).actor,getWeights:()=>t.map(e=>e.weight),remove:e=>{$(t,n=>n.actor===e)}}),L=t=>{let e=Mt(t);return bt(e)};var wt=t=>At(t,[1,t.initiative]),At=(t,e)=>({weight:e,actor:t}),tt=(t,e)=>{for(let n of t)n.weight=A(n.weight,e)},Ct=t=>{let e=Ht(t);return tt(t,e.weight),e.weight=[1,e.actor.initiative],e},Lt=(t,e)=>C(t.weight,e.weight),Ht=t=>w(t,Lt),Mt=t=>{let e=t.map(wt);return e.sort((n,r)=>r.actor.initiative-n.actor.initiative),tt(e,e[0].weight),e};var H=(t,e)=>{let n=T(e,t.next);return{getBuffer:()=>n,next:()=>(n=[...n.slice(1),t.next()],n[0]),remove:r=>{for(t.remove(r),n=n.filter(o=>o!==r);n.length<e;)n.push(t.next())}}};var et={passable:!1,unit:null},B={passable:!0,unit:null},M=t=>[-t,-t+1,1,t+1,t,t-1,-1,-t-1];var E=class{constructor(e,n,r){this.type=e;this.position=n;this.faction=r;this.health=e.health,this.restoreMovePoints()}restoreMovePoints(){this.movePoints=this.type.speed}get initiative(){return this.type.initiative}};var Rt={id:1,health:40,attack:12,speed:3,initiative:3},Nt={id:2,health:6,attack:5,speed:4,initiative:4},nt=[Rt,Nt];var Pt=t=>H(L(t),8),_t=t=>t.map(e=>e?B:et),Ft=(t,e)=>t.map(n=>{let r=new E(nt[n.id-1],n.position,n.faction);return e[n.position]={...e[n.position],unit:r},r}),R=t=>{let e=_t(t.tiles),n=Ft(t.units,e),r=Pt(n),o=()=>{let s=n[0].faction;for(let c=1;c<n.length;c++)if(s!==n[c].faction)return null;return s},i=()=>(l.currentUnit.restoreMovePoints(),l.currentUnit=r.next(),["turnEnd",{activeUnitPosition:l.currentUnit.position}]),a=(s,c)=>{e[s]=B,l.currentUnit.position=c,e[c]={...e[c],unit:l.currentUnit};let u=[["move",{from:s,to:c}]];return l.currentUnit.movePoints===1?u.push(i()):l.currentUnit.movePoints--,u},p=s=>{let c=l.currentUnit.position;s.health-=l.currentUnit.type.attack;let u=s.health<=0;if(u){z(n,s),e[s.position]=B,r.remove(s);let O=o();if(O!==null)return[["attack",{from:c,to:s.position,isDead:u}],["win",{winFaction:O}]]}return[["attack",{from:c,to:s.position,isDead:u}],i()]},l={width:t.width,height:t.height,tiles:e,move:s=>{let c=l.currentUnit.position,u=e[s].unit;if(u){if(u.faction!==l.currentUnit.faction)return p(u)}else return a(c,s);return[]},endTurn:()=>[i()],currentUnit:r.getBuffer()[0],getUnitsQueue:()=>r.getBuffer()};return l};var Qt=["d","r"],kt=["Red","Blue"],N="faction-",I=t=>Qt[t.type.id-1],rt=t=>kt[t],v=t=>["unit",`${N}${t.faction}`];var Ot=t=>({attack:async({to:e,isDead:n})=>{await t.triggerShakeAnimation(e),n&&t.updateTile(e)},move:({from:e,to:n})=>{t.updateTile(e),t.updateTile(n)},turnEnd:({activeUnitPosition:e})=>{d("active"),t.updateTile(e)},win:({winFaction:e})=>{let n=rt(e);alert(`${n} wins!`)}}),ot=t=>{let e=Ot(t);return(n,r)=>{let o=e[n];return o(r)}};var it=t=>m("div",I(t),{className:v(t).join(" ")}),at=(t,e)=>{let n=t.map(it),r=m("div",{className:"units-queue"},n);return h(r,o=>{let i=o!==null?t[n.indexOf(o)]:null;e(i)}),{element:r,clearHighlight:()=>{d("highlighted",r)},highlight:o=>{for(let i=0;i<t.length;i++)t[i]===o?n[i].classList.add("highlighted"):n[i].classList.remove("highlighted")},update:o=>{o!==t&&(t=o,n=o.map(it),r.replaceChildren(...n))}}};var ct="tile-",Yt=ct.length,st=48,x=t=>ct+t,mt=t=>{let e=x(t);return W(`#${e} span`)},P=t=>+t.substring(Yt),lt=t=>`${t}px`,pt=(t,e)=>({width:lt(t*st+t-1),height:lt(e*st+e-1)}),$t=t=>{let e=["unit","active"],n=Array.from(t.classList).find(r=>r.startsWith(N));return n&&e.push(n),e},jt=t=>{t.classList.remove(...$t(t))},_=(t,e,n)=>{if(!e.unit)jt(t),t.innerText=e.passable?"":"#";else{t.replaceChildren(m("span",{innerText:I(e.unit)}));let r=zt(e.unit,e.unit===n);t.className+=" "+r}},zt=(t,e)=>{let n=v(t);return e&&n.push("active"),n.join(" ")};var Vt=(t,e,n)=>{let r=e.tiles.length-e.width;for(let o=0;o<e.tiles.length;o++){let i=e.tiles[o],a=m("div",{id:x(o)});(o+1)%e.width!==0&&a.classList.add("right-border"),o<r&&a.classList.add("bottom-border"),_(a,i,n),t.append(a)}},F=(t,e,n,r)=>{let o=s=>{if(!s){r(null);return}let c=P(s.id),u=t.tiles[c];r(u)},i=()=>{d("highlighted",l)},a={updateTile:s=>{let c=f(x(s)),u=t.tiles[s];_(c,u,e())},triggerShakeAnimation:s=>{let c=mt(s);return G(c,"shake-animate")},highlight:s=>{i(),f(x(s)).classList.add("highlighted")},clearHighlighted:i},p=n(a),l=m("div",{className:"field",style:pt(t.width,t.height),onclick:({target:s})=>{let c=P(s.id);p(c)}});return h(l,o),Vt(l,t,e()),{element:l,handle:a}};var Wt=(t,e)=>{let n=e.getValue(t),r=e.getMaxValue(t);return e.name+": "+n+"/"+r},ut=(t,e)=>e.map(n=>Wt(t,n)).join("; ");var Q=t=>{let e=m("span");return{element:e,update:n=>{e.innerText=n?ut(n,t):""}}};var Gt=[{name:"Health",getValue:t=>t.health,getMaxValue:t=>t.type.health},{name:"Move Points",getValue:t=>t.movePoints,getMaxValue:t=>t.type.speed}],dt=()=>Q(Gt);var Xt=(t,e)=>{let{tiles:n,width:r}=t,o=M(r);return V(async i=>{if(!o.includes(i-t.currentUnit.position)||!n[i].passable)return;let a=t.move(i);for(let[p,l]of a)await e(p,l)})},k=t=>{let e=dt(),n=at(t.getUnitsQueue(),a=>{e.update(a),a!==null?i.handle.highlight(a.position):i.handle.clearHighlighted()}),r=a=>{if(!a){n.clearHighlight();return}let{unit:p}=a;e.update(p),p?n.highlight(p):n.clearHighlight()},o,i=F(t,()=>t.currentUnit,a=>{o=ot(a);let p=Xt(t,o);return l=>{p(l),n.update(t.getUnitsQueue()),r(t.tiles[l])}},r);return m("div",[i.element,m("div",{className:"bottom-panel"},[n.element,m("button","End Turn",{onclick:()=>{let a=t.endTurn();for(let[p,l]of a)o(p,l);n.update(t.getUnitsQueue())}})]),e.element])};var ft=t=>{let e=b(t),n=R(e);return k(n)};var xt=t=>m("ul",t.map(([e,n])=>m("li",[m("a",e,{href:`#${n}`})])));var Zt=[["1d1r-1","20A99e0"],["1d1r-2","g0e0zi8"],["1d2r-1","8w3VY!vfw218BfM"],["1d2r-2","8w3VY!vfw2xhcHM"],["1d3r-1","ow0~DY~DQ~w19it9YD8"],["1d3r-2","qw0~DY~DY~DY04IjYjQCo0"],["1d3r-3","P07DDDw8UnNiBG0"],["1d4r-1","pw0~DY~DY~DY~w0xh1AyA78u0"],["1d4r-2","Ew0!vDV!v01sBalpko90"],["2d5r-1","pw0~DA~DY~BY~w0FhqyT5uaazd6U0"],["2d5r-2","pw0vDY~DY~DY~00xhaAz45iejsxU0"]],Tt=()=>xt(Zt);var Kt=t=>()=>{let e=location.hash.slice(1),n=e?ft(e):Tt();t.replaceChildren(n)},ht=t=>{let e=Kt(t);e(),window.addEventListener("hashchange",e)};ht(f("root"));})();
