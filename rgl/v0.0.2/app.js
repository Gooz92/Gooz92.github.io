(()=>{var L=(t,e)=>{let n=t.trim().split(`
`),r=0;for(let o=0;o<n.length;o++){let s=n[o].trim();r===0&&(r=(s.length+1)/2);for(let l=0;l<s.length;l+=2)e(s[l],o*r+l/2)}return[r,n.length]};var k={id:1,health:40,attack:12,initiative:3},C={id:2,health:6,attack:5,initiative:4};var E=class{constructor(e,n,r){this.type=e;this.position=n;this.faction=r;this.health=e.health}get initiative(){return this.type.initiative}};var X={passable:!1,unit:null},g={passable:!0,unit:null},Z=(t,e,n)=>new E(t,e,n),w=(t,e,n)=>({passable:!0,unit:Z(t,e,n)}),G={"#":()=>X,".":()=>g,r:(t,e)=>w(C,t,e),d:(t,e)=>w(k,t,e)},N=(t,e)=>{let n=t.toLowerCase(),r=G[n];if(!r)throw new Error(`Unknown tile: ${t}`);let o=+(n===t);return r(e,o)},y=t=>[-t,-t+1,1,t+1,t,t-1,-1,-t-1];var F=t=>typeof t=="string";var P=(t,e)=>{_(t,t.findIndex(e))},_=(t,e)=>{e>=0&&t.splice(e,1)},H=(t,e)=>{_(t,t.indexOf(e))};var M=t=>{let e=null;return(...n)=>(e!==null||(e=t(...n).finally(()=>{e=null})),e)};var h=(t,e)=>{let n=t[0];for(let r=1;r<t.length;r++){let o=t[r];e(o,n)&&(n=o)}return n};var K=t=>({turns:0,actor:t}),J=(t,e)=>(t.turns+1)*e.actor.initiative<(e.turns+1)*t.actor.initiative,V=t=>h(t,J),tt=t=>t.map(K).sort((n,r)=>r.actor.initiative-n.actor.initiative),D=t=>{let e=tt(t);return{next:()=>{let n=V(e);return++n.turns,n.actor},remove:n=>{P(e,r=>r.actor===n)}}};var b=t=>{let e=[],n=[],[r,o]=L(t,(a,m)=>{let i=N(a,m);i.unit&&n.push(i.unit),e.push(i)}),s=D(n),l=()=>{let a=n[0].faction;for(let m=1;m<n.length;m++)if(a!==n[m].faction)return null;return a},c={width:r,height:o,tiles:e,move:a=>{let m=c.currentUnit.position;return e[c.currentUnit.position]=g,c.currentUnit.position=a,e[a]={passable:!0,unit:c.currentUnit},c.currentUnit=s.next(),[["move",{from:m,to:a}],["turnEnd",{activeUnitPosition:c.currentUnit.position}]]},attack:a=>{let m=c.currentUnit.position,i=e[a].unit;i.health-=c.currentUnit.type.attack;let u=i.health<=0;if(u){H(n,i),e[i.position]=g,s.remove(i);let p=l();if(p!==null)return[["attack",{from:m,to:a,isDead:u}],["win",{winFaction:p}]]}return c.currentUnit=s.next(),[["attack",{from:m,to:a,isDead:u}],["turnEnd",{activeUnitPosition:c.currentUnit.position}]]},currentUnit:s.next()};return c};var d=(t,...e)=>{let n=document.createElement(t);for(let r of e)F(r)?n.innerText=r:Array.isArray(r)?n.append(...r):A(n,r);return n},A=(t,e)=>{for(let n in e)n==="style"?Object.assign(t.style,e.style):t[n]=e[n]},R=t=>{let e=null;return{onmousemove:({target:n})=>{n!==e&&(e=n,t(e))},onmouseleave:()=>{e=null,t(e)}}},O=(t,e)=>{let n=document.getElementById(t);return et(n,e)},et=(t,e)=>(t.classList.add(e),new Promise(n=>{t.addEventListener("animationend",()=>{t.classList.remove(e),n()},{once:!0})}));var Q=32,nt=["d","r"],j="tile-",rt=j.length,f=t=>j+t,I=t=>+t.substring(rt),q=t=>t.passable?t.unit?U(t.unit):".":"#",U=t=>nt[t.type.id-1],$=t=>`${t}px`,Y=(t,e)=>({width:$(t*Q),height:$(e*Q)}),ot=["Red","Blue"],z=t=>ot[t],T=t=>`faction-${t}`,x=(t,e)=>{let n=document.getElementById(f(t));A(n,e)};var it=t=>({attack:async({to:e,isDead:n})=>{await O(f(e),"shake-animate"),n&&x(e,{className:"",innerText:"."})},move:({from:e,to:n})=>{let{unit:r}=t[n];x(e,{innerText:".",className:""}),x(n,{innerText:U(r),className:T(r.faction)})},turnEnd:({activeUnitPosition:e})=>{document.querySelector(".selected")?.classList.remove("selected"),x(e,{className:`selected ${T(t[e].unit.faction)}`})},win:({winFaction:e})=>{let n=z(e);alert(`${n} wins!`)}}),W=t=>{let e=it(t);return(n,r)=>{let o=e[n];return o(r)}};var st=(t,e)=>{let{tiles:n}=t,r=s=>{let{unit:l}=n[s];return l?l.faction===t.currentUnit.faction?[]:t.attack(s):t.move(s)},o=W(n);return M(async s=>{if(!e.includes(s-t.currentUnit.position)||!n[s].passable)return;let l=r(s);for(let[c,a]of l)await o(c,a)})},B=t=>{let e=b(t),{width:n,height:r,tiles:o}=e,s=y(n),l=st(e,s),c=d("span"),a=i=>{if(!i){c.innerText="";return}let u=I(i.id),p=o[u];c.innerText=p.unit?`Health: ${p.unit.health}`:""},m=d("div",{className:"field",style:Y(n,r),onclick:({target:i})=>{let u=I(i.id);l(u)},...R(a)});for(let i=0;i<o.length;i++){let u=o[i],p=d("div",q(u),{id:f(i)}),{unit:v}=u;v&&(v===e.currentUnit&&p.classList.add("selected"),p.classList.add(T(v.faction))),m.append(p)}return d("div",[m,c])};var S=`
  # # # # # # #
  # . . . . . #
  # . R . R . #
  # . . . . . #
  # . . d . . #
  # . . . . . #
  # # # # # # #
`;document.body.appendChild(B(S));})();
