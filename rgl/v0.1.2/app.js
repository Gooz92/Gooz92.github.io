(()=>{var P=t=>typeof t=="string";var O=(t,e)=>{Y(t,t.findIndex(e))},Y=(t,e)=>{e>=0&&t.splice(e,1)},j=(t,e)=>{Y(t,t.indexOf(e))},T=(t,e)=>{let n=[];for(let r=0;r<t;r++)n.push(e(r));return n};var z=t=>{let e=null;return(...n)=>(e!==null||(e=t(...n).finally(()=>{e=null})),e)};var dt=(t,e)=>{let n=0,r=t,o={readBit:()=>{r===t&&(n=e.next(),r=0);let i=(n>>>t-r-1&1)===1;return++r,i},readBits:i=>T(i,o.readBit),readUint:i=>{let a=0;for(let p=0;p<i;p++)o.readBit()&&(a+=2**p);return a}};return o},$=t=>dt(6,t);var h=t=>Math.floor(Math.log2(t))+1;var ft="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ!~",xt=t=>{let e=0;return{next:()=>{if(e>=t.length)throw new Error("Unexpected end of input");let n=t[e],r=ft.indexOf(n);if(r===-1)throw new Error(`Unexpected token '${n}' at position ${e+1}`);return++e,r}}};var U=t=>{let e=xt(t);return $(e)};var Z=(t,e)=>{let n=t.readUint(3);return n===0?null:{id:n,faction:t.readUint(1),position:t.readUint(e)}},b=t=>{let e=U(t),n=e.readUint(4)+3,r=e.readUint(4)+3,o=n*r,i=e.readBits(o),a=[],p=h(o),s=Z(e,p);for(;s!==null;)a.push(s),s=Z(e,p);return{width:n,height:r,tiles:i,units:a}};var w=(t,e)=>{let n=t[0];for(let r=1;r<t.length;r++){let o=t[r];e(o,n)&&(n=o)}return n};var G=[0,1],A=([t,e],[n,r])=>{let o=t*r-n*e;if(o===0)return G;let i=e*r,a=ht(o,i);return[o/a,i/a]},ht=(t,e)=>{for(;e!==0;){let n=e;e=t%e,t=n}return t},H=([t,e],[n,r])=>t*r<n*e;var gt=t=>({next:()=>Et(t).actor,getWeights:()=>t.map(e=>e.weight),remove:e=>{O(t,n=>n.actor===e)}}),R=t=>{let e=Ut(t);return gt(e)};var Bt=t=>It(t,[1,t.initiative]),It=(t,e)=>({weight:e,actor:t}),X=(t,e)=>{for(let n of t)n.weight=A(n.weight,e)},Et=t=>{let e=Dt(t);return X(t,e.weight),e.weight=[1,e.actor.initiative],e},vt=(t,e)=>H(t.weight,e.weight),Dt=t=>w(t,vt),Ut=t=>{let e=t.map(Bt);return e.sort((n,r)=>r.actor.initiative-n.actor.initiative),X(e,e[0].weight),e};var L=(t,e)=>{let n=T(e,t.next);return{getBuffer:()=>n,next:()=>(n=[...n.slice(1),t.next()],n[0]),remove:r=>{for(t.remove(r),n=n.filter(o=>o!==r);n.length<e;)n.push(t.next())}}};var K={passable:!1,unit:null},g={passable:!0,unit:null},C=t=>[-t,-t+1,1,t+1,t,t-1,-1,-t-1];var B=class{constructor(e,n,r){this.type=e;this.position=n;this.faction=r;this.health=e.health}get initiative(){return this.type.initiative}};var St={id:1,health:40,attack:12,initiative:3},yt={id:2,health:6,attack:5,initiative:4},J=[St,yt];var bt=t=>L(R(t),8),wt=t=>t.map(e=>e?g:K),At=(t,e)=>t.map(n=>{let r=new B(J[n.id-1],n.position,n.faction);return e[n.position]={...e[n.position],unit:r},r}),M=t=>{let e=wt(t.tiles),n=At(t.units,e),r=bt(n),o=()=>{let c=n[0].faction;for(let m=1;m<n.length;m++)if(c!==n[m].faction)return null;return c},i=(c,m)=>(e[c]=g,s.currentUnit.position=m,e[m]={...e[m],unit:s.currentUnit},s.currentUnit=r.next(),[["move",{from:c,to:m}],p()]),a=c=>{let m=s.currentUnit.position;c.health-=s.currentUnit.type.attack;let l=c.health<=0;if(l){j(n,c),e[c.position]=g,r.remove(c);let d=o();if(d!==null)return[["attack",{from:m,to:c.position,isDead:l}],["win",{winFaction:d}]]}return s.currentUnit=r.next(),[["attack",{from:m,to:c.position,isDead:l}],p()]},p=()=>["turnEnd",{activeUnitPosition:s.currentUnit.position}],s={width:t.width,height:t.height,tiles:e,move:c=>{let m=s.currentUnit.position,l=e[c].unit;if(l){if(l.faction!==s.currentUnit.faction)return a(l)}else return i(m,c);return[]},currentUnit:r.getBuffer()[0],getUnitsQueue:()=>r.getBuffer()};return s};var u=(t,...e)=>{let n=document.createElement(t);for(let r of e)P(r)?n.innerText=r:Array.isArray(r)?n.append(...r):Ht(n,r);return n},Ht=(t,e)=>{for(let n in e)n==="style"?Object.assign(t.style,e.style):t[n]=e[n]},Rt=t=>t instanceof HTMLElement,I=(t,e)=>{let n=null;t.addEventListener("mousemove",({target:r})=>{if(r!==n){if(r===t||!Rt(r)){e(null);return}n=r,e(n)}}),t.addEventListener("mouseleave",()=>{n=null,e(null)})},q=(t,e)=>{let n=document.getElementById(t);return Lt(n,e)},f=(t,e=document)=>{e.querySelectorAll(`.${t}`).forEach(n=>{n.classList.remove(t)})},Lt=(t,e)=>(t.classList.add(e),new Promise(n=>{t.addEventListener("animationend",()=>{t.classList.remove(e),n()},{once:!0})}));var Ct=["d","r"],Mt=["Red","Blue"],E=t=>Ct[t.type.id-1],tt=t=>Mt[t],v=t=>["unit",`faction-${t.faction}`];var Nt=t=>({attack:async({to:e,isDead:n})=>{await t.triggerShakeAnimation(e),n&&t.updateTile(e)},move:({from:e,to:n})=>{t.updateTile(e),t.updateTile(n)},turnEnd:({activeUnitPosition:e})=>{f("active"),t.updateTile(e)},win:({winFaction:e})=>{let n=tt(e);alert(`${n} wins!`)}}),et=t=>{let e=Nt(t);return(n,r)=>{let o=e[n];return o(r)}};var nt=t=>u("div",E(t),{className:v(t).join(" ")}),rt=(t,e)=>{let n=t.map(nt),r=u("div",{className:"units-queue"},n);return I(r,o=>{let i=o!==null?t[n.indexOf(o)]:null;e(i)}),{element:r,clearHighlight:()=>{f("highlighted",r)},highlight:o=>{for(let i=0;i<t.length;i++)t[i]===o?n[i].classList.add("highlighted"):n[i].classList.remove("highlighted")},update:o=>{o!==t&&(t=o,n=o.map(nt),r.replaceChildren(...n))}}};var at="tile-",Ft=at.length,ot=32,x=t=>at+t,N=t=>+t.substring(Ft),it=t=>`${t}px`,st=(t,e)=>({width:it(t*ot),height:it(e*ot)}),F=(t,e,n)=>{e.unit?(t.innerText=E(e.unit),t.className=_t(e.unit,e.unit===n)):(t.removeAttribute("class"),t.innerText=e.passable?".":"#")},_t=(t,e)=>{let n=v(t);return e&&n.push("active"),n.join(" ")};var Qt=(t,e,n)=>{for(let r=0;r<e.length;r++){let o=e[r],i=u("div",{id:x(r)});F(i,o,n),t.append(i)}},_=({width:t,height:e,tiles:n},r,o,i)=>{let a=l=>{if(!l){i(null);return}let d=N(l.id),D=n[d];i(D)},p=()=>{f("highlighted",m)},s={updateTile:l=>{let d=document.getElementById(x(l)),D=n[l];F(d,D,r())},triggerShakeAnimation:l=>q(x(l),"shake-animate"),highlight:l=>{p(),document.getElementById(x(l)).classList.add("highlighted")},clearHighlighted:p},c=o(s),m=u("div",{className:"field",style:st(t,e),onclick:({target:l})=>{let d=N(l.id);c(d)}});return I(m,a),Qt(m,n,r()),{element:m,handle:s}};var kt=(t,e)=>{let n=e.getValue(t),r=e.getMaxValue(t);return e.name+": "+n+"/"+r},ct=(t,e)=>e.map(n=>kt(t,n)).join("; ");var Q=t=>{let e=u("span");return{element:e,update:n=>{e.innerText=n?ct(n,t):""}}};var Pt=(t,e)=>{let{tiles:n,width:r}=t,o=C(r),i=et(e);return z(async a=>{if(!o.includes(a-t.currentUnit.position)||!n[a].passable)return;let p=t.move(a);for(let[s,c]of p)await i(s,c)})},Ot=[{name:"Health",getValue:t=>t.health,getMaxValue:t=>t.type.health}],Yt=()=>Q(Ot),k=t=>{let e=Yt(),n=rt(t.getUnitsQueue(),i=>{e.update(i),i!==null?o.handle.highlight(i.position):o.handle.clearHighlighted()}),r=i=>{if(!i){n.clearHighlight();return}let{unit:a}=i;e.update(a),a?n.highlight(a):n.clearHighlight()},o=_(t,()=>t.currentUnit,i=>{let a=Pt(t,i);return p=>{a(p),n.update(t.getUnitsQueue()),r(t.tiles[p])}},r);return u("div",[o.element,n.element,e.element])};var lt=t=>{let e=b(t),n=M(e);return k(n)};var mt=t=>u("ul",t.map(([e,n])=>u("li",[u("a",e,{href:`#${n}`})])));var jt=[["1d1r-1","20A99e0"],["1d1r-2","g0e0zi8"],["1d2r-1","8w3VY!vfw218BfM"],["1d2r-2","8w3VY!vfw2xhcHM"],["1d3r-1","ow0~DY~DQ~w19it9YD8"],["1d3r-2","qw0~DY~DY~DY04IjYjQCo0"],["1d3r-3","P07DDDw8UnNiBG0"],["1d4r-1","pw0~DY~DY~DY~w0xh1AyA78u0"],["1d4r-2","Ew0!vDV!v01sBalpko90"],["2d5r-1","pw0~DA~DY~BY~w0FhqyT5uaazd6U0"],["2d5r-2","pw0vDY~DY~DY~00xhaAz45iejsxU0"]],pt=()=>mt(jt);var zt=t=>()=>{let e=location.hash.slice(1),n=e?lt(e):pt();t.replaceChildren(n)},ut=t=>{let e=zt(t);e(),window.addEventListener("hashchange",e)};ut(document.getElementById("root"));})();
