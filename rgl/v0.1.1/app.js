(()=>{var Q=t=>typeof t=="string";var P=(t,e)=>{O(t,t.findIndex(e))},O=(t,e)=>{e>=0&&t.splice(e,1)},Y=(t,e)=>{O(t,t.indexOf(e))},g=(t,e)=>{let n=[];for(let r=0;r<t;r++)n.push(e(r));return n};var $=t=>{let e=null;return(...n)=>(e!==null||(e=t(...n).finally(()=>{e=null})),e)};var ut=(t,e)=>{let n=0,r=t,i={readBit:()=>{r===t&&(n=e.next(),r=0);let o=(n>>>t-r-1&1)===1;return++r,o},readBits:o=>g(o,i.readBit),readUint:o=>{let a=0;for(let s=0;s<o;s++)i.readBit()&&(a+=2**s);return a}};return i},j=t=>ut(6,t);var B=t=>Math.floor(Math.log2(t))+1;var ft="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ!~",xt=t=>{let e=0;return{next:()=>{if(e>=t.length)throw new Error("Unexpected end of input");let n=t[e],r=ft.indexOf(n);if(r===-1)throw new Error(`Unexpected token '${n}' at position ${e+1}`);return++e,r}}};var y=t=>{let e=xt(t);return j(e)};var V=(t,e)=>{let n=t.readUint(3);return n===0?null:{id:n,faction:t.readUint(1),position:t.readUint(e)}},D=t=>{let e=y(t),n=e.readUint(4)+3,r=e.readUint(4)+3,i=n*r,o=e.readBits(i),a=[],s=B(i),c=V(e,s);for(;c!==null;)a.push(c),c=V(e,s);return{width:n,height:r,tiles:o,units:a}};var b=(t,e)=>{let n=t[0];for(let r=1;r<t.length;r++){let i=t[r];e(i,n)&&(n=i)}return n};var Z=[0,1],A=([t,e],[n,r])=>{let i=t*r-n*e;if(i===0)return Z;let o=e*r,a=ht(i,o);return[i/a,o/a]},ht=(t,e)=>{for(;e!==0;){let n=e;e=t%e,t=n}return t},H=([t,e],[n,r])=>t*r<n*e;var gt=t=>({next:()=>It(t).actor,getWeights:()=>t.map(e=>e.weight),remove:e=>{P(t,n=>n.actor===e)}}),L=t=>{let e=yt(t);return gt(e)};var Bt=t=>Et(t,[1,t.initiative]),Et=(t,e)=>({weight:e,actor:t}),G=(t,e)=>{for(let n of t)n.weight=A(n.weight,e)},It=t=>{let e=Ut(t);return G(t,e.weight),e.weight=[1,e.actor.initiative],e},vt=(t,e)=>H(t.weight,e.weight),Ut=t=>b(t,vt),yt=t=>{let e=t.map(Bt);return e.sort((n,r)=>r.actor.initiative-n.actor.initiative),G(e,e[0].weight),e};var R=(t,e)=>{let n=g(e,t.next);return{getBuffer:()=>n,next:()=>(n=[...n.slice(1),t.next()],n[0]),remove:r=>{for(t.remove(r),n=n.filter(i=>i!==r);n.length<e;)n.push(t.next())}}};var X={passable:!1,unit:null},E={passable:!0,unit:null},C=t=>[-t,-t+1,1,t+1,t,t-1,-1,-t-1];var I=class{constructor(e,n,r){this.type=e;this.position=n;this.faction=r;this.health=e.health}get initiative(){return this.type.initiative}};var St={id:1,health:40,attack:12,initiative:3},wt={id:2,health:6,attack:5,initiative:4},K=[St,wt];var Dt=t=>R(L(t),8),bt=t=>t.map(e=>e?E:X),At=(t,e)=>t.map(n=>{let r=new I(K[n.id-1],n.position,n.faction);return e[n.position]={...e[n.position],unit:r},r}),F=t=>{let e=bt(t.tiles),n=At(t.units,e),r=Dt(n),i=()=>{let a=n[0].faction;for(let s=1;s<n.length;s++)if(a!==n[s].faction)return null;return a},o={width:t.width,height:t.height,tiles:e,move:a=>{let s=o.currentUnit.position;return e[o.currentUnit.position]=E,o.currentUnit.position=a,e[a]={passable:!0,unit:o.currentUnit},o.currentUnit=r.next(),[["move",{from:s,to:a}],["turnEnd",{activeUnitPosition:o.currentUnit.position}]]},attack:a=>{let s=o.currentUnit.position,c=e[a].unit;c.health-=o.currentUnit.type.attack;let u=c.health<=0;if(u){Y(n,c),e[c.position]=E,r.remove(c);let p=i();if(p!==null)return[["attack",{from:s,to:a,isDead:u}],["win",{winFaction:p}]]}return o.currentUnit=r.next(),[["attack",{from:s,to:a,isDead:u}],["turnEnd",{activeUnitPosition:o.currentUnit.position}]]},currentUnit:r.getBuffer()[0],getUnitsQueue:()=>r.getBuffer()};return o};var l=(t,...e)=>{let n=document.createElement(t);for(let r of e)Q(r)?n.innerText=r:Array.isArray(r)?n.append(...r):Ht(n,r);return n},Ht=(t,e)=>{for(let n in e)n==="style"?Object.assign(t.style,e.style):t[n]=e[n]},Lt=t=>t instanceof HTMLElement,v=(t,e)=>{let n=null;t.addEventListener("mousemove",({target:r})=>{if(r!==n){if(r===t||!Lt(r)){e(null);return}n=r,e(n)}}),t.addEventListener("mouseleave",()=>{n=null,e(null)})},J=(t,e)=>{let n=document.getElementById(t);return Rt(n,e)},f=(t,e=document)=>{e.querySelectorAll(`.${t}`).forEach(n=>{n.classList.remove(t)})},Rt=(t,e)=>(t.classList.add(e),new Promise(n=>{t.addEventListener("animationend",()=>{t.classList.remove(e),n()},{once:!0})}));var Ct=["d","r"],Ft=["Red","Blue"],x=t=>Ct[t.type.id-1],q=t=>Ft[t],U=t=>`faction-${t}`;var Mt=t=>({attack:async({to:e,isDead:n})=>{await t.triggerShakeAnimation(e),n&&t.updateTile(e)},move:({from:e,to:n})=>{t.updateTile(e),t.updateTile(n)},turnEnd:({activeUnitPosition:e})=>{f("selected"),t.updateTile(e)},win:({winFaction:e})=>{let n=q(e);alert(`${n} wins!`)}}),tt=t=>{let e=Mt(t);return(n,r)=>{let i=e[n];return i(r)}};var et=t=>l("div",x(t),{className:U(t.faction)}),nt=(t,e)=>{let n=t.map(et),r=l("div",{className:"units-queue"},n);return v(r,i=>{let o=i!==null?t[n.indexOf(i)]:null;e(o)}),{element:r,clearHighlight:()=>{f("highlighted",r)},highlight:i=>{for(let o=0;o<t.length;o++)t[o]===i?n[o].classList.add("highlighted"):n[o].classList.remove("highlighted")},update:i=>{i!==t&&(t=i,n=i.map(et),r.replaceChildren(...n))}}};var ot="tile-",Nt=ot.length,rt=32,T=t=>ot+t,M=t=>+t.substring(Nt),at=t=>t.passable?t.unit?x(t.unit):".":"#",it=t=>`${t}px`,st=(t,e)=>({width:it(t*rt),height:it(e*rt)});var ct=(t,e,n)=>{t.innerText=x(e),e===n&&t.classList.add("selected"),t.classList.add(U(e.faction))},_t=(t,e,n)=>{for(let r=0;r<e.length;r++){let i=e[r],o=l("div",at(i),{id:T(r)}),{unit:a}=i;a&&ct(o,a,n),t.append(o)}},N=({width:t,height:e,tiles:n},r,i,o)=>{let a=m=>{if(!m){o(null);return}let d=M(m.id),h=n[d];o(h)},s=()=>{f("highlighted",p)},c={updateTile:m=>{let d=document.getElementById(T(m)),h=n[m],{unit:k}=h;d.className="",k?ct(d,k,r()):d.innerText=h.passable?".":"#"},triggerShakeAnimation:m=>J(T(m),"shake-animate"),highlight:m=>{s(),document.getElementById(T(m)).classList.add("highlighted")},clearHighlighted:s},u=i(c),p=l("div",{className:"field",style:st(t,e),onclick:({target:m})=>{let d=M(m.id);u(d)}});return v(p,a),_t(p,n,r()),{element:p,handle:c}};var kt=(t,e)=>{let{tiles:n,width:r}=t,i=C(r),o=s=>{let{unit:c}=n[s];return c?c.faction!==t.currentUnit.faction?t.attack(s):[]:t.move(s)},a=tt(e);return $(async s=>{if(!i.includes(s-t.currentUnit.position)||!n[s].passable)return;let c=o(s);for(let[u,p]of c)await a(u,p)})},Qt=()=>{let t=l("span");return{element:t,update:e=>{t.innerText=e?`Health: ${e.health}`:""}}},_=t=>{let e=Qt(),n=nt(t.getUnitsQueue(),i=>{e.update(i),i!==null?r.handle.highlight(i.position):r.handle.clearHighlighted()}),r=N(t,()=>t.currentUnit,i=>{let o=kt(t,i);return async a=>{await o(a),n.update(t.getUnitsQueue())}},i=>{if(!i){n.clearHighlight();return}let{unit:o}=i;e.update(o),o?n.highlight(o):n.clearHighlight()});return l("div",[r.element,n.element,e.element])};var lt=t=>{let e=D(t),n=F(e);return _(n)};var mt=t=>l("ul",t.map(([e,n])=>l("li",[l("a",e,{href:`#${n}`})])));var Pt=[["1d1r-1","20A99e0"],["1d1r-2","g0e0zi8"],["1d2r-1","8w3VY!vfw218BfM"],["1d2r-2","8w3VY!vfw2xhcHM"],["1d3r-1","ow0~DY~DQ~w19it9YD8"],["1d3r-2","qw0~DY~DY~DY04IjYjQCo0"],["1d3r-3","P07DDDw8UnNiBG0"],["1d4r-1","pw0~DY~DY~DY~w0xh1AyA78u0"],["1d4r-2","Ew0!vDV!v01sBalpko90"],["2d5r-1","pw0~DA~DY~BY~w0FhqyT5uaazd6U0"],["2d5r-2","pw0vDY~DY~DY~00xhaAz45iejsxU0"]],pt=()=>mt(Pt);var Ot=t=>()=>{let e=location.hash.slice(1),n=e?lt(e):pt();t.replaceChildren(n)},dt=t=>{let e=Ot(t);e(),window.addEventListener("hashchange",e)};dt(document.getElementById("root"));})();
