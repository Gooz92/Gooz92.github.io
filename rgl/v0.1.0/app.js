(()=>{var C=t=>typeof t=="string";var F=(t,e)=>{O(t,t.findIndex(e))},O=(t,e)=>{e>=0&&t.splice(e,1)},Y=(t,e)=>{O(t,t.indexOf(e))},h=(t,e)=>{let n=[];for(let r=0;r<t;r++)n.push(e(r));return n};var $=t=>{let e=null;return(...n)=>(e!==null||(e=t(...n).finally(()=>{e=null})),e)};var y=(t,e)=>{let n=t[0];for(let r=1;r<t.length;r++){let s=t[r];e(s,n)&&(n=s)}return n};var j=[0,1],w=([t,e],[n,r])=>{let s=t*r-n*e;if(s===0)return j;let o=e*r,i=dt(s,o);return[s/i,o/i]},dt=(t,e)=>{for(;e!==0;){let n=e;e=t%e,t=n}return t},D=([t,e],[n,r])=>t*r<n*e;var ft=t=>({next:()=>gt(t).actor,getWeights:()=>t.map(e=>e.weight),remove:e=>{F(t,n=>n.actor===e)}}),S=t=>{let e=Bt(t);return ft(e)};var xt=t=>Tt(t,[1,t.initiative]),Tt=(t,e)=>({weight:e,actor:t}),z=(t,e)=>{for(let n of t)n.weight=w(n.weight,e)},gt=t=>{let e=ht(t);return z(t,e.weight),e.weight=[1,e.actor.initiative],e},It=(t,e)=>D(t.weight,e.weight),ht=t=>y(t,It),Bt=t=>{let e=t.map(xt);return e.sort((n,r)=>r.actor.initiative-n.actor.initiative),z(e,e[0].weight),e};var b=(t,e)=>{let n=h(e,t.next);return{getBuffer:()=>n,next:()=>(n.shift(),n.push(t.next()),n[0]),remove:r=>{for(t.remove(r),n=n.filter(s=>s!==r);n.length<e;)n.push(t.next())}}};var W={passable:!1,unit:null},B={passable:!0,unit:null},A=t=>[-t,-t+1,1,t+1,t,t-1,-1,-t-1];var E=class{constructor(e,n,r){this.type=e;this.position=n;this.faction=r;this.health=e.health}get initiative(){return this.type.initiative}};var Et={id:1,health:40,attack:12,initiative:3},vt={id:2,health:6,attack:5,initiative:4},V=[Et,vt];var Ut=t=>b(S(t),8),yt=t=>t.map(e=>e?B:W),wt=(t,e)=>t.map(n=>{let r=new E(V[n.id-1],n.position,n.faction);return e[n.position]={...e[n.position],unit:r},r}),R=t=>{let e=yt(t.tiles),n=wt(t.units,e),r=Ut(n),s=()=>{let i=n[0].faction;for(let a=1;a<n.length;a++)if(i!==n[a].faction)return null;return i},o={width:t.width,height:t.height,tiles:e,move:i=>{let a=o.currentUnit.position;return e[o.currentUnit.position]=B,o.currentUnit.position=i,e[i]={passable:!0,unit:o.currentUnit},o.currentUnit=r.next(),[["move",{from:a,to:i}],["turnEnd",{activeUnitPosition:o.currentUnit.position}]]},attack:i=>{let a=o.currentUnit.position,c=e[i].unit;c.health-=o.currentUnit.type.attack;let d=c.health<=0;if(d){Y(n,c),e[c.position]=B,r.remove(c);let f=s();if(f!==null)return[["attack",{from:a,to:i,isDead:d}],["win",{winFaction:f}]]}return o.currentUnit=r.next(),[["attack",{from:a,to:i,isDead:d}],["turnEnd",{activeUnitPosition:o.currentUnit.position}]]},currentUnit:r.getBuffer()[0],getUnitsQueue:()=>r.getBuffer()};return o};var m=(t,...e)=>{let n=document.createElement(t);for(let r of e)C(r)?n.innerText=r:Array.isArray(r)?n.append(...r):N(n,r);return n},N=(t,e)=>{for(let n in e)n==="style"?Object.assign(t.style,e.style):t[n]=e[n]},Z=t=>{let e=null;return{onmousemove:({target:n})=>{n!==e&&(e=n,t(e))},onmouseleave:()=>{e=null,t(e)}}},q=(t,e)=>{let n=document.getElementById(t);return Dt(n,e)},Dt=(t,e)=>(t.classList.add(e),new Promise(n=>{t.addEventListener("animationend",()=>{t.classList.remove(e),n()},{once:!0})}));var G=32,St=["d","r"],K="tile-",bt=K.length,x=t=>K+t,L=t=>+t.substring(bt),J=t=>t.passable?t.unit?T(t.unit):".":"#",T=t=>St[t.type.id-1],X=t=>`${t}px`,tt=(t,e)=>({width:X(t*G),height:X(e*G)}),At=["Red","Blue"],et=t=>At[t],g=t=>`faction-${t}`,I=(t,e)=>{let n=document.getElementById(x(t));N(n,e)};var Rt=t=>({attack:async({to:e,isDead:n})=>{await q(x(e),"shake-animate"),n&&I(e,{className:"",innerText:"."})},move:({from:e,to:n})=>{let{unit:r}=t[n];I(e,{innerText:".",className:""}),I(n,{innerText:T(r),className:g(r.faction)})},turnEnd:({activeUnitPosition:e})=>{document.querySelector(".selected")?.classList.remove("selected"),I(e,{className:`selected ${g(t[e].unit.faction)}`})},win:({winFaction:e})=>{let n=et(e);alert(`${n} wins!`)}}),nt=t=>{let e=Rt(t);return(n,r)=>{let s=e[n];return s(r)}};var rt=t=>m("div",T(t)),ot=t=>{let e=m("div",{className:"units-queue"},t.map(rt));return{element:e,update:n=>{e.replaceChildren(...n.map(rt))}}};var Nt=(t,e)=>{let n=0,r=t,s={readBit:()=>{r===t&&(n=e.next(),r=0);let o=(n>>>t-r-1&1)===1;return++r,o},readBits:o=>h(o,s.readBit),readUint:o=>{let i=0;for(let a=0;a<o;a++)s.readBit()&&(i+=2**a);return i}};return s},it=t=>Nt(6,t);var v=t=>Math.floor(Math.log2(t))+1;var Lt="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ!~",_t=t=>{let e=0;return{next:()=>{if(e>=t.length)throw new Error("Unexpected end of input");let n=t[e],r=Lt.indexOf(n);if(r===-1)throw new Error(`Unexpected token '${n}' at position ${e+1}`);return++e,r}}};var _=t=>{let e=_t(t);return it(e)};var ct=(t,e)=>{let n=t.readUint(3);return n===0?null:{id:n,faction:t.readUint(1),position:t.readUint(e)}},P=t=>{let e=_(t),n=e.readUint(4)+3,r=e.readUint(4)+3,s=n*r,o=e.readBits(s),i=[],a=v(s),c=ct(e,a);for(;c!==null;)i.push(c),c=ct(e,a);return{width:n,height:r,tiles:o,units:i}};var Mt=(t,e)=>{let{tiles:n}=t,r=o=>{let{unit:i}=n[o];return i?i.faction===t.currentUnit.faction?[]:t.attack(o):t.move(o)},s=nt(n);return $(async o=>{if(!e.includes(o-t.currentUnit.position)||!n[o].passable)return;let i=r(o);for(let[a,c]of i)await s(a,c)})},k=t=>{let e=P(t),n=R(e),{width:r,height:s,tiles:o}=n,i=A(r),a=Mt(n,i),c=m("span"),d=l=>{if(!l){c.innerText="";return}let p=L(l.id),u=o[p];c.innerText=u.unit?`Health: ${u.unit.health}`:""},f=ot(n.getUnitsQueue()),H=m("div",{className:"field",style:tt(r,s),onclick:({target:l})=>{let p=L(l.id);a(p),f.update(n.getUnitsQueue())},...Z(d)});for(let l=0;l<o.length;l++){let p=o[l],u=m("div",J(p),{id:x(l)}),{unit:U}=p;U&&(U===n.currentUnit&&u.classList.add("selected"),u.classList.add(g(U.faction))),H.append(u)}return m("div",[H,f.element,c])};var mt=t=>k(t);var lt=t=>m("ul",t.map(([e,n])=>m("li",[m("a",e,{href:`#${n}`})])));var Pt=[["1d1r-1","20A99e0"],["1d1r-2","g0e0zi8"],["1d2r-1","8w3VY!vfw218BfM"],["1d2r-2","8w3VY!vfw2xhcHM"],["1d3r-1","ow0~DY~DQ~w19it9YD8"],["1d3r-2","qw0~DY~DY~DY04IjYjQCo0"],["1d3r-3","P07DDDw8UnNiBG0"],["1d4r-1","pw0~DY~DY~DY~w0xh1AyA78u0"],["1d4r-2","Ew0!vDV!v01sBalpko90"],["2d5r-1","pw0~DA~DY~BY~w0FhqyT5uaazd6U0"],["2d5r-2","pw0vDY~DY~DY~00xhaAz45iejsxU0"]],pt=()=>lt(Pt);var kt=t=>()=>{let e=location.hash.slice(1),n=e?mt(e):pt();t.replaceChildren(n)},ut=t=>{let e=kt(t);e(),window.addEventListener("hashchange",e)};ut(document.getElementById("root"));})();
