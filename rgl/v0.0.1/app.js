(()=>{var S=(t,e)=>{let n=t.trim().split(`
`),r=0;for(let o=0;o<n.length;o++){let s=n[o].trim();r===0&&(r=(s.length+1)/2);for(let l=0;l<s.length;l+=2)e(s[l],o*r+l/2)}return[r,n.length]};var w={id:1,health:40,attack:12,initiative:3},L={id:2,health:6,attack:5,initiative:4};var z={passable:!1,unit:null},g={passable:!0,unit:null},W=(t,e,n)=>({unitType:t,faction:n,position:e,health:t.health}),k=(t,e,n)=>({passable:!0,unit:W(t,e,n)}),X={"#":()=>z,".":()=>g,r:(t,e)=>k(L,t,e),d:(t,e)=>k(w,t,e)},C=(t,e)=>{let n=t.toLowerCase(),r=X[n];if(!r)throw new Error(`Unknown tile: ${t}`);let o=+(n===t);return r(e,o)},v=t=>[-t,-t+1,1,t+1,t,t-1,-1,-t-1];var P=t=>typeof t=="string";var H=(t,e)=>{_(t,t.findIndex(e))},_=(t,e)=>{e>=0&&t.splice(e,1)},F=(t,e)=>{_(t,t.indexOf(e))};var M=t=>{let e=null;return(...n)=>(e!==null||(e=t(...n).finally(()=>{e=null})),e)};var h=(t,e)=>{let n=t[0];for(let r=1;r<t.length;r++){let o=t[r];e(o,n)&&(n=o)}return n};var G=(t,e)=>{let n=1/e(t);return{weight:n,delta:n,actor:t}},K=(t,e)=>t.weight<e.weight,Z=t=>h(t,K),J=(t,e)=>t.map(r=>G(r,e)).sort((r,o)=>r.weight-o.weight),N=(t,e)=>{let n=J(t,e);return{next:()=>{let r=Z(n);return r.weight+=r.delta,r.actor},remove:r=>{H(n,o=>o.actor===r)}}};var y=t=>{let e=[],n=[],[r,o]=S(t,(c,m)=>{let i=C(c,m);i.unit&&n.push(i.unit),e.push(i)}),s=N(n,c=>c.unitType.initiative),l=()=>{let c=n[0].faction;for(let m=1;m<n.length;m++)if(c!==n[m].faction)return null;return c},a={width:r,height:o,tiles:e,move:c=>{let m=a.currentUnit.position;return e[a.currentUnit.position]=g,a.currentUnit.position=c,e[c]={passable:!0,unit:a.currentUnit},a.currentUnit=s.next(),[["move",{from:m,to:c}],["turnEnd",{activeUnitPosition:a.currentUnit.position}]]},attack:c=>{let m=a.currentUnit.position,i=e[c].unit;i.health-=a.currentUnit.unitType.attack;let u=i.health<=0;if(u){F(n,i),e[i.position]=g,s.remove(i);let p=l();if(p!==null)return[["attack",{from:m,to:c,isDead:u}],["win",{winFaction:p}]]}return a.currentUnit=s.next(),[["attack",{from:m,to:c,isDead:u}],["turnEnd",{activeUnitPosition:a.currentUnit.position}]]},currentUnit:s.next()};return a};var d=(t,...e)=>{let n=document.createElement(t);for(let r of e)P(r)?n.innerText=r:Array.isArray(r)?n.append(...r):b(n,r);return n},b=(t,e)=>{for(let n in e)n==="style"?Object.assign(t.style,e.style):t[n]=e[n]},D=t=>{let e=null;return{onmousemove:({target:n})=>{n!==e&&(e=n,t(e))},onmouseleave:()=>{e=null,t(e)}}},R=(t,e)=>{let n=document.getElementById(t);return V(n,e)},V=(t,e)=>(t.classList.add(e),new Promise(n=>{t.addEventListener("animationend",()=>{t.classList.remove(e),n()},{once:!0})}));var O=32,tt=["d","r"],$="tile-",et=$.length,T=t=>$+t,U=t=>+t.substring(et),j=t=>t.passable?t.unit?A(t.unit):".":"#",A=t=>tt[t.unitType.id-1],Q=t=>`${t}px`,q=(t,e)=>({width:Q(t*O),height:Q(e*O)}),f=t=>`faction-${t}`,x=(t,e)=>{let n=document.getElementById(T(t));b(n,e)};var nt=t=>({attack:async({to:e,isDead:n})=>{await R(T(e),"shake-animate"),n&&x(e,{className:"",innerText:"."})},move:({from:e,to:n})=>{let{unit:r}=t[n];x(e,{innerText:".",className:""}),x(n,{innerText:A(r),className:f(r.faction)})},turnEnd:({activeUnitPosition:e})=>{document.querySelector(".selected")?.classList.remove("selected"),x(e,{className:`selected ${f(t[e].unit.faction)}`})},win:({winFaction:e})=>{alert(`Faction: ${e} win!`)}}),Y=t=>{let e=nt(t);return(n,r)=>{let o=e[n];return o(r)}};var rt=(t,e)=>{let{tiles:n}=t,r=s=>{let{unit:l}=n[s];return l?l.faction===t.currentUnit.faction?[]:t.attack(s):t.move(s)},o=Y(n);return M(async s=>{if(!e.includes(s-t.currentUnit.position)||!n[s].passable)return;let l=r(s);for(let[a,c]of l)await o(a,c)})},B=t=>{let e=y(t),{width:n,height:r,tiles:o}=e,s=v(n),l=rt(e,s),a=d("span"),c=i=>{if(!i){a.innerText="";return}let u=U(i.id),p=o[u];a.innerText=p.unit?`Health: ${p.unit.health}`:""},m=d("div",{className:"field",style:q(n,r),onclick:({target:i})=>{let u=U(i.id);l(u)},...D(c)});for(let i=0;i<o.length;i++){let u=o[i],p=d("div",j(u),{id:T(i)}),{unit:E}=u;E&&(E===e.currentUnit&&p.classList.add("selected"),p.classList.add(f(E.faction))),m.append(p)}return d("div",[m,a])};var I=`
  # # # # # # #
  # . . . . . #
  # . R . R . #
  # . . . . . #
  # . . d . . #
  # . . . . . #
  # # # # # # #
`;document.body.appendChild(B(I));})();
