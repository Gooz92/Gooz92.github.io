(()=>{var $=t=>typeof t=="string";var z=(t,e)=>{j(t,t.findIndex(e))},j=(t,e)=>{e>=0&&t.splice(e,1)},V=(t,e)=>{j(t,t.indexOf(e))},T=(t,e)=>{let n=[];for(let r=0;r<t;r++)n.push(e(r));return n};function v(t,e){U(t===null,e)}var U=(t,e)=>{if(t)throw new Error(e)},W=t=>{let e=null;return(...n)=>(e!==null||(e=t(...n).finally(()=>{e=null})),e)};var c=(t,...e)=>{let n=document.createElement(t);for(let r of e)$(r)?n.innerText=r:Array.isArray(r)?n.append(...r):It(n,r);return n},It=(t,e)=>{for(let n in e)n==="style"?Object.assign(t.style,e.style):t[n]=e[n]},f=t=>{let e=document.getElementById(t);return v(e,`Element with id '${t}' not found`),e},X=t=>{let e=document.querySelector(t);return v(e,`Element with selector '${t}' not found`),e},vt=t=>t instanceof HTMLElement,h=(t,e)=>{let n=null;t.addEventListener("mousemove",({target:r})=>{if(r!==n){if(r===t||!vt(r)){e(null);return}n=r,e(n)}}),t.addEventListener("mouseleave",()=>{n=null,e(null)})},d=(t,e=document)=>{e.querySelectorAll(`.${t}`).forEach(n=>{n.classList.remove(t)})},Z=(t,e)=>(t.classList.add(e),new Promise(n=>{t.addEventListener("animationend",()=>{t.classList.remove(e),n()},{once:!0})}));var D=t=>Math.floor(Math.log2(t))+1;var Ut=(t,e)=>{let n=0,r=t,o={readBit:()=>{r===t&&(n=e.next(),r=0);let i=(n>>>t-r-1&1)===1;return++r,i},readBits:i=>T(i,o.readBit),readUint:i=>{let a=0;for(let m=0;m<i;m++)o.readBit()&&(a+=2**m);return a}};return o},G=t=>Ut(6,t);var Dt="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ!~",St=t=>{let e=0;return{next:()=>{if(e>=t.length)throw new Error("Unexpected end of input");let n=t[e],r=Dt.indexOf(n);if(r===-1)throw new Error(`Unexpected token '${n}' at position ${e+1}`);return++e,r}}};var S=t=>{let e=St(t);return G(e)};var tt=(t,e)=>{let n=t.readUint(3);return n===0?null:{id:n,faction:t.readUint(1),position:t.readUint(e)}},bt=(t,e)=>{let n=[],r=D(e),o=tt(t,r);for(;o!==null;)n.push(o),o=tt(t,r);return n},wt=t=>{let e=t.readUint(4)+3,n=t.readUint(4)+3,r=e*n;U(r<12,`Too few tiles: ${r} < ${12}`);let o=t.readBits(r);return{width:e,height:n,tiles:o}},w=t=>{let e=S(t),n=wt(e),r=bt(e,n.tiles.length);return{...n,units:r}};var A=(t,e)=>{let n=t[0];for(let r=1;r<t.length;r++){let o=t[r];e(o,n)&&(n=o)}return n};var et=[0,1],C=([t,e],[n,r])=>{let o=t*r-n*e;if(o===0)return et;let i=e*r,a=At(o,i);return[o/a,i/a]},At=(t,e)=>{for(;e!==0;){let n=e;e=t%e,t=n}return t},L=([t,e],[n,r])=>t*r<n*e;var Ct=t=>({next:()=>Nt(t).actor,getWeights:()=>t.map(e=>e.weight),remove:e=>{z(t,n=>n.actor===e)}}),M=t=>{let e=Pt(t);return Ct(e)};var Lt=t=>Mt(t,[1,t.initiative]),Mt=(t,e)=>({weight:e,actor:t}),nt=(t,e)=>{for(let n of t)n.weight=C(n.weight,e)},Nt=t=>{let e=Rt(t);return nt(t,e.weight),e.weight=[1,e.actor.initiative],e},Ht=(t,e)=>L(t.weight,e.weight),Rt=t=>A(t,Ht),Pt=t=>{let e=t.map(Lt);return e.sort((n,r)=>r.actor.initiative-n.actor.initiative),nt(e,e[0].weight),e};var N=(t,e)=>{let n=T(e,t.next);return{getBuffer:()=>n,next:()=>(n=[...n.slice(1),t.next()],n[0]),remove:r=>{for(t.remove(r),n=n.filter(o=>o!==r);n.length<e;)n.push(t.next())}}};var rt={passable:!1,unit:null},g={passable:!0,unit:null},H=t=>[-t,-t+1,1,t+1,t,t-1,-1,-t-1];var B=class{constructor(e,n,r){this.type=e;this.position=n;this.faction=r;this.health=e.health,this.restoreMovePoints()}restoreMovePoints(){this.movePoints=this.type.speed}get initiative(){return this.type.initiative}};var _t={id:1,health:40,attack:12,speed:3,initiative:3},Ft={id:2,health:6,attack:5,speed:4,initiative:4},ot=[_t,Ft];var kt=t=>N(M(t),8),Qt=t=>t.map(e=>e?g:rt),Ot=(t,e)=>t.map(n=>{let r=new B(ot[n.id-1],n.position,n.faction);return e[n.position]={...e[n.position],unit:r},r}),R=t=>{let e=Qt(t.tiles),n=Ot(t.units,e),r=kt(n),o=()=>{let l=n[0].faction;for(let p=1;p<n.length;p++)if(l!==n[p].faction)return null;return l},i=()=>(s.currentUnit.restoreMovePoints(),s.currentUnit=r.next(),["turnEnd",{activeUnitPosition:s.currentUnit.position}]),a=(l,p)=>{e[l]=g,s.currentUnit.position=p,e[p]={...e[p],unit:s.currentUnit};let u=[["move",{from:l,to:p}]];return s.currentUnit.movePoints===1?u.push(i()):s.currentUnit.movePoints--,u},m=l=>{let p=s.currentUnit.position;l.health-=s.currentUnit.type.attack;let u=l.health<=0;if(u){V(n,l),e[l.position]=g,r.remove(l);let Y=o();if(Y!==null)return[["attack",{from:p,to:l.position,isDead:u}],["win",{winFaction:Y}]]}return[["attack",{from:p,to:l.position,isDead:u}],i()]},s={width:t.width,height:t.height,tiles:e,move:l=>{let p=s.currentUnit.position,u=e[l].unit;if(u){if(u.faction!==s.currentUnit.faction)return m(u)}else return a(p,l);return[]},endTurn:()=>[i()],currentUnit:r.getBuffer()[0],getUnitsQueue:()=>r.getBuffer()};return s};var Yt=["d","r"],$t=["Red","Blue"],P="faction-",E=t=>Yt[t.type.id-1],it=t=>$t[t],I=t=>["unit",`${P}${t.faction}`];var zt=t=>({attack:async({to:e,isDead:n})=>{await t.triggerShakeAnimation(e),n&&t.updateTile(e)},move:({from:e,to:n})=>{t.updateTile(e),t.updateTile(n)},turnEnd:({activeUnitPosition:e})=>{d("active"),t.updateTile(e)},win:({winFaction:e})=>{let n=it(e);alert(`${n} wins!`)}}),at=t=>{let e=zt(t);return(n,r)=>{let o=e[n];return o(r)}};var st=t=>c("div",E(t),{className:I(t).join(" ")}),lt=(t,e)=>{let n=t.map(st),r=c("div",{className:"units-queue"},n);return h(r,o=>{let i=o!==null?t[n.indexOf(o)]:null;e(i)}),{element:r,clearHighlight:()=>{d("highlighted",r)},highlight:o=>{for(let i=0;i<t.length;i++)t[i]===o?n[i].classList.add("highlighted"):n[i].classList.remove("highlighted")},update:o=>{o!==t&&(t=o,n=o.map(st),r.replaceChildren(...n))}}};var pt="tile-",jt=pt.length,ct=48,x=t=>pt+t,ut=t=>{let e=x(t);return X(`#${e} span`)},_=t=>+t.substring(jt),mt=t=>`${t}px`,dt=(t,e)=>({width:mt(t*ct+t-1),height:mt(e*ct+e-1)}),Vt=t=>{let e=["unit","active"],n=Array.from(t.classList).find(r=>r.startsWith(P));return n&&e.push(n),e},Wt=t=>{t.classList.remove(...Vt(t))},F=(t,e,n)=>{if(!e.unit)Wt(t),t.innerText=e.passable?"":"#";else{t.replaceChildren(c("span",{innerText:E(e.unit)}));let r=Xt(e.unit,e.unit===n);t.className+=" "+r}},Xt=(t,e)=>{let n=I(t);return e&&n.push("active"),n.join(" ")};var Zt=(t,e,n)=>{let r=e.tiles.length-e.width;for(let o=0;o<e.tiles.length;o++){let i=e.tiles[o],a=c("div",{id:x(o)});(o+1)%e.width!==0&&a.classList.add("right-border"),o<r&&a.classList.add("bottom-border"),F(a,i,n),t.append(a)}},k=(t,e,n,r)=>{let o=s=>{if(!s){r(null);return}let l=_(s.id),p=t.tiles[l];r(p)},i=()=>{d("highlighted",m)},a={updateTile:s=>{let l=f(x(s)),p=t.tiles[s];F(l,p,e())},triggerShakeAnimation:s=>{let l=ut(s);return Z(l,"shake-animate")},highlight:s=>{i(),f(x(s)).classList.add("highlighted")},clearHighlighted:i},m=c("div",{className:"field",style:dt(t.width,t.height),onclick:({target:s})=>{let l=_(s.id);n(l)}});return h(m,o),Zt(m,t,e()),{element:m,handle:a}};var Gt=(t,e)=>{let n=e.getValue(t),r=e.getMaxValue(t);return e.name+": "+n+"/"+r},ft=(t,e)=>e.map(n=>Gt(t,n)).join("; ");var Q=t=>{let e=c("span");return{element:e,update:n=>{e.innerText=n?ft(n,t):""}}};var Kt=[{name:"Health",getValue:t=>t.health,getMaxValue:t=>t.type.health},{name:"Move Points",getValue:t=>t.movePoints,getMaxValue:t=>t.type.speed}],xt=()=>Q(Kt);var qt=(t,e)=>{let{tiles:n,width:r}=t,o=H(r),i=at(e);return{onTileClick:W(async a=>{if(!o.includes(a-t.currentUnit.position)||!n[a].passable)return;let m=t.move(a);for(let[s,l]of m)await i(s,l)}),onTurnEnd:()=>{let a=t.endTurn();for(let[m,s]of a)i(m,s)}}},O=t=>{let e=xt(),n=lt(t.getUnitsQueue(),a=>{e.update(a),a!==null?o.handle.highlight(a.position):o.handle.clearHighlighted()}),r=a=>{if(!a){n.clearHighlight();return}let{unit:m}=a;e.update(m),m?n.highlight(m):n.clearHighlight()},o=k(t,()=>t.currentUnit,a=>{i.onTileClick(a),n.update(t.getUnitsQueue()),r(t.tiles[a])},r),i=qt(t,o.handle);return c("div",[o.element,c("div",{className:"bottom-panel"},[n.element,c("button","End Turn",{onclick:()=>{i.onTurnEnd(),n.update(t.getUnitsQueue())}})]),e.element])};var Tt=t=>{let e=w(t),n=R(e);return O(n)};var ht=t=>c("ul",t.map(([e,n])=>c("li",[c("a",e,{href:`#${n}`})])));var Jt=[["1d1r-1","20A99e0"],["1d1r-2","g0e0zi8"],["1d2r-1","8w3VY!vfw218BfM"],["1d2r-2","8w3VY!vfw2xhcHM"],["1d3r-1","ow0~DY~DQ~w19it9YD8"],["1d3r-2","qw0~DY~DY~DY04IjYjQCo0"],["1d3r-3","P07DDDw8UnNiBG0"],["1d4r-1","pw0~DY~DY~DY~w0xh1AyA78u0"],["1d4r-2","Ew0!vDV!v01sBalpko90"],["2d5r-1","pw0~DA~DY~BY~w0FhqyT5uaazd6U0"],["2d5r-2","pw0vDY~DY~DY~00xhaAz45iejsxU0"]],gt=()=>ht(Jt);var Bt=t=>c("div",[c("h1","Error"),c("span",t)]);var te=t=>{try{return t?Tt(t):gt()}catch{return Bt(`Failed to deserialize battle scene from string: '${t}'`)}},ee=t=>()=>{let e=location.hash.slice(1);t.replaceChildren(te(e))},Et=t=>{let e=ee(t);e(),window.addEventListener("hashchange",e)};Et(f("root"));})();
