(()=>{var C=(t,e)=>{let n=t.trim().split(`
`),r=0;for(let o=0;o<n.length;o++){let c=n[o].trim();r===0&&(r=(c.length+1)/2);for(let s=0;s<c.length;s+=2)e(c[s],o*r+s/2)}return[r,n.length]};var _={id:1,health:40,attack:12,initiative:3},L={id:2,health:6,attack:5,initiative:4};var $={passable:!1,unit:null},x={passable:!0,unit:null},W=(t,e,n)=>({unitType:t,faction:n,position:e,health:t.health}),N=(t,e,n)=>({passable:!0,unit:W(t,e,n)}),q={"#":()=>$,".":()=>x,r:(t,e)=>N(L,t,e),d:(t,e)=>N(_,t,e)},H=(t,e)=>{let n=t.toLowerCase(),r=q[n];if(!r)throw new Error(`Unknown tile: ${t}`);let o=+(n===t);return r(e,o)},h=t=>[-t,-t+1,1,t+1,t,t-1,-1,-t-1];var k=t=>typeof t=="string";var w=(t,e)=>{O(t,t.findIndex(e))},O=(t,e)=>{e>=0&&t.splice(e,1)},D=(t,e)=>{O(t,t.indexOf(e))};var b=(t,e)=>{let n=t[0];for(let r=1;r<t.length;r++){let o=t[r];e(o,n)&&(n=o)}return n};var Y=(t,e)=>{let n=1/e(t);return{weight:n,delta:n,actor:t}},z=(t,e)=>t.weight<e.weight,X=t=>b(t,z),G=(t,e)=>t.map(r=>Y(r,e)).sort((r,o)=>r.weight-o.weight),F=(t,e)=>{let n=G(t,e);return{next:()=>{let r=X(n);return r.weight+=r.delta,r.actor},remove:r=>{w(n,o=>o.actor===r)}}};var U=t=>{let e=[],n=[],[r,o]=C(t,(i,a)=>{let m=H(i,a);m.unit&&n.push(m.unit),e.push(m)}),c=F(n,i=>i.unitType.initiative),s={width:r,height:o,tiles:e,getWinFaction:()=>{let i=n[0].faction;for(let a=1;a<n.length;a++)if(i!==n[a].faction)return null;return i},move:i=>{e[s.currentUnit.position]=x,s.currentUnit.position=i,e[i]={passable:!0,unit:s.currentUnit},s.currentUnit=c.next()},attack:i=>{i.health-=s.currentUnit.unitType.attack;let a=i.health<=0;return a&&(D(n,i),e[i.position]=x,c.remove(i)),s.currentUnit=c.next(),a},currentUnit:c.next()};return s};var T=(t,...e)=>{let n=document.createElement(t);for(let r of e)k(r)?n.innerText=r:Array.isArray(r)?n.append(...r):g(n,r);return n},g=(t,e)=>{for(let n in e)n==="style"?Object.assign(t.style,e.style):t[n]=e[n]},y=t=>{let e=null;return{onmousemove:({target:n})=>{n!==e&&(e=n,t(e))},onmouseleave:()=>{e=null,t(e)}}};var P=32,K=["d","r"],R="tile-",Z=R.length,A=t=>R+t,S=t=>+t.substring(Z),Q=t=>t.passable?t.unit?v(t.unit):".":"#",v=t=>K[t.unitType.id-1],M=t=>`${t}px`,j=(t,e)=>({width:M(t*P),height:M(e*P)}),d=t=>`faction-${t}`,f=(t,e)=>{let n=document.getElementById(A(t));g(n,e)};var J=(t,e)=>{let{tiles:n}=t;return r=>{if(!e.includes(r-t.currentUnit.position)||!n[r].passable)return;let{unit:o}=n[r];if(o){if(o.faction!==t.currentUnit.faction&&(f(t.currentUnit.position,{className:d(t.currentUnit.faction)}),t.attack(o))){f(o.position,{innerText:".",className:""});let s=t.getWinFaction();s!==null&&alert(`Faction ${s} win!`)}}else f(t.currentUnit.position,{innerText:".",className:""}),f(r,{innerText:v(t.currentUnit),className:d(t.currentUnit.faction)}),t.move(r);f(t.currentUnit.position,{className:`selected ${d(t.currentUnit.faction)}`})}},I=t=>{let e=U(t),{width:n,height:r,tiles:o}=e,c=h(n),s=J(e,c),i=T("span"),a=l=>{if(!l){i.innerText="";return}let p=S(l.id),u=o[p];i.innerText=u.unit?`Health: ${u.unit.health}`:""},m=T("div",{className:"field",style:j(n,r),onclick:({target:l})=>{let p=S(l.id);s(p)},...y(a)});for(let l=0;l<o.length;l++){let p=o[l],u=T("div",Q(p),{id:A(l)}),{unit:E}=p;E&&(E===e.currentUnit&&u.classList.add("selected"),u.classList.add(d(E.faction))),m.append(u)}return T("div",[m,i])};var B=`
  # # # # # # #
  # . . . . . #
  # . R . R . #
  # . . . . . #
  # . . d . . #
  # . . . . . #
  # # # # # # #
`;document.body.appendChild(I(B));})();
