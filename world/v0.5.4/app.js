!function(){"use strict";const t=()=>{},e=t=>t,i=()=>!0,n=()=>!1,s=t=>"string"==typeof t,o=t=>"function"==typeof t,r=t=>null===t||(t=>void 0===t)(t),l=(t,e)=>{const i=[];for(let n=0;n<t;n++){const t=e(n);i.push(t)}return i},a=t=>t[t.length-1],c=(t,e=i)=>t.reduce(((t,i)=>e(i)?t+1:t),0),h=(t,e)=>{t.splice(e,1)},d=t=>Array.isArray(t)?t:[t],u=t=>r(t)?null:s(t)?{type:0,text:t}:t,p=t=>{const e=[];for(const i of t)if(Array.isArray(i))e.push(...p(i));else{const t=u(i);e.push(t)}return e},g=(t,e)=>(t=>{var e;return o(null===(e=t.prototype)||void 0===e?void 0:e.render)})(t)?((t,e)=>({type:3,Component:t,props:e,children:null}))(t,e):{type:2,component:t,props:e,children:p([t(e)])},f=(...t)=>{const[e]=t;if(s(e)){return((t,e)=>{const i=[],n={};for(const t of e)if(Array.isArray(t)){const e=p(t);i.push(...e)}else"object"==typeof t?Object.assign(n,t):i.push({type:0,text:t});return{tagName:t,type:1,children:i,attributes:n}})(e,t.slice(1))}return g(e,t[1])},m=(t,e)=>{Object.keys(t).forEach((i=>{e(t[i],i)}))},y=(t,e)=>({vNode:t,parentElement:e.parentElement,prevSibling:e.currentSibling,nextSibling:null,element:document.createTextNode(t.text)}),w=t=>{const e={vNode:null,parentElement:t.parentElement,prevSibling:t.currentSibling,nextSibling:null};return t.currentSibling&&(t.currentSibling.nextSibling=e),t.currentSibling=e,e},v=(t,e)=>{const i=document.createElement(t.tagName),n={vNode:t,parentElement:e.parentElement,prevSibling:e.currentSibling,nextSibling:null,element:i,children:[]},s=e.parentElement;e.parentElement=i;const r=e.currentSibling;return e.currentSibling=null,S(n,e),e.parentElement=s,r&&(r.nextSibling=n),e.currentSibling=n,m(t.attributes,((t,e)=>{"ref"===e?o(t)?t(i):t.value=i:i[e]=t})),n},x=(t,e)=>T(t,e,E),S=(t,e)=>T(t,e,M),T=(t,e,i)=>{t.children=t.vNode.children.map((t=>i(t,e)))},C=t=>{const e=new t.Component(t.props);return t.children=p(d(e.render())),{vNode:t,component:e,children:null}},P=(t,e)=>{const i=C(t);return S(i,e),i.component.$mount(i),i},b=(t,e)=>{const i={vNode:t,children:null};return S(i,e),i},E=(t,e)=>null===t?w(e):I[t.type](t,e),I=[y,v,(t,e)=>{const i={vNode:t,children:null};return x(i,e),i},(t,e)=>{const i=C(t);return x(i,e),i.component.$mount(i),i}],M=(t,e)=>null===t?w(e):A[t.type](t,e),A=[(t,e)=>{const i=y(t,e);return e.parentElement.appendChild(i.element),i},(t,e)=>{const i=v(t,e);return e.parentElement.appendChild(i.element),i},b,P],N=t=>Boolean(t.element),U=(t,e)=>{const i=[t];for(;i.length>0;){const t=i.shift();F(t)||(N(t)?e(t):i.push(...t.children))}return[]},B=t=>{const e=document.createDocumentFragment();return U(t,(({element:t})=>{e.appendChild(t)})),e},O=({element:t})=>{t.remove()},j=t=>{U(t,O)},D=t=>null===t.vNode||N(t),R=t=>{for(;!D(t);)t=t.children[0];return t},k=t=>{for(;!D(t);)t=t.children.at(-1);return t},z=t=>{do{if(null===(t=t.nextSibling))return null}while(!N(t));return t.element},L=[(t,e)=>(t.element.textContent!==e.text&&(t.element.textContent=e.text,t.vNode=e),t),(t,e)=>t.vNode.tagName!==e.tagName?_(t,e):(((t,e)=>{Object.assign(t.element,e.attributes)})(t,e),G(t,e.children),t),(t,e)=>t.vNode.component!==e.component?_(t,e):(G(t,e.children),t),(t,e)=>{t.vNode.Component,e.Component,t.component.props=e.props;const i=p(d(t.component.render()));return G(t,i),t}],H=(t,e)=>t.vNode===e?t:t.vNode.type!==e.type?_(t,e):((t,e)=>L[e.type](t,e))(t,e),_=(t,e)=>{const i=R(t),n=k(t),s=z(n);j(t);const o={parentElement:i.parentElement,currentSibling:i.prevSibling},r=E(e,o),l=B(r);return i.parentElement.insertBefore(l,s),o.currentSibling.nextSibling=n.nextSibling,r},F=t=>null===t.vNode,W=(t,e)=>{const i={parentElement:t.parentElement,currentSibling:t.prevSibling},n=E(e,i),s=z(t),o=B(n);return t.parentElement.insertBefore(o,s),t.nextSibling&&(i.currentSibling.nextSibling=t.nextSibling,t.nextSibling.prevSibling=i.currentSibling),n},$=t=>{j(t);const e=R(t),i=k(t),n={parentElement:e.parentElement,currentSibling:e.prevSibling},s=w(n);return n.currentSibling.nextSibling=i.nextSibling,s},G=(t,e)=>{for(let i=0;i<t.children.length;i++){const n=t.children[i],s=e[i];if(F(n)){if(null!==s){const e=W(n,s);t.children[i]=e,t.vNode.children[i]=e.vNode}}else if(null!==s){const e=H(n,s);t.children[i]=e,t.vNode.children[i]=e.vNode}else{const e=$(n);t.children[i]=e,t.vNode.children[i]=null}}};class X{constructor(t){this.props=t,this.node=null,this.state=this.getInitialState()}setState(t){let e=!1;if(m(t,((t,i)=>{Object.is(this.state[i],t)||(e=!0,this.state[i]=t)})),e&&this.isMounted){const t=this.render();((t,e)=>{const i=p(d(e));G(t,i)})(this.node,t)}}getInitialState(){return{}}$mount(t){this.node=t,this.onMounted()}get isMounted(){return null!==this.node}onMounted(){}}const V=new Image;var Y=[{id:1,name:"worker",movePoints:6},{id:2,name:"warrior",movePoints:6},{id:3,name:"settler",movePoints:6}];const Q=[{id:1,name:"grassland",dryLand:!0},{id:2,name:"steppe",dryLand:!0},{id:3,name:"sea",dryLand:!1}],[q,K,J]=Q,Z=Y,tt=[{productId:1,cost:2},{productId:2,cost:5},{productId:3,cost:8}],et=Q[0],it=(t=et)=>({city:null,unit:null,terrain:t}),nt=(t,e,i)=>e*i+t,st=(t,e)=>{let i=t%e;return i<0&&(i+=e),~~i},ot=(t,e,i,n)=>[st(t,i),st(e,n)],rt=(t,e)=>[t%e,Math.floor(t/e)],lt=(t,e,i)=>{const n=e-t,s=i/2;return Math.abs(n)<=s?n:n>0?n-i:i+n},at=(t,e,i,n)=>e.map((e=>((t,e,i,n)=>{const[s,o]=t,[r,l]=e;return[lt(s,r,i),lt(o,l,n)]})(t,e,i,n))),ct=(t,e,i,n)=>{const s=Math.abs(t-i),o=Math.abs(e-n);return ht(s,o)};ct.DIAGONAL_MOVE_COST=3,ct.AXIAL_MOVE_COST=2;const ht=(t,e)=>ct.DIAGONAL_MOVE_COST*Math.min(t,e)+ct.AXIAL_MOVE_COST*Math.abs(t-e),dt=(t,e)=>{if(t===e)return!0;if(!t||!e)return!1;const[i,n]=t,[s,o]=e;return i===s&&n===o},ut=(t,e)=>t.some((t=>dt(t,e))),pt=(t=>{const e=Math.floor(t/ct.AXIAL_MOVE_COST),i=[],n=t-2;for(let t=-e;t<=e;t++)for(let s=-e;s<=e;s++){if(0===s&&0===t)continue;const e=[s,t];for(let o=ct(0,0,s,t)-2;o<=n;o++){const t=i[o];t?t.push(e):i[o]=[e]}}return i})(7)[5],gt=([t,e],i)=>[t,2*i-e],ft=([t,e],i)=>[2*i-t,e],mt=([t,e,i,n])=>[i,e,t,n],yt=([t,e,i,n])=>[t,n,i,e],wt=(t,e)=>({position:gt(t.position,e),borders:mt(t.borders)}),vt=(t,e)=>({position:ft(t.position,e),borders:yt(t.borders)});class xt{constructor(t,e){this.width=t,this.height=e}getPosition(t,e){return ot(t,e,this.width,this.height)}getPositionByIndex(t){return rt(t,this.width)}getIndexesByPositions(t){return t.map((([t,e])=>this.getIndexByPosition(t,e)))}getIndexByPosition(t,e){return nt(t,e,this.width)}getOffsets(t,e){const[i,n]=t,[s,o]=e;return[lt(i,s,this.width),lt(n,o,this.height)]}getCirclePositions(t,e,i){const n=Math.floor(i/ct.AXIAL_MOVE_COST),s=[];for(let o=-n;o<=n;o++)for(let r=-n;r<=n;r++){const n=this.getPosition(t+r,e+o),[l,a]=n;this.getOctileDistance(l,a,t,e)<=i&&s.push(n)}const o=[t,e];return s.sort(((t,e)=>this.comparePositions(o,t,e)))}getNextLinePosition(t,e){const[i,n]=this.getOffsets(t,e),s=Math.sign(i),o=Math.sign(n),r=Math.abs(i),l=Math.abs(n);let a=r-l,[c,h]=t;const d=2*a;return d>-l&&(a-=l,c+=s),d<r&&(a+=r,h+=o),[c,h]}comparePositions(t,e,i){const[n,s]=this.getOffsets(t,e),[o,r]=this.getOffsets(t,i),l=ht(Math.abs(n),Math.abs(s)),a=ht(Math.abs(o),Math.abs(r));return l!==a?l-a:s!==r?s-r:n-o}sortPositions(t,e){return i=(e,i)=>this.comparePositions(t,e,i),e.slice().sort(i);var i}isAdjacentPositionsIndexes(t,e){const i=this.getPositionByIndex(t),n=this.getPositionByIndex(e);return this.isAdjacentPositions(i,n)}isAdjacentPositions(t,e){const[i,n]=this.getOffsets(t,e),s=Math.abs(i),o=Math.abs(n);return 1===s&&1===o||0===s&&1===o||1===s&&0===o}getOctileDistance(t,e,i,n){const[s,o]=this.getOffsets([t,e],[i,n]);return ht(Math.abs(s),Math.abs(o))}}class St extends xt{constructor(t,e){super(e,t.length/e),this.tiles=t}get(t,e){const[i,n]=this.getPosition(t,e),s=this.getIndexByPosition(i,n);return this.tiles[s]}getTileFood(t,e){return(t=>t.terrain===q?2:1)(this.get(t,e))}influencedByCity(t,e,i){return this.get(t,e).influencedBy===i}addInfluence(t,e,i){this.get(t,e).influencedBy=i}}St.createTileFromTileData=t=>((t=et)=>({...it(t),influencedBy:null}))(t.terrain),St.createFromTilesData=(t,e)=>new St(t.map(St.createTileFromTileData),e);const Tt=t=>10*t+(t-1)**2,Ct={NORTH:[0,-1],NORTH_EAST:[1,-1],EAST:[1,0],SOUTH_EAST:[1,1],SOUTH:[0,1],SOUTH_WEST:[-1,1],WEST:[-1,0],NORTH_WEST:[-1,-1]};class Pt{static $(t){const[e,i]=Ct[t];return new Pt(t,e,i)}constructor(t,e,i){this.name=t,this.dx=e,this.dy=i,this.isAxial=0===e||0===i,this.offset=[e,i];(this.isAxial?Pt.axial:Pt.diagonal).push(this),Pt.members.push(this)}equals(t,e){return this.dx===t&&this.dy===e}}Pt.members=[],Pt.axial=[],Pt.diagonal=[],Pt.NORTH=Pt.$("NORTH"),Pt.NORTH_EAST=Pt.$("NORTH_EAST"),Pt.EAST=Pt.$("EAST"),Pt.SOUTH_EAST=Pt.$("SOUTH_EAST"),Pt.SOUTH=Pt.$("SOUTH"),Pt.SOUTH_WEST=Pt.$("SOUTH_WEST"),Pt.WEST=Pt.$("WEST"),Pt.NORTH_WEST=Pt.$("NORTH_WEST"),Pt.fromOffsets=(t,e)=>Pt.members.find((i=>i.equals(t,e)))||null;var bt=["populationIncreased","bordersExpanded","unitCompleted","unitMoved","moveCanceled"].reduce(((t,e)=>({...t,[e]:t=>({type:e,payload:t})})),{});const Et=(t,e)=>({index:0,buffer:[],*[Symbol.iterator](){for(;this.index<t.length;)0===this.buffer.length&&(this.buffer=e(t[this.index]),++this.index),yield this.buffer.shift();for(;this.buffer.length>0;)yield this.buffer.shift();throw new Error("Unexpected end of input")}}),It=t=>{let e=0;for(let i=0;i<t.length;i++)t[i]&&(e+=2**i);return e},Mt=(t,e,i)=>{const n=[];for(;t>0&&n.length<e;){const e=i(t%2==1);t=Math.floor(t/2),n.push(e)}const s=i(!1);for(;n.length<e;)n.push(s);return n},At=(t,i)=>Mt(t,i,e),Nt=t=>At(t,8),Ut=(t,i)=>((t,e,i)=>{const n=[];for(const s of t){const t=Mt(s,e,i);n.push(...t)}return n})(t,i,e);const Bt=(t,e)=>t<<15|e,Ot=(t,e)=>{let i=0,n=0;if(0===e)return i;for(const s of t)if(s&&(i+=2**n),++n,n===e)return i;return i},jt=(t,e)=>{t&&++e.truesCount},Dt=(t,e,i,n)=>{const s=[];for(const o of t)if(n(o,i),s.push(o),s.length===e)return{booleans:s,stats:i};return{booleans:s,stats:i}},Rt=(t,e)=>{const i=[];for(const n of t)if(i.push(n),i.length===e)return i;return i},kt=t=>Math.ceil(Math.log2(t+1)),zt=(t,e)=>((t,e,i)=>{const n=[];for(let s=0;s<e;s++){const e=Rt(t,i),s=It(e);n.push(s)}return n})(t,e,8);class Lt{static getStartInfluencePositions(t,e,i=3){const[n,s]=t;return e.getCirclePositions(n,s,i).filter((([t,i])=>!e.get(t,i).influencedBy))}constructor(t,e){this.city=t,this.tileToExpand=null,this.positions=this.grid.sortPositions(t.position,e.influencedPositions),this.expandingProgress=e.expandingProgress,this.place()}getFreeTilesCount(){const[t,e]=this.city.position;return c(pt,(([i,n])=>{const{influencedBy:s}=this.grid.get(t+i,e+n);return null===s}))}getTileExpansionCost(t){const[e,i]=t;let n=0;for(const{dx:t,dy:s}of Pt.members){const o=e+t,r=i+s,{influencedBy:l}=this.grid.get(o,r);l&&(n+=6/this.grid.getOctileDistance(o,r,e,i))}const[s,o]=this.city.position,r=this.grid.getOctileDistance(s,o,e,i)-3;return Math.round(160/n+r**2)}getTilesToExpand(){const t=this.getNextFrontierPositions(),e=[];for(const i of t)if(this.canExpandToPosition(i)){const t=this.getTileExpansionCost(i);e.push({position:i,turnsToExpand:t/this.getExpandingPoints(),cost:t})}return e.sort(((t,e)=>this.compareTilesToExpand(t,e)))}compareTilesToExpand(t,e){const i=t.cost-e.cost;if(0!==i)return i;const[n,s]=t.position,[o,r]=e.position,l=this.grid.getTileFood(n,s);return this.grid.getTileFood(o,r)-l}getExpandingPoints(){return((t,e)=>{const i=Math.ceil(t/2);return e>=i?e-i+1:0})(this.positions.length,this.city.population)}expand(){const{position:t}=this.tileToExpand;this.tileToExpand=null;const[e,i]=t;return this.addTile(e,i),bt.bordersExpanded({city:this.city,position:t})}turn(){if(null===this.tileToExpand)return null;this.expandingProgress+=this.getExpandingPoints();const t=this.expandingProgress-this.tileToExpand.cost;return t>=0?(this.expandingProgress=t,this.expand()):null}place(){for(const[t,e]of this.positions)this.grid.addInfluence(t,e,this.city)}remove(){this.positions.forEach((([t,e])=>{this.grid.get(t,e).influencedBy=null}))}canExpandToPosition(t){const[e,i]=t;if(null!==this.grid.get(e,i).influencedBy)return!1;const n=this.city.position,[s,o]=this.grid.getNextLinePosition(t,n);if(!this.grid.influencedByCity(s,o,this.city))return!1;if(!Pt.diagonal.some((({dx:t,dy:n})=>this.grid.influencedByCity(e+t,i+n,this.city))))return!1;if(!Pt.axial.some((({dx:t,dy:n})=>this.grid.influencedByCity(e+t,i+n,this.city))))return!1;const[r,l]=n;return this.grid.getOctileDistance(e,i,r,l)<=7}getNextFrontierPositions(){const t=[];for(const[e,i]of this.positions)for(const{dx:n,dy:s}of Pt.axial){const o=e+n,r=i+s,l=this.grid.getPosition(o,r),{influencedBy:a}=this.grid.get(o,r);null!==a||ut(t,l)||t.push(l)}return t}swap(t,e){const i=this.grid.get(t,e).influencedBy,n=this.positions.findIndex((([i,n])=>t===i&&e===n));h(this.positions,n),this.positions=this.grid.sortPositions(this.city.position,this.positions),i.influence.addTile(t,e)}canSwap(t,e){return this._canSwap(t,e,new Map)}_canSwap(t,e,i){const n=Bt(t,e);if(i.has(n))return i.get(n);const s=this.grid.get(t,e).influencedBy;if(null===s||s===this.city)return i.set(n,!1),!1;const[o,r]=this.city.position;if(this.grid.getOctileDistance(t,e,o,r)>7)return i.set(n,!1),!1;if(!s.assignments.hasFreeTiles())return i.set(n,!1),!1;const l=[!1,!1],a=[[],[]];for(const{dx:s,dy:o,isAxial:r}of Pt.members){const c=t+s,h=e+o,{influencedBy:d}=this.grid.get(c,h),u=+r;if(d!==this.city){a[u].push([c,h]);continue}const p=+!r;if(l[u]=!0,l[p])return i.set(n,!0),!0}return l.every(((t,e)=>t||a[e].some((([t,e])=>this._canSwap(t,e,i)))))}addTile(t,e){this.grid.addInfluence(t,e,this.city);const{positions:i}=this;i.push([t,e]),this.positions=this.grid.sortPositions(this.city.position,i)}expandToTile(t,e){const i=[t,e];ut(this.positions,i)||this.addTile(t,e)}get grid(){return this.city.grid}}class Ht{static getDefaultPositions(t,e,i,n=1){const s=[];for(;n-- >0;){let n,o=0;for(let r=0;r<e.length;r++){const l=e[r];if(dt(l,t)||s.some((t=>dt(t,l))))continue;const[a,c]=l,h=i.getTileFood(a,c);h>o&&(o=h,n=l)}n&&s.push(n)}return s}recalculate(t=this.influence.city.population){this.positions=Ht.getDefaultPositions(this.influence.city.position,this.influence.positions,this.grid,t)}constructor(t,e,i){this.grid=t,this.influence=e,this.positions=i}isPositionOccupied(t){return dt(t,this.city.position)||ut(this.positions,t)}isPositionFree(t){return!this.isPositionOccupied(t)}hasFreeTiles(){return this.influence.positions.some((t=>this.isPositionFree(t)))}getFreeTilesCount(){return c(this.influence.positions,(t=>this.isPositionFree(t)))}getFoodPerTurn(){const[t,e]=this.influence.city.position,i=this.grid.getTileFood(t,e);return this.positions.reduce(((t,e)=>{if(!this.influence.positions.some((t=>dt(t,e))))return t;const[i,n]=e;return t+this.grid.getTileFood(i,n)}),i)}get city(){return this.influence.city}}const _t={population:1,expansionLevel:0};class Ft{static found(t,e,i=0,n="",s={}){const o={..._t,...s},r=Lt.getStartInfluencePositions(e,t,o.expansionLevel+3),l=Ht.getDefaultPositions(e,r,t,o.population);return new Ft(t,{position:e,project:null,influencedPositions:r,assignmentsPositions:l,growthProgress:0,expandingProgress:0,name:n,id:i})}constructor(t,e){this.grid=t,this.position=e.position,this.name=e.name,this.id=e.id,this.growthProgress=e.growthProgress,this.project=e.project;const[i,n]=e.position;t.get(i,n).city=this,this.influence=new Lt(this,e),this.assignments=new Ht(t,this.influence,e.assignmentsPositions),this.assignments.getFreeTilesCount()>0?this.foodBasketSize=Tt(this.population):this.foodBasketSize=0}turn(e=t){const i=this.updateGrowthProgress(),n=this.updateProjectProgress(e);return null!==n&&i.push(n),i}updateGrowthProgress(){const t=[],e=this.assignments.getFreeTilesCount();if(0===e)return t;const i=Tt(this.population);this.growthProgress+=this.foodSurplus;let n=this.population;const s=this.influence.turn();null!==s&&t.push(s);const o=this.growthProgress-i;if(o>=0){e>1?(this.growthProgress=o,this.foodBasketSize=Tt(this.population+1)):(this.growthProgress=0,this.foodBasketSize=0),++n;const i=bt.populationIncreased({city:this});t.push(i)}else this.growthProgress;return t.length>0&&this.assignments.recalculate(n),t}updateProjectProgress(t){const{project:e}=this;if(null===e)return null;const[i,n]=this.position,s=this.grid.getIndexByPosition(i,n),o=this.project.progress+1;if(!(o===this.project.type.cost))return this.project.progress=o,null;if(!!this.grid.tiles[s].unit)return null;const r=bt.unitCompleted({unitTypeId:this.project.type.productId,cityPositionIndex:s});return this.project=null,t(r.payload),r}setProject(t){null!==t?null!==this.project&&t.productId===this.project.type.productId||(this.project={type:t,progress:0}):this.project=null}get foodSurplus(){return this.assignments.getFoodPerTurn()-2*this.population}get population(){return this.assignments.positions.length}get influencedPositions(){return this.influence.positions}get assignmentsPositions(){return this.assignments.positions}get expandingProgress(){return this.influence.expandingProgress}remove(){this.influence.remove()}}class Wt{constructor(t){this.influence=t,this.tilesToExpand=t.getTilesToExpand(),this.tilesToExpandLeft=t.getFreeTilesCount()}get tileToExpand(){return this.influence.tileToExpand}set tileToExpand(t){this.influence.tileToExpand=t}}const $t=(t,e)=>e.tileToExpand.turnsToExpand!==t.tileToExpand.turnsToExpand?e.tileToExpand.turnsToExpand<t.tileToExpand.turnsToExpand:e.tilesToExpandLeft<t.tilesToExpandLeft;class Gt{constructor(e,i=[],n=0){this.grid=e,this.unitCreationHandler=t,this.cities=Gt.createCities(e,i),this._nextCityId=n,this.updateTilesToExpand()}onUnitCreated(t){this.unitCreationHandler=t}updateTilesToExpand(){(t=>{const e=new Map;for(;t.length>0;){const i=t.shift();if(0===i.tilesToExpand.length)continue;const n=i.tilesToExpand.shift(),[s,o]=n.position,r=Bt(s,o),l=e.get(r);i.tileToExpand=n,l?$t(l,i)?(l.tileToExpand=null,t.push(l),e.set(r,i)):(i.tileToExpand=null,t.push(i)):e.set(r,i)}})(this.cities.map((t=>(t.influence.tileToExpand=null,new Wt(t.influence)))))}turn(){const t=[];return this.cities.forEach((e=>{const i=e.turn(this.unitCreationHandler);t.push(...i)})),this.updateTilesToExpand(),t}addCity(t){this.cities.push(t),this.updateTilesToExpand(),++this._nextCityId}nextCityName(){return(t=>{const e=[];do{const i=t%26;t=Math.floor(t/26),e.push(String.fromCharCode(i+65))}while(t>0);return e.join("")})(this.nextCityId)}foundCity(t,e,i){if(!this.canPlaceCity(t,e))return null;const n=Ft.found(this.grid,[t,e],this.nextCityId,this.nextCityName(),i);return this.addCity(n),n}canPlaceCity(t,e){return!!this.grid.get(t,e).terrain.dryLand&&this.cities.every((({position:[i,n]})=>this.grid.getOctileDistance(i,n,t,e)>=8))}captureRelativePosition(t,[e,i]){const[n,s]=t.position,[o,r]=this.grid.getPosition(n+e,s+i);this.captureTile(n,s,o,r)}captureTile(t,e,i,n){const{city:s}=this.grid.get(t,e);s.influence.expandToTile(i,n),this.updateTilesToExpand()}setProject(t,e){const{city:i}=this.grid.tiles[t];i.setProject(e)}get nextCityId(){return this._nextCityId}}Gt.createCities=(t,e)=>e.map((e=>new Ft(t,e))).sort(((t,e)=>t.id-e.id));class Xt{constructor(t,e){this.grid=t,this.path=[];const{targetPosition:i,...n}=e;Object.assign(this,n);const[s,o]=e.position;t.get(s,o).unit=this}beforeTurn(){this.movePoints+=this.type.movePoints}cancelMove(){const t=this.grid.getPositionByIndex(a(this.path));return this.path=[],bt.moveCanceled({from:this.position,to:t})}getMoveCost(t,e){const[i,n]=this.grid.getOffsets(t,e);return Pt.fromOffsets(i,n).isAxial?2:3}isTilePassable(t){return this.grid.tiles[t].terrain.dryLand}getNextPathSegment(t){let e=this.position,i=0;const n=[],s=[];for(const o of t){if(!this.isTilePassable(o))break;const t=this.grid.getPositionByIndex(o),r=i+this.getMoveCost(e,t);if(r>this.movePoints)break;this.grid.tiles[o].unit?s.push(t):(s.length>0&&(n.push(...s),s.length=0),n.push(t)),i=r,e=t}return n.push(...s),{positions:n,cost:i}}moveByPath(t){const e=this.getNextPathSegment(t),{positions:i,cost:n}=e;if(0===i.length)return this.path=t.slice(),null;const s=a(i),[o,r]=s;if(this.grid.get(o,r).unit)return null;this.path=t.slice(i.length);const[l,c]=this.position;return this.grid.get(l,c).unit=null,this.grid.get(o,r).unit=this,this.movePoints-=n,i.unshift(this.position),this.position=s,bt.unitMoved({path:i})}get targetPosition(){return this.path.length>0?a(this.path):null}}Xt.DEFAULT_UNIT_TYPE=Z[0],Xt.getDefaultData=(t,e)=>({position:[t,e],type:Xt.DEFAULT_UNIT_TYPE,movePoints:Xt.DEFAULT_UNIT_TYPE.movePoints,targetPosition:null});const Vt=(t,e,i)=>Math.floor(t+(e-t+1)*i),Yt=(t,e)=>((t,e,i)=>t<e?e:t>i?i:t)(t,0,e),Qt=2*Math.PI,qt=t=>{let e=t[0],i=0;for(let n=1;n<t.length;n++){const s=t[n];s.f<e.f&&(e=s,i=n)}return h(t,i),e},Kt=t=>{const e=[];for(;t.previous;)e.unshift({position:t.position,positionIndex:t.positionIndex}),t=t.previous;return e};class Jt{constructor(t,e=[]){this.grid=t,this.movements=new Map,this.units=[],this.createUnits(e)}createUnits(t){t.forEach((t=>{const e=this.addUnit(t);if(null!==t.targetPosition){const i=this.grid.getPositionByIndex(t.targetPosition);this.movements.set(e.targetPosition,e),e.path=this.findPath(e,i)}}))}findPath(t,e){return((t,e,n,s=i)=>{const[o,r]=e,[l,a]=n,c=t.getIndexByPosition(o,r),h=[{position:e,positionIndex:c,g:0,f:t.getOctileDistance(o,r,l,a),previous:null}],d=new Set([c]);for(;h.length>0;){const e=qt(h),[i,n]=e.position;if(i===l&&n===a)return Kt(e);d.add(e.positionIndex);for(const{dx:o,dy:r,isAxial:c}of Pt.members){const u=t.getPosition(i+o,n+r),[p,g]=u,f=t.getIndexByPosition(p,g);if(d.has(f))continue;if(!s(f))continue;const m=e.g+(c?2:3),y=t.getOctileDistance(p,g,l,a),w=m+y,v=h.find((t=>t.positionIndex===f));v?m<v.g&&(v.g=m,v.f=w,v.previous=e):h.push({previous:e,position:u,positionIndex:f,g:m,f:m+y})}}return[]})(this.grid,t.position,e,(e=>t.isTilePassable(e))).map((t=>t.positionIndex))}turn(){const t=[],e=[];for(const i of this.units){if(i.beforeTurn(),null!==i.targetPosition){const[n,s]=i.position,o=this.grid.getIndexByPosition(n,s),r=this.move([o,...i.path]);null===r?e.push(i.cancelMove()):t.push(r)}i.movePoints=Yt(i.movePoints,i.type.movePoints)}return{moves:t,canceledMoves:e}}addUnit(t){const e=new Xt(this.grid,t);return this.units.push(e),e}placeUnit(t,e,i={}){const n=this.grid.get(t,e);if(null!==n.unit||!n.terrain.dryLand)return null;const s=Object.assign(Xt.getDefaultData(t,e),i);return this.addUnit(s)}moveUnit(t,e,i){const n=[e,i];if(dt(t.position,n))return this.cancelMove(t),null;const s=this.findPath(t,n);if(0===s.length)return null;const[o,r]=t.position,l=this.grid.getIndexByPosition(o,r);return s.unshift(l),this.move(s)}move(t){const[e,...i]=t,n=i[0],{unit:s}=this.grid.tiles[e];if(this.movements.has(s.targetPosition)&&this.movements.delete(s.targetPosition),2===t.length){const t=this.movements.get(n);1===(null==t?void 0:t.path.length)&&this.cancelMove(t)}const o=a(i);return null!==this.grid.tiles[o].unit?null:(this.movements.set(o,s),s.moveByPath(i))}removeUnit(t){const[e,i]=t.position,n=this.grid.getIndexByPosition(e,i);this.grid.tiles[n].unit=null,this.movements.delete(t.targetPosition),((t,e)=>{const i=t.indexOf(e);-1!==i&&h(t,i)})(this.units,t)}cancelMove(t){this.movements.delete(t.targetPosition),t.cancelMove()}}class Zt{static createEmptyWorldData(t,e,i=et){const n=((t,e,i=et)=>l(e*t,(()=>it(i))))(t,e,i);return this.fromTilesData(n,t)}static createEmptyWorld(t,e,i=et){const n=this.createEmptyWorldData(t,e,i);return Zt.fromData(n)}static fromTerrainMap(t,e,i){const n=t.map(it);return this.fromData(this.fromTilesData(n,e,i))}static fromData(t){const e=St.createFromTilesData(t.tiles,t.width);return new Zt(e,t)}constructor(t,e){this.grid=t,this.turnNumber=e.turnNumber,this.citiesService=new Gt(t,e.cities,e.nextCityId),this.citiesService.onUnitCreated((t=>{this.unitCreationHandler(t)})),this.unitsService=new Jt(t,e.units),this.mapSeed=e.mapSeed}unitCreationHandler({cityPositionIndex:t,unitTypeId:e}){const i=Z[e-1],[n,s]=this.grid.getPositionByIndex(t);this.placeUnit(n,s,{type:i})}turn(){this.turnNumber===Zt.MAX_TURN_NUMBER&&(console.warn("Max turns reached"),this.turnNumber=1);const t=this.citiesService.turn(),e=this.unitsService.turn();return++this.turnNumber,t.concat(e.moves,e.canceledMoves)}moveUnit(t,e,i){return this.unitsService.moveUnit(t,e,i)}placeTerrain(t,e,i){const n=this.grid.get(t,e);if(!((t,e)=>t.terrain!==e&&(e.dryLand||!t.city&&!t.unit))(n,i))return!1;n.terrain=i,this.mapSeed=null;const{influencedBy:s}=n;s&&s.assignments.recalculate();return Pt.axial.some((({dx:i,dy:n})=>this.grid.get(t+i,e+n).influencedBy))&&this.citiesService.updateTilesToExpand(),!0}placeUnit(t,e,i={}){return this.unitsService.placeUnit(t,e,i)}removeUnit(t){this.unitsService.removeUnit(t)}foundCity(t,e,i){return this.citiesService.foundCity(t,e,i)}captureTile(t,e,i,n){this.citiesService.captureTile(t,e,i,n)}setCityProject(t,e){const i=null!==e?tt.find((t=>t.productId===e)):null;this.citiesService.setProject(t,i)}get cities(){return this.citiesService.cities}get units(){return this.unitsService.units}get nextCityId(){return this.citiesService.nextCityId}get tiles(){return this.grid.tiles}get width(){return this.grid.width}get height(){return this.grid.height}}Zt.MAX_TURN_NUMBER=65536,Zt.fromTilesData=(t,e,i=null)=>({tiles:t,width:e,height:t.length/e,cities:[],units:[],turnNumber:1,nextCityId:0,mapSeed:i});const te=new TextEncoder,ee=new TextDecoder("utf-8"),ie=(t,e)=>{if(!t)throw new Error("Serialized string must not be empty");const i=2**e,n=(t=>te.encode(t))(t);if(n.length>i)throw new Error(`Max string size exceeded. ${n.length} > ${i}`);return At(n.length-1,e).concat((t=>Ut(t,8))(n))},ne=(t,e)=>{const i=Ot(t,e)+1;return(t=>{const{buffer:e}=new Uint8Array(t);return ee.decode(e)})(zt(t,i))},se=(t,e=0)=>{const i=2**t+e-1;return{read:i=>Ot(i,t)+e,write:n=>{if(n>i)throw new Error("Overflow error");return At(n-e,t)}}},oe=(t,e)=>({name:t,read:i=>({[t]:e.read(i)}),write:t=>e.write(t)}),re=(t,e,i={context:{},data:{}})=>{const n={context:{},data:{},...i},{data:s}=n;for(const i of e){const e=i.read(t,n);"object"==typeof e&&Object.assign(s,e)}return s},le=(t,e,i={})=>{const n=[],s={data:t,context:i};for(const i of e){const e=t[i.name],o=i.write(e,s);for(const t of o)n.push(t)}return n},ae=(ce=7,{read:t=>ne(t,ce),write:t=>ie(t,ce)});var ce;const he=se(7),de=se(3,3),ue=se(3),pe=(t,e)=>t===e?0:kt(Tt(t)),ge=[{name:"id",read:(t,{context:e})=>({id:Ot(t,e.cityIdSize)}),write:(t,{context:e})=>At(t,e.cityIdSize)},oe("name",ae),{write(t,{data:e,context:i}){const n=((t,e)=>{const i=at(t.position,t.influencedPositions,e.width,e.height),[n,s,o,r]=(t=>{const[e,i]=t[0];let n=e,s=i,o=e,r=i;for(const[e,i]of t)e<n&&(n=e),i<s&&(s=i),e>o&&(o=e),i>r&&(r=i);return[n,s,o,r]})(i),l=o-n+1,a=r-s+1,c=nt(Math.abs(n),Math.abs(s),l),h=i.map((([t,e])=>nt(t-n,e-s,l))),d=l*a,u=[],p=[];for(let e=0;e<d;e++){const i=h.indexOf(e),n=i>=0;if(u.push(n),n){const e=t.influencedPositions[i],n=ut(t.assignmentsPositions,e);p.push(n)}}return{width:l,height:a,cityIndex:c,influence:u,assignments:p,influenceSize:t.influencedPositions.length}})(e,i.worldSize);return le(n,fe)},read:(t,{context:e})=>((t,e,i)=>{const n=[],{width:s,height:o}=t,r=s*o,[l,a]=rt(t.cityIndex,s),[c,h]=[e[0]-l,e[1]-a];for(let e=0;e<r;e++)if(t.influence[e]){const[t,o]=rt(e,s),[r,l]=ot(t+c,o+h,i.width,i.height);n.push([r,l])}const d=[];for(let e=0;e<t.assignments.length;e++)t.assignments[e]&&d.push(n[e]);return{position:e,influencedPositions:n,assignmentsPositions:d}})(re(t,fe),e.position,e.worldSize)},{name:"project",read:t=>{const e=ue.read(t);if(0===e)return{project:null};const i=tt[e-1],n=kt(i.cost);return{project:{type:i,progress:Ot(t,n)}}},write:t=>{if(null===t)return l(3,n);const e=kt(t.type.cost);return ue.write(t.type.productId).concat(At(t.progress,e))}},{name:"growthProgress",write(t,{data:e}){const i=pe(e.assignmentsPositions.length,e.influencedPositions.length);return At(t,i)},read(t,{data:e}){const i=pe(e.assignmentsPositions.length,e.influencedPositions.length);return{growthProgress:Ot(t,i)}}},oe("expandingProgress",he)],fe=[oe("width",de),oe("height",de),{name:"cityIndex",write:(t,{data:e})=>At(t,kt(e.width*e.height)),read:(t,{data:e})=>({cityIndex:Ot(t,kt(e.width*e.height))})},{name:"influence",read(t,{data:e,context:i}){const{booleans:n,count:s}=((t,e)=>{const i=Dt(t,e,{truesCount:0},jt);return{booleans:i.booleans,count:i.stats.truesCount}})(t,e.width*e.height);return i.influenceSize=s,{influence:n}},write:t=>t},{name:"assignments",read:(t,{context:e})=>({assignments:Rt(t,e.influenceSize)}),write:t=>t}],me=(t,e,i,n)=>re(t,ge,{context:{cityIdSize:n,position:e,worldSize:i}}),ye=se(3),we=se(4),ve=[{name:"type",read:t=>{const e=ye.read(t);return{type:Z[e]}},write:t=>ye.write(t.id-1)},oe("movePoints",we),{name:"targetPosition",read(t,{context:{targetIndexSize:e,positionIndex:i,worldWidth:n}}){const s=Ot(t,e);return{targetPosition:s!==i?s:null,position:rt(i,n)}},write(t,{data:e,context:{targetIndexSize:i,worldWidth:n}}){const s=((t,e,i)=>{if(null===t){const[t,n]=e;return nt(t,n,i)}return t})(t,e.position,n);return At(s,i)}}],xe=(t,e=null)=>{const{width:i,height:n}=t,s={worldWidth:i,targetIndexSize:Se(i,n)};if(null!==e){const[t,n]=e;s.positionIndex=nt(t,n,i)}return s},Se=(t,e)=>kt(t*e),Te=(t,e,i)=>{const n=xe(i,e);return re(t,ve,{context:n})},Ce=265;var Pe;class be{constructor(t=Pe.getDefaultSeed()){this.seed=t}next(){return this.seed=(1664525*this.seed+1013904223)%Pe.PERIOD,this.seed/Pe.PERIOD}nextFloat(t,e){return t+(e-t)*this.next()}nextInt(t,e){if(1===arguments.length)return this.nextInt(0,t);const i=this.next();return Vt(t,e,i)}nextBoolean(t=.5){return this.next()<t}}Pe=be,be.getDefaultSeed=()=>{return t=0,e=Pe.PERIOD,Vt(t,e,Math.random());var t,e},be.PERIOD=2**32;const Ee=(t,e)=>String(t).padStart(e,"0"),Ie=new RegExp("^[\\da-f]{8}$"),Me=t=>(t=>Ie.test(t))(t)?parseInt(t,16):null,Ae=t=>{return e=8,t.toString(16).padStart(e,"0");var e},Ne=()=>Ae(Ue()),Ue=()=>be.getDefaultSeed(),Be=([t,e],[i,n])=>t*i+e*n,Oe=(t,e,i)=>{return t+(6*(n=i)**2-15*n+10)*n**3*(e-t);var n},je=t=>((t,e)=>[t*Math.cos(e),t*Math.sin(e)])(1,t),De=(t,e,i,n)=>{const s=Math.ceil(t/i)+1,o=Math.ceil(e/i)+1,r=new be(n),a=l(s*o,(()=>{const t=r.nextFloat(0,Qt);return je(t)})),c=(t,e)=>{const i=nt(t,e,s);return a[i]};return(t,e)=>.5+.5*((t,e,i)=>{const n=Math.floor(t),s=Math.floor(e),o=t-n,r=e-s,l=Be([o,r],i(n,s)),a=Be([o-1,r],i(n+1,s)),c=Be([o-1,r-1],i(n+1,s+1)),h=Be([o,r-1],i(n,s+1)),d=Oe(l,a,o),u=Oe(h,c,o);return Oe(d,u,r)})(t/i,e/i,c)},Re=(t,e,i,s)=>{const o=t.map(n),r=new xt(e,t.length/e),l=[i],a=[s],c=new Set([i,s]);for(;l.length>0||a.length>0;){if(l.length>0){const e=ze(l,t),[i,n]=r.getPositionByIndex(e);for(const{dx:t,dy:e}of Pt.axial){const[s,o]=r.getPosition(i+t,n+e),a=r.getIndexByPosition(s,o);c.has(a)||(l.push(a),c.add(a))}}if(a.length>0){const e=ke(a,t),[i,n]=r.getPositionByIndex(e);o[e]=!0;for(const{dx:t,dy:e}of Pt.axial){const[s,o]=r.getPosition(i+t,n+e),l=r.getIndexByPosition(s,o);c.has(l)||(a.push(l),c.add(l))}}}return o},ke=(t,e)=>{let i=t[0],n=0;for(let s=1;s<t.length;s++)e[t[s]]>e[i]&&(i=t[s],n=s);return h(t,n),i},ze=(t,e)=>{let i=t[0],n=0;for(let s=1;s<t.length;s++)e[t[s]]<e[i]&&(i=t[s],n=s);return h(t,n),i},Le=(t,e,i)=>{const n=((t,e,i,n)=>{const s=[],o=(t-1)/2,r=(e-1)/2,l=De(t,e,i,n);let a,c,h=Number.POSITIVE_INFINITY,d=Number.NEGATIVE_INFINITY;for(let i=0;i<e;i++)for(let n=0;n<t;n++){if(n<3||n>t-3||i<2||i>e-2){s.push(0);continue}const u=l(n,i)*(1-Math.sqrt(((o-n)/o)**2+((r-i)/r)**2)/Math.SQRT2);u<h&&(h=u,a=nt(n,i,t)),u>d&&(d=u,c=nt(n,i,t)),s.push(u)}return Re(s,t,a,c)})(t,e,7,i),s=((t,e,i)=>{const n=t.length/e,s=De(e,n,3,i),o=(e-1)/2,r=(n-1)/2,l=[];for(let i=0;i<n;i++)for(let n=0;n<e;n++){const a=nt(n,i,e),c=s(n,i),h=1-Math.sqrt(.3*((o-n)/o)**2+.7*((r-i)/r)**2)/Math.SQRT2;l.push(t[a]&&(c*h)**2>.2)}return l})(n,t,i);return n.map(((t,e)=>t?s[e]?K:q:J))},He=kt(252),_e=kt(Zt.MAX_TURN_NUMBER-1),Fe=kt(2**32-1),We=(t,e,i,n)=>{const[s,o]=t;return{city:s?me(t,e,i,n.cityIdSize):null,unit:o?Te(t,e,i):null,terrain:Q[Ot(t,3)]}},$e=(t,e,i)=>{const n=At(t.terrain.id-1,3),{city:s,unit:o}=t,r=[!!s,!!o];return s&&r.push(...((t,e,i)=>le(t,ge,{worldSize:e,cityIdSize:i}))(s,e,i)),o&&r.push(...((t,e)=>{const i=xe(e);return le(t,ve,i)})(o,e)),r.concat(n)},Ge=se(He,13),Xe=se(_e,1),Ve=[oe("width",Ge),oe("height",Ge),oe("turnNumber",Xe),{name:"mapSeed",write:t=>null===t?[!1]:[!0,...At(t,Fe)],read(t){const[e]=t;return{mapSeed:e?Ot(t,Fe):null}}},{name:"nextCityId",write:(t,{context:e})=>(e.cityIdSize=(t=>t>0?kt(t-1):0)(t),At(e.cityIdSize,5)),read(t,{context:e}){e.cityIdSize=Ot(t,5)}},{name:"tiles",write:(t,{data:e,context:i})=>((t,e,i)=>{const n=[];return t.forEach((t=>{n.push(...$e(t,e,i.cityIdSize))})),n})(t,e,i),read:(t,{context:e,data:i})=>((t,e,i)=>{const n=[],s=[],o=[];for(let r=0;r<e.height;r++)for(let l=0;l<e.width;l++){const a=We(t,[l,r],e,i),{city:c,unit:h}=a;c&&(n.push(c),c.id>=e.nextCityId&&(e.nextCityId=c.id+1)),h&&o.push(h),s.push(a)}return{tiles:s,cities:n,units:o}})(t,i,e)}],Ye=t=>{const e=(t=>Et(t,Nt))(t);return re(e,Ve,{data:{nextCityId:0}})},Qe=t=>t.charAt(0).toUpperCase()+t.slice(1),qe=(t,e)=>{for(const i in e)"style"===i?Object.assign(t.style,e.style):i in t?t[i]=e[i]:t.setAttribute(i,e[i])},Ke=(t,...e)=>{const i=document.createElement(t);return((t,...e)=>{for(const i of e)Array.isArray(i)?t.append(...i):s(i)?t.innerText=i:qe(t,i)})(i,...e),i},Je=(...t)=>{const[e,...i]=t;return s(e)?Ke(e,...i):(t=>{const e=document.createDocumentFragment();return e.append(...t),e})(t)},Ze=[[[13,3],[9,7],[15,13],[3,25],[7,29],[19,17],[25,23],[29,19]],[[28,4],[17,10],[8,22],[5,19],[3,21],[6,24],[3,27],[5,29],[8,26],[11,29],[13,27],[10,24],[22,15]],[[5,5],[27,5],[18,10],[27,16],[8,16],[8,28],[5,28]]];class ti{constructor(t,e){this.view=t,this.context=e}drawIcon(t,e,i){const n=Ze[t];((t,[e,i],n,s)=>{t.fillStyle=s;const[[o,r]]=n;t.beginPath(),t.moveTo(e+o,i+r);for(let s=1;s<n.length;s++){const[o,r]=n[s];t.lineTo(e+o,i+r)}t.closePath(),t.stroke(),t.fill()})(this.context,[e,i],n,"#006400")}drawSprite(t,e,i){const{tileSize:n}=this.view,s=V.width/n,[o,r]=rt(t,s),l=o*n,a=r*n;this.context.drawImage(V,l,a,n,n,e,i,n,n)}clearTile(t,e){const[i,n]=this.view.toCanvasPosition(t,e),{tileSize:s}=this.view;this.context.clearRect(i,n,s,s)}clear(){this.context.clearRect(0,0,this.view.width,this.view.height)}moveViewport(t,e){const{context:i}=this,{width:n,height:s,tileSize:o}=this.view;if(0!==t){const e=t*o,r=t>0?e:n+e,l=i.getImageData(0,0,r,s),a=i.getImageData(r,0,n-r,s);i.putImageData(l,n-r,0),i.putImageData(a,0,0)}if(0!==e){const t=e*o,r=e>0?t:s+t,l=i.getImageData(0,0,n,r),a=i.getImageData(0,r,n,s-r);i.putImageData(l,0,s-r),i.putImageData(a,0,0)}}}const ei={grassland:"#388E3C",steppe:"#88C34A",sea:"#0090c4"};class ii extends ti{drawGrid(){this.context.fillStyle=ii.GRID_COLOR;const{tileSize:t}=this.view,{width:e,height:i}=this.context.canvas;for(let n=t;n<e;n+=this.view.tileSize)this.context.fillRect(n,0,1,i);for(let n=t;n<i;n+=this.view.tileSize)this.context.fillRect(0,n,e,1)}moveViewport(){}}ii.GRID_COLOR="#555";const ni=(t,e)=>((t,e,i)=>{const n=Math.floor(i/2),s=t-n,o=[];let r=t;for(let l=e-n;l<e;l++){const n=Math.abs(l-e);let a=!0;for(let c=s;c<t;c++){const s=r,h=Math.abs(c-t),d=ht(h,n);if(d!==i&&d!==i-1)continue;let u;c<s?(u=a?[!0,!1,!1,!0]:[!0,!1,!1,!1],r=c):u=c===s?[!1,!1,!1,!0]:[!0,!1,!1,!1],a=!1;const p={position:[c,l],borders:u},g=vt(p,t),f=wt(g,e),m=vt(f,t);o.push(p,g,f,m),a=!1}}const l={position:[t,e-n],borders:i%2==0?[!0,!0,!1,!0]:[!0,!1,!1,!1]},a={position:[t-n,e],borders:i%2==0?[!0,!1,!0,!0]:[!1,!1,!1,!0]},c=wt(l,e),h=vt(a,t);return o.push(l,a,c,h),o})(t,e,7);class si extends ti{constructor(t,e,i){super(t,e),this.bordersRenderer=i,this.context.fillStyle=si.BORDERS_COLOR}drawTileBorders(t,e,i){this.bordersRenderer(this.context,t,e,i)}}si.BORDERS_COLOR="#000";var oi={terrain:class extends ti{drawTerrain(t,e,i){this.context.fillStyle=ei[i];const{tileSize:n}=this.view;this.context.fillRect(t,e,n,n)}},grid:ii,borders:si,objects:class extends ti{drawUnit(t,e,i){this.drawIcon(i-1,t,e)}drawHouse(t,e){this.drawSprite(1,t,e)}drawCityWithGarrison(t,e){this.drawSprite(2,t,e)}},selection:class extends ti{constructor(t,e,i){super(t,e),this.borderRenderer=i}drawMaxCityBorders([t,e]){this.context.fillStyle="#333";ni(t,e).forEach((t=>{const[e,i]=this.view.toCanvasPosition(...t.position);this.borderRenderer(this.context,e,i,t.borders)}))}clearMaxCityMaxBorders([t,e]){ni(t,e).forEach((({position:[t,e]})=>{this.clearTile(t,e)}))}drawCitizenDistribution(t){for(const[e,i]of t.assignmentsPositions)this.drawCitizen(e,i)}clearCitizenDistribution(t){for(const[e,i]of t.influencedPositions)this.clearTile(e,i)}drawCitizen(t,e){const[i,n]=this.view.toCanvasPosition(t,e);this.drawSprite(0,i,n)}drawPath(t){this.context.fillStyle="#5af";for(let e=0;e<t.length;e++){const i=t[e],[n,s]=this.view.grid.getPositionByIndex(i),[o,r]=this.view.toCanvasPosition(n,s);this.drawPathNode(o,r)}}drawPathNode(t,e){const i=this.view.tileSize/2,n=t+i,s=e+i;this.context.beginPath(),this.context.arc(n,s,4,0,2*Math.PI,!1),this.context.closePath(),this.context.fill()}drawUnitSelection(t,e,i){i.length>0&&this.drawPath(i);const[n,s]=this.view.toCanvasPosition(t,e);this.context.strokeStyle="#000",this.context.beginPath(),this.context.rect(n+2,s+2,this.view.tileSize-3,this.view.tileSize-3),this.context.closePath(),this.context.stroke()}clearPath(t){t.forEach((t=>{const[e,i]=this.view.grid.getPositionByIndex(t);this.clearTile(e,i)}))}clearUnitSelection(t,e,i){super.clearTile(t,e),this.clearPath(i)}drawCitySelection(t){this.drawCitizenDistribution(t),this.drawMaxCityBorders(t.position)}clearCitySelection(t){this.clearMaxCityMaxBorders(t.position),this.clearCitizenDistribution(t)}}};class ri{static getLayerId(t){return ri.LAYER_ID_PREFIX+t}constructor(t,e,i=ri.DEFAULT_TILE_SIZE){this.world=t,this.selectionHandlers=e,this.tileSize=i,this.selectedUnit=null,this.selectedCity=null,this.viewportPosition=[0,0],this.selectors=[({unit:t})=>this.selectUnit(t),({city:t})=>this.selectCity(t),()=>this.clearSelection()],this.eventHandlers={onPopulationIncreased:({city:t})=>{var e;(null===(e=this.selectedCity)||void 0===e?void 0:e.id)===t.id&&this.layers.selection.drawCitizenDistribution(t)},onBordersExpanded:({city:t,position:e})=>{var i;const[n,s]=e;this.drawCapturedTileBorders(n,s),(null===(i=this.selectedCity)||void 0===i?void 0:i.id)===t.id&&this.refreshCitySelection()},onUnitMoved:({path:t})=>{const[e,i]=t[0],[n,s]=a(t),{unit:o}=this.grid.get(n,s),r=this.grid.get(e,i);null===r.unit&&null===r.city?this.layers.objects.clearTile(e,i):this.drawObject(e,i),this.drawObject(n,s),this.selectedUnit===o&&(this.layers.selection.clear(),this.layers.selection.drawUnitSelection(n,s,o.path))},onMoveCanceled:({from:[t,e]})=>{const{unit:i}=this.grid.get(t,e);this.selectedUnit===i&&(this.layers.selection.clear(),this.layers.selection.drawUnitSelection(t,e,i.path))},onUnitCompleted:({cityPositionIndex:t})=>{const[e,i]=this.grid.getPositionByIndex(t);this.drawObject(e,i)}},this.bordersRender=(t=>{const e=(t=>[[0,0,t,1],[t-1,0,1,t],[0,t-1,t,1],[0,0,1,t]])(t);return(t,i,n,s)=>{e.filter(((t,e)=>s[e])).forEach((([e,s,o,r])=>{t.fillRect(i+e,s+n,o,r)}))}})(i)}get grid(){return this.world.grid}get width(){return this.world.width*this.tileSize}get height(){return this.world.height*this.tileSize}handleEvent(t){this.eventHandlers[`on${Qe(t.type)}`](t.payload)}createLayer(t){const e=Je("canvas",{id:ri.getLayerId(t),width:this.width,height:this.height});return this.layersContainer.appendChild(e),e.getContext("2d",{willReadFrequently:!0})}createLayers(){this.layers={};for(const[t,e]of Object.entries(oi)){const i=this.createLayer(t);this.layers[t]=new e(this,i,this.bordersRender)}this.layers.grid.drawGrid()}mount(t){this.layersContainer=Je("div",{id:"layers",style:{width:this.width+"px",height:this.height+"px"}}),this.createLayers(),t.appendChild(this.layersContainer)}canCapture(t,e){return this.selectedCity.influence.canExpandToPosition([t,e])}drawCapturedTileBorders(t,e){this.drawBorders(t,e);for(const{dx:i,dy:n}of Pt.axial){const s=t+i,o=e+n;this.grid.get(s,o).influencedBy&&this.drawBorders(t+i,e+n)}}captureTile(t,e){const[i,n]=this.selectedCity.position;this.world.captureTile(i,n,t,e),this.drawCapturedTileBorders(t,e)}selectCity(t){const e=!!t;return e&&(this.clearSelection(),this.selectedCity=t,this.drawCitySelection(),this.selectionHandlers.onCitySelected(t)),e}selectUnit(t){const e=!!t;if(e){this.clearSelection(),this.selectedUnit=t;const[e,i]=t.position;this.layers.selection.drawUnitSelection(e,i,t.path)}return e}select(t,e=!0){for(let i=e?0:1;i<this.selectors.length;i++){if((0,this.selectors[i])(t))break}}onTileClick(t,e){if(this.selectedCity&&this.canCapture(t,e))return void this.captureTile(t,e);const i=this.selectedUnit||this.selectedCity,n=!dt(null==i?void 0:i.position,[t,e]),s=this.grid.get(t,e);this.select(s,n)}drawCitySelection(){this.layers.selection.drawCitySelection(this.selectedCity);for(const[t,e]of this.selectedCity.assignmentsPositions){const{unit:i}=this.grid.get(t,e);i&&this.layers.objects.clearTile(t,e)}}clearSelection(){this.unselectUnit(),this.unselectCity()}refreshCitySelection(){this.clearCitySelection(),this.drawCitySelection()}unselectCity(){null!==this.selectedCity&&(this.clearCitySelection(),this.selectedCity=null)}clearCitySelection(){this.selectionHandlers.onClearSelection(),this.layers.selection.clearCitySelection(this.selectedCity);for(const[t,e]of this.selectedCity.assignmentsPositions){const{unit:i}=this.grid.get(t,e);if(i){const[n,s]=this.toCanvasPosition(t,e);this.layers.objects.drawUnit(n,s,i.type.id)}}}unselectUnit(){this.selectedUnit&&(this.clearUnitSelection(),this.selectedUnit=null)}clearUnitSelection(){this.selectionHandlers.onClearSelection();const[t,e]=this.selectedUnit.position;this.layers.selection.clearUnitSelection(t,e,this.selectedUnit.path),this.selectedUnit=null}changeCityProject(t){const[e,i]=this.selectedCity.position,n=this.grid.getIndexByPosition(e,i);this.world.setCityProject(n,t)}moveUnit(t,e){const i=this.selectedUnit,n=this.world.grid.get(t,e).unit;if(n&&n!==i)return;const s=this.world.moveUnit(i,t,e);null===s?(this.layers.selection.clear(),this.selectUnit(i)):this.handleEvent(s)}draw(){for(let t=0;t<this.grid.tiles.length;t++){const[e,i]=this.grid.getPositionByIndex(t);this.drawTile(e,i)}}toCanvasPosition(t,e){const[i,n]=this.viewportPosition,[s,o]=this.grid.getPosition(t-i,e-n);return[s*this.tileSize,o*this.tileSize]}moveViewport(t,e){const[i,n]=this.viewportPosition;this.viewportPosition=this.grid.getPosition(i+t,n+e),m(this.layers,(i=>{i.moveViewport(t,e)}))}removeSelectedUnit(){if(this.selectedUnit){const[t,e]=this.selectedUnit.position;this.world.removeUnit(this.selectedUnit),this.drawObject(t,e),this.clearUnitSelection()}}placeTerrain(t,e,i){const n=this.world.placeTerrain(t,e,Q[i-1]);return n&&(this.drawTile(t,e),this.selectedCity&&this.refreshCitySelection()),n}drawBorders(t,e){this.layers.borders.clearTile(t,e);const i=Pt.axial.map((({dx:i,dy:n})=>!this.grid.get(t+i,e+n).influencedBy)),[n,s]=this.toCanvasPosition(t,e);this.layers.borders.drawTileBorders(n,s,i)}drawObject(t,e){const[i,n]=this.toCanvasPosition(t,e),{unit:s,city:o}=this.grid.get(t,e);this.layers.objects.clearTile(t,e),s&&o?this.layers.objects.drawCityWithGarrison(i,n):s?this.layers.objects.drawUnit(i,n,s.type.id):o&&this.layers.objects.drawHouse(i,n)}drawTile(t,e){const i=this.toCanvasPosition(t,e),n=this.grid.get(t,e),[s,o]=i;this.layers.terrain.drawTerrain(s,o,n.terrain.name),(n.city||n.unit)&&this.drawObject(t,e),n.influencedBy&&this.drawBorders(t,e)}skipTurnsUntilEvent(t=1e3){let e=t;for(let i=1;i<=t;i++){const t=this.world.turn();if(t.length>0){t.forEach((t=>{this.handleEvent(t)})),e=i;break}}return e}update(t){this.world=t,this.viewportPosition=[0,0],this.layersContainer.innerHTML="",Object.assign(this.layersContainer.style,{width:this.width+"px",height:this.height+"px"}),this.createLayers(),this.draw()}setGridShown(t){document.getElementById("layer-grid").style.display=t?"block":"none"}turn(){const t=this.world.turn();return t.forEach((t=>{this.handleEvent(t)})),t}placeUnit(t,e,i){this.world.placeUnit(t,e,{type:Z[i-1]}),this.drawObject(t,e)}placeCity(t,e,i){if(this.world.foundCity(t,e,i)){this.drawObject(t,e);for(const{dx:i,dy:n}of Pt.members)this.drawCapturedTileBorders(t+i,e+n)}}getViewportPosition(){return this.viewportPosition}}ri.DEFAULT_TILE_SIZE=32,ri.LAYER_ID_PREFIX="layer-";const li=t=>Ee(t,2),ai=t=>{return e=t.getMilliseconds(),Ee(e,3);var e},ci=t=>`${((t,e="-")=>[t.getFullYear(),li(t.getMonth()+1),li(t.getDate())].join(e))(t)} ${((t,e=".")=>[li(t.getHours()),li(t.getMinutes()),li(t.getSeconds())].join(e))(t)}.${ai(t)}`,hi=t=>e=>((t,e)=>{const i=[];for(const n of e){const e=n.label||n.field,s=n.get?n.get(t):t[n.field];if(!r(s)){const t=`${e}: ${s}`;i.push(t)}}return i.join("; ")})(e,t),di="-",ui=hi([{field:"id"},{field:"name"},{field:"population"},{label:"project",get:t=>{if(null===t.project)return di;var e;var i;return`${e=t.project.type.productId,Z[e-1].name} (${(i=t.project).progress+"/"+i.type.cost})`}},{label:"grow progress",get:t=>t.foodBasketSize>0?t.growthProgress+"/"+t.foodBasketSize:di},{label:"food surplus",field:"foodSurplus"},{label:"free tiles",get:t=>t.assignments.getFreeTilesCount()},{label:"expanding progress",get:t=>{const{tileToExpand:e}=t.influence;return e?t.influence.expandingProgress+"/"+e.cost:di}},{label:"growth to",get:t=>{const{tileToExpand:e}=t.influence;return e?e.position.join(", "):di}}]),pi=hi([{label:"move points",field:"movePoints"}]),gi=t=>{const e=ci(new Date),i=prompt("File Name",e);if(null!==i){const n=le(t,Ve),s=Array.from(function*(t){let e=0,i=0;for(const n of t)8===e&&(yield i,e=0,i=0),n&&(i+=2**e),++e;e>0&&(yield i)}(n));((t,e)=>{let i="";for(const t of e)i+=String.fromCharCode(t);const n=btoa(i),s=document.createElement("a");s.href="data:;base64,"+n,s.download=`${t}.save`,s.click()})(i||e,s)}},fi=({content:t})=>[f("div",{className:"backdrop"}),f("div",{className:"modal-wrapper"},[t])];var mi;class yi extends X{onMounted(){mi.instance=this,document.addEventListener("keydown",(({key:t})=>{"Escape"===t&&this.closeModal()}))}showModal(t){this.setState({modal:t})}closeModal(){this.setState({modal:null})}render(){return this.state.modal?f(fi,{content:this.state.modal}):null}}mi=yi,yi.showModal=t=>{mi.instance.showModal(t)},yi.closeModal=()=>{mi.instance.closeModal()};const wi=({label:t,value:e})=>f("span",{className:"field"},[f("span",`${t}: `,{className:"label"}),f("span",e,{className:"value"})]);class vi extends X{constructor(){super(...arguments),this.fileInputRef={value:null},this.fileReader=new FileReader,this.loadFile=()=>{this.fileInputRef.value.click()}}onMounted(){this.fileReader.addEventListener("loadend",(t=>{const e=new Uint8Array(t.target.result);this.props.onLoad(e)}))}render(){return f("div",{className:"save-load"},[f("button","Save",{onclick:this.props.onSave}),f("button","Load",{onclick:this.loadFile}),f("input",{type:"file",ref:this.fileInputRef,onchange:t=>{const e=t.target;this.fileReader.readAsArrayBuffer(e.files[0]),e.value=null},style:{display:"none"}})])}}const xi=({turn:t,mapSeed:e,onSave:i,onLoad:n,onNewWorld:s})=>{return f("div",{className:"top-panel"},[f(wi,{label:"Turn",value:String(t)}),f(wi,{label:"Map Seed",value:(o=e,"number"==typeof o?Ae(e):"-")}),f(vi,{onSave:i,onLoad:n}),f("button","New World",{onclick:s})]);var o},Si=({items:t,onChange:e,selectedItem:i=t[0],disabled:n=!1})=>f("select",{disabled:n,selectedIndex:t.indexOf(i),onchange:i=>{const n=t[i.target.selectedIndex];e(n)}},t.map((t=>f("option",t.name,{value:t.id})))),Ti=({label:t,disabled:e,items:i,selectedItem:n,onChange:s})=>[f("span",{className:"label"},`${t}: `),f(Si,{disabled:e,items:i,selectedItem:n,onChange:s})],Ci=({value:t,onChange:e})=>f("div",{className:"seed-field"},[f("label","Seed: "),f("input",{type:"text",value:t,oninput:t=>{e(t.target.value)}}),f("button","↻",{onclick:()=>{const t=Ne();e(t)}})]),Pi=({value:t,min:e,max:i,required:n,onChange:s})=>f("input",{value:t,min:e,max:i,step:1,required:n,type:"number",onchange:t=>{const e=t.target;s(Math.floor(+e.value))}}),bi=({width:t,height:e,min:i,max:n,onWidthChange:s,onHeightChange:o})=>f("div",[f("span","Size: "),f(Pi,{min:i,max:n,value:t,onChange:s,required:!0}),f("span",{className:"size-inputs-separator"},"x"),f(Pi,{min:i,max:n,value:e,onChange:o,required:!0})]),Ei=({name:t,options:e,onChange:i,value:n})=>f("div",e.map((e=>{const o=s(e)?{id:e,name:e}:e;return[f("input",{type:"radio",name:t,id:o.id,value:o.id,onchange:()=>{i(e)},checked:n===e}),f("label",o.name,{htmlFor:o.id})]}))),Ii=["Width","Height"],Mi=(t,e,i)=>{const n=[];return t.forEach(((t,s)=>{if(t<e){const t=Ii[s];n.push(`${t} must be >= ${e}`)}else if(t>i){const t=Ii[s];n.push(`World ${t} must be <= ${i}`)}})),n};class Ai extends X{constructor(){super(...arguments),this.confirm=()=>{const{width:t,height:e}=this.state;this.setState({errors:[]}),this.state.isEmpty?this.onCreateEmptyWorld(t,e,this.state.terrain):this.onGenerateWorld(t,e,this.state.seed)},this.cancel=()=>{yi.closeModal()},this.getChangeHandler=t=>e=>{this.setState({[t]:e})},this.toggleEmpty=()=>{this.setState({isEmpty:!this.state.isEmpty})}}getInitialState(){return{width:40,height:20,seed:Ne(),terrain:Q[0],errors:[],isEmpty:!0}}onCreateEmptyWorld(t,e,i){const n=Mi([t,e],13,Ce);0===n.length?(this.props.onCreateEmptyWorld(t,e,i),yi.closeModal()):this.setState({errors:n})}onGenerateWorld(t,e,i){const n=Mi([t,e],13,Ce),s=Me(i);null===s&&n.push("Invalid seed"),0===n.length?(this.props.onGenerateWorld(t,e,s),yi.closeModal()):this.setState({errors:n})}render(){return f("div",{className:"modal create-world"},[f("div",{className:"form-row"},[f(bi,{width:this.state.width,height:this.state.height,min:13,max:Ce,onWidthChange:this.getChangeHandler("width"),onHeightChange:this.getChangeHandler("height")})]),f("div",{className:"form-row"},[f(Ei,{name:"options",options:["empty","generate"],value:this.state.isEmpty?"empty":"generate",onChange:t=>{this.setState({isEmpty:"empty"===t})}})]),f("div",{className:"form-row"},[this.state.isEmpty?f(Ti,{label:"Terrain",items:Q,selectedItem:this.state.terrain,onChange:this.getChangeHandler("terrain")}):f(Ci,{value:this.state.seed,onChange:this.getChangeHandler("seed")})]),this.state.errors.length>0?f("ul",{className:"errors"},this.state.errors.map((t=>f("li",t)))):null,f("div",{className:"modal-buttons"},[f("button","Cancel",{onclick:this.cancel}),f("button","Create",{onclick:this.confirm})])])}}const Ni=({checked:t=!1,label:e,id:i=e,onChange:n})=>f("div",{className:"labeled-checkbox"},[f("input",{type:"checkbox",id:i,checked:t,onchange:t=>{const e=t.target;n(e.checked)}}),f("label",e,{htmlFor:i})]);class Ui extends X{constructor(){super(...arguments),this.checked=!1}render(){return f("div",{className:"controls-group"},[f("button",this.props.buttonText,{onclick:()=>{this.props.onPress(this.checked)}}),f(Ni,{label:this.props.optionName,checked:this.checked,onChange:t=>{this.checked=t}})])}}const Bi=({onToggle:t,items:e,selectedItem:i,onItemSelected:n,selected:s})=>f("div",{className:"toggled-dropdown"},[f("input",{type:"checkbox",checked:s,onchange:()=>{t(!s)}}),f(Si,{items:e,selectedItem:i,disabled:!s,onChange:n})]);class Oi extends X{constructor(){super(...arguments),this.selectedItem=this.props.tool.items[0]}render(){return f(Bi,{selected:this.props.selected,items:this.props.tool.items,selectedItem:this.selectedItem,onItemSelected:t=>{this.selectedItem=t,this.props.onChange(t)},onToggle:t=>{this.props.onChange(t?this.selectedItem:null)}})}}const ji=({tool:t,selectedTool:e,onChange:i})=>{const n=t.id===(null==e?void 0:e.id);return(t=>Boolean(t.items))(t)?f(Oi,{selected:n,tool:t,onChange:e=>{i(e?{id:t.id,option:e.id}:null)}}):f(Ni,{checked:n,label:t.label,onChange:e=>{i(e?t:null)}})},Di=({tools:t,onChange:e,selectedTool:i})=>f("div",{className:"controls-group"},t.map((t=>f(ji,{tool:t,selectedTool:i,onChange:e})))),Ri=[{id:"placeTerrain",items:Q},{id:"placeUnit",items:Z},{id:"placeCity",label:"City"}],ki={id:0,name:"-"},zi=[ki,...tt.map(((t,e)=>({id:t.productId,name:`${Z[e].name} (${t.cost})`})))],Li=({onChange:t,selectedProject:e})=>{const i=null===e?ki:zi.find((t=>t.id===e.productId));return f("div",{className:"controls-group labeled"},[f(Ti,{label:"City Project",disabled:!1,onChange:e=>{const i=e!==ki?tt.find((t=>t.productId===e.id)):null;t(i)},selectedItem:i,items:zi})])},Hi=({onTurn:t,onSkipTurns:e,onToggleGrid:i,onToolSelected:n,onCityProjectChanged:s,selectedTool:o,selectedCity:r,gridShown:l,tileInfo:a})=>f("div",{className:"bottom-panel"},[f("div",{className:"controls-panel"},[f(Ni,{label:"Grid",checked:l,onChange:i}),f(Ui,{optionName:"Skip Silent Turns",buttonText:"Turn",onPress:i=>{i?e():t()}}),f(Di,{tools:Ri,onChange:n,selectedTool:o}),r?f(Li,{onChange:s,selectedProject:r.project?r.project.type:null}):null]),f("span",{innerHTML:null!=a?a:"-"})]),_i=t=>{const{offsetX:e,offsetY:i}=t,{clientWidth:n,clientHeight:s}=t.target,o=s-1;return[Yt(e,n-1),Yt(i,o)]},Fi=(e,i)=>{((t,e)=>{m(e,((e,i)=>{((t,e,i)=>{t.addEventListener(e,(t=>{t.preventDefault(),i(t)}))})(t,i,e)}))})(i,{contextmenu:t,mouseup:t=>{const i=_i(t);0===t.button?t.ctrlKey?e.onCtrlClick(i):e.onLeftClick(i):e.onRightClick(i)},mousemove:t=>{const i=_i(t);e.onMove(i)},mouseleave:()=>{e.onLeave()}})},Wi=(t,e)=>{let i=null;return{onMove:n=>{const s=e(n);dt(s,i)||(t.onMove(s),i=s)},onLeave:()=>{t.onLeave(),i=null}}},$i=(t,e)=>{const{onLeave:i,onMove:n,...s}=t,o=((t,e)=>{const i={};return m(t,((t,n)=>{const s=e(t,n);i[n]=s})),i})(s,(t=>((t,e)=>i=>{t(e(i))})(t,e)));return{...o,...Wi({onMove:n,onLeave:i},e)}},Gi={ArrowLeft:Pt.WEST.offset,ArrowUp:Pt.NORTH.offset,ArrowRight:Pt.EAST.offset,ArrowDown:Pt.SOUTH.offset};class Xi extends X{constructor(){super(...arguments),this.view=new ri(Zt.createEmptyWorld(40,20),{onClearSelection:()=>{this.setState({selectedCity:null})},onCitySelected:t=>{this.setState({selectedCity:t})}}),this.viewContainerRef={value:null},this.saveWorld=()=>{gi(this.view.world)},this.loadWorld=t=>{const e=Zt.fromData(Ye(t));this.updateWorld(e)},this.createWorld=()=>{yi.showModal(f(Ai,{onCreateEmptyWorld:(t,e,i)=>{const n=Zt.createEmptyWorld(t,e,i);this.updateWorld(n)},onGenerateWorld:(t,e,i)=>{const n=Le(t,e,i),s=Zt.fromTerrainMap(n,t,i);this.updateWorld(s)}}))},this.onToggleGrid=()=>{const t=!this.state.gridShow;this.view.setGridShown(t),this.setState({gridShow:t})},this.onTurn=()=>{this.view.turn(),this.setState({turn:this.view.world.turnNumber})},this.skipTurns=()=>{this.view.skipTurnsUntilEvent(),this.setState({turn:this.view.world.turnNumber})},this.onToolSelected=t=>{this.setState({selectedTool:t})},this.onCityProjectChanged=t=>{var e;this.view.changeCityProject(null!==(e=null==t?void 0:t.productId)&&void 0!==e?e:null)}}getInitialState(){return{turn:1,gridShow:!0,mapSeed:null,selectedTool:null,selectedCity:null}}onMounted(){this.view.mount(this.viewContainerRef.value),this.view.draw(),this.addMouseHandlers(),this.addKeyHandlers()}addMouseHandlers(){(({element:t,getTilePosition:e,...i})=>{const n=$i(i,e);Fi(n,t)})({element:this.view.layersContainer,getTilePosition:([t,e])=>{const[i,n]=this.view.getViewportPosition();return this.view.grid.getPosition(Math.floor(t/this.view.tileSize)+i,Math.floor(e/this.view.tileSize)+n)},onLeftClick:([t,e])=>{this.state.selectedTool?(this.applyTool(t,e),this.setState({selectedTool:null})):this.view.onTileClick(t,e)},onRightClick:([t,e])=>{this.view.selectedUnit&&this.view.moveUnit(t,e)},onCtrlClick:([t,e])=>{this.state.selectedTool&&this.applyTool(t,e)},onMove:t=>{const e=this.getTileInfo(t);this.setState({tileInfo:e})},onLeave:()=>{this.setState({tileInfo:null})}})}addKeyHandlers(){(({element:t,...e})=>{t.addEventListener("keydown",(({key:t})=>{var i;if(t.startsWith("Arrow")){const i=Gi[t];e.onArrow(i)}else null===(i=e[`on${t}`])||void 0===i||i.call(e)}))})({element:document,onEscape:()=>{this.view.clearSelection(),this.setState({selectedTool:null})},onArrow:([t,e])=>{this.view.moveViewport(t,e)},onDelete:()=>{this.view.removeSelectedUnit()}})}getTileInfo(t){return((t,e)=>{const[i,n]=e,s=[t.world.grid.getIndexByPosition(i,n),`[${e.join("; ")}]`],o=t.grid.get(i,n),{unit:r,city:l}=o;if(o.influencedBy&&s.push(((t,e)=>e.assignments.isPositionOccupied(t)?`<b>${e.name}</b>`:e.name)(e,o.influencedBy)),r)s.push(pi(r));else if(l)s.push(ui(l));else if(t.selectedCity){const r=t.selectedCity.influence.getTilesToExpand().find((({position:t})=>dt(t,e)));r?s.push(`expansion cost: ${r.cost}`):null!==o.influencedBy&&o.influencedBy!==t.selectedCity&&t.selectedCity.influence.canSwap(i,n)&&s.push("swappable")}return s.join(" ")})(this.view,t)}applyTool(t,e){var i;const{selectedTool:n}=this.state,s=n.id,o=this.view[s](t,e,n.option);o&&(null===(i=this[`on${Qe(s)}`])||void 0===i||i.call(this,o))}onPlaceTerrain(){this.setState({mapSeed:this.view.world.mapSeed})}updateWorld(t){this.view.update(t),this.setState({turn:this.view.world.turnNumber,mapSeed:this.view.world.mapSeed})}render(){return[f("div",{className:"main"},[f(xi,{turn:this.state.turn,mapSeed:this.state.mapSeed,onSave:this.saveWorld,onLoad:this.loadWorld,onNewWorld:this.createWorld}),f("div",{ref:this.viewContainerRef}),f(Hi,{gridShown:this.state.gridShow,onToggleGrid:this.onToggleGrid,onTurn:this.onTurn,onSkipTurns:this.skipTurns,onToolSelected:this.onToolSelected,onCityProjectChanged:this.onCityProjectChanged,selectedTool:this.state.selectedTool,selectedCity:this.state.selectedCity,tileInfo:this.state.tileInfo})]),f(yi,{})]}}var Vi;Vi=()=>{((t,e,i)=>{const n=g(t,e),s={parentElement:i,currentSibling:null};3===n.type?P(n,s):b(n,s)})(Xi,{},document.body)},V.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGAAAAAgCAYAAADtwH1UAAAAAXNSR0IArs4c6QAAAZFJREFUaEPtmluuwyAMRNutsXC21qtUSkojHsPYxtzK/cYMnmMDRXk+4ufqwNNVPcQfAcC5CEQAUkqvc/05Z9Fczj64ydOmleY7QziKgM5DwXmRPrXwmvlOEK4OdIIg1v/PAMrkT/5UPmQXqOhTC96gA2rJr4Sgpk8BODJ1PAN6ya+AoKpPA7hDWHQLQpK3hKCuLwJA7p1s2EzyFhBM9CkADmcAk7wmBDP9aQA9842uopLkNSCY6k8BQMxXhqCRvASCuf7OADSTZyAs0d8VgEXyMxCW6QeA+p0sALB3VSAOKboAABjJDgkAgHNoBZZmMjGtpUBzpZSu+JwzkNZ7yFcBINVwTbzwGooYUFs7G3c3bzhPaX5x9UYg/ASAXuGMzEOKrjtHzfwJCDyA1ivoHbvCw5zEREnsmcq+AEYQFMw/JKTv7WbxveoHu0DWAQHgc/C2NvzBgRwAgJOy2UHRAdgXEL+9BbW2IaX9P84AoEXfQww/zDKrYPDzlb23IBRQjBs7gPwpGc8SI2gHAgBtnU7gHxo8viHzg01RAAAAAElFTkSuQmCC",V.onload=Vi}();
