!function(){"use strict";const t=t=>t,e=()=>!0,i=()=>!1,n=(t,e)=>t===e,s=t=>"string"==typeof t;function o(t,e){for(const i in e)"style"===i?Object.assign(t.style,e.style):i in t?t[i]=e[i]:t.setAttribute(i,e[i])}function r(t,e){for(const i of e){const e=s(i)?document.createTextNode(i):i;t.appendChild(e)}}const c=(t,...e)=>{const i=document.createElement(t);for(const t of e)Array.isArray(t)?r(i,t):s(t)?i.innerText=t:o(i,t);return i};let a=0;const l=()=>`checkbox-${a++};`;function h({id:t=l(),label:e,onToggle:i,checked:n=!1}){const s=c("input",{type:"checkbox",checked:n,onchange(t){const e=t.target;i(e.checked)}});return{element:c("div",[c("label",e,{htmlFor:t}),s]),update({checked:t}){s.checked=t}}}var u;!function(t){t[t.STEPPE=0]="STEPPE",t[t.GRASSLAND=1]="GRASSLAND"}(u||(u={}));const d=[{id:u.STEPPE,text:"steppe"},{id:u.GRASSLAND,text:"grassland"}],f=({onToggle:t,onTerrainSelected:e})=>{const i=c("div"),n=c("input",{type:"checkbox",htmlFor:"terrain"}),s=(({items:t,onSelect:e,disabled:i=!1})=>{const n=c("select",{disabled:i});for(const e of t){const t=c("option",{innerText:e.text,value:e.id.toString()});n.appendChild(t)}return n.onchange=i=>{const s=t[n.selectedIndex];e(s)},{element:n,onSelect:e,update({disabled:t}){n.disabled=t}}})({items:d,onSelect({id:t}){e(t)},disabled:!0});return i.appendChild(s.element),i.appendChild(n),n.onchange=e=>{s.update({disabled:!n.checked}),t(n.checked)},{element:i,update({checked:t}){s.element.disabled=!t,n.checked=t}}},g={name:"placeTerrain",options:{terrain:u.STEPPE}},p={name:"placeCity"},y=(t,e,i=n)=>t.length===e.length&&t.every(((t,n)=>i(t,e[n])));function m(t,e){const i=[];for(let n=0;n<t;n++){const t=e(n);i.push(t)}return i}const w=(t,e,i)=>m(t,(t=>m(e,(e=>i(t,e))))),E=(t,e,i)=>i?t.some((t=>i(t,e))):t.includes(e),T=(t,e,i=n)=>t.filter((t=>!E(e,t,i)));const P=(t,e)=>t.reduce(((t,i)=>{const[n,s]=e(i);return t[n]=s,t}),{}),b=(t,i=e)=>t.reduce(((t,e)=>i(e)?t+1:t),0),x=[9,3,[[1,0,4,4],[0,5,6,7],[1,12,4,6]]],S=[4,4,[[6,0,6,2],[4,2,10,2],[2,4,14,2],[0,6,18,2],[2,8,14,3],[2,11,5,5],[11,11,5,5]]],C=t=>{const{offsetX:e,offsetY:i}=t,{clientWidth:n,clientHeight:s}=t.target;return e>=n||i>=s?null:[e,i]};function M(t,e,i,n){t.fillStyle="black";const[s,o,r]=e;for(const[e,c,a,l]of r)t.fillRect(i+e+s,n+c+o,a,l)}v.DIAGONAL_MOVE_COST=3,v.AXIAL_MOVE_COST=2;const A=(t,e)=>v.DIAGONAL_MOVE_COST*Math.min(t,e)+v.AXIAL_MOVE_COST*Math.abs(t-e);function v(t,e,i,n){const s=Math.abs(t-i),o=Math.abs(e-n);return A(s,o)}function I(t,e){return[t%e,Math.floor(t/e)]}const k=(t,e,i)=>e*i+t;function O(t,e,i){const n=e-t,s=i/2;return Math.abs(n)<=s?n:n>0?n-i:i+n}function D(t,e,i,n){const[s,o]=t,[r,c]=e;return[O(s,r,i),O(o,c,n)]}const N=(t,e)=>{if(t===e)return!0;if(null===t||null===e)return!1;const[i,n]=t,[s,o]=e;return i===s&&n===o},B=function(t){const e=Math.floor(t/v.AXIAL_MOVE_COST),i=[];for(let n=-e;n<=e;n++)for(let s=-e;s<=e;s++)if(0!==s||0!==n){v(0,0,s,n)<=t&&i.push([s,n])}return i}(4),R=([t,e],i)=>[t,2*i-e],z=([t,e],i)=>[2*i-t,e],_=([t,e,i,n])=>[i,e,t,n],L=([t,e,i,n])=>[t,n,i,e],j=(t,e)=>({position:R(t.position,e),borders:_(t.borders)}),F=(t,e)=>({position:z(t.position,e),borders:L(t.borders)});function U(t,e,i){const n=Math.floor(i/2),s=t-n,o=[];let r=t;for(let c=e-n;c<e;c++){const n=Math.abs(c-e);let a=!0;for(let l=s;l<t;l++){const s=r,h=Math.abs(l-t),u=A(h,n);if(u!==i&&u!==i-1)continue;let d;l<s?(d=a?[!0,!1,!1,!0]:[!0,!1,!1,!1],r=l):d=l===s?[!1,!1,!1,!0]:[!0,!1,!1,!1],a=!1;const f={position:[l,c],borders:d},g=F(f,t),p=j(g,e),y=F(p,t);o.push(f,g,p,y),a=!1}}const c={position:[t,e-n],borders:i%2==0?[!0,!0,!1,!0]:[!0,!1,!1,!1]},a={position:[t-n,e],borders:i%2==0?[!0,!1,!0,!0]:[!1,!1,!1,!0]},l=j(c,e),h=F(a,t);return o.push(c,a,l,h),o}const H=(t,e)=>({index:0,buffer:[],[Symbol.iterator]:function*(){for(;this.index<t.length;)0===this.buffer.length&&(this.buffer=e(t[this.index]),++this.index),yield this.buffer.shift();for(;this.buffer.length>0;)yield this.buffer.shift();throw new Error("Unexpected end of input")}});const X=t=>Math.pow(2,t);const $=function(t){let e=0;for(let i=0;i<t.length;i++)t[i]&&(e+=X(i));return e};function G(t,e,i){const n=[];for(;t>0&&n.length<e;){const e=i(t%2==1);t=Math.floor(t/2),n.push(e)}const s=i(!1);for(;n.length<e;)n.push(s);return n}const W=(e,i)=>G(e,i,t),V=t=>W(t,8);const Y=(e,i)=>function(t,e,i){const n=[];for(const s of t){const t=G(s,e,i);n.push(...t)}return n}(e,i,t);function Z(t,e){let i=0,n=0;if(0===e)return i;for(const s of t)if(s&&(i+=X(n)),++n,n===e)return i;return i}const q=(t,e)=>{t&&++e.truesCount};function J(t,e){const i=function(t,e,i,n){const s=[];for(const o of t)if(n(o,i),s.push(o),s.length===e)return{booleans:s,stats:i};return{booleans:s,stats:i}}(t,e,{truesCount:0},q);return{booleans:i.booleans,count:i.stats.truesCount}}function K(t,e){const i=[];for(const n of t)if(i.push(n),i.length===e)return i;return i}const Q=t=>Math.ceil(Math.log2(t+1));const tt=(t,e)=>function(t,e,i){const n=Z(t,e),s=[];for(let e=0;e<n;e++){const e=K(t,i),n=$(e);s.push(n)}return s}(t,e,8),et=new TextEncoder,it=new TextDecoder("utf-8");function nt(t,e){const i=X(e)-1,n=(t=>et.encode(t))(t);if(n.length<=i){return W(n.length,e).concat((t=>Y(t,8))(n))}throw new Error(`Max string size exceeded. ${n.length} > ${i}`)}function st(t,e){return(t=>{const{buffer:e}=new Uint8Array(t);return it.decode(e)})(tt(t,e))}const ot=(t,e=0)=>{const i=Math.pow(2,t)+e-1;return{read:i=>Z(i,t)+e,write:n=>{if(n>i)throw new Error("Overflow error");return W(n-e,t)}}};function rt(t,e){let i=t%e;return i<0&&(i+=e),~~i}const ct=(t,e,i,n)=>[rt(t,i),rt(e,n)],at=()=>({city:null,terrain:u.GRASSLAND}),lt=()=>Object.assign(Object.assign({},at()),{influencedBy:null}),ht=(t,e)=>w(e,t,at),ut=t=>10*t+Math.pow(t-1,2);const dt=(t,e)=>P(e,(([e,{read:i}])=>[e,i(t)]));const ft=(gt=6,{read:t=>st(t,gt),write:t=>nt(t,gt)});var gt;const pt=t=>[["id",{write:e=>W(e,t),read:e=>Z(e,t)}],["name",ft]],yt=(t,e,i)=>{const n=((t,e,i,n)=>e.map((e=>D(t,e,i,n))))(t.position,t.influencedPositions,e,i),[s,o,r,c]=function(t){const[e,i]=t[0];let n=e,s=i,o=e,r=i;for(const[e,i]of t)e<n&&(n=e),i<s&&(s=i),e>o&&(o=e),i>r&&(r=i);return[n,s,o,r]}(n),a=r-s+1,l=c-o+1,h=k(Math.abs(s),Math.abs(o),a),u=n.map((([t,e])=>k(t-s,e-o,a))),d=a*l,f=[],g=[];for(let e=0;e<d;e++){const i=u.indexOf(e),n=i>=0;if(f.push(n),n){const e=t.influencedPositions[i],n=E(t.assignmentsPositions,e,N);g.push(n)}}return{width:a,height:l,cityIndex:h,influence:f,assignments:g,influenceSize:t.influencedPositions.length}},mt=ot(3,3),wt=ot(7);const Et=(t,e)=>t===e?0:Q(ut(t));function Tt(e,i){const n=[];return function(t,e,i){for(const[n,{write:s}]of i){const i=s(t[n]);e.push(...i)}}(e,n,pt(i)),n.push(...function(t){const{width:e,height:i}=t;return[...mt.write(e),...mt.write(i),...W(t.cityIndex,Q(e*i)),...t.influence,...t.assignments]}(e.workArea),...W(e.growthProgress,Et(b(e.workArea.assignments,t),e.workArea.influenceSize)),...wt.write(e.expandingProgress)),n}function Pt(t,e){const i=((t,e,i)=>{const n=yt(t,e,i);return{id:t.id,name:t.name,workArea:n,population:t.assignmentsPositions.length,growthProgress:t.growthProgress,expandingProgress:t.expandingProgress}})(t,e.width,e.height);return Tt(i,e.cityIdSize)}function bt(t,e,i){const n=function(t,e){const{id:i,name:n}=dt(t,pt(e)),s=mt.read(t),o=mt.read(t),r=s*o,c=Z(t,Q(r)),{booleans:a,count:l}=J(t,r),{booleans:h,count:u}=J(t,l);return{id:i,name:n,workArea:{width:s,height:o,cityIndex:c,influence:a,assignments:h,influenceSize:l},growthProgress:Z(t,Et(u,l)),expandingProgress:wt.read(t)}}(t,i.cityIdSize);return function(t,e,i,n){const s=[],{width:o,height:r}=t.workArea,c=o*r,[a,l]=I(t.workArea.cityIndex,o),[h,u]=[e[0]-a,e[1]-l];for(let e=0;e<c;e++)if(t.workArea.influence[e]){const[t,r]=I(e,o),[c,a]=ct(t+h,r+u,i,n);s.push([c,a])}const d=[];for(let e=0;e<t.workArea.assignments.length;e++)t.workArea.assignments[e]&&d.push(s[e]);return{id:t.id,name:t.name,influencedPositions:s,position:e,assignmentsPositions:d,growthProgress:t.growthProgress,expandingProgress:t.expandingProgress}}(n,e,i.width,i.height)}const xt=function(t,e){const i=[];return function(t,e){Object.keys(t).forEach((i=>{e(t[i],i)}))}(t,((t,n)=>{const s=e(n,t);i.push(s)})),i}({NORTH:[0,-1],NORTH_EAST:[1,-1],EAST:[1,0],SOUTH_EAST:[1,1],SOUTH:[0,1],SOUTH_WEST:[-1,1],WEST:[-1,0],NORTH_WEST:[-1,-1]},(function(t,e){const[i,n]=e;return{name:t,offset:e,isAxial:0===i||0===n}})),St=xt.reduce(((t,e)=>Object.assign(Object.assign({},t),{[e.name]:e})),{});var Ct=Object.assign({members:xt,axial:xt.filter((t=>t.isAxial)),diagonal:xt.filter((t=>!t.isAxial))},St);const Mt=[1,2];function At(t,e,i){const[n,s]=t,o=new Map,r=B.reduce(((t,[e,r])=>{const c=n+e,a=s+r,{influencedBy:l}=i.get(c,a);return l?(Math.abs(e)+Math.abs(r)===1&&o.set(l.id,l),t+i.getOctileDistance(n,s,c,a)):t}),0),[c,a]=e.city.position;return Math.ceil(36*(i.getOctileDistance(n,s,c,a)-2)/(Math.sqrt(r)*o.size))}function vt([t,e],i,n){const[s,o]=i.city.position,[r,c]=function(t,e,i,n,s,o){const r=O(i,t,s),c=O(n,e,o),a=Math.sign(r),l=Math.sign(c),h=Math.abs(r),u=Math.abs(c);let d=h-u,f=i,g=n;const p=2*d;return p>-u&&(d-=u,f+=a),p<h&&(d+=h,g+=l),[f,g]}(s,o,t,e,n.width,n.height);return!!n.influencedByCity(r,c,i.city)&&(!!Ct.diagonal.some((({offset:[i,s]})=>n.get(t+i,e+s).influencedBy))&&(!!Ct.axial.some((({offset:[i,s]})=>n.get(t+i,e+s).influencedBy))&&n.getOctileDistance(t,e,s,o)<=7))}function It(t){const{grid:e}=t.city,i=function(t,e){const i=[];for(const[n,s]of t)for(const{offset:[t,o]}of Ct.axial){const r=n+t,c=s+o,a=e.getPosition(r,c);null!==e.get(r,c).influencedBy||E(i,a,N)||i.push(a)}return i}(t.positions,e),n=[];for(const s of i)if(vt(s,t,e)){const i=At(s,t,e),[o,r]=s;n.push({weight:i,position:s,food:Mt[e.get(o,r).terrain]})}return n}function kt(t,e,i,n){return((t,e)=>t.slice().sort(e))(e,((e,s)=>function(t,e,i,n,s){const[o,r]=D(t,e,n,s),[c,a]=D(t,i,n,s),l=A(Math.abs(o),Math.abs(r)),h=A(Math.abs(c),Math.abs(a));return l!==h?l-h:r!==a?r-a:o-c}(t,e,s,i,n)))}class Ot{constructor(t,e){this.grid=t.grid,this.positions=kt(t.position,e.influencedPositions,this.grid.width,this.grid.height),this.city=t,this.expandingProgress=e.expandingProgress,this.tilesToExpand=[],this.place()}static getStartInfluencePositions(t,e){const[i,n]=t;return kt(t,Ct.members.map((({offset:[t,s]})=>e.getPosition(i+t,n+s))).concat([t]),e.width,e.height)}getExpandingPoints(){return((t,e)=>{const i=Math.ceil(t/2);return e>=i?e-i+1:0})(this.positions.length,this.city.population)}turn(){const t=this.getNextTileToExpand();if(null===t)return null;this.expandingProgress+=this.getExpandingPoints();const e=this.expandingProgress-t.weight;return e>=0?(this.expandingProgress=e,{type:"BORDERS_EXPANDED",payload:{city:this.city,position:t.position}}):null}place(){for(const[t,e]of this.positions)this.grid.set(t,e,{influencedBy:this.city})}remove(){this.positions.forEach((([t,e])=>{this.grid.get(t,e).influencedBy=null}))}getNextTileToExpand(){const{tilesToExpand:t}=this;if(0===t.length)return null;let e=t[0];for(let i=1;i<t.length;i++){const n=t[i];(n.weight<e.weight||n.weight===e.weight&&n.food>e.food)&&(e=n)}return e}getPositionsToExpand(){return It(this)}canExpandToTile(t,e){return this.getPositionsToExpand().some((({position:[i,n]})=>i===t&&n===e))}addTile(t,e,i=this.city){const n=[t,e];if(!E(this.positions,n,y)){this.grid.addInfluence(t,e,i);const{positions:s}=this;s.push(n),this.positions=kt(this.city.position,s,this.grid.width,this.grid.height),this.city.assignments.recalculate()}}expandToTile(t,e){this.addTile(t,e)}}class Dt{constructor(t,e,i){this.positions=t,this.influence=e,this.grid=i}static getDefaultPositions(t,e,n,s=1){const o=m(s,i),r=[];for(;s-- >0;){let i,s=0,c=0;for(let r=0;r<e.length;r++){if(o[r])continue;const a=e[r];if(N(a,t))continue;const[l,h]=a,u=n.get(l,h),d=Mt[u.terrain];d>s&&(s=d,c=r,i=a)}r.push(i),o[c]=!0}return r}recalculate(){const t=Dt.getDefaultPositions(this.influence.city.position,this.influence.positions,this.grid,this.influence.city.population),e=function(t,e,i=n){const s=T(t,e,i),o=T(e,t);return s.concat(o)}(this.positions,t);return this.positions=t,e}onPopulationChanged(t){this.positions=Dt.getDefaultPositions(this.influence.city.position,this.influence.positions,this.grid,t)}getFreePositionsCount(){return b(this.influence.positions,(t=>!y(t,this.influence.city.position)&&!E(this.positions,t,y)))}getFoodPerTurn(){const[t,e]=this.influence.city.position,i=Mt[this.grid.get(t,e).terrain];return this.positions.reduce(((t,e)=>{if(!this.influence.positions.some((t=>N(t,e))))return t;const[i,n]=e;return t+Mt[this.grid.get(i,n).terrain]}),i)}}const Nt=["POPULATION_INCREASED","BORDERS_EXPANDED"].reduce(((t,e)=>Object.assign(Object.assign({},t),{[e]:e})),{});class Bt{constructor(t,e){this.position=t.position,this.name=t.name,this.id=t.id,this.grid=e;const[i,n]=t.position;e.set(i,n,{city:this}),this.influence=new Ot(this,t),this.assignments=new Dt(t.assignmentsPositions,this.influence,e),this.growthProgress=t.growthProgress,this.assignments.getFreePositionsCount()>0?this.foodBasketSize=this.getFoodBasketSize():this.foodBasketSize=0}static found(t,e,i=0,n=""){const s=Ot.getStartInfluencePositions(e,t);return new Bt({position:e,influencedPositions:s,assignmentsPositions:Dt.getDefaultPositions(e,s,t),growthProgress:0,expandingProgress:0,name:n,id:i},t)}get population(){return this.assignments.positions.length}get influencedPositions(){return this.influence.positions}get assignmentsPositions(){return this.assignments.positions}get expandingProgress(){return this.influence.expandingProgress}updateExpansionProgress(){return this.influence.turn()}onTurn(){const t=[],e=this.assignments.getFreePositionsCount();if(0===e)return t;const i=this.getFoodBasketSize();this.growthProgress+=this.assignments.getFoodPerTurn()-2*this.population;const n=this.growthProgress-i;if(n>=0){this.assignments.onPopulationChanged(this.population+1),e>1?(this.growthProgress=n,this.foodBasketSize=this.getFoodBasketSize()):(this.growthProgress=0,this.foodBasketSize=0);const i=((t,e={})=>({type:t,payload:e}))(Nt.POPULATION_INCREASED,{city:this});t.push(i)}else this.growthProgress;return t}remove(){this.influence.remove()}getFoodBasketSize(){return ut(this.population)}}class Rt{constructor(t){this.tiles=t}static createEmptyGrid(t,e){const i=((t,e)=>w(e,t,lt))(t,e);return new Rt(i)}static createTileFromTileData(t){return{city:null,influencedBy:null,terrain:t.terrain}}static createFromTilesData(t){const e=[],i=new Rt(e);for(let i=0;i<t.length;i++){const n=[];for(let e=0;e<t[0].length;e++){const s=Rt.createTileFromTileData(t[i][e]);n.push(s)}e.push(n)}return i}getPosition(t,e){return ct(t,e,this.width,this.height)}getIndexByPosition(t,e){return t+e*this.width}get(t,e){const[i,n]=this.getPosition(t,e);return this.tiles[n][i]}set(t,e,i){const[n,s]=this.getPosition(t,e),o=this.tiles[s][n],r=Object.assign(Object.assign({},o),i);return this.tiles[s][n]=r,r}forEachTile(t){for(let e=0;e<this.height;e++)for(let i=0;i<this.width;i++){t(this.get(i,e),i,e,this)}}getOctileDistance(t,e,i,n){const s=Math.abs(O(t,i,this.width)),o=Math.abs(O(e,n,this.height));return A(s,o)}influencedByCity(t,e,i){return this.get(t,e).influencedBy===i}influencedByAnotherCity(t,e,i){const{influencedBy:n}=this.get(t,e);return null!==n&&n!==i}addInfluence(t,e,i){this.get(t,e).influencedBy=i}get width(){return this.tiles[0].length}get height(){return this.tiles.length}}function zt(t){const{weight:e,city:i}=t;return(e-i.expandingProgress)/i.influence.getExpandingPoints()}function _t(t){let e=t[0],i=zt(e);for(let n=1;n<t.length;n++){const s=t[n],o=zt(s);if(o<i)i=o,e=s;else if(o===i){const t=s.city.influence.tilesToExpand.filter((t=>zt(Object.assign(Object.assign({},t),{city:s.city}))<=i)).length,n=e.city.influence.tilesToExpand.filter((t=>zt(Object.assign(Object.assign({},t),{city:e.city}))<=i)).length;(t<n||t===n&&s.city.id<e.city.id)&&(e=s)}}return e}class Lt{constructor(t,e){this.citiesInfluences=e,this.grid=t,this.positionsToExpand=new Map}turn(){this.positionsToExpand.clear(),this.citiesInfluences.forEach((t=>{t.tilesToExpand=[],this.collectPositionsToExpand(t)}));for(const t of this.positionsToExpand.values()){const e=_t(t);e.city.influence.tilesToExpand.push(e)}}addInfluence(t){this.citiesInfluences.push(t),this.turn()}collectPositionsToExpand(t){if(0===t.getExpandingPoints())return;t.getPositionsToExpand().forEach((e=>{const[i,n]=e.position,s=this.grid.getIndexByPosition(i,n),o=Object.assign(Object.assign({},e),{city:t.city}),r=this.positionsToExpand.get(s);r?r.push(o):this.positionsToExpand.set(s,[o])}))}}class jt{constructor(t,e,i,n){this.grid=t,this.cities=e,this.turnNumber=i,this.nextCityId=n,this.influence=new Lt(t,e.map((t=>t.influence)))}static createEmptyWorld(t,e){const i=this.getEmptyWorldData(t,e);return jt.fromData(i)}static fromData(t){const e=Rt.createFromTilesData(t.tiles),i=this.createCities(t.cities,e);return new jt(e,i,t.turnNumber,t.nextCityId)}turn(){this.turnNumber===jt.MAX_TURN_NUMBER&&(console.warn("Max turns reached"),this.turnNumber=1);const t=[],e=[];return this.influence.turn(),this.cities.forEach((i=>{const n=i.updateExpansionProgress(),s=i.onTurn();n&&e.push(n),t.push(...s)})),e.forEach((t=>{t.payload.city.influence.expandToTile(...t.payload.position)})),++this.turnNumber,[...t,...e]}placeTerrain(t,e,i){const n=this.grid.get(t,e),s=[];n.terrain=i;const o=n.influencedBy;return o&&s.push(...o.assignments.recalculate()),s}placeCity(t,e){if(i=this.grid,n=this.cities,s=[t,e],!n.every((t=>{const[e,n]=D(t.position,s,i.width,i.height);return A(Math.abs(e),Math.abs(n))>=9})))return null;var i,n,s;const o=Bt.found(this.grid,[t,e],this.nextCityId,function(t){const e=[];do{const i=t%26;t=Math.floor(t/26),e.push(String.fromCharCode(i+65))}while(t>0);return e.join("")}(this.nextCityId));return this.nextCityId++,this.cities.push(o),this.influence.addInfluence(o.influence),o}removeCity(t){this.cities=this.cities.filter((e=>e!==t)),this.grid.get(...t.position).city=null,t.influence.remove()}get width(){return this.grid.width}get height(){return this.grid.height}}jt.MAX_TURN_NUMBER=Math.pow(2,16),jt.getEmptyWorldData=(t,e)=>({tiles:ht(t,e),cities:[],turnNumber:1,nextCityId:0}),jt.createCities=(t,e)=>t.map((t=>new Bt(t,e))).sort(((t,e)=>t.id-e.id));const Ft=Q(jt.MAX_TURN_NUMBER-1),Ut=ot(8,13),Ht=[["width",Ut],["height",Ut],["turnNumber",ot(Ft,1)]],Xt=ot(16),$t=ot(3),Gt=t=>Z(t,5);function Wt(t){const e=Xt.write(0),i={};for(const[n,s]of Ht){const o=t[n];i[n]=o,e.push(...s.write(o))}var n,s;return i.cityIdSize=(n=t.nextCityId)>0?Q(n-1):0,e.push(...(s=i.cityIdSize,W(s,5))),{output:e,attributes:i}}function Vt(t){const{output:e,attributes:i}=Wt(t);return t.grid.forEachTile((t=>{e.push(...function(t,e){const i=$t.write(t.terrain),{city:n}=t;if(!n)return[!1,...i];return[!0,...Pt(n,e),...i]}(t,i))})),e}function Yt(t,e,i){const[n]=t;if(!n){return{city:null,terrain:$t.read(t)}}return{city:bt(t,e,i),terrain:$t.read(t)}}function Zt(t){const e=(t=>H(t,V))(t);var i;i=e,Xt.read(i);const n=function(t){return Object.assign(Object.assign({},dt(t,Ht)),{cityIdSize:Gt(t)})}(e),{tiles:s,cities:o}=function(t,e){const i=[],n=[];for(let s=0;s<e.height;s++){const o=[];for(let n=0;n<e.width;n++){const r=Yt(t,[n,s],e);r.city&&i.push(r.city),o.push(r)}n.push(o)}return{tiles:n,cities:i}}(e,n),r=o.length>0?function(t,e){let i=t[0];for(let n=1;n<t.length;n++){const s=t[n];e(s,i)&&(i=s)}return i}(o,((t,e)=>t.id>e.id)).id+1:0;return{cities:o,tiles:s,turnNumber:n.turnNumber,nextCityId:r}}function qt(t,e){const i=t.toString();if(i.length>=e)return i;const n=e-i.length;return"0".repeat(n)+i}const Jt=t=>qt(t,2),Kt=t=>qt(t.getMilliseconds(),3),Qt=t=>`${((t,e="-")=>[t.getFullYear(),Jt(t.getMonth()+1),Jt(t.getDate())].join(e))(t)} ${((t,e=".")=>[Jt(t.getHours()),Jt(t.getMinutes()),Jt(t.getSeconds())].join(e))(t)}.${Kt(t)}`;class te{constructor(t,e=te.DEFAULT_TILE_SIZE){this.selectedCity=null,this.viewportPosition=[0,0],this.eventHandlers={[Nt.POPULATION_INCREASED]:({city:t})=>{this.drawAssignmentsMarks(t)},[Nt.BORDERS_EXPANDED]:({city:t,position:e})=>{const[i,n]=e;this.drawTile(i,n),Ct.members.forEach((({offset:[t,e]})=>{this.drawTile(i+t,n+e)})),this.selectedCity&&(this.clearMaxCityBorders(),this.drawMaxCityBorders()),t.influence.positions.forEach((([t,e])=>{this.drawTile(t,e)}))}},this.update(t),this.tileSize=e,this.width=t.grid.width*e,this.height=t.grid.height*e,this.bordersRender=function(t){const e=(t=>[[0,0,t,1],[t-1,0,1,t],[0,t-1,t,1],[0,0,1,t]])(t);return(t,i,n,s)=>{e.filter(((t,e)=>s[e])).forEach((([e,s,o,r])=>{t.fillRect(i+e,s+n,o,r)}))}}(e)}static getLayerId(t){return te.LAYER_ID_PREFIX+t}handleEvent(t){this.eventHandlers[t.type](t.payload)}update(t){this.world=t,this.grid=this.world.grid}createLayer(t){const e=c("canvas",{id:te.getLayerId(t),width:this.width,height:this.height});return this.layersContainer.appendChild(e),e.getContext("2d")}mount(t){this.layersContainer=c("div",{id:"layers",style:{width:this.width+"px",height:this.height+"px"}}),this.layers=P(te.LAYERS_NAMES,(t=>[t,this.createLayer(t)])),function(t,e){t.fillStyle="#555";const{width:i,height:n}=t.canvas;for(let s=e;s<i;s+=e)t.fillRect(s,0,1,n);for(let s=e;s<n;s+=e)t.fillRect(0,s,i,1)}(this.layers.grid,this.tileSize),t.appendChild(this.layersContainer)}addMouseMoveHandler(t){let e=null;this.layersContainer.addEventListener("mousemove",(i=>{const n=C(i);if(null===n)return t(null),void(e=null);const[s,o]=n,r=this.getTilePosition(s,o);N(r,e)||(t(r),e=r)})),this.layersContainer.addEventListener("mouseleave",(()=>{t(null)}))}canCapture(t,e){return!!this.selectedCity&&this.selectedCity.influence.canExpandToTile(t,e)}captureTile(t,e){this.selectedCity.influence.expandToTile(t,e),this.drawTile(t,e),Ct.members.forEach((({offset:[i,n]})=>{this.drawTile(t+i,e+n)}))}clearPositionsToExpand(){const t=this.selectedCity.influence.getPositionsToExpand();for(const{position:[e,i]}of t)this.drawTile(e,i)}drawMaxCityBorders(){const[t,e]=this.selectedCity.position,i=U(t,e,7);this.layers.selection.fillStyle="#333",i.forEach((t=>{const[e,i]=this.toCanvasPosition(...t.position);this.bordersRender(this.layers.selection,e,i,t.borders)}))}clearMaxCityBorders(){const[t,e]=this.selectedCity.position;U(t,e,7).forEach((t=>{const[e,i]=this.toCanvasPosition(...t.position);this.layers.selection.clearRect(e,i,this.tileSize,this.tileSize)}))}selectCity(t){this.unselectCity(),this.selectedCity=t,this.drawMaxCityBorders()}unselectCity(){this.selectedCity&&(this.clearPositionsToExpand(),this.clearMaxCityBorders(),this.selectedCity=null)}draw(){this.grid.forEachTile(((t,e,i)=>{this.drawTile(e,i)}))}fillTile(t,e,i){this.layers.main.fillStyle=i,this.layers.main.fillRect(t,e,this.tileSize,this.tileSize)}clearTile(t,e){this.layers.main.clearRect(t,e,this.tileSize,this.tileSize)}toCanvasPosition(t,e){const[i,n]=this.viewportPosition,[s,o]=this.grid.getPosition(t-i,e-n);return[s*this.tileSize,o*this.tileSize]}moveViewport(t,e){const[i,n]=this.viewportPosition;this.viewportPosition=this.grid.getPosition(i+t,n+e),[this.layers.main,this.layers.borders,this.layers.selection].forEach((i=>{if(0!==t){const e=t*this.tileSize,n=t>0?e:this.width+e,s=i.getImageData(0,0,n,this.height),o=i.getImageData(n,0,this.width-n,this.height);i.putImageData(s,this.width-n,0),i.putImageData(o,0,0)}if(0!==e){const t=e*this.tileSize,n=e>0?t:this.height+t,s=i.getImageData(0,0,this.width,n),o=i.getImageData(0,n,this.width,this.height-n);i.putImageData(s,0,this.height-n),i.putImageData(o,0,0)}}))}getTilePosition(t,e){const[i,n]=this.viewportPosition;return this.grid.getPosition(Math.floor(t/this.tileSize)+i,Math.floor(e/this.tileSize)+n)}placeTerrain(t,e,{terrain:i}){const n=this.world.placeTerrain(t,e,i);this.drawTile(t,e),n.forEach((([t,e])=>{this.drawTile(t,e)}))}drawTile(t,e){const i=this.toCanvasPosition(t,e),n=this.grid.get(t,e),[s,o]=i;this.clearTile(s,o),this.layers.borders.clearRect(s,o,this.tileSize,this.tileSize);const r=n.terrain===u.STEPPE?"#88C34A":"#388E3C";if(this.fillTile(s,o,r),this.layers.main.fillStyle="black",n.city)M(this.layers.main,S,s,o);else if(n.influencedBy){const i=[];Ct.axial.forEach((({offset:[n,s]})=>{i.push(null===this.grid.get(t+n,e+s).influencedBy)})),this.layers.borders.fillStyle="#000",this.bordersRender(this.layers.borders,s,o,i);const r=n.influencedBy,[c,a]=r.position;this.grid.get(c,a).city.assignments.positions.some((i=>N(i,[t,e])))&&this.drawAssignmentMark(s,o)}}skipTurnsUntilEvent(t=1e3){for(let e=1;e<=t;e++){const t=this.world.turn();if(t.length>0){t.forEach((t=>{this.handleEvent(t)}));break}}}turn(){const t=this.world.turn();return t.forEach((t=>{this.handleEvent(t)})),t}drawAssignmentsMarks(t){for(const e of t.influencedPositions){const[i,n]=e;if(E(t.assignmentsPositions,e,y)){const[t,e]=this.toCanvasPosition(i,n);this.drawAssignmentMark(t,e)}else this.drawTile(i,n)}}drawAssignmentMark(t,e){M(this.layers.main,x,t,e)}placeCity(t,e){const i=this.world.placeCity(t,e);i&&(i.influencedPositions.forEach((([t,e])=>{this.drawTile(t,e)})),function(t,e){const i=[];for(const[n,s]of t.influencedPositions)for(const{offset:[o,r]}of Ct.axial){const c=n+o,a=s+r,l=e.getPosition(c,a),{influencedBy:h}=e.get(c,a);null===h||h===t||E(i,l,N)||i.push(l)}return i}(i,this.grid).forEach((([t,e])=>{this.drawTile(t,e)})))}}te.DEFAULT_TILE_SIZE=24,te.LAYERS_NAMES=["main","grid","selection","borders"],te.LAYER_ID_PREFIX="layer-";const ee=function({view:t}){let e=null;const i=(({label:t,value:e})=>{const i=c("span",e,{className:"value"});return{element:c("span",{className:"field"},[c("span",{className:"label"},`${t}:`,[" ",c("span",{className:""})]),i]),update({value:t}){i.innerText=t}}})({label:"Turn",value:t.world.turnNumber.toString()}),n=c("div",{id:"view"},[i.element]);t.mount(n),t.draw();const s=c("button","Turn",{onclick:()=>{t.turn(),d(t.world.turnNumber)}}),o=c("button","Skip Turns Until Event",{onclick:()=>{t.skipTurnsUntilEvent(),d(t.world.turnNumber)}}),a=c("span","-"),{element:l}=h({label:"Grid",id:"grid",checked:!0,onToggle(t){document.getElementById("layer-grid").style.display=t?"block":"none"}}),u=(t=>{const e=f({onToggle(e){e?(i.update({checked:!1}),t(g)):t(null)},onTerrainSelected(t){g.options.terrain=t}}),i=h({label:"Place City",onToggle(i){t(i?p:null),i&&e.update({checked:!1})}});return{element:c("div",{className:"tools"},[i,e].map((t=>t.element)))}})((t=>{e=t}));t.addMouseMoveHandler((e=>{if(null===e)return void(a.innerHTML="-");let i=e.join("; ");const[n,s]=e,o=t.grid.get(n,s),{city:r}=o;if(o.influencedBy&&(i+=" "+((t,e)=>{const{name:i}=e;return E(e.assignments.positions,t,y)?`<b>${i}</b>`:i})(e,o.influencedBy)),r)i+=" "+(t=>{const e=t.foodBasketSize>0?t.growthProgress+"/"+t.foodBasketSize:"-";return["id: "+t.id,"population: "+t.population,"growth progress: "+e,"food per turn: "+t.assignments.getFoodPerTurn(),"expanding points: "+t.expandingProgress].join("; ")})(r);else if(t.selectedCity){const n=t.selectedCity.influence.getPositionsToExpand().find((({position:t})=>N(t,e)));n&&(i+=" "+n.weight)}a.innerHTML=i})),t.layersContainer.addEventListener("click",(i=>{const n=C(i),s=t.getTilePosition(...n),[o,r]=s,{city:c}=t.grid.get(o,r);c?t.selectCity(c):t.canCapture(o,r)?t.captureTile(o,r):(t.unselectCity(),e&&t[e.name](o,r,e.options))}));const d=t=>{i.update({value:t})},m=e=>{t.update(e),d(e.turnNumber),t.draw()},w=(({onSave:t,onLoad:e})=>{const i=new FileReader;i.addEventListener("loadend",(t=>{const i=new Uint8Array(t.target.result);e(i)}));const n=c("input",{type:"file",onchange(t){const e=t.target;i.readAsArrayBuffer(e.files[0]),e.value=null},style:{display:"none"}});return{element:c("div",[c("button","Load",{onclick(){n.click()}}),n,c("button","Save",{onclick:t})])}})({onSave(){const e=Vt(t.world),i=Array.from(function*(t){let e=0,i=0;for(const n of t)8===e&&(yield i,e=0,i=0),n&&(i+=X(e)),++e;e>0&&(yield i)}(e)),n=Qt(new Date),s=prompt("File Name",n);null!==s&&function(t,e){let i="";for(const t of e)i+=String.fromCharCode(t);const n=btoa(i),s=document.createElement("a");s.href="data:;base64,"+n,s.download=`${t}.save`,s.click()}(s||n,i)},onLoad(t){const e=Zt(t);m(jt.fromData(e))}});return r(n,[c("div",[a]),c("div",{className:"controls-panel"},[l,s,o,u.element,w.element])]),{element:n,view:t,update({world:t}){m(t)}}}({view:new te(jt.createEmptyWorld(32,24))});document.body.appendChild(ee.element);const ie={ArrowLeft:[-1,0],ArrowUp:[0,-1],ArrowRight:[1,0],ArrowDown:[0,1]};document.addEventListener("keydown",(t=>{const e=ie[t.code];if(e){const[t,i]=e;ee.view.moveViewport(t,i)}}))}();
