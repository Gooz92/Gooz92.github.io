!function(){"use strict";const t=()=>{},e=t=>t,i=()=>!0,n=()=>!1,s=t=>"string"==typeof t,o=t=>"function"==typeof t,r=t=>null===t||(t=>void 0===t)(t),a=(t,e)=>{const i=[];for(let n=0;n<t;n++){const t=e(n);i.push(t)}return i},l=t=>t.at(-1),c=(t,e=i)=>t.reduce(((t,i)=>e(i)?t+1:t),0),h=(t,e)=>{const i=t.indexOf(e);return-1!==i&&(d(t,i),!0)},d=(t,e)=>{t.splice(e,1)},u=t=>Array.isArray(t)?t:[t],p=t=>r(t)?null:s(t)?{type:0,text:t}:t,g=t=>{const e=[];for(const i of t)if(Array.isArray(i))e.push(...g(i));else{const t=p(i);e.push(t)}return e},m=(t,e)=>(t=>o(t.prototype?.render))(t)?((t,e)=>({type:3,Component:t,props:e,children:null}))(t,e):{type:2,component:t,props:e,children:g([t(e)])},f=(...t)=>{const[e]=t;if(s(e)){return((t,e)=>{const i=[],n={};for(const t of e)if(Array.isArray(t)){const e=g(t);i.push(...e)}else"object"==typeof t?Object.assign(n,t):i.push({type:0,text:t});return{tagName:t,type:1,children:i,attributes:n}})(e,t.slice(1))}return m(e,t[1])},y=(t,e)=>{Object.keys(t).forEach((i=>{e(t[i],i)}))},v=(t,e)=>{const i={};return y(t,((t,n)=>{const s=e(t,n);i[n]=s})),i},w=(t,e)=>({vNode:t,parentElement:e.parentElement,prevSibling:e.currentSibling,nextSibling:null,element:document.createTextNode(t.text)}),x=t=>{const e={vNode:null,parentElement:t.parentElement,prevSibling:t.currentSibling,nextSibling:null};return t.currentSibling&&(t.currentSibling.nextSibling=e),t.currentSibling=e,e},b=(t,e)=>{const i=document.createElement(t.tagName),n={vNode:t,parentElement:e.parentElement,prevSibling:e.currentSibling,nextSibling:null,element:i,children:[]},s=e.parentElement;e.parentElement=i;const r=e.currentSibling;return e.currentSibling=null,P(n,e),e.parentElement=s,r&&(r.nextSibling=n),e.currentSibling=n,y(t.attributes,((t,e)=>{"ref"===e?o(t)?t(i):t.value=i:i[e]=t})),n},S=(t,e)=>C(t,e,M),P=(t,e)=>C(t,e,U),C=(t,e,i)=>{t.children=t.vNode.children.map((t=>i(t,e)))},T=t=>{const e=new t.Component(t.props);return t.children=g(u(e.render())),{vNode:t,component:e,children:null}},I=(t,e)=>{const i=T(t);return P(i,e),i.component.$mount(i),i},E=(t,e)=>{const i={vNode:t,children:null};return P(i,e),i},M=(t,e)=>null===t?x(e):N[t.type](t,e),N=[w,b,(t,e)=>{const i={vNode:t,children:null};return S(i,e),i},(t,e)=>{const i=T(t);return S(i,e),i.component.$mount(i),i}],U=(t,e)=>null===t?x(e):B[t.type](t,e),B=[(t,e)=>{const i=w(t,e);return e.parentElement.appendChild(i.element),i},(t,e)=>{const i=b(t,e);return e.parentElement.appendChild(i.element),i},E,I],A=t=>Boolean(t.element),O=(t,e)=>{const i=[t];for(;i.length>0;){const t=i.shift();$(t)||(A(t)?e(t):i.push(...t.children))}return[]},D=t=>{const e=document.createDocumentFragment();return O(t,(({element:t})=>{e.appendChild(t)})),e},j=({element:t})=>{t.remove()},k=t=>{O(t,j)},R=t=>null===t.vNode||A(t),z=t=>{for(;!R(t);)t=t.children[0];return t},L=t=>{for(;!R(t);)t=l(t.children);return t},F=t=>{do{if(null===(t=t.nextSibling))return null}while(!A(t));return t.element},H=[(t,e)=>(t.element.textContent!==e.text&&(t.element.textContent=e.text,t.vNode=e),t),(t,e)=>t.vNode.tagName!==e.tagName?_(t,e):(((t,e)=>{Object.assign(t.element,e.attributes)})(t,e),Y(t,e.children),t),(t,e)=>t.vNode.component!==e.component?_(t,e):(Y(t,e.children),t),(t,e)=>{t.vNode.Component,e.Component,t.component.props=e.props;const i=g(u(t.component.render()));return Y(t,i),t}],W=(t,e)=>t.vNode===e?t:t.vNode.type!==e.type?_(t,e):((t,e)=>H[e.type](t,e))(t,e),_=(t,e)=>{const i=z(t),n=L(t),s=F(n);k(t);const o={parentElement:i.parentElement,currentSibling:i.prevSibling},r=M(e,o),a=D(r);return i.parentElement.insertBefore(a,s),o.currentSibling.nextSibling=n.nextSibling,r},$=t=>null===t.vNode,G=(t,e)=>{const i={parentElement:t.parentElement,currentSibling:t.prevSibling},n=M(e,i),s=F(t),o=D(n);return t.parentElement.insertBefore(o,s),t.nextSibling&&(i.currentSibling.nextSibling=t.nextSibling,t.nextSibling.prevSibling=i.currentSibling),n},X=t=>{k(t);const e=z(t),i=L(t),n={parentElement:e.parentElement,currentSibling:e.prevSibling},s=x(n);return n.currentSibling.nextSibling=i.nextSibling,s},Y=(t,e)=>{for(let i=0;i<t.children.length;i++){const n=t.children[i],s=e[i];if($(n)){if(null!==s){const e=G(n,s);t.children[i]=e,t.vNode.children[i]=e.vNode}}else if(null!==s){const e=W(n,s);t.children[i]=e,t.vNode.children[i]=e.vNode}else{const e=X(n);t.children[i]=e,t.vNode.children[i]=null}}};class K{constructor(t){this.props=t,this.node=null,this.state=this.getInitialState()}setState(t){let e=!1;if(y(t,((t,i)=>{Object.is(this.state[i],t)||(e=!0,this.state[i]=t)})),e&&this.isMounted){const t=this.render();((t,e)=>{const i=g(u(e));Y(t,i)})(this.node,t)}}getInitialState(){return{}}$mount(t){this.node=t,this.onMounted()}get isMounted(){return null!==this.node}onMounted(){}}const Q=new Image;var V=[{id:1,name:"worker",movePoints:6,military:!1},{id:2,name:"warrior",movePoints:6,military:!0},{id:3,name:"settler",movePoints:6,military:!1}];const q=[{id:1,name:"grassland",dryLand:!0},{id:2,name:"steppe",dryLand:!0},{id:3,name:"sea",dryLand:!1}],[J,Z,tt]=q,et=V,it=[{productId:1,cost:2},{productId:2,cost:5},{productId:3,cost:8}],nt=q[0],st=(t=nt)=>({city:null,unit:null,terrain:t}),ot=(t,e,i)=>e*i+t,rt=(t,e)=>{let i=t%e;return i<0&&(i+=e),~~i},at=(t,e,i,n)=>[rt(t,i),rt(e,n)],lt=(t,e)=>[t%e,Math.floor(t/e)],ct=(t,e,i)=>{const n=e-t,s=i/2;return Math.abs(n)<=s?n:n>0?n-i:i+n},ht=(t,e,i,n)=>e.map((e=>((t,e,i,n)=>{const[s,o]=t,[r,a]=e;return[ct(s,r,i),ct(o,a,n)]})(t,e,i,n))),dt=(t,e,i,n)=>{const s=Math.abs(t-i),o=Math.abs(e-n);return gt(s,o)},ut=2,pt=t=>t?ut:3,gt=(t,e)=>3*Math.min(t,e)+ut*Math.abs(t-e),mt=(t,e)=>{if(t===e)return!0;if(!t||!e)return!1;const[i,n]=t,[s,o]=e;return i===s&&n===o},ft=(t,e)=>t.some((t=>mt(t,e))),yt=(t=>{const e=Math.floor(t/ut),i=[],n=t-2;for(let t=-e;t<=e;t++)for(let s=-e;s<=e;s++){if(0===s&&0===t)continue;const e=[s,t];for(let o=dt(0,0,s,t)-2;o<=n;o++){const t=i[o];t?t.push(e):i[o]=[e]}}return i})(7)[5],vt=([t,e],i)=>[t,2*i-e],wt=([t,e],i)=>[2*i-t,e],xt=([t,e,i,n])=>[i,e,t,n],bt=([t,e,i,n])=>[t,n,i,e],St=(t,e)=>({position:vt(t.position,e),borders:xt(t.borders)}),Pt=(t,e)=>({position:wt(t.position,e),borders:bt(t.borders)});var Ct=((t,e,i)=>{const n={members:[]};return y(t,((t,i)=>{const s={name:i,...e(t)};n.members.push(s),n[i]=s})),i&&Object.assign(n,i(n)),n})({NORTH:[0,-1],NORTH_EAST:[1,-1],EAST:[1,0],SOUTH_EAST:[1,1],SOUTH:[0,1],SOUTH_WEST:[-1,1],WEST:[-1,0],NORTH_WEST:[-1,-1]},(t=>{const[e,i]=t;return{dx:e,dy:i,offset:t,isOrthogonal:0===e||0===i}}),(t=>({orthogonal:t.members.filter((t=>t.isOrthogonal)),diagonal:t.members.filter((t=>!t.isOrthogonal)),fromOffsets:(e,i)=>t.members.find((t=>t.dx===e&&t.dy===i))||null})));class Tt{constructor(t,e){this.width=t,this.height=e}getPosition(t,e){return at(t,e,this.width,this.height)}getPositionByIndex(t){return lt(t,this.width)}getIndexesByPositions(t){return t.map((([t,e])=>this.getIndexByPosition(t,e)))}getIndexByPosition(t,e){return ot(t,e,this.width)}getOffsets(t,e){const[i,n]=t,[s,o]=e;return[ct(i,s,this.width),ct(n,o,this.height)]}getDirection(t,e){const[i,n]=this.getOffsets(t,e);return Ct.fromOffsets(i,n)}getCirclePositions(t,e,i){const n=Math.floor(i/ut),s=[];for(let o=-n;o<=n;o++)for(let r=-n;r<=n;r++){const n=this.getPosition(t+r,e+o),[a,l]=n;this.getOctileDistance(a,l,t,e)<=i&&s.push(n)}const o=[t,e];return s.sort(((t,e)=>this.comparePositions(o,t,e)))}getNextLinePosition(t,e){const[i,n]=this.getOffsets(t,e),s=Math.sign(i),o=Math.sign(n),r=Math.abs(i),a=Math.abs(n);let l=r-a,[c,h]=t;const d=2*l;return d>-a&&(l-=a,c+=s),d<r&&(l+=r,h+=o),[c,h]}comparePositions(t,e,i){const[n,s]=this.getOffsets(t,e),[o,r]=this.getOffsets(t,i),a=gt(Math.abs(n),Math.abs(s)),l=gt(Math.abs(o),Math.abs(r));return a!==l?a-l:s!==r?s-r:n-o}sortPositions(t,e){return e.toSorted(((e,i)=>this.comparePositions(t,e,i)))}isAdjacentPositionsIndexes(t,e){const i=this.getPositionByIndex(t),n=this.getPositionByIndex(e);return this.isAdjacentPositions(i,n)}isAdjacentPositions(t,e){const[i,n]=this.getOffsets(t,e),s=Math.abs(i),o=Math.abs(n);return 1===s&&1===o||0===s&&1===o||1===s&&0===o}getOctileDistance(t,e,i,n){const[s,o]=this.getOffsets([t,e],[i,n]);return gt(Math.abs(s),Math.abs(o))}}class It extends Tt{constructor(t,e){super(e,t.length/e),this.tiles=t}get(t,e){const[i,n]=this.getPosition(t,e),s=this.getIndexByPosition(i,n);return this.tiles[s]}getTileFood(t,e){return(t=>t.terrain===J?2:1)(this.get(t,e))}influencedByCity(t,e,i){return this.get(t,e).influencedBy===i}addInfluence(t,e,i){this.get(t,e).influencedBy=i}}It.createTileFromTileData=t=>((t=nt)=>({...st(t),influencedBy:null}))(t.terrain),It.createFromTilesData=(t,e)=>new It(t.map(It.createTileFromTileData),e);const Et=t=>10*t+(t-1)**2;var Mt=["populationIncreased","bordersExpanded","unitCompleted","unitMoved","moveCanceled","combat","unitKilled","cityPillaged","cityDestroyed"].reduce(((t,e)=>({...t,[e]:t=>({type:e,payload:t})})),{});const Nt=(t,e)=>({index:0,buffer:[],*[Symbol.iterator](){for(;this.index<t.length;)0===this.buffer.length&&(this.buffer=e(t[this.index]),++this.index),yield this.buffer.shift();for(;this.buffer.length>0;)yield this.buffer.shift();throw new Error("Unexpected end of input")}}),Ut=t=>{let e=0;for(let i=0;i<t.length;i++)t[i]&&(e+=2**i);return e},Bt=(t,e,i)=>{const n=[];for(;t>0&&n.length<e;){const e=i(t%2==1);t=Math.floor(t/2),n.push(e)}const s=i(!1);for(;n.length<e;)n.push(s);return n},At=(t,i)=>Bt(t,i,e),Ot=t=>At(t,8),Dt=(t,i)=>((t,e,i)=>{const n=[];for(const s of t){const t=Bt(s,e,i);n.push(...t)}return n})(t,i,e);const jt=(t,e)=>t<<15|e,kt=(t,e)=>{let i=0,n=0;if(0===e)return i;for(const s of t)if(s&&(i+=2**n),++n,n===e)return i;return i},Rt=(t,e)=>{t&&++e.truesCount},zt=(t,e,i,n)=>{const s=[];for(const o of t)if(n(o,i),s.push(o),s.length===e)return{booleans:s,stats:i};return{booleans:s,stats:i}},Lt=(t,e)=>{const i=[];for(const n of t)if(i.push(n),i.length===e)return i;return i},Ft=t=>Math.ceil(Math.log2(t+1)),Ht=(t,e)=>((t,e,i)=>{const n=[];for(let s=0;s<e;s++){const e=Lt(t,i),s=Ut(e);n.push(s)}return n})(t,e,8);class Wt{static getStartInfluencePositions(t,e,i=3){const[n,s]=t;return e.getCirclePositions(n,s,i).filter((([t,i])=>!e.get(t,i).influencedBy))}constructor(t,e){this.city=t,this.tileToExpand=null,this.positions=this.grid.sortPositions(t.position,e.influencedPositions),this.expandingProgress=e.expandingProgress,this.place()}getFreeTilesCount(){const[t,e]=this.city.position;return c(yt,(([i,n])=>{const{influencedBy:s}=this.grid.get(t+i,e+n);return null===s}))}getTileExpansionCost(t){const[e,i]=t;let n=0;for(const{dx:t,dy:s}of Ct.members){const o=e+t,r=i+s,{influencedBy:a}=this.grid.get(o,r);a&&(n+=6/this.grid.getOctileDistance(o,r,e,i))}const[s,o]=this.city.position,r=this.grid.getOctileDistance(s,o,e,i)-3;return Math.round(160/n+r**2)}getTilesToExpand(){const t=this.getNextFrontierPositions(),e=[];for(const i of t)if(this.canExpandToPosition(i)){const t=this.getTileExpansionCost(i);e.push({position:i,turnsToExpand:t/this.getExpandingPoints(),cost:t})}return e.sort(((t,e)=>this.compareTilesToExpand(t,e)))}compareTilesToExpand(t,e){const i=t.cost-e.cost;if(0!==i)return i;const[n,s]=t.position,[o,r]=e.position,a=this.grid.getTileFood(n,s);return this.grid.getTileFood(o,r)-a}getExpandingPoints(){return((t,e)=>{const i=Math.ceil(t/2);return e>=i?e-i+1:0})(this.positions.length,this.city.population)}expand(){const{position:t}=this.tileToExpand;this.tileToExpand=null;const[e,i]=t;return this.addTile(e,i),Mt.bordersExpanded({city:this.city,position:t})}turn(){if(null===this.tileToExpand)return null;this.expandingProgress+=this.getExpandingPoints();const t=this.expandingProgress-this.tileToExpand.cost;return t>=0?(this.expandingProgress=t,this.expand()):null}place(){for(const[t,e]of this.positions)this.grid.addInfluence(t,e,this.city)}remove(){this.positions.forEach((([t,e])=>{this.grid.get(t,e).influencedBy=null}))}canExpandToPosition(t){const[e,i]=t;if(null!==this.grid.get(e,i).influencedBy)return!1;const n=this.city.position,[s,o]=this.grid.getNextLinePosition(t,n);if(!this.grid.influencedByCity(s,o,this.city))return!1;if(!Ct.diagonal.some((({dx:t,dy:n})=>this.grid.influencedByCity(e+t,i+n,this.city))))return!1;if(!Ct.orthogonal.some((({dx:t,dy:n})=>this.grid.influencedByCity(e+t,i+n,this.city))))return!1;const[r,a]=n;return this.grid.getOctileDistance(e,i,r,a)<=7}getFrontierPositions(){const t=[];for(const e of this.positions){const[i,n]=e;for(const{dx:s,dy:o}of Ct.orthogonal){const r=i+s,a=n+o,{influencedBy:l}=this.grid.get(r,a);null!==l||ft(t,e)||t.push(e)}}return t}getNextFrontierPositions(){const t=[];for(const[e,i]of this.positions)for(const{dx:n,dy:s}of Ct.orthogonal){const o=e+n,r=i+s,a=this.grid.getPosition(o,r),{influencedBy:l}=this.grid.get(o,r);null!==l||ft(t,a)||t.push(a)}return t}swap(t,e){const i=this.grid.get(t,e).influencedBy,n=this.positions.findIndex((([i,n])=>t===i&&e===n));d(this.positions,n),this.positions=this.grid.sortPositions(this.city.position,this.positions),i.influence.addTile(t,e)}canSwap(t,e){return this._canSwap(t,e,new Map)}_canSwap(t,e,i){const n=jt(t,e);if(i.has(n))return i.get(n);const s=this.grid.get(t,e).influencedBy;if(null===s||s===this.city)return i.set(n,!1),!1;const[o,r]=this.city.position;if(this.grid.getOctileDistance(t,e,o,r)>7)return i.set(n,!1),!1;if(!s.assignments.hasFreeTiles())return i.set(n,!1),!1;const a=[!1,!1],l=[[],[]];for(const{dx:s,dy:o,isOrthogonal:r}of Ct.members){const c=t+s,h=e+o,{influencedBy:d}=this.grid.get(c,h),u=+r;if(d!==this.city){l[u].push([c,h]);continue}const p=+!r;if(a[u]=!0,a[p])return i.set(n,!0),!0}return a.every(((t,e)=>t||l[e].some((([t,e])=>this._canSwap(t,e,i)))))}addTile(t,e){this.grid.addInfluence(t,e,this.city);const{positions:i}=this;i.push([t,e]),this.positions=this.grid.sortPositions(this.city.position,i)}expandToTile(t,e){const i=[t,e];ft(this.positions,i)||this.addTile(t,e)}get grid(){return this.city.grid}}class _t{static getDefaultPositions(t,e,i,n=1){const s=[];for(;n-- >0;){let n,o=0;for(let r=0;r<e.length;r++){const a=e[r];if(mt(a,t)||s.some((t=>mt(t,a))))continue;const[l,c]=a,h=i.getTileFood(l,c);h>o&&(o=h,n=a)}n&&s.push(n)}return s}recalculate(t=this.influence.city.population){this.positions=_t.getDefaultPositions(this.influence.city.position,this.influence.positions,this.grid,t)}constructor(t,e,i){this.grid=t,this.influence=e,this.positions=i}isPositionOccupied(t){return mt(t,this.city.position)||ft(this.positions,t)}isPositionFree(t){return!this.isPositionOccupied(t)}hasFreeTiles(){return this.influence.positions.some((t=>this.isPositionFree(t)))}getFreeTilesCount(){return c(this.influence.positions,(t=>this.isPositionFree(t)))}getFoodPerTurn(){const[t,e]=this.influence.city.position,i=this.grid.getTileFood(t,e);return this.positions.reduce(((t,e)=>{if(!this.influence.positions.some((t=>mt(t,e))))return t;const[i,n]=e;return t+this.grid.getTileFood(i,n)}),i)}get city(){return this.influence.city}}const $t={population:1,expansionLevel:0};class Gt{static found(t,e,i=0,n="",s={}){const o={...$t,...s},r=Wt.getStartInfluencePositions(e,t,o.expansionLevel+3),a=_t.getDefaultPositions(e,r,t,o.population);return new Gt(t,{position:e,project:null,influencedPositions:r,assignmentsPositions:a,growthProgress:0,expandingProgress:0,name:n,id:i})}constructor(t,e){this.grid=t,this.position=e.position,this.name=e.name,this.id=e.id,this.growthProgress=e.growthProgress,this.project=e.project;const[i,n]=e.position;t.get(i,n).city=this,this.influence=new Wt(this,e),this.assignments=new _t(t,this.influence,e.assignmentsPositions),this.assignments.getFreeTilesCount()>0?this.foodBasketSize=Et(this.population):this.foodBasketSize=0}turn(e=t){const i=this.updateGrowthProgress(),n=this.updateProjectProgress(e);return null!==n&&i.push(n),i}updateGrowthProgress(){const t=[],e=this.assignments.getFreeTilesCount();if(0===e)return t;const i=Et(this.population);this.growthProgress+=this.foodSurplus;let n=this.population;const s=this.influence.turn();null!==s&&t.push(s);const o=this.growthProgress-i;if(o>=0){e>1?(this.growthProgress=o,this.foodBasketSize=Et(this.population+1)):(this.growthProgress=0,this.foodBasketSize=0),++n;const i=Mt.populationIncreased({city:this});t.push(i)}else this.growthProgress;return t.length>0&&this.assignments.recalculate(n),t}updateProjectProgress(e=t){const{project:i}=this;if(null===i)return null;const[n,s]=this.position,o=this.grid.getIndexByPosition(n,s),r=this.project.progress+1;if(!(r===this.project.type.cost))return this.project.progress=r,null;if(!!this.grid.tiles[o].unit)return null;const a=Mt.unitCompleted({unitTypeId:this.project.type.productId,cityPositionIndex:o});return this.project=null,e(a),a}setProject(t){null!==t?null!==this.project&&t.productId===this.project.type.productId||(this.project={type:t,progress:0}):this.project=null}get foodSurplus(){return this.assignments.getFoodPerTurn()-2*this.population}get population(){return this.assignments.positions.length}get influencedPositions(){return this.influence.positions}get assignmentsPositions(){return this.assignments.positions}get expandingProgress(){return this.influence.expandingProgress}remove(){const[t,e]=this.position;this.grid.get(t,e).city=null,this.influence.remove()}}class Xt{constructor(t){this.influence=t,this.tilesToExpand=t.getTilesToExpand(),this.tilesToExpandLeft=t.getFreeTilesCount()}get tileToExpand(){return this.influence.tileToExpand}set tileToExpand(t){this.influence.tileToExpand=t}}const Yt=(t,e)=>e.tileToExpand.turnsToExpand!==t.tileToExpand.turnsToExpand?e.tileToExpand.turnsToExpand<t.tileToExpand.turnsToExpand:e.tilesToExpandLeft<t.tilesToExpandLeft;class Kt{constructor(e,i=[],n=t,s=0){this.grid=e,this.dispatch=n,this.cities=Kt.createCities(e,i),this._nextCityId=s,this.updateTilesToExpand()}createEventHandlers(){return t=this,{cityPillaged:({city:t})=>{t.assignments.recalculate(t.population-1)},cityDestroyed:({city:e})=>{t.removeCity(e)}};var t}updateTilesToExpand(){(t=>{const e=new Map;for(;t.length>0;){const i=t.shift();if(0===i.tilesToExpand.length)continue;const n=i.tilesToExpand.shift(),[s,o]=n.position,r=jt(s,o),a=e.get(r);i.tileToExpand=n,a?Yt(a,i)?(a.tileToExpand=null,t.push(a),e.set(r,i)):(i.tileToExpand=null,t.push(i)):e.set(r,i)}})(this.cities.map((t=>(t.influence.tileToExpand=null,new Xt(t.influence)))))}turn(){const t=[];return this.cities.forEach((e=>{const i=e.turn(this.dispatch);t.push(...i)})),this.updateTilesToExpand(),t}addCity(t){this.cities.push(t),this.updateTilesToExpand(),++this._nextCityId}nextCityName(){return(t=>{const e=[];do{const i=t%26;t=Math.floor(t/26),e.push(String.fromCharCode(i+65))}while(t>0);return e.join("")})(this.nextCityId)}removeCity(t){h(this.cities,t),t.remove(),this.updateTilesToExpand()}foundCity(t,e,i){if(!this.canPlaceCity(t,e))return null;const n=Gt.found(this.grid,[t,e],this.nextCityId,this.nextCityName(),i);return this.addCity(n),n}canPlaceCity(t,e){const i=this.grid.get(t,e);return!(!i.terrain.dryLand||0===i.unit?.playerId)&&this.cities.every((({position:[i,n]})=>this.grid.getOctileDistance(i,n,t,e)>=8))}captureRelativePosition(t,[e,i]){const[n,s]=t.position,[o,r]=this.grid.getPosition(n+e,s+i);this.captureTile(n,s,o,r)}captureTile(t,e,i,n){const{city:s}=this.grid.get(t,e);s.influence.expandToTile(i,n),this.updateTilesToExpand()}setProject(t,e){const{city:i}=this.grid.tiles[t];i.setProject(e)}get nextCityId(){return this._nextCityId}}Kt.createCities=(t,e)=>e.map((e=>new Gt(t,e))).sort(((t,e)=>t.id-e.id));class Qt{constructor(t,e){this.grid=t,this.path=[];const{targetPosition:i,...n}=e;Object.assign(this,n);const[s,o]=e.position;t.get(s,o).unit=this}beforeTurn(){this.movePoints+=this.type.movePoints}cancelMove(){const t=this.grid.getPositionByIndex(l(this.path));return this.path=[],Mt.moveCanceled({from:this.position,to:t})}getMoveCost(t,e){const i=this.grid.getDirection(t,e);return pt(i.isOrthogonal)}isTilePassable(t){const{terrain:e,unit:i,city:n}=this.grid.tiles[t];return e.dryLand&&(!i||i.playerId===this.playerId)&&(!n||0!==this.playerId)}getNextPathSegment(t){let e=this.position,i=0;const n=[],s=[];for(const o of t){if(!this.isTilePassable(o))break;const t=this.grid.getPositionByIndex(o),r=i+this.getMoveCost(e,t);if(r>this.movePoints)break;this.grid.tiles[o].unit?s.push(t):(s.length>0&&(n.push(...s),s.length=0),n.push(t)),i=r,e=t}return n.push(...s),{positions:n,cost:i}}moveByPath(t){const e=this.getNextPathSegment(t),{positions:i,cost:n}=e;if(0===i.length)return this.path=t.slice(),null;const s=l(i),[o,r]=s;if(this.grid.get(o,r).unit)return null;this.path=t.slice(i.length);const[a,c]=this.position;return this.grid.get(a,c).unit=null,this.grid.get(o,r).unit=this,this.movePoints-=n,i.unshift(this.position),this.position=s,Mt.unitMoved({path:i})}getPositionIndex(){const[t,e]=this.position;return this.grid.getIndexByPosition(t,e)}get targetPosition(){return this.path.length>0?l(this.path):null}}Qt.DEFAULT_UNIT_TYPE=et[0],Qt.getDefaultData=(t,e)=>({playerId:1,position:[t,e],type:Qt.DEFAULT_UNIT_TYPE,movePoints:Qt.DEFAULT_UNIT_TYPE.movePoints,targetPosition:null});const Vt=(t,e,i)=>Math.floor(e+(i-e+1)*t),qt=(t,e)=>Vt(Math.random(),t,e),Jt=(t,e)=>t>e?e:t,Zt=(t,e)=>((t,e,i)=>t<e?e:t>i?i:t)(t,0,e),te=2*Math.PI,ee=t=>{let e=t[0],i=0;for(let n=1;n<t.length;n++){const s=t[n];s.f<e.f&&(e=s,i=n)}return d(t,i),e},ie=t=>{const e=[];for(;t.previous;)e.unshift({position:t.position,positionIndex:t.positionIndex}),t=t.previous;return e};var ne;const se=t=>(1664525*t+1013904223)%oe.PERIOD;class oe{constructor(t=ne.getDefaultSeed()){this.seed=t}next(){return this.seed=se(this.seed),this.seed/ne.PERIOD}nextFloat(t,e){return t+(e-t)*this.next()}nextInt(t,e){if(1===arguments.length)return this.nextInt(0,t);const i=this.next();return Vt(i,t,e)}nextBoolean(t=.5){return this.next()<t}}ne=oe,oe.getDefaultSeed=()=>qt(0,ne.PERIOD),oe.PERIOD=2**32;const re=(t,e,i)=>{var n,s;return((t,e,i)=>Math.round(3*Math.E**((t-e)/200)*i))(t,e,(n=i(),(s=8)+(12-s)*n))},ae=(t,e,i,n)=>t<=i&&e<=n?i/t<n/e?le(t,e,i,n):ce(t,e,i,n):t<i?ce(t,e,i,n):e<n?le(t,e,i,n):[i,n],le=(t,e,i,n)=>[Math.round(Jt(i*e/n,t-1)),e],ce=(t,e,i,n)=>[t,Math.round(Jt(n*t/i,e-1))],he=[4,8,3,5,5,3,3],de=he.map((t=>2**t-1)),ue=(t,e)=>t.grid.getDirection(t.position,e.position),pe=(t,e,i,n)=>{const s=((t,e,i)=>[i,t.getPositionIndex(),Ct.members.indexOf(ue(t,e)),t.hitPoints,e.hitPoints,t.movePoints,e.movePoints])(t,e,i),o=(t=>{let e=0;for(let i=0;i<he.length;i++)e<<=he[i],e|=se(t[i])&de[i];return e})(s)^n,r=new oe(o);return((t,e,i)=>{const n=re(t,e,i),s=re(e,t,i);return ae(t,e,s,n)})(t.hitPoints,e.hitPoints,(()=>r.next()))};class ge extends Qt{constructor(t,e){const{hitPoints:i,combated:n,...s}=e;super(t,s),this.hitPoints=i,this.combated=n}combat(t,e,i){const n=pe(this,t,e,i),[s,o]=n;return this.combated=!0,Mt.combat({from:this.position,to:t.position,damage:n,attackerDestroyed:s>=this.hitPoints,defenderDestroyed:o>=t.hitPoints})}beforeTurn(){super.beforeTurn(),this.combated=!1}kill(t){return this.combated=!0,Mt.unitKilled({attackerPosition:this.position,killedUnitPosition:t.position})}}const me=t=>t.type.military,fe=t=>me(t);class ye{constructor(e,i=[[],[]],n=t,s=0){var o;this.grid=e,this.dispatch=n,this.combatSeed=s,this.movements=i.map((()=>new Map)),this.units=(o=t=>this.createUnit(t),i.map((t=>t.map(o))))}createEventHandlers(){return t=this,{unitCompleted:({unitTypeId:e,cityPositionIndex:i})=>{const[n,s]=t.grid.getPositionByIndex(i);t.placeUnit(n,s,{type:et[e-1]})}};var t}setMoveTargetIndex(t,e){this.movements[t.playerId].set(e,t)}removeMoveTargetIndex(t,e){return this.movements[t].delete(e)}getMoveCompetitor(t,e){return this.movements[t].get(e)}createUnit(t){const e=((t,e)=>me(e)?new ge(t,e):new Qt(t,e))(this.grid,t);if(null!==t.targetPosition){const i=this.grid.getPositionByIndex(t.targetPosition);this.setMoveTargetIndex(e,e.targetPosition),e.path=this.findPath(e,i)}return e}findPath(t,e){return((t,e,n,s=i)=>{const[o,r]=e,[a,l]=n,c=t.getIndexByPosition(o,r),h=[{position:e,positionIndex:c,g:0,f:t.getOctileDistance(o,r,a,l),previous:null}],d=new Set([c]);for(;h.length>0;){const e=ee(h),[i,n]=e.position;if(i===a&&n===l)return ie(e);d.add(e.positionIndex);for(const{dx:o,dy:r,isOrthogonal:c}of Ct.members){const u=t.getPosition(i+o,n+r),[p,g]=u,m=t.getIndexByPosition(p,g);if(d.has(m)||!s(m))continue;const f=e.g+pt(c),y=t.getOctileDistance(p,g,a,l),v=f+y,w=h.find((t=>t.positionIndex===m));w?f<w.g&&(w.g=f,w.f=v,w.previous=e):h.push({previous:e,position:u,positionIndex:m,g:f,f:f+y})}}return[]})(this.grid,t.position,e,(e=>t.isTilePassable(e))).map((t=>t.positionIndex))}turnEnd(){const t=[],e=[];return((t,e)=>{for(let i=0;i<t.length;i++){const n=t[i];for(let t=0;t<n.length;t++)e(n[t])}})(this.units,(i=>{if(i.beforeTurn(),null!==i.targetPosition){const[n,s]=i.position,o=this.grid.getIndexByPosition(n,s),r=this.move([o,...i.path]);null===r?e.push(i.cancelMove()):t.push(r)}i.movePoints=Jt(i.movePoints,i.type.movePoints)})),{moves:t,canceledMoves:e}}canPlaceUnit(t,e,i){const n=this.grid.get(t,e);return!(null!==n.unit||!n.terrain.dryLand)&&(0!==i.playerId||!n.city)}placeUnit(t,e,i={}){if(!this.canPlaceUnit(t,e,i))return null;const n=Object.assign(Qt.getDefaultData(t,e),i);me(n)&&(n.hitPoints=100);const s=this.createUnit(n);return this.units[s.playerId].push(s),s}combat(t,e,i){if(fe(e)){const n=t.combat(e,i,this.combatSeed),{damage:[s,o]}=n.payload;if(this.causeDamage(t,s),this.causeDamage(e,o)){const[i,n]=e.position,s=this.grid.getIndexByPosition(i,n);t.moveByPath([s])}else{const i=this.grid.getDirection(t.position,e.position);t.movePoints-=pt(i.isOrthogonal)}return n}const n=t.kill(e);this.removeUnit(e);const[s,o]=n.payload.killedUnitPosition,r=this.grid.getIndexByPosition(s,o);return t.moveByPath([r]),n}handleCombat(t,e,i,n){const s=[],o=this.grid.get(e,i),r=o.unit;if(r&&r.playerId!==t.playerId){const e=this.combat(t,r,n);s.push(e)}const a=o.city;if(0===t.playerId&&a&&(!o.unit||0===o.unit.playerId)){const e=this.pillageCity(t,a);this.dispatch(e),s.push(e)}return s}moveUnit(t,e,i,n=0){const s=[e,i];if(mt(t.position,s))return this.cancelMove(t),[];if(((t,e,i)=>{const n=t.position,s=[e,i];if(!fe(t)||t.combated||!t.grid.isAdjacentPositions(t.position,s))return!1;const o=t.grid.getDirection(n,s),r=pt(o.isOrthogonal);return t.movePoints>=r})(t,e,i)){const s=this.handleCombat(t,e,i,n);if(s.length>0)return s}const o=this.findPath(t,s);if(0===o.length)return[];const[r,a]=t.position,l=this.grid.getIndexByPosition(r,a);o.unshift(l);const c=this.move(o);return c?[c]:[]}pillageCity(t,e){return this.removeUnit(t),e.population>1?Mt.cityPillaged({barbarianPosition:t.position,city:e}):Mt.cityDestroyed({city:e,barbarian:t})}causeDamage(t,e){return t.hitPoints-=e,t.hitPoints<=0&&(this.removeUnit(t),!0)}move(t){const[e,...i]=t,n=i[0],{unit:s}=this.grid.tiles[e];if(this.removeMoveTargetIndex(s.playerId,s.targetPosition),2===t.length){const t=this.getMoveCompetitor(s.playerId,n);1===t?.path.length&&this.cancelMove(t)}const o=l(i),r=this.grid.tiles[o];return null!==r.unit||r.city&&0===s.playerId?null:(this.setMoveTargetIndex(s,o),s.moveByPath(i))}removeUnit(t){const[e,i]=t.position;this.grid.get(e,i).unit=null,this.removeMoveTargetIndex(t.playerId,t.targetPosition),h(this.units[t.playerId],t)}cancelMove(t){this.removeMoveTargetIndex(t.playerId,t.targetPosition),t.cancelMove()}}class ve{static createEmptyWorldData(t,e,i=nt){const n=((t,e,i=nt)=>a(e*t,(()=>st(i))))(t,e,i);return this.fromTilesData(n,t)}static createEmptyWorld(t,e,i=nt){const n=this.createEmptyWorldData(t,e,i);return ve.fromData(n)}static fromTerrainMap(t,e,i){const n=t.map(st);return this.fromData(this.fromTilesData(n,e,i))}static fromData(t){const e=It.createFromTilesData(t.tiles,t.width);return new ve(e,t)}constructor(t,e){this.grid=t,this.turnNumber=e.turnNumber;const i=(()=>{const t=[];return{addSubscriber:e=>{t.push(e)},dispatch:e=>{t.forEach((t=>{t[e.type]?.(e.payload)}))}}})();this.citiesService=new Kt(t,e.cities,i.dispatch,e.nextCityId),i.addSubscriber(this.citiesService.createEventHandlers()),this.unitsService=new ye(t,e.units,i.dispatch,e.combatSeed),i.addSubscriber(this.unitsService.createEventHandlers()),this.mapSeed=e.mapSeed,this.playerId=e.playerId}turn(){return 0===this.playerId?(this.playerId=1,this.turnEnd()):(this.playerId=0,[])}turnEnd(){this.turnNumber===ve.MAX_TURN_NUMBER?(console.warn("Max turns reached"),this.turnNumber=1):++this.turnNumber;const t=this.citiesService.turn(),e=this.unitsService.turnEnd();return t.concat(e.moves,e.canceledMoves)}moveUnit(t,e,i){return t.playerId!==this.playerId?[]:this.unitsService.moveUnit(t,e,i,this.turnNumber)}placeTerrain(t,e,i){const n=this.grid.get(t,e);if(!((t,e)=>t.terrain!==e&&(e.dryLand||!t.city&&!t.unit))(n,i))return!1;n.terrain=i,this.mapSeed=null;const{influencedBy:s}=n;s&&s.assignments.recalculate();return Ct.orthogonal.some((({dx:i,dy:n})=>this.grid.get(t+i,e+n).influencedBy))&&this.citiesService.updateTilesToExpand(),!0}placeUnit(t,e,i={}){return this.unitsService.placeUnit(t,e,i)}removeUnit(t){this.unitsService.removeUnit(t)}removeCity(t){this.citiesService.removeCity(t)}foundCity(t,e,i){return this.citiesService.foundCity(t,e,i)}captureTile(t,e,i,n){this.citiesService.captureTile(t,e,i,n)}setCityProject(t,e){const i=null!==e?it.find((t=>t.productId===e)):null;this.citiesService.setProject(t,i)}get cities(){return this.citiesService.cities}get units(){return this.unitsService.units}get nextCityId(){return this.citiesService.nextCityId}get combatSeed(){return this.unitsService.combatSeed}get tiles(){return this.grid.tiles}get width(){return this.grid.width}get height(){return this.grid.height}}ve.MAX_TURN_NUMBER=65536,ve.fromTilesData=(t,e,i=null)=>({playerId:1,tiles:t,width:e,height:t.length/e,cities:[],units:[[],[]],turnNumber:1,nextCityId:0,mapSeed:i,combatSeed:qt(0,2147483647)});const we=new TextEncoder,xe=new TextDecoder("utf-8"),be=(t,e)=>{if(!t)throw new Error("Serialized string must not be empty");const i=2**e,n=(t=>we.encode(t))(t);if(n.length>i)throw new Error(`Max string size exceeded. ${n.length} > ${i}`);return At(n.length-1,e).concat((t=>Dt(t,8))(n))},Se=(t,e)=>{const i=kt(t,e)+1;return(t=>{const{buffer:e}=new Uint8Array(t);return xe.decode(e)})(Ht(t,i))},Pe=(t,e=0)=>{const i=2**t+e-1;return{read:i=>kt(i,t)+e,write:n=>{if(n>i)throw new Error("Overflow error");return At(n-e,t)}}},Ce=(t,e)=>({name:t,read:i=>({[t]:e.read(i)}),write:t=>e.write(t)}),Te=(t,e,i={context:{},data:{}})=>{const n={context:{},data:{},...i},{data:s}=n;for(const i of e){const e=i.read(t,n);"object"==typeof e&&Object.assign(s,e)}return s},Ie=(t,e,i={})=>{const n=[],s={data:t,context:i};for(const i of e){const e=t[i.name],o=i.write(e,s);for(const t of o)n.push(t)}return n},Ee=(Me=7,{read:t=>Se(t,Me),write:t=>be(t,Me)});var Me;const Ne=Pe(7),Ue=Pe(3,3),Be=Pe(3),Ae=(t,e)=>t===e?0:Ft(Et(t)),Oe=[{name:"id",read:(t,{context:e})=>({id:kt(t,e.cityIdSize)}),write:(t,{context:e})=>At(t,e.cityIdSize)},Ce("name",Ee),{write(t,{data:e,context:i}){const n=((t,e)=>{const i=ht(t.position,t.influencedPositions,e.width,e.height),[n,s,o,r]=(t=>{const[e,i]=t[0];let n=e,s=i,o=e,r=i;for(const[e,i]of t)e<n&&(n=e),i<s&&(s=i),e>o&&(o=e),i>r&&(r=i);return[n,s,o,r]})(i),a=o-n+1,l=r-s+1,c=ot(Math.abs(n),Math.abs(s),a),h=i.map((([t,e])=>ot(t-n,e-s,a))),d=a*l,u=[],p=[];for(let e=0;e<d;e++){const i=h.indexOf(e),n=i>=0;if(u.push(n),n){const e=t.influencedPositions[i],n=ft(t.assignmentsPositions,e);p.push(n)}}return{width:a,height:l,cityIndex:c,influence:u,assignments:p,influenceSize:t.influencedPositions.length}})(e,i.worldSize);return Ie(n,De)},read:(t,{context:e})=>((t,e,i)=>{const n=[],{width:s,height:o}=t,r=s*o,[a,l]=lt(t.cityIndex,s),[c,h]=[e[0]-a,e[1]-l];for(let e=0;e<r;e++)if(t.influence[e]){const[t,o]=lt(e,s),[r,a]=at(t+c,o+h,i.width,i.height);n.push([r,a])}const d=[];for(let e=0;e<t.assignments.length;e++)t.assignments[e]&&d.push(n[e]);return{position:e,influencedPositions:n,assignmentsPositions:d}})(Te(t,De),e.position,e.worldSize)},{name:"project",read:t=>{const e=Be.read(t);if(0===e)return{project:null};const i=it[e-1],n=Ft(i.cost);return{project:{type:i,progress:kt(t,n)}}},write:t=>{if(null===t)return a(3,n);const e=Ft(t.type.cost);return Be.write(t.type.productId).concat(At(t.progress,e))}},{name:"growthProgress",write(t,{data:e}){const i=Ae(e.assignmentsPositions.length,e.influencedPositions.length);return At(t,i)},read(t,{data:e}){const i=Ae(e.assignmentsPositions.length,e.influencedPositions.length);return{growthProgress:kt(t,i)}}},Ce("expandingProgress",Ne)],De=[Ce("width",Ue),Ce("height",Ue),{name:"cityIndex",write:(t,{data:e})=>At(t,Ft(e.width*e.height)),read:(t,{data:e})=>({cityIndex:kt(t,Ft(e.width*e.height))})},{name:"influence",read(t,{data:e,context:i}){const{booleans:n,count:s}=((t,e)=>{const i=zt(t,e,{truesCount:0},Rt);return{booleans:i.booleans,count:i.stats.truesCount}})(t,e.width*e.height);return i.influenceSize=s,{influence:n}},write:t=>t},{name:"assignments",read:(t,{context:e})=>({assignments:Lt(t,e.influenceSize)}),write:t=>t}],je=(t,e,i,n)=>Te(t,Oe,{context:{cityIdSize:n,position:e,worldSize:i}}),ke=Pe(3),Re=Pe(4),ze=[Ce("playerId",Pe(1)),{name:"type",read:t=>{const e=ke.read(t);return{type:et[e]}},write:t=>ke.write(t.id-1)},Ce("movePoints",Re),{name:"targetPosition",read(t,{context:{targetIndexSize:e,positionIndex:i,worldWidth:n}}){const s=kt(t,e);return{targetPosition:s!==i?s:null,position:lt(i,n)}},write(t,{data:e,context:{targetIndexSize:i,worldWidth:n}}){const s=((t,e,i)=>{if(null===t){const[t,n]=e;return ot(t,n,i)}return t})(t,e.position,n);return At(s,i)}}],Le=(t,e=null)=>{const{width:i,height:n}=t,s={worldWidth:i,targetIndexSize:Fe(i,n)};if(null!==e){const[t,n]=e;s.positionIndex=ot(t,n,i)}return s},Fe=(t,e)=>Ft(t*e),He=Pe(7,1),We=(t,e,i)=>{const n=Le(i,e),s=Te(t,ze,{context:n});return me(s)&&(s.hitPoints=He.read(t),s.combated=(t=>{const[e]=t;return e})(t)),s},_e=265,$e=(t,e)=>String(t).padStart(e,"0"),Ge=new RegExp("^[\\da-f]{8}$"),Xe=t=>(t=>Ge.test(t))(t)?parseInt(t,16):null,Ye=t=>{return e=8,t.toString(16).padStart(e,"0");var e},Ke=()=>Ye(Qe()),Qe=()=>oe.getDefaultSeed(),Ve=([t,e],[i,n])=>t*i+e*n,qe=(t,e,i)=>{return t+(6*(n=i)**2-15*n+10)*n**3*(e-t);var n},Je=t=>((t,e)=>[t*Math.cos(e),t*Math.sin(e)])(1,t),Ze=(t,e,i,n)=>{const s=Math.ceil(t/i)+1,o=Math.ceil(e/i)+1,r=new oe(n),l=a(s*o,(()=>{const t=r.nextFloat(0,te);return Je(t)})),c=(t,e)=>{const i=ot(t,e,s);return l[i]};return(t,e)=>.5+.5*((t,e,i)=>{const n=Math.floor(t),s=Math.floor(e),o=t-n,r=e-s,a=Ve([o,r],i(n,s)),l=Ve([o-1,r],i(n+1,s)),c=Ve([o-1,r-1],i(n+1,s+1)),h=Ve([o,r-1],i(n,s+1)),d=qe(a,l,o),u=qe(h,c,o);return qe(d,u,r)})(t/i,e/i,c)},ti=(t,e,i,s)=>{const o=t.map(n),r=new Tt(e,t.length/e),a=[i],l=[s],c=new Set([i,s]);for(;a.length>0||l.length>0;){if(a.length>0){const e=ii(a,t),[i,n]=r.getPositionByIndex(e);for(const{dx:t,dy:e}of Ct.orthogonal){const[s,o]=r.getPosition(i+t,n+e),l=r.getIndexByPosition(s,o);c.has(l)||(a.push(l),c.add(l))}}if(l.length>0){const e=ei(l,t),[i,n]=r.getPositionByIndex(e);o[e]=!0;for(const{dx:t,dy:e}of Ct.orthogonal){const[s,o]=r.getPosition(i+t,n+e),a=r.getIndexByPosition(s,o);c.has(a)||(l.push(a),c.add(a))}}}return o},ei=(t,e)=>{let i=t[0],n=0;for(let s=1;s<t.length;s++)e[t[s]]>e[i]&&(i=t[s],n=s);return d(t,n),i},ii=(t,e)=>{let i=t[0],n=0;for(let s=1;s<t.length;s++)e[t[s]]<e[i]&&(i=t[s],n=s);return d(t,n),i},ni=(t,e,i)=>{const n=((t,e,i,n)=>{const s=[],o=(t-1)/2,r=(e-1)/2,a=Ze(t,e,i,n);let l,c,h=Number.POSITIVE_INFINITY,d=Number.NEGATIVE_INFINITY;for(let i=0;i<e;i++)for(let n=0;n<t;n++){if(n<3||n>t-3||i<2||i>e-2){s.push(0);continue}const u=a(n,i)*(1-Math.sqrt(((o-n)/o)**2+((r-i)/r)**2)/Math.SQRT2);u<h&&(h=u,l=ot(n,i,t)),u>d&&(d=u,c=ot(n,i,t)),s.push(u)}return ti(s,t,l,c)})(t,e,7,i),s=((t,e,i)=>{const n=t.length/e,s=Ze(e,n,3,i),o=(e-1)/2,r=(n-1)/2,a=[];for(let i=0;i<n;i++)for(let n=0;n<e;n++){const l=ot(n,i,e),c=s(n,i),h=1-Math.sqrt(.3*((o-n)/o)**2+.7*((r-i)/r)**2)/Math.SQRT2;a.push(t[l]&&(c*h)**2>.2)}return a})(n,t,i);return n.map(((t,e)=>t?s[e]?Z:J:tt))},si=Ft(252),oi=Ft(ve.MAX_TURN_NUMBER-1),ri=Ft(2**32-1),ai=(t,e,i,n)=>{const[s,o]=t;return{city:s?je(t,e,i,n.cityIdSize):null,unit:o?We(t,e,i):null,terrain:q[kt(t,3)]}},li=(t,e,i)=>{const n=At(t.terrain.id-1,3),{city:s,unit:o}=t,r=[!!s,!!o];return s&&r.push(...((t,e,i)=>Ie(t,Oe,{worldSize:e,cityIdSize:i}))(s,e,i)),o&&r.push(...((t,e)=>{const i=Le(e),n=Ie(t,ze,i);return me(t)&&(n.push(...He.write(t.hitPoints)),n.push(t.combated)),n})(o,e)),r.concat(n)},ci=Pe(si,13),hi=Pe(oi,1),di=Pe(31),ui=[Ce("width",ci),Ce("height",ci),Ce("turnNumber",hi),Ce("playerId",Pe(1)),Ce("combatSeed",di),{name:"mapSeed",write:t=>null===t?[!1]:[!0,...At(t,ri)],read(t){const[e]=t;return{mapSeed:e?kt(t,ri):null}}},{name:"nextCityId",write:(t,{context:e})=>(e.cityIdSize=(t=>t>0?Ft(t-1):0)(t),At(e.cityIdSize,5)),read(t,{context:e}){e.cityIdSize=kt(t,5)}},{name:"tiles",write:(t,{data:e,context:i})=>((t,e,i)=>{const n=[];return t.forEach((t=>{n.push(...li(t,e,i.cityIdSize))})),n})(t,e,i),read:(t,{context:e,data:i})=>((t,e,i)=>{const n=[],s=[],o=[[],[]];for(let r=0;r<e.height;r++)for(let a=0;a<e.width;a++){const l=ai(t,[a,r],e,i),{city:c,unit:h}=l;c&&(n.push(c),c.id>=e.nextCityId&&(e.nextCityId=c.id+1)),h&&o[h.playerId].push(h),s.push(l)}return{tiles:s,cities:n,units:o}})(t,i,e)}],pi=t=>{const e=(t=>Nt(t,Ot))(t);return Te(e,ui,{data:{nextCityId:0}})},gi=(t,e)=>{for(const i in e)"style"===i?Object.assign(t.style,e.style):i in t?t[i]=e[i]:t.setAttribute(i,e[i])},mi=(t,...e)=>{const i=document.createElement(t);return((t,...e)=>{for(const i of e)Array.isArray(i)?t.append(...i):s(i)?t.innerText=i:gi(t,i)})(i,...e),i},fi=(...t)=>{const[e,...i]=t;return s(e)?mi(e,...i):(t=>{const e=document.createDocumentFragment();return e.append(...t),e})(t)},yi=fi,vi=[[[13,3],[9,7],[15,13],[3,25],[7,29],[19,17],[25,23],[29,19]],[[28,4],[17,10],[8,22],[5,19],[3,21],[6,24],[3,27],[5,29],[8,26],[11,29],[13,27],[10,24],[22,15]],[[5,5],[27,5],[18,10],[27,16],[8,16],[8,28],[5,28]]],wi=["#da1e28","#006400"];class xi{constructor(t,e){this.view=t,this.context=e}drawIcon(t,e,i,n){const s=vi[i];((t,[e,i],n,s)=>{t.fillStyle=s;const[[o,r]]=n;t.beginPath(),t.moveTo(e+o,i+r);for(let s=1;s<n.length;s++){const[o,r]=n[s];t.lineTo(e+o,i+r)}t.closePath(),t.stroke(),t.fill()})(this.context,[t,e],s,wi[n])}drawSprite(t,e,i){const{tileSize:n}=this.view,s=Q.width/n,[o,r]=lt(t,s),a=o*n,l=r*n;this.context.drawImage(Q,a,l,n,n,e,i,n,n)}clearTile(t,e){const[i,n]=this.view.toCanvasPosition(t,e),{tileSize:s}=this.view;this.context.clearRect(i,n,s,s)}clear(){this.context.clearRect(0,0,this.view.width,this.view.height)}refresh(){(t=>{const e=t.getImageData(0,0,1,1);t.putImageData(e,0,0)})(this.context)}moveViewport(t,e){const{context:i}=this,{width:n,height:s,tileSize:o}=this.view;if(0!==t){const e=t*o,r=t>0?e:n+e,a=i.getImageData(0,0,r,s),l=i.getImageData(r,0,n-r,s);i.putImageData(a,n-r,0),i.putImageData(l,0,0)}if(0!==e){const t=e*o,r=e>0?t:s+t,a=i.getImageData(0,0,n,r),l=i.getImageData(0,r,n,s-r);i.putImageData(a,0,s-r),i.putImageData(l,0,0)}}}const bi={grassland:"#388E3C",steppe:"#88C34A",sea:"#0090c4"};class Si extends xi{drawGrid(){this.context.fillStyle=Si.GRID_COLOR;const{tileSize:t}=this.view,{width:e,height:i}=this.context.canvas;for(let n=t;n<e;n+=this.view.tileSize)this.context.fillRect(n,0,1,i);for(let n=t;n<i;n+=this.view.tileSize)this.context.fillRect(0,n,e,1)}moveViewport(){}}Si.GRID_COLOR="#555";const Pi=(t,e)=>((t,e,i)=>{const n=Math.floor(i/2),s=t-n,o=[];let r=t;for(let a=e-n;a<e;a++){const n=Math.abs(a-e);let l=!0;for(let c=s;c<t;c++){const s=r,h=Math.abs(c-t),d=gt(h,n);if(d!==i&&d!==i-1)continue;let u;c<s?(u=l?[!0,!1,!1,!0]:[!0,!1,!1,!1],r=c):u=c===s?[!1,!1,!1,!0]:[!0,!1,!1,!1],l=!1;const p={position:[c,a],borders:u},g=Pt(p,t),m=St(g,e),f=Pt(m,t);o.push(p,g,m,f),l=!1}}const a={position:[t,e-n],borders:i%2==0?[!0,!0,!1,!0]:[!0,!1,!1,!1]},l={position:[t-n,e],borders:i%2==0?[!0,!1,!0,!0]:[!1,!1,!1,!0]},c=St(a,e),h=Pt(l,t);return o.push(a,l,c,h),o})(t,e,7);class Ci extends xi{constructor(t,e,i){super(t,e),this.bordersRenderer=i,this.context.fillStyle=Ci.BORDERS_COLOR}drawTileBorders(t,e,i){this.bordersRenderer(this.context,t,e,i)}}Ci.BORDERS_COLOR="#000";var Ti={terrain:class extends xi{drawTerrain(t,e,i){this.context.fillStyle=bi[i];const{tileSize:n}=this.view;this.context.fillRect(t,e,n,n)}},grid:Si,borders:Ci,objects:class extends xi{constructor(t,e){super(t,e),this.animations=this.createShakingAnimations()}createShakingAnimations(){const t={vertical:{maxOffset:e=3,getOffsets:t=>[t,0]},horizontal:{maxOffset:e,getOffsets:t=>[0,t]},mainDiagonal:{maxOffset:i=3,getOffsets:t=>[t,t]},antiDiagonal:{maxOffset:i,getOffsets:t=>[-t,t]}};var e,i;return v(t,(t=>((t,e,{maxOffset:i,getOffsets:n})=>{const s=4*i*e-1;return(e,o,r)=>{const a=o*t,l=r*t,c=e.getImageData(a,l,t,t),h=(s,o,r,d)=>{const u=Math.abs(o)===i?-r:r,p=o+u,[g,m]=n(p);e.clearRect(a,l,t,t),e.putImageData(c,a+g,l+m),s>0?requestAnimationFrame((()=>h(s-1,p,u,d))):d()};return new Promise((t=>{h(s,0,1,t)}))}})(this.view.tileSize,3,t)))}drawUnit(t,e,{type:{id:i},playerId:n}){this.drawIcon(t,e,i-1,n)}drawHouse(t,e){this.drawSprite(1,t,e)}drawCityWithGarrison(t,e){this.drawSprite(2,t,e)}getAnimation(t,e){return 0===t?this.animations.horizontal:0===e?this.animations.vertical:t===e?this.animations.mainDiagonal:this.animations.antiDiagonal}shake(t,e,i,n){return this.getAnimation(i,n)(this.context,t,e)}},selection:class extends xi{constructor(t,e,i){super(t,e),this.borderRenderer=i}drawMaxCityBorders([t,e]){this.context.fillStyle="#333";Pi(t,e).forEach((t=>{const[e,i]=this.view.toCanvasPosition(...t.position);this.borderRenderer(this.context,e,i,t.borders)}))}clearMaxCityMaxBorders([t,e]){Pi(t,e).forEach((({position:[t,e]})=>{this.clearTile(t,e)}))}drawCitizenDistribution(t){for(const[e,i]of t.assignmentsPositions)this.drawCitizen(e,i)}clearCitizenDistribution(t){for(const[e,i]of t.influencedPositions)this.clearTile(e,i)}drawCitizen(t,e){const[i,n]=this.view.toCanvasPosition(t,e);this.drawSprite(0,i,n)}drawPath(t){this.context.fillStyle="#5af";for(let e=0;e<t.length;e++){const i=t[e],[n,s]=this.view.grid.getPositionByIndex(i),[o,r]=this.view.toCanvasPosition(n,s);this.drawPathNode(o,r)}}drawPathNode(t,e){const i=this.view.tileSize/2,n=t+i,s=e+i;this.context.beginPath(),this.context.arc(n,s,4,0,2*Math.PI,!1),this.context.closePath(),this.context.fill()}drawUnitSelection(t,e,i=[]){i.length>0&&this.drawPath(i);const[n,s]=this.view.toCanvasPosition(t,e);this.context.strokeStyle="#000",this.context.beginPath(),this.context.rect(n+2,s+2,this.view.tileSize-3,this.view.tileSize-3),this.context.closePath(),this.context.stroke()}clearPath(t){t.forEach((t=>{const[e,i]=this.view.grid.getPositionByIndex(t);this.clearTile(e,i)}))}clearUnitSelection(t,e,i){super.clearTile(t,e),this.clearPath(i)}drawCitySelection(t){this.drawCitizenDistribution(t),this.drawMaxCityBorders(t.position)}clearCitySelection(t){this.clearMaxCityMaxBorders(t.position),this.clearCitizenDistribution(t)}}};class Ii{static getLayerId(t){return Ii.LAYER_ID_PREFIX+t}constructor(t,e,i=Ii.DEFAULT_TILE_SIZE){var n;this.world=t,this.selectionHandlers=e,this.tileSize=i,this.selectedUnit=null,this.selectedCity=null,this.viewportPosition=[0,0],this.selectors=[({unit:t})=>this.selectUnit(t),({city:t})=>this.selectCity(t),()=>this.clearSelection()],this.eventHandlers=(n=this,{populationIncreased:({city:t})=>{n.selectedCity?.id===t.id&&n.layers.selection.drawCitizenDistribution(t)},bordersExpanded:({city:t,position:e})=>{const[i,s]=e;n.drawCapturedTileBorders(i,s),n.selectedCity?.id===t.id&&n.refreshCitySelection()},unitMoved:({path:t})=>{const[e,i]=t[0],[s,o]=l(t),{unit:r}=n.grid.get(s,o);n.drawObject(e,i),n.drawObject(s,o),n.selectedUnit===r&&(n.layers.selection.clear(),n.layers.selection.drawUnitSelection(s,o,r.path))},moveCanceled:({from:[t,e]})=>{const{unit:i}=n.grid.get(t,e);n.selectedUnit===i&&(n.layers.selection.clear(),n.layers.selection.drawUnitSelection(t,e,i.path))},unitCompleted:({cityPositionIndex:t})=>{const[e,i]=n.grid.getPositionByIndex(t);n.drawObject(e,i)},unitKilled:({attackerPosition:[t,e],killedUnitPosition:[i,s]})=>{n.drawObject(t,e),n.drawObject(i,s),n.layers.selection.clear(),n.layers.selection.drawUnitSelection(i,s)},combat:async({from:t,from:[e,i],to:s,to:[o,r],attackerDestroyed:a,defenderDestroyed:l})=>{const[c,h]=n.grid.getOffsets(t,s);await Promise.allSettled([n.shake(e,i,c,h),n.shake(o,r,c,h)]),a?(n.drawObject(e,i),n.unselectUnit()):l&&(n.drawObject(e,i),n.drawObject(o,r),n.layers.selection.clear(),n.layers.selection.drawUnitSelection(o,r))},cityDestroyed:({city:t,barbarian:{position:[e,i]}})=>{n.clearCity(t),n.drawObject(e,i),n.clearUnitSelection()},cityPillaged:({barbarianPosition:[t,e]})=>{n.drawObject(t,e),n.clearUnitSelection()}}),this.refresh=()=>{y(this.layers,(t=>{t.refresh()}))},this.bordersRender=(t=>{const e=(t=>[[0,0,t,1],[t-1,0,1,t],[0,t-1,t,1],[0,0,1,t]])(t);return(t,i,n,s)=>{e.filter(((t,e)=>s[e])).forEach((([e,s,o,r])=>{t.fillRect(i+e,s+n,o,r)}))}})(i)}get grid(){return this.world.grid}get width(){return this.world.width*this.tileSize}get height(){return this.world.height*this.tileSize}async handleEvent(t){const e=this.eventHandlers[t.type];e?await e(t.payload):console.warn(`'${t.type}' event handler not defined`)}async handleEvents(t){for(const e of t)await this.handleEvent(e)}createLayer(t){const e=yi("canvas",{id:Ii.getLayerId(t),width:this.width,height:this.height});return this.layersContainer.appendChild(e),e.getContext("2d",{willReadFrequently:!0})}createLayers(){this.layers={};for(const[t,e]of Object.entries(Ti)){const i=this.createLayer(t);this.layers[t]=new e(this,i,this.bordersRender)}this.layers.grid.drawGrid()}mount(t){var e;this.layersContainer=yi("div",{id:"layers",style:{width:this.width+"px",height:this.height+"px"}}),this.createLayers(),t.appendChild(this.layersContainer),e=this.refresh,document.addEventListener("visibilitychange",(()=>{"visible"===document.visibilityState&&e()}))}canCapture(t,e){return this.selectedCity.influence.canExpandToPosition([t,e])}drawCapturedTileBorders(t,e){this.drawBorders(t,e);for(const{dx:i,dy:n}of Ct.orthogonal){const s=t+i,o=e+n;this.grid.get(s,o).influencedBy&&this.drawBorders(t+i,e+n)}}captureTile(t,e){const[i,n]=this.selectedCity.position;this.world.captureTile(i,n,t,e),this.drawCapturedTileBorders(t,e)}selectCity(t){const e=!!t;return e&&(this.clearSelection(),this.selectedCity=t,this.drawCitySelection(),this.selectionHandlers.onCitySelected(t)),e}selectUnit(t){const e=!!t;if(e){this.clearSelection(),this.selectedUnit=t;const[e,i]=t.position;this.layers.selection.drawUnitSelection(e,i,t.path)}return e}select(t,e=!0){for(let i=e?0:1;i<this.selectors.length;i++){if((0,this.selectors[i])(t))break}}onTileClick(t,e){if(this.selectedCity&&this.canCapture(t,e))return void this.captureTile(t,e);const i=this.selectedUnit||this.selectedCity,n=!mt(i?.position,[t,e]),s=this.grid.get(t,e);this.select(s,n)}drawCitySelection(){this.layers.selection.drawCitySelection(this.selectedCity);for(const[t,e]of this.selectedCity.assignmentsPositions){const{unit:i}=this.grid.get(t,e);i&&this.layers.objects.clearTile(t,e)}}clearSelection(){this.unselectUnit(),this.unselectCity()}refreshCitySelection(){this.clearCitySelection(),this.drawCitySelection()}unselectCity(){null!==this.selectedCity&&(this.clearCitySelection(),this.selectedCity=null)}clearCitySelection(){this.selectionHandlers.onClearSelection(),this.layers.selection.clearCitySelection(this.selectedCity);for(const[t,e]of this.selectedCity.assignmentsPositions){const{unit:i}=this.grid.get(t,e);if(i){const[n,s]=this.toCanvasPosition(t,e);this.layers.objects.drawUnit(n,s,i)}}}unselectUnit(){this.selectedUnit&&(this.clearUnitSelection(),this.selectedUnit=null)}clearUnitSelection(){this.selectionHandlers.onClearSelection();const[t,e]=this.selectedUnit.position;this.layers.selection.clearUnitSelection(t,e,this.selectedUnit.path),this.selectedUnit=null}changeCityProject(t){const[e,i]=this.selectedCity.position,n=this.grid.getIndexByPosition(e,i);this.world.setCityProject(n,t)}async moveUnit(t,e){const i=this.world.moveUnit(this.selectedUnit,t,e);i.length>0?await this.handleEvents(i):(this.layers.selection.clear(),this.selectUnit(this.selectedUnit))}draw(){for(let t=0;t<this.grid.tiles.length;t++){const[e,i]=this.grid.getPositionByIndex(t);this.drawTile(e,i)}}toTileViewportPosition(t,e){const[i,n]=this.viewportPosition;return this.grid.getPosition(t-i,e-n)}toCanvasPosition(t,e){const[i,n]=this.toTileViewportPosition(t,e);return[i*this.tileSize,n*this.tileSize]}shake(t,e,i,n){const[s,o]=this.toTileViewportPosition(t,e);return this.layers.objects.shake(s,o,i,n)}moveViewport(t,e){const[i,n]=this.viewportPosition;this.viewportPosition=this.grid.getPosition(i+t,n+e),y(this.layers,(i=>{i.moveViewport(t,e)}))}removeSelectedUnit(){if(this.selectedUnit){const[t,e]=this.selectedUnit.position;this.world.removeUnit(this.selectedUnit),this.drawObject(t,e),this.clearUnitSelection()}}clearCity(t){const{position:[e,i],influence:n}=t;this.drawObject(e,i),n.getFrontierPositions().forEach((([t,e])=>{this.layers.borders.clearTile(t,e);for(const{dx:i,dy:n}of Ct.members){const s=t+i,o=e+n;this.grid.get(s,o).influencedBy&&this.drawBorders(s,o)}}))}removeSelectedCity(){this.selectedCity&&(this.clearCity(this.selectedCity),this.unselectCity())}placeTerrain(t,e,i){const n=this.world.placeTerrain(t,e,q[i-1]);return n&&(this.drawTile(t,e),this.selectedCity&&this.refreshCitySelection()),n}drawBorders(t,e){this.layers.borders.clearTile(t,e);const i=Ct.orthogonal.map((({dx:i,dy:n})=>!this.grid.get(t+i,e+n).influencedBy)),[n,s]=this.toCanvasPosition(t,e);this.layers.borders.drawTileBorders(n,s,i)}drawObject(t,e){const[i,n]=this.toCanvasPosition(t,e),{unit:s,city:o}=this.grid.get(t,e);this.layers.objects.clearTile(t,e),s&&o?this.layers.objects.drawCityWithGarrison(i,n):s?this.layers.objects.drawUnit(i,n,s):o&&this.layers.objects.drawHouse(i,n)}drawTile(t,e){const i=this.toCanvasPosition(t,e),n=this.grid.get(t,e),[s,o]=i;this.layers.terrain.drawTerrain(s,o,n.terrain.name),(n.city||n.unit)&&this.drawObject(t,e),n.influencedBy&&this.drawBorders(t,e)}skipTurnsUntilEvent(t=1e3){let e=t;for(let i=1;i<=t;i++){const t=this.world.turn();if(t.length>0){t.forEach((t=>{this.handleEvent(t)})),e=i;break}}return e}update(t){this.world=t,this.viewportPosition=[0,0],this.layersContainer.innerHTML="",Object.assign(this.layersContainer.style,{width:this.width+"px",height:this.height+"px"}),this.createLayers(),this.draw()}setGridShown(t){document.getElementById("layer-grid").style.display=t?"block":"none"}turn(){const t=this.world.turn();return t.forEach((t=>{this.handleEvent(t)})),t}placeUnit(t,e,i){const n=i<=et.length?{type:et[i-1],playerId:1}:{type:et[1],playerId:0};this.world.placeUnit(t,e,n),this.drawObject(t,e)}placeCity(t,e,i){if(this.world.foundCity(t,e,i)){this.drawObject(t,e);for(const{dx:i,dy:n}of Ct.members)this.drawCapturedTileBorders(t+i,e+n)}}}Ii.DEFAULT_TILE_SIZE=32,Ii.LAYER_ID_PREFIX="layer-";const Ei=t=>$e(t,2),Mi=t=>{return e=t.getMilliseconds(),$e(e,3);var e},Ni=t=>`${((t,e="-")=>[t.getFullYear(),Ei(t.getMonth()+1),Ei(t.getDate())].join(e))(t)} ${((t,e=".")=>[Ei(t.getHours()),Ei(t.getMinutes()),Ei(t.getSeconds())].join(e))(t)}.${Mi(t)}`,Ui=t=>e=>((t,e)=>{const i=[];for(const n of e){const e=n.label||n.field,s=n.get?n.get(t):t[n.field];if(!r(s)){const t=`${e}: ${s}`;i.push(t)}}return i.join("; ")})(e,t),Bi="-",Ai=[{label:"move points",field:"movePoints"},{label:"hit points",get:t=>me(t)?t.hitPoints:null}],Oi=Ui([{field:"id"},{field:"name"},{field:"population"},{label:"project",get:t=>{if(null===t.project)return Bi;var e;var i;return`${e=t.project.type.productId,et[e-1].name} (${(i=t.project).progress+"/"+i.type.cost})`}},{label:"grow progress",get:t=>t.foodBasketSize>0?t.growthProgress+"/"+t.foodBasketSize:Bi},{label:"food surplus",field:"foodSurplus"},{label:"free tiles",get:t=>t.assignments.getFreeTilesCount()},{label:"expanding progress",get:t=>{const{tileToExpand:e}=t.influence;return e?t.influence.expandingProgress+"/"+e.cost:Bi}},{label:"growth to",get:t=>{const{tileToExpand:e}=t.influence;return e?e.position.join(", "):Bi}}]),Di=Ui(Ai),ji=t=>{const e=Ni(new Date),i=prompt("File Name",e);if(null!==i){const n=Ie(t,ui),s=new Uint8Array(function*(t){let e=0,i=0;for(const n of t)8===e&&(yield i,e=0,i=0),n&&(i+=2**e),++e;e>0&&(yield i)}(n));((t,e)=>{const i=new Blob([e],{type:"application/octet-stream"}),n=URL.createObjectURL(i),s=fi("a",{href:n,download:`${t}.save`});document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(n)})(i||e,s)}},ki=({content:t})=>[f("div",{className:"backdrop"}),f("div",{className:"modal-wrapper"},[t])];var Ri;class zi extends K{onMounted(){Ri.instance=this,document.addEventListener("keydown",(({key:t})=>{"Escape"===t&&this.closeModal()}))}showModal(t){this.setState({modal:t})}closeModal(){this.setState({modal:null})}render(){return this.state.modal?f(ki,{content:this.state.modal}):null}}Ri=zi,zi.showModal=t=>{Ri.instance.showModal(t)},zi.closeModal=()=>{Ri.instance.closeModal()};const Li=({label:t,value:e})=>f("span",{className:"field"},[f("span",`${t}: `,{className:"label"}),f("span",e,{className:"value"})]);class Fi extends K{constructor(){super(...arguments),this.fileInputRef={value:null},this.fileReader=new FileReader,this.loadFile=()=>{this.fileInputRef.value.click()}}onMounted(){this.fileReader.addEventListener("loadend",(t=>{const e=new Uint8Array(t.target.result);this.props.onLoad(e)}))}render(){return f("div",{className:"save-load"},[f("button","Save",{onclick:this.props.onSave}),f("button","Load",{onclick:this.loadFile}),f("input",{type:"file",ref:this.fileInputRef,onchange:t=>{const e=t.target;this.fileReader.readAsArrayBuffer(e.files[0]),e.value=null},style:{display:"none"}})])}}const Hi=({turn:t,mapSeed:e,playerName:i,onSave:n,onLoad:s,onNewWorld:o})=>{return f("div",{className:"top-panel"},[f(Li,{label:"Turn",value:`${t} (${i})`}),f(Li,{label:"Map Seed",value:(r=e,"number"==typeof r?Ye(e):"-")}),f(Fi,{onSave:n,onLoad:s}),f("button","New World",{onclick:o})]);var r},Wi=["Width","Height"],_i=(t,e,i)=>{const n=[];return t.forEach(((t,s)=>{if(t<e){const t=Wi[s];n.push(`${t} must be >= ${e}`)}else if(t>i){const t=Wi[s];n.push(`World ${t} must be <= ${i}`)}})),n},$i=({items:t,onChange:e,selectedItem:i=t[0],disabled:n=!1})=>f("select",{disabled:n,selectedIndex:t.indexOf(i),onchange:i=>{const n=t[i.target.selectedIndex];e(n)}},t.map((t=>f("option",t.name,{value:t.id})))),Gi=({label:t,disabled:e,items:i,selectedItem:n,onChange:s})=>[f("span",{className:"label"},`${t}: `),f($i,{disabled:e,items:i,selectedItem:n,onChange:s})],Xi=({value:t,onChange:e})=>f("div",{className:"seed-field"},[f("label","Seed: "),f("input",{type:"text",value:t,oninput:t=>{e(t.target.value)}}),f("button","",{type:"button",onclick:()=>{const t=Ke();e(t)}})]),Yi=({value:t,min:e,max:i,required:n,onChange:s})=>f("input",{value:t,min:e,max:i,step:1,required:n,type:"number",onchange:t=>{const e=t.target;s(Math.floor(+e.value))}}),Ki=({width:t,height:e,min:i,max:n,onWidthChange:s,onHeightChange:o})=>f("div",{className:"size-inputs"},[f("span","Size: "),f(Yi,{min:i,max:n,value:t,onChange:s,required:!0}),f("span",{className:"separator"},"x"),f(Yi,{min:i,max:n,value:e,onChange:o,required:!0})]),Qi=({name:t,value:e,checked:i,onChange:n,label:s})=>f("label",{className:"radio-button-container"},[f("input",{type:"radio",name:t,value:e,checked:i,onchange:()=>{n(!i)}}),f("div",{className:"checkmark"},[f("div")]),f("span",s,{className:"label"})]),Vi=({name:t,options:e,onChange:i,value:n})=>f("div",{className:"radio-buttons-group"},e.map((e=>{const o=s(e)?{id:e,name:e}:e;return f(Qi,{name:t,value:o.id,checked:n===e,onChange:()=>{i(e)},label:o.name})})));class qi extends K{constructor(){super(...arguments),this.handleSubmit=t=>{t.preventDefault();const{width:e,height:i}=this.state;this.setState({errors:[]}),this.state.isEmpty?this.onCreateEmptyWorld(e,i,this.state.terrain):this.onGenerateWorld(e,i,this.state.seed)},this.cancel=()=>{zi.closeModal()},this.getChangeHandler=t=>e=>{this.setState({[t]:e})},this.toggleEmpty=()=>{this.setState({isEmpty:!this.state.isEmpty})}}getInitialState(){return{width:40,height:20,seed:Ke(),terrain:q[0],errors:[],isEmpty:!0}}onCreateEmptyWorld(t,e,i){const n=_i([t,e],13,_e);0===n.length?(this.props.onCreateEmptyWorld(t,e,i),zi.closeModal()):this.setState({errors:n})}onGenerateWorld(t,e,i){const n=_i([t,e],13,_e),s=Xe(i);null===s&&n.push("Invalid seed"),0===n.length?(this.props.onGenerateWorld(t,e,s),zi.closeModal()):this.setState({errors:n})}render(){return f("div",{className:"modal create-world"},[f("div",{className:"form-row"},[f(Vi,{name:"options",options:["empty","generate"],value:this.state.isEmpty?"empty":"generate",onChange:t=>{this.setState({isEmpty:"empty"===t})}})]),f("form",{onsubmit:this.handleSubmit,noValidate:!0},[f("div",{className:"form-row"},[f(Ki,{width:this.state.width,height:this.state.height,min:13,max:_e,onWidthChange:this.getChangeHandler("width"),onHeightChange:this.getChangeHandler("height")})]),f("div",{className:"form-row"},[this.state.isEmpty?f(Gi,{label:"Terrain",items:q,selectedItem:this.state.terrain,onChange:this.getChangeHandler("terrain")}):f(Xi,{value:this.state.seed,onChange:this.getChangeHandler("seed")})]),this.state.errors.length>0?f("ul",{className:"errors"},this.state.errors.map((t=>f("li",t)))):null,f("div",{className:"modal-buttons"},[f("button","Cancel",{type:"button",onclick:this.cancel}),f("button","Create")])])])}}const Ji=({value:t=!1,label:e,onChange:i})=>f("label",{className:"checkbox-container"},[f("input",{type:"checkbox",checked:t,onchange:()=>{i(!t)}}),f("div",{className:"checkmark"},[f("div")]),e?f("span",e,{className:"label"}):null]);class Zi extends K{getInitialState(){return{checked:!1}}render(){return f("div",{className:"controls-group"},[f("button",this.props.buttonText,{onclick:()=>{this.props.onPress(this.state.checked)}}),f(Ji,{label:this.props.optionName,value:this.state.checked,onChange:t=>{this.setState({checked:t})}})])}}const tn=({onToggle:t,items:e,selectedItem:i,onItemSelected:n,selected:s})=>f("div",{className:"toggled-dropdown"},[f(Ji,{value:s,onChange:()=>{t(!s)}}),f($i,{items:e,selectedItem:i,disabled:!s,onChange:n})]);class en extends K{constructor(){super(...arguments),this.selectedItem=this.props.tool.items[0]}render(){return f(tn,{selected:this.props.selected,items:this.props.tool.items,selectedItem:this.selectedItem,onItemSelected:t=>{this.selectedItem=t,this.props.onChange(t)},onToggle:t=>{this.props.onChange(t?this.selectedItem:null)}})}}const nn=({tool:t,selectedTool:e,onChange:i})=>{const n=t.id===e?.id;return(t=>Boolean(t.items))(t)?f(en,{selected:n,tool:t,onChange:e=>{i(e?{id:t.id,option:e.id}:null)}}):f(Ji,{value:n,label:t.label,onChange:e=>{i(e?t:null)}})},sn=({tools:t,onChange:e,selectedTool:i})=>f("div",{className:"controls-group"},t.map((t=>f(nn,{tool:t,selectedTool:i,onChange:e})))),on={...et[1],id:et.length+1,name:"barbarian"},rn=[...et,on],an=[{id:"placeTerrain",items:q},{id:"placeUnit",items:rn},{id:"placeCity",label:"City"}],ln={id:0,name:"-"},cn=[ln,...it.map(((t,e)=>({id:t.productId,name:`${et[e].name} (${t.cost})`})))],hn=({onChange:t,selectedProject:e})=>{const i=null===e?ln:cn.find((t=>t.id===e.productId));return f("div",{className:"controls-group labeled"},[f(Gi,{label:"City Project",disabled:!1,onChange:e=>{const i=e!==ln?it.find((t=>t.productId===e.id)):null;t(i)},selectedItem:i,items:cn})])},dn=({onTurn:t,onSkipTurns:e,onToggleGrid:i,onToolSelected:n,onCityProjectChanged:s,selectedTool:o,selectedCity:r,gridShown:a,tileInfo:l})=>f("div",{className:"bottom-panel"},[f("div",{className:"controls-panel"},[f("div",{className:"controls-group"},[f(Ji,{label:"Grid",value:a,onChange:i})]),f(Zi,{optionName:"Skip Silent Turns",buttonText:"Turn",onPress:i=>{i?e():t()}}),f(sn,{tools:an,onChange:n,selectedTool:o}),r?f(hn,{onChange:s,selectedProject:r.project?r.project.type:null}):null]),f("span",{innerHTML:l??"-"})]),un=t=>{const{offsetX:e,offsetY:i}=t,{clientWidth:n,clientHeight:s}=t.target,o=s-1;return[Zt(e,n-1),Zt(i,o)]},pn=(e,i)=>{((t,e)=>{y(e,((e,i)=>{((t,e,i)=>{t.addEventListener(e,(t=>{t.preventDefault(),i(t)}))})(t,i,e)}))})(i,{contextmenu:t,mouseup:t=>{const i=un(t);0===t.button?t.ctrlKey?e.onCtrlClick(i):e.onLeftClick(i):e.onRightClick(i)},mousemove:t=>{const i=un(t);e.onMove(i)},mouseleave:()=>{e.onLeave()}})},gn=(t,e)=>{let i=null;return{onMove:n=>{const s=e(n);mt(s,i)||(t.onMove(s),i=s)},onLeave:()=>{t.onLeave(),i=null}}},mn=({element:t,getTilePosition:e,...i})=>{const n=((t,e)=>{const{onLeave:i,onMove:n,...s}=t,o=v(s,(t=>((t,e)=>i=>{t(e(i))})(t,e)));return{...o,...gn({onMove:n,onLeave:i},e)}})(i,e);pn(n,t)},fn={ArrowLeft:Ct.WEST.offset,ArrowUp:Ct.NORTH.offset,ArrowRight:Ct.EAST.offset,ArrowDown:Ct.SOUTH.offset},yn=["barbarians","player"];class vn extends K{constructor(){super(...arguments),this.view=new Ii(ve.createEmptyWorld(40,20),{onClearSelection:()=>{this.setState({selectedCity:null})},onCitySelected:t=>{this.setState({selectedCity:t})}}),this.viewContainerRef={value:null},this.saveWorld=()=>{ji(this.view.world)},this.loadWorld=t=>{const e=ve.fromData(pi(t));this.updateWorld(e)},this.createWorld=()=>{zi.showModal(f(qi,{onCreateEmptyWorld:(t,e,i)=>{const n=ve.createEmptyWorld(t,e,i);this.updateWorld(n)},onGenerateWorld:(t,e,i)=>{const n=ni(t,e,i),s=ve.fromTerrainMap(n,t,i);this.updateWorld(s)}}))},this.onToggleGrid=()=>{const t=!this.state.gridShow;this.view.setGridShown(t),this.setState({gridShow:t})},this.onTurn=()=>{this.view.turn(),this.setState({turn:this.view.world.turnNumber,playerName:this.getPlayerName()})},this.skipTurns=()=>{this.view.skipTurnsUntilEvent(),this.setState({turn:this.view.world.turnNumber,playerName:this.getPlayerName()})},this.onToolSelected=t=>{this.setState({selectedTool:t})},this.onCityProjectChanged=t=>{this.view.changeCityProject(t?.productId??null)}}getPlayerName(){return this.view?yn[this.view.world.playerId]:yn[1]}getInitialState(){return{turn:1,gridShow:!0,mapSeed:null,selectedTool:null,selectedCity:null,playerName:this.getPlayerName()}}onMounted(){this.view.mount(this.viewContainerRef.value),this.view.draw(),this.addMouseHandlers(),this.addKeyHandlers()}addMouseHandlers(){mn({element:this.view.layersContainer,getTilePosition:([t,e])=>{const[i,n]=this.view.viewportPosition;return this.view.grid.getPosition(Math.floor(t/this.view.tileSize)+i,Math.floor(e/this.view.tileSize)+n)},onLeftClick:([t,e])=>{this.state.selectedTool?(this.applyTool(t,e),this.setState({selectedTool:null})):this.view.onTileClick(t,e)},onRightClick:([t,e])=>{this.view.selectedUnit&&this.view.moveUnit(t,e)},onCtrlClick:([t,e])=>{this.state.selectedTool&&this.applyTool(t,e)},onMove:t=>{const e=this.getTileInfo(t);this.setState({tileInfo:e})},onLeave:()=>{this.setState({tileInfo:null})}})}addKeyHandlers(){(({element:t,...e})=>{t.addEventListener("keydown",(({key:t})=>{if(t.startsWith("Arrow")){const i=fn[t];e.onArrow(i)}else e[`on${t}`]?.()}))})({element:document,onEscape:()=>{this.view.clearSelection(),this.setState({selectedTool:null})},onArrow:([t,e])=>{this.view.moveViewport(t,e)},onDelete:()=>{this.view.removeSelectedUnit(),this.view.removeSelectedCity()}})}getTileInfo(t){return((t,e)=>{const[i,n]=e,s=[t.world.grid.getIndexByPosition(i,n),`[${e.join("; ")}]`],o=t.grid.get(i,n),{unit:r,city:a}=o;if(o.influencedBy&&s.push(((t,e)=>e.assignments.isPositionOccupied(t)?`<b>${e.name}</b>`:e.name)(e,o.influencedBy)),r)s.push(Di(r));else if(a)s.push(Oi(a));else if(t.selectedCity){const r=t.selectedCity.influence.getTilesToExpand().find((({position:t})=>mt(t,e)));r?s.push(`expansion cost: ${r.cost}`):null!==o.influencedBy&&o.influencedBy!==t.selectedCity&&t.selectedCity.influence.canSwap(i,n)&&s.push("swappable")}return s.join(" ")})(this.view,t)}applyTool(t,e){const{selectedTool:i}=this.state,n=i.id,s=this.view[n](t,e,i.option);var o;s&&this[`on${o=n,o.charAt(0).toUpperCase()+o.slice(1)}`]?.(s)}onPlaceTerrain(){this.setState({mapSeed:this.view.world.mapSeed})}updateWorld(t){this.view.update(t),this.setState({turn:this.view.world.turnNumber,mapSeed:this.view.world.mapSeed,playerName:this.getPlayerName()})}render(){return[f("div",{className:"main"},[f(Hi,{turn:this.state.turn,mapSeed:this.state.mapSeed,playerName:this.state.playerName,onSave:this.saveWorld,onLoad:this.loadWorld,onNewWorld:this.createWorld}),f("div",{ref:this.viewContainerRef}),f(dn,{gridShown:this.state.gridShow,onToggleGrid:this.onToggleGrid,onTurn:this.onTurn,onSkipTurns:this.skipTurns,onToolSelected:this.onToolSelected,onCityProjectChanged:this.onCityProjectChanged,selectedTool:this.state.selectedTool,selectedCity:this.state.selectedCity,tileInfo:this.state.tileInfo})]),f(zi,{})]}}var wn;wn=()=>{((t,e,i)=>{const n=m(t,e),s={parentElement:i,currentSibling:null};3===n.type?I(n,s):E(n,s)})(vn,{},document.body)},Q.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGAAAAAgCAYAAADtwH1UAAAAAXNSR0IArs4c6QAAAZFJREFUaEPtmluuwyAMRNutsXC21qtUSkojHsPYxtzK/cYMnmMDRXk+4ufqwNNVPcQfAcC5CEQAUkqvc/05Z9Fczj64ydOmleY7QziKgM5DwXmRPrXwmvlOEK4OdIIg1v/PAMrkT/5UPmQXqOhTC96gA2rJr4Sgpk8BODJ1PAN6ya+AoKpPA7hDWHQLQpK3hKCuLwJA7p1s2EzyFhBM9CkADmcAk7wmBDP9aQA9842uopLkNSCY6k8BQMxXhqCRvASCuf7OADSTZyAs0d8VgEXyMxCW6QeA+p0sALB3VSAOKboAABjJDgkAgHNoBZZmMjGtpUBzpZSu+JwzkNZ7yFcBINVwTbzwGooYUFs7G3c3bzhPaX5x9UYg/ASAXuGMzEOKrjtHzfwJCDyA1ivoHbvCw5zEREnsmcq+AEYQFMw/JKTv7WbxveoHu0DWAQHgc/C2NvzBgRwAgJOy2UHRAdgXEL+9BbW2IaX9P84AoEXfQww/zDKrYPDzlb23IBRQjBs7gPwpGc8SI2gHAgBtnU7gHxo8viHzg01RAAAAAElFTkSuQmCC",Q.onload=wn}();
