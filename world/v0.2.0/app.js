!function(){"use strict";const t=new Image,e=(t,e,i)=>e*i+t;function i(t,e){let i=t%e;return i<0&&(i+=e),~~i}const n=(t,e,n,s)=>[i(t,n),i(e,s)];function s(t,e){return[t%e,Math.floor(t/e)]}function o(t,e,i){const n=e-t,s=i/2;return Math.abs(n)<=s?n:n>0?n-i:i+n}const r=(t,e,i,n)=>e.map((e=>function(t,e,i,n){const[s,r]=t,[c,l]=e;return[o(s,c,i),o(r,l,n)]}(t,e,i,n)));l.DIAGONAL_MOVE_COST=3,l.AXIAL_MOVE_COST=2;const c=(t,e)=>l.DIAGONAL_MOVE_COST*Math.min(t,e)+l.AXIAL_MOVE_COST*Math.abs(t-e);function l(t,e,i,n){const s=Math.abs(t-i),o=Math.abs(e-n);return c(s,o)}const a=(t,e)=>{if(t===e)return!0;if(!t||!e)return!1;const[i,n]=t,[s,o]=e;return i===s&&n===o},h=(t,e)=>t.some((t=>a(t,e))),d=function(t){const e=Math.floor(t/l.AXIAL_MOVE_COST),i=[],n=t-2;for(let t=-e;t<=e;t++)for(let s=-e;s<=e;s++){if(0===s&&0===t)continue;const e=[s,t];for(let o=l(0,0,s,t)-2;o<=n;o++){const t=i[o];t?t.push(e):i[o]=[e]}}return i}(7);d[0],d[1],d[2],d[3],d[4];const u=d[5],g=([t,e],i)=>[t,2*i-e],p=([t,e],i)=>[2*i-t,e],f=([t,e,i,n])=>[i,e,t,n],y=([t,e,i,n])=>[t,n,i,e],m=(t,e)=>({position:g(t.position,e),borders:f(t.borders)}),w=(t,e)=>({position:p(t.position,e),borders:y(t.borders)});const T=t=>t,x=()=>!0,S=t=>"string"==typeof t,C=t=>void 0===t,v=t=>null===t||C(t);function E(t,e){for(const i in e)"style"===i?Object.assign(t.style,e.style):i in t?t[i]=e[i]:t.setAttribute(i,e[i])}const P=(t,...e)=>{const i=document.createElement(t);for(const t of e)Array.isArray(t)?i.append(...t):S(t)?i.innerText=t:E(i,t);return i},b=t=>{const{offsetX:e,offsetY:i}=t,{clientWidth:n,clientHeight:s}=t.target;return e>=n||i>=s?null:[e,i]};const A={NORTH:[0,-1],NORTH_EAST:[1,-1],EAST:[1,0],SOUTH_EAST:[1,1],SOUTH:[0,1],SOUTH_WEST:[-1,1],WEST:[-1,0],NORTH_WEST:[-1,-1]};class O{static $(t){const[e,i]=A[t];return new O(t,e,i)}constructor(t,e,i){this.name=t,this.dx=e,this.dy=i,this.isAxial=0===e||0===i,this.offset=[e,i];(this.isAxial?O.axial:O.diagonal).push(this),O.members.push(this)}}O.members=[],O.axial=[],O.diagonal=[],O.NORTH=O.$("NORTH"),O.NORTH_EAST=O.$("NORTH_EAST"),O.EAST=O.$("EAST"),O.SOUTH_EAST=O.$("SOUTH_EAST"),O.SOUTH=O.$("SOUTH"),O.SOUTH_WEST=O.$("SOUTH_WEST"),O.WEST=O.$("WEST"),O.NORTH_WEST=O.$("NORTH_WEST"),O.fromCoordinates=(t,e,i,n)=>O.fromOffsets(i-t,n-e),O.fromOffsets=(t,e)=>O.members.find((i=>i.dx===t&&i.dy===e))||null;const I=t=>e=>((t,e)=>{const i=[];for(const n of e){const e=n.label||String(n.field),s=n.get?n.get(t):t[n.field];if(!v(s)){const t=`${e}: ${s}`;i.push(t)}}return i.join("; ")})(e,t),M=I([{field:"id"},{field:"name"},{field:"population"},{label:"grow progress",get:t=>t.foodBasketSize>0?t.growthProgress+"/"+t.foodBasketSize:"-"},{label:"food surplus",field:"foodSurplus"},{label:"free tiles",get:t=>t.assignments.getFreeTilesCount()},{label:"expanding progress",get:t=>{const{tileToExpand:e}=t.influence;return e?t.influence.expandingProgress+"/"+e.cost:"-"}},{label:"growth to",get:t=>{const{tileToExpand:e}=t.influence;return e?e.position.join(", "):"-"}}]),R=I([{label:"move points",field:"movePoints"},{label:"move to",get:({targetPosition:t})=>t?t.join(", "):null}]),B={ArrowLeft:O.WEST.offset,ArrowUp:O.NORTH.offset,ArrowRight:O.EAST.offset,ArrowDown:O.SOUTH.offset};const U=(t,e=x)=>t.reduce(((t,i)=>e(i)?t+1:t),0);var D,N,L;!function(t){t[t.SETTLER=0]="SETTLER",t[t.WARRIOR=1]="WARRIOR",t[t.WORKER=2]="WORKER"}(D||(D={})),function(t){t[t.STEPPE=0]="STEPPE",t[t.GRASSLAND=1]="GRASSLAND"}(N||(N={})),function(t){t[t.UNIT=0]="UNIT",t[t.CITY=1]="CITY"}(L||(L={}));const j=(t=N.GRASSLAND)=>({city:null,unit:null,terrain:t}),k=(t,e)=>function(t,e){const i=[];for(let n=0;n<t;n++){const t=e(n);i.push(t)}return i}(e*t,(()=>j()));class z{constructor(t,e){this.width=t,this.height=e}getPosition(t,e){return n(t,e,this.width,this.height)}getPositionByIndex(t){return s(t,this.width)}getIndexByPosition(t,e){return t+e*this.width}getOffsets(t,e){const[i,n]=t,[s,r]=e;return[o(i,s,this.width),o(n,r,this.height)]}getCirclePositions(t,e,i){const n=Math.floor(i/l.AXIAL_MOVE_COST),s=[];for(let o=-n;o<=n;o++)for(let r=-n;r<=n;r++){const n=this.getPosition(t+r,e+o),[c,l]=n;this.getOctileDistance(c,l,t,e)<=i&&s.push(n)}const o=[t,e];return s.sort(((t,e)=>this.comparePositions(o,t,e)))}getNextLinePosition(t,e){const[i,n]=this.getOffsets(t,e),s=Math.sign(i),o=Math.sign(n),r=Math.abs(i),c=Math.abs(n);let l=r-c,[a,h]=t;const d=2*l;return d>-c&&(l-=c,a+=s),d<r&&(l+=r,h+=o),[a,h]}comparePositions(t,e,i){const[n,s]=this.getOffsets(t,e),[o,r]=this.getOffsets(t,i),l=c(Math.abs(n),Math.abs(s)),a=c(Math.abs(o),Math.abs(r));return l!==a?l-a:s!==r?s-r:n-o}sortPositions(t,e){return i=(e,i)=>this.comparePositions(t,e,i),e.slice().sort(i);var i}isAdjacentPositions(t,e){const[i,n]=this.getOffsets(t,e),s=Math.abs(i),o=Math.abs(n);return 1===s&&1===o||0===s&&1===o||1===s&&0===o}getOctileDistance(t,e,i,n){const[s,o]=this.getOffsets([t,e],[i,n]);return c(Math.abs(s),Math.abs(o))}}class _ extends z{constructor(t,e){super(e,t.length/e),this.tiles=t}get(t,e){const[i,n]=this.getPosition(t,e),s=this.getIndexByPosition(i,n);return this.tiles[s]}influencedByCity(t,e,i){return this.get(t,e).influencedBy===i}addInfluence(t,e,i){this.get(t,e).influencedBy=i}}_.createTileFromTileData=t=>((t=N.GRASSLAND)=>Object.assign(Object.assign({},j(t)),{influencedBy:null}))(t.terrain),_.createFromTilesData=(t,e)=>new _(t.map(_.createTileFromTileData),e);const F=t=>10*t+Math.pow(t-1,2);var H=["populationIncreased","bordersExpanded","unitMoved"].reduce(((t,e)=>Object.assign(Object.assign({},t),{[e]:t=>({type:e,payload:t})})),{});const W=(t,e)=>({index:0,buffer:[],*[Symbol.iterator](){for(;this.index<t.length;)0===this.buffer.length&&(this.buffer=e(t[this.index]),++this.index),yield this.buffer.shift();for(;this.buffer.length>0;)yield this.buffer.shift();throw new Error("Unexpected end of input")}});const Q=function(t){let e=0;for(let i=0;i<t.length;i++)t[i]&&(e+=Math.pow(2,i));return e};function G(t,e,i){const n=[];for(;t>0&&n.length<e;){const e=i(t%2==1);t=Math.floor(t/2),n.push(e)}const s=i(!1);for(;n.length<e;)n.push(s);return n}const V=(t,e)=>G(t,e,T),$=t=>V(t,8);const Y=(t,e)=>function(t,e,i){const n=[];for(const s of t){const t=G(s,e,i);n.push(...t)}return n}(t,e,T);const q=(t,e)=>t<<15|e;function J(t,e){let i=0,n=0;if(0===e)return i;for(const s of t)if(s&&(i+=Math.pow(2,n)),++n,n===e)return i;return i}const K=(t,e)=>{t&&++e.truesCount};function X(t,e){const i=[];for(const n of t)if(i.push(n),i.length===e)return i;return i}const Z=t=>Math.ceil(Math.log2(t+1));const tt=(t,e)=>function(t,e,i){const n=[];for(let s=0;s<e;s++){const e=X(t,i),s=Q(e);n.push(s)}return n}(t,e,8),et=[1,2];class it{static getStartInfluencePositions(t,e,i=3){const[n,s]=t;return e.getCirclePositions(n,s,i).filter((([t,i])=>!e.get(t,i).influencedBy))}constructor(t,e){this.city=t,this.tileToExpand=null,this.positions=this.grid.sortPositions(t.position,e.influencedPositions),this.expandingProgress=e.expandingProgress,this.place()}getFreeTilesCount(){const[t,e]=this.city.position;return U(u,(([i,n])=>{const{influencedBy:s}=this.grid.get(t+i,e+n);return null===s}))}getTileExpansionCost(t){const[e,i]=t;let n=0;for(const{dx:t,dy:s}of O.members){const o=e+t,r=i+s,{influencedBy:c}=this.grid.get(o,r);c&&(n+=6/this.grid.getOctileDistance(o,r,e,i))}const[s,o]=this.city.position,r=this.grid.getOctileDistance(s,o,e,i)-3;return Math.round(160/n+Math.pow(r,2))}getTilesToExpand(){const t=this.getNextFrontierPositions(),e=[];for(const i of t)if(this.canExpandToPosition(i)){const t=this.getTileExpansionCost(i);e.push({position:i,turnsToExpand:t/this.getExpandingPoints(),cost:t})}return e.sort(((t,e)=>this.compareTilesToExpand(t,e)))}compareTilesToExpand(t,e){const i=t.cost-e.cost;if(0!==i)return i;const[n,s]=t.position,[o,r]=e.position,c=et[this.grid.get(n,s).terrain];return et[this.grid.get(o,r).terrain]-c}getExpandingPoints(){return((t,e)=>{const i=Math.ceil(t/2);return e>=i?e-i+1:0})(this.positions.length,this.city.population)}expand(){const{position:t}=this.tileToExpand;this.tileToExpand=null;const[e,i]=t;return this.addTile(e,i),H.bordersExpanded({city:this.city,position:t})}turn(){if(null===this.tileToExpand)return null;this.expandingProgress+=this.getExpandingPoints();const t=this.expandingProgress-this.tileToExpand.cost;return t>=0?(this.expandingProgress=t,this.expand()):null}place(){for(const[t,e]of this.positions)this.grid.addInfluence(t,e,this.city)}remove(){this.positions.forEach((([t,e])=>{this.grid.get(t,e).influencedBy=null}))}canExpandToPosition(t){const[e,i]=t;if(null!==this.grid.get(e,i).influencedBy)return!1;const[n,s]=this.grid.getNextLinePosition(t,this.city.position);if(!this.grid.influencedByCity(n,s,this.city))return!1;if(!O.diagonal.some((({dx:t,dy:n})=>this.grid.influencedByCity(e+t,i+n,this.city))))return!1;if(!O.axial.some((({dx:t,dy:n})=>this.grid.influencedByCity(e+t,i+n,this.city))))return!1;const[o,r]=this.city.position;return this.grid.getOctileDistance(e,i,o,r)<=7}getNextFrontierPositions(){const t=[];for(const[e,i]of this.positions)for(const{dx:n,dy:s}of O.axial){const o=e+n,r=i+s,c=this.grid.getPosition(o,r),{influencedBy:l}=this.grid.get(o,r);null!==l||h(t,c)||t.push(c)}return t}swap(t,e){const i=this.grid.get(t,e).influencedBy,n=this.positions.findIndex((([i,n])=>t===i&&e===n));((t,e)=>{t.splice(e,1)})(this.positions,n),this.positions=this.grid.sortPositions(this.city.position,this.positions),i.influence.addTile(t,e)}canSwap(t,e){return this._canSwap(t,e,new Map)}_canSwap(t,e,i){const n=q(t,e);if(i.has(n))return i.get(n);const s=this.grid.get(t,e).influencedBy;if(null===s||s===this.city)return i.set(n,!1),!1;const[o,r]=this.city.position;if(this.grid.getOctileDistance(t,e,o,r)>7)return i.set(n,!1),!1;if(!s.assignments.hasFreeTiles())return i.set(n,!1),!1;const c=[!1,!1],l=[[],[]];for(const{dx:s,dy:o,isAxial:r}of O.members){const a=t+s,h=e+o,{influencedBy:d}=this.grid.get(a,h),u=+r;if(d!==this.city){l[u].push([a,h]);continue}const g=+!r;if(c[u]=!0,c[g])return i.set(n,!0),!0}return c.every(((t,e)=>t||l[e].some((([t,e])=>this._canSwap(t,e,i)))))}addTile(t,e){this.grid.addInfluence(t,e,this.city);const{positions:i}=this;i.push([t,e]),this.positions=this.grid.sortPositions(this.city.position,i)}expandToTile(t,e){const i=[t,e];h(this.positions,i)||this.addTile(t,e)}get grid(){return this.city.grid}}class nt{static getDefaultPositions(t,e,i,n=1){const s=[];for(;n-- >0;){let n,o=0;for(let r=0;r<e.length;r++){const c=e[r];if(a(c,t)||s.some((t=>a(t,c))))continue;const[l,h]=c,d=i.get(l,h),u=et[d.terrain];u>o&&(o=u,n=c)}n&&s.push(n)}return s}recalculate(t=this.influence.city.population){this.positions=nt.getDefaultPositions(this.influence.city.position,this.influence.positions,this.grid,t)}constructor(t,e,i){this.grid=t,this.influence=e,this.positions=i}isPositionOccupied(t){return a(t,this.city.position)||h(this.positions,t)}isPositionFree(t){return!this.isPositionOccupied(t)}hasFreeTiles(){return this.influence.positions.some((t=>this.isPositionFree(t)))}getFreeTilesCount(){return U(this.influence.positions,(t=>this.isPositionFree(t)))}getFoodPerTurn(){const[t,e]=this.influence.city.position,i=et[this.grid.get(t,e).terrain];return this.positions.reduce(((t,e)=>{if(!this.influence.positions.some((t=>a(t,e))))return t;const[i,n]=e;return t+et[this.grid.get(i,n).terrain]}),i)}get city(){return this.influence.city}}const st={population:1,expansionLevel:0};class ot{static found(t,e,i=0,n="",s={}){const o=Object.assign(Object.assign({},st),s),r=it.getStartInfluencePositions(e,t,o.expansionLevel+3);return new ot(t,{position:e,influencedPositions:r,assignmentsPositions:nt.getDefaultPositions(e,r,t,o.population),growthProgress:0,expandingProgress:0,name:n,id:i})}constructor(t,e){this.grid=t,this.position=e.position,this.name=e.name,this.id=e.id,this.growthProgress=e.growthProgress;const[i,n]=e.position;t.get(i,n).city=this,this.influence=new it(this,e),this.assignments=new nt(t,this.influence,e.assignmentsPositions),this.assignments.getFreeTilesCount()>0?this.foodBasketSize=F(this.population):this.foodBasketSize=0}get population(){return this.assignments.positions.length}get influencedPositions(){return this.influence.positions}get assignmentsPositions(){return this.assignments.positions}get expandingProgress(){return this.influence.expandingProgress}turn(){const t=[],e=this.assignments.getFreeTilesCount();if(0===e)return t;const i=F(this.population);this.growthProgress+=this.foodSurplus;let n=this.population;const s=this.influence.turn();null!==s&&t.push(s);const o=this.growthProgress-i;if(o>=0){e>1?(this.growthProgress=o,this.foodBasketSize=F(this.population+1)):(this.growthProgress=0,this.foodBasketSize=0),++n;const i=H.populationIncreased({city:this});t.push(i)}else this.growthProgress;return t.length>0&&this.assignments.recalculate(n),t}get foodSurplus(){return this.assignments.getFoodPerTurn()-2*this.population}remove(){this.influence.remove()}}class rt{constructor(t){this.influence=t,this.tilesToExpand=t.getTilesToExpand(),this.tilesToExpandLeft=t.getFreeTilesCount()}get tileToExpand(){return this.influence.tileToExpand}set tileToExpand(t){this.influence.tileToExpand=t}}const ct=(t,e)=>e.tileToExpand.turnsToExpand!==t.tileToExpand.turnsToExpand?e.tileToExpand.turnsToExpand<t.tileToExpand.turnsToExpand:e.tilesToExpandLeft<t.tilesToExpandLeft;class lt{constructor(t,e=[],i=0){this.grid=t,this.cities=lt.createCities(t,e),this._nextCityId=i,this.updateTilesToExpand()}updateTilesToExpand(){(t=>{const e=new Map;for(;t.length>0;){const i=t.shift();if(0===i.tilesToExpand.length)continue;const n=i.tilesToExpand.shift(),[s,o]=n.position,r=q(s,o),c=e.get(r);i.tileToExpand=n,c?ct(c,i)?(c.tileToExpand=null,t.push(c),e.set(r,i)):(i.tileToExpand=null,t.push(i)):e.set(r,i)}})(this.cities.map((t=>(t.influence.tileToExpand=null,new rt(t.influence)))))}turn(){const t=[];return this.cities.forEach((e=>{const i=e.turn();t.push(...i)})),this.updateTilesToExpand(),t}addCity(t){this.cities.push(t),this.updateTilesToExpand(),++this._nextCityId}nextCityName(){return(t=>{const e=[];do{const i=t%26;t=Math.floor(t/26),e.push(String.fromCharCode(i+65))}while(t>0);return e.join("")})(this.nextCityId)}foundCity(t,e,i){if(!this.canPlaceCity(t,e))return null;const n=ot.found(this.grid,[t,e],this.nextCityId,this.nextCityName(),i);return this.addCity(n),n}canPlaceCity(t,e){return this.cities.every((({position:[i,n]})=>this.grid.getOctileDistance(i,n,t,e)>=8))}captureRelativePosition(t,[e,i]){const[n,s]=t.position,[o,r]=this.grid.getPosition(n+e,s+i);this.captureTile(n,s,o,r)}captureTile(t,e,i,n){const{city:s}=this.grid.get(t,e);s.influence.expandToTile(i,n),this.updateTilesToExpand()}get nextCityId(){return this._nextCityId}}var at;lt.createCities=(t,e)=>e.map((e=>new ot(t,e))).sort(((t,e)=>t.id-e.id));class ht{constructor(t,e){this.grid=t,this.targetPosition=null,Object.assign(this,e);const[i,n]=e.position;t.get(i,n).unit=this}canMove(){const t=[];let e=this.targetPosition;for(;null!==e;){const[i,n]=e,s=this.grid.getIndexByPosition(i,n);if(t.includes(s))return!0;t.push(s);const o=this.grid.get(i,n).unit;if(!o)return!0;e=o.targetPosition}return!1}beforeTurn(){this.canMove()?this.movePoints+=ht.START_MOVE_POINTS:(this.movePoints=ht.START_MOVE_POINTS,this.cancelMove())}cancelMove(){this.targetPosition=null}decreaseMovePoints(t){this.movePoints-=t,this.movePoints>ht.START_MOVE_POINTS&&(this.movePoints=ht.START_MOVE_POINTS)}scheduleMove(t,e){this.targetPosition=[t,e]}hasEnoughPointsToMove(){return this.getMoveCost()<=this.movePoints}getMoveCost(){const[t,e]=this.grid.getOffsets(this.position,this.targetPosition);return O.fromOffsets(t,e).isAxial?2:3}move(){const[t,e]=this.position,[i,n]=this.targetPosition,s=this.getMoveCost(),o=this.grid.get(i,n),r=this.grid.get(t,e);o.unit=this,r.unit===this&&(r.unit=null),this.decreaseMovePoints(s);const c=H.unitMoved({from:this.position,to:this.targetPosition});return this.position=this.targetPosition,this.targetPosition=null,c}}at=ht,ht.START_MOVE_POINTS=6,ht.getDefaultData=(t,e)=>({position:[t,e],type:D.SETTLER,movePoints:at.START_MOVE_POINTS,targetPosition:null});class dt{constructor(t,e=[]){this.grid=t,this.movements=new Map,this.units=[],this.createUnits(e)}createUnits(t){t.forEach((t=>{const[e,i]=t.position,n=this.placeUnit(e,i,t);if(null!==n.targetPosition){const[t,e]=n.targetPosition,i=this.grid.getIndexByPosition(t,e);this.movements.set(i,n)}}))}turn(){const t=[];this.units.forEach((t=>{t.beforeTurn()}));for(const e of this.units)if(e.targetPosition){const[i,n]=e.targetPosition,s=this.moveUnit(e,i,n);t.push(...s)}return t}placeUnit(t,e,i={}){if(null!==this.grid.get(t,e).unit)return null;const n=Object.assign(ht.getDefaultData(t,e),i),s=new ht(this.grid,n);return this.units.push(s),s}moveUnit(t,e,i){if(a(t.position,[e,i])&&this.cancelMove(t),!this.grid.isAdjacentPositions(t.position,[e,i]))return[];if(t.targetPosition){const[e,i]=t.targetPosition,n=this.grid.getIndexByPosition(e,i);this.movements.delete(n)}const n=this.grid.getIndexByPosition(e,i),s=this.movements.get(n);s&&this.cancelMove(s),t.scheduleMove(e,i),this.movements.set(n,t);const o=this.getMoveChain(t,!0);return o.isLoop||null===this.grid.tiles[n].unit?this.moveUnits(o.units):[]}moveUnits(t){return t.map((t=>{const[e,i]=t.targetPosition,n=this.grid.getIndexByPosition(e,i);return this.movements.delete(n),t.move()}))}cancelMove(t){const{units:e}=this.getMoveChain(t,!1);this.chancelUnitsMoves(e)}chancelUnitsMoves(t){t.forEach((t=>{if(null!==t.targetPosition){const[e,i]=t.targetPosition,n=this.grid.getIndexByPosition(e,i);this.movements.delete(n),t.cancelMove()}}))}getMoveChain(t,e){const i=[],n=[];for(;(null==t?void 0:t.targetPosition)&&(!e||t.hasEnoughPointsToMove());){const[e,s]=t.position,o=this.grid.getIndexByPosition(e,s);if(i.includes(o))return{units:n,isLoop:!0};n.push(t),i.push(o),t=this.movements.get(o)}return{units:n,isLoop:!1}}}class ut{static createEmptyWorld(t,e){const i=this.createEmptyWorldData(t,e);return ut.fromData(i)}static fromData(t){const e=_.createFromTilesData(t.tiles,t.width);return new ut(e,t)}constructor(t,e){this.grid=t,this.turnNumber=e.turnNumber,this.citiesService=new lt(t,e.cities,e.nextCityId),this.unitsService=new dt(t,e.units)}turn(){this.turnNumber===ut.MAX_TURN_NUMBER&&(console.warn("Max turns reached"),this.turnNumber=1);const t=this.citiesService.turn(),e=this.unitsService.turn();return++this.turnNumber,t.concat(e)}moveUnit(t,e,i){return this.unitsService.moveUnit(t,e,i)}placeTerrain(t,e,i){const n=this.grid.get(t,e);n.terrain=i;const{influencedBy:s}=n;return s?s.assignments.recalculate():(O.axial.some((({dx:i,dy:n})=>this.grid.get(t+i,e+n).influencedBy))&&this.citiesService.updateTilesToExpand(),[])}placeUnit(t,e,i={}){return this.unitsService.placeUnit(t,e,i)}foundCity(t,e,i){return this.citiesService.foundCity(t,e,i)}captureTile(t,e,i,n){this.citiesService.captureTile(t,e,i,n)}get cities(){return this.citiesService.cities}get units(){return this.unitsService.units}get nextCityId(){return this.citiesService.nextCityId}get tiles(){return this.grid.tiles}get width(){return this.grid.width}get height(){return this.grid.height}}ut.MAX_TURN_NUMBER=Math.pow(2,16),ut.createEmptyWorldData=(t,e)=>({tiles:k(t,e),height:e,width:t,cities:[],units:[],turnNumber:1,nextCityId:0});var gt={showGrid:!0,tool:null,world:ut.createEmptyWorld(40,20)};let pt=0;const ft=()=>`checkbox-${pt++};`,yt=({id:t=ft(),label:e,onToggle:i,checked:n=!1})=>{const s=P("input",{type:"checkbox",checked:n,onchange(t){const e=t.target;i(e.checked)}});return{element:P("div",[P("label",e,{htmlFor:t}),s]),update({checked:t}){s.checked=t}}},mt=/^\s*([1-9]\d*)[^\d]+([1-9]\d*)\s*$/;const wt=["width","height"];function Tt(t,e){const i=function(t){const e=mt.exec(t);return e?[+e[1],+e[2]]:null}(t);if(null===i)return e(`Invalid world size: '${t}'`),null;const n=function(t){const e=[];return t.forEach(((t,i)=>{if(t<13){const t=wt[i];e.push(`World ${t} must be equal or greater than 13`)}else if(t>265){const t=wt[i];e.push(`World ${t} must be equal or less than 265`)}})),e}(i);return n.length>0?(e(n.join("\n")),null):i}function xt({onDone:t}){const e=(t=>{const{parseInput:e,onParseError:i,onDone:n,buttonText:s,promptTitle:o}=t;return{element:P("button",s,{onclick(){const t=prompt(o);if(null===t)return;let s=!0;const r=e(t,(t=>{i(t),s=!1}));s&&n(r)}})}})({buttonText:"New World",promptTitle:"New world size:",parseInput:Tt,onParseError(t){alert(t)},onDone([e,i]){t(e,i)}});return{element:e.element}}const St=({onToggle:t,items:e,onItemSelected:i})=>{const n=(({items:t,onSelect:e,disabled:i=!1})=>{const n=P("select",{disabled:i});for(const e of t){const t=P("option",{innerText:e.text,value:e.id.toString()});n.appendChild(t)}return n.onchange=()=>{const i=t[n.selectedIndex];e(i)},{element:n,onSelect:e,update({disabled:t}){n.disabled=t}}})({items:e,onSelect:i,disabled:!0}),s=P("input",{type:"checkbox",onchange(){n.update({disabled:!s.checked}),t(s.checked)}});return{element:P("div",[s,n.element]),update({checked:t}){n.element.disabled=!t,s.checked=t}}},Ct=[{id:N.STEPPE,text:"steppe"},{id:N.GRASSLAND,text:"grassland"}],vt=[{id:D.SETTLER,text:"settler"},{id:D.WARRIOR,text:"warrior"},{id:D.WORKER,text:"worker"}],Et={component:null,createComponent(t){return this.component=St({onToggle:e=>{t(e?this:null)},onItemSelected:t=>{this.options.selectedItem=t},items:this.options.items}),this.component}},Pt={component:null,createComponent(t){return this.component=yt({onToggle:e=>{t(e?this:null)},label:this.options.label}),this.component}},bt=[Object.assign(Object.assign({},Et),{name:"placeTerrain",options:{items:Ct,selectedItem:Ct[0]}}),Object.assign(Object.assign({},Et),{name:"placeUnit",options:{items:vt,selectedItem:vt[0]}}),Object.assign(Object.assign({},Pt),{name:"placeCity",options:{label:"City"}})],At=({dispatch:t})=>{const e=P("span","-"),{element:i}=yt({label:"Grid",id:"grid",checked:gt.showGrid,onToggle(e){t({showGrid:e})}}),n=P("button","Turn",{onclick:()=>{t("turn")}}),s=P("button","Skip Turns Until Event",{onclick:()=>{t("skipTurns")}}),o=(({onSave:t,onLoad:e})=>{const i=new FileReader;i.addEventListener("loadend",(t=>{const i=new Uint8Array(t.target.result);e(i)}));const n=P("input",{type:"file",onchange(t){const e=t.target;i.readAsArrayBuffer(e.files[0]),e.value=null},style:{display:"none"}});return{element:P("div",[P("button","Load",{onclick(){n.click()}}),n,P("button","Save",{onclick:t})])}})({onSave(){t("save")},onLoad(e){t("load",e)}}),r=(t=>{let e=null;const i=i=>{i!==e&&(e=i,t(e),bt.forEach((t=>{t!==e&&t.component.update({checked:!1})})))},n=bt.map((t=>t.createComponent(i)));return{element:P("div",{className:"tools"},n.map((t=>t.element))),update({tool:t}){i(t)}}})((e=>{t({tool:e})})),c=xt({onDone(e,i){t("newWorld",e,i)}}),l=P("div",{className:"controls-panel"},[i,n,s,r.element,o.element,c.element]);return{element:P("div",{className:"bottom-panel"},[l,e]),update({info:t,tool:i}){C(t)||(e.innerHTML=t||"-"),C(i)||r.update({tool:i})}}};class Ot{constructor(t,e){this.view=t,this.context=e}drawSprite(e,i,n){const{tileSize:o}=this.view,r=t.width/o,[c,l]=s(e,r),a=c*o,h=l*o;this.context.drawImage(t,a,h,o,o,i,n,o,o)}clearTile(t,e){const[i,n]=this.view.toCanvasPosition(t,e),{tileSize:s}=this.view;this.context.clearRect(i,n,s,s)}moveViewport(t,e){const{context:i}=this,{width:n,height:s,tileSize:o}=this.view;if(0!==t){const e=t*o,r=t>0?e:n+e,c=i.getImageData(0,0,r,s),l=i.getImageData(r,0,n-r,s);i.putImageData(c,n-r,0),i.putImageData(l,0,0)}if(0!==e){const t=e*o,r=e>0?t:s+t,c=i.getImageData(0,0,n,r),l=i.getImageData(0,r,n,s-r);i.putImageData(c,0,s-r),i.putImageData(l,0,0)}}}const It=["#88C34A","#388E3C"];class Mt extends Ot{drawGrid(){this.context.fillStyle=Mt.GRID_COLOR;const{tileSize:t}=this.view,{width:e,height:i}=this.context.canvas;for(let n=t;n<e;n+=this.view.tileSize)this.context.fillRect(n,0,1,i);for(let n=t;n<i;n+=this.view.tileSize)this.context.fillRect(0,n,e,1)}moveViewport(){}}Mt.GRID_COLOR="#555";class Rt extends Ot{constructor(t,e,i){super(t,e),this.borderRenderer=i}drawMaxCityBorders([t,e]){this.context.fillStyle=Rt.BORDERS_COLOR;Rt.getBorderTiles(t,e).forEach((t=>{const[e,i]=this.view.toCanvasPosition(...t.position);this.borderRenderer(this.context,e,i,t.borders)}))}clearMaxCityMaxBorders([t,e]){Rt.getBorderTiles(t,e).forEach((({position:[t,e]})=>{this.clearTile(t,e)}))}drawCitizenDistribution(t){this.context.fillStyle=Rt.CITIZEN_COLOR;for(const[e,i]of t.assignmentsPositions)this.drawCitizen(e,i)}clearCitizenDistribution(t){for(const[e,i]of t.influencedPositions)this.clearTile(e,i)}drawCitizen(t,e){const[i,n]=this.view.toCanvasPosition(t,e);this.drawSprite(3,i,n)}drawUnitSelection(t,e){const[i,n]=this.view.toCanvasPosition(t,e);this.context.strokeStyle="#000",this.context.beginPath(),this.context.rect(i+2,n+2,this.view.tileSize-3,this.view.tileSize-3),this.context.closePath(),this.context.stroke()}drawCitySelection(t){this.drawCitizenDistribution(t),this.drawMaxCityBorders(t.position)}clearCitySelection(t){this.clearMaxCityMaxBorders(t.position),this.clearCitizenDistribution(t)}}Rt.BORDERS_COLOR="#333",Rt.CITIZEN_COLOR="#000",Rt.getBorderTiles=(t,e)=>function(t,e,i){const n=Math.floor(i/2),s=t-n,o=[];let r=t;for(let l=e-n;l<e;l++){const n=Math.abs(l-e);let a=!0;for(let h=s;h<t;h++){const s=r,d=Math.abs(h-t),u=c(d,n);if(u!==i&&u!==i-1)continue;let g;h<s?(g=a?[!0,!1,!1,!0]:[!0,!1,!1,!1],r=h):g=h===s?[!1,!1,!1,!0]:[!0,!1,!1,!1],a=!1;const p={position:[h,l],borders:g},f=w(p,t),y=m(f,e),T=w(y,t);o.push(p,f,y,T),a=!1}}const l={position:[t,e-n],borders:i%2==0?[!0,!0,!1,!0]:[!0,!1,!1,!1]},a={position:[t-n,e],borders:i%2==0?[!0,!1,!0,!0]:[!1,!1,!1,!0]},h=m(l,e),d=w(a,t);return o.push(l,a,h,d),o}(t,e,7);class Bt extends Ot{constructor(t,e,i){super(t,e),this.context.fillStyle=Bt.BORDERS_COLOR,this.bordersRenderer=i}drawTileBorders(t,e,i){this.bordersRenderer(this.context,t,e,i)}}Bt.BORDERS_COLOR="#000";var Ut={terrain:class extends Ot{drawTerrain(t,e,i){this.context.fillStyle=It[i];const{tileSize:n}=this.view;this.context.fillRect(t,e,n,n)}},grid:Mt,selection:Rt,borders:Bt,objects:class extends Ot{drawUnit(t,e,i){this.drawSprite(i,t,e)}drawHouse(t,e){this.drawSprite(4,t,e)}drawCityWithGarrison(t,e){this.drawSprite(5,t,e)}}};class Dt{static getLayerId(t){return Dt.LAYER_ID_PREFIX+t}constructor(t,e=Dt.DEFAULT_TILE_SIZE){this.world=t,this.tileSize=e,this.selectedUnit=null,this.selectedCity=null,this.viewportPosition=[0,0],this.selectors=[({unit:t})=>this.selectUnit(t),({city:t})=>this.selectCity(t),()=>this.clearSelection()],this.eventHandlers={onPopulationIncreased:({city:t})=>{var e;(null===(e=this.selectedCity)||void 0===e?void 0:e.id)===t.id&&this.layers.selection.drawCitizenDistribution(t)},onBordersExpanded:({city:t,position:e})=>{var i;const[n,s]=e;this.drawCapturedTileBorders(n,s),(null===(i=this.selectedCity)||void 0===i?void 0:i.id)===t.id&&this.refreshCitySelection()},onUnitMoved:({from:[t,e],to:[i,n]})=>{const{unit:s}=this.grid.get(i,n),o=this.grid.get(t,e);null===o.unit&&null===o.city?this.layers.objects.clearTile(t,e):this.drawObject(t,e),this.drawObject(i,n),this.selectedUnit===s&&(this.layers.selection.clearTile(t,e),this.layers.selection.drawUnitSelection(i,n))}},this.bordersRender=function(t){const e=(t=>[[0,0,t,1],[t-1,0,1,t],[0,t-1,t,1],[0,0,1,t]])(t);return(t,i,n,s)=>{e.filter(((t,e)=>s[e])).forEach((([e,s,o,r])=>{t.fillRect(i+e,s+n,o,r)}))}}(e)}get grid(){return this.world.grid}get width(){return this.world.width*this.tileSize}get height(){return this.world.height*this.tileSize}handleEvent(t){var e;this.eventHandlers[`on${e=t.type,e.charAt(0).toUpperCase()+e.slice(1)}`](t.payload)}createLayer(t){const e=P("canvas",{id:Dt.getLayerId(t),width:this.width,height:this.height});return this.layersContainer.appendChild(e),e.getContext("2d")}createLayers(){this.layers={};for(const[t,e]of Object.entries(Ut)){const i=this.createLayer(t);this.layers[t]=new e(this,i,this.bordersRender)}this.layers.grid.drawGrid()}mount(t){this.layersContainer=P("div",{id:"layers",style:{width:this.width+"px",height:this.height+"px"}}),this.createLayers(),t.appendChild(this.layersContainer)}addMouseMoveHandler(t){let e=null;this.layersContainer.addEventListener("mousemove",(i=>{const n=b(i);if(null===n)return t(null),void(e=null);const[s,o]=n,r=this.getTilePosition(s,o);a(r,e)||(t(r),e=r)})),this.layersContainer.addEventListener("mouseleave",(()=>{t(null)}))}canCapture(t,e){return!h(this.selectedCity.influencedPositions,[t,e])&&this.selectedCity.influence.canExpandToPosition([t,e])}drawCapturedTileBorders(t,e){this.drawBorders(t,e);for(const{dx:i,dy:n}of O.axial){const s=t+i,o=e+n;this.grid.get(s,o).influencedBy&&this.drawBorders(t+i,e+n)}}captureTile(t,e){const[i,n]=this.selectedCity.position;this.world.captureTile(i,n,t,e),this.drawCapturedTileBorders(t,e)}selectCity(t){const e=!!t;return e&&(this.clearSelection(),this.selectedCity=t,this.drawCitySelection()),e}selectUnit(t){const e=!!t;if(e){this.clearSelection(),this.selectedUnit=t;const[e,i]=t.position;this.layers.selection.drawUnitSelection(e,i)}return e}select(t,e=!0){for(let i=e?0:1;i<this.selectors.length;i++){if((0,this.selectors[i])(t))break}}onTileClick(t,e){if(this.selectedCity&&this.canCapture(t,e))return void this.captureTile(t,e);const i=this.selectedUnit||this.selectedCity,n=!a(null==i?void 0:i.position,[t,e]),s=this.grid.get(t,e);this.select(s,n)}drawCitySelection(){this.layers.selection.drawCitySelection(this.selectedCity);for(const[t,e]of this.selectedCity.assignmentsPositions){const{unit:i}=this.grid.get(t,e);i&&this.layers.objects.clearTile(t,e)}}clearSelection(){this.unselectUnit(),this.unselectCity()}refreshCitySelection(){this.clearCitySelection(),this.drawCitySelection()}unselectCity(){null!==this.selectedCity&&(this.clearCitySelection(),this.selectedCity=null)}clearCitySelection(){this.layers.selection.clearCitySelection(this.selectedCity);for(const[t,e]of this.selectedCity.assignmentsPositions){const{unit:i}=this.grid.get(t,e);if(i){const[n,s]=this.toCanvasPosition(t,e);this.layers.objects.drawUnit(n,s,i.type)}}}unselectUnit(){this.selectedUnit&&(this.clearUnitSelection(),this.selectedUnit=null)}clearUnitSelection(){const[t,e]=this.selectedUnit.position;this.layers.selection.clearTile(t,e),this.selectedUnit=null}moveUnit(t,e){const i=this.selectedUnit,n=this.world.moveUnit(i,t,e);n.forEach((t=>{this.handleEvent(t)}));const s=this.world.grid.get(t,e).unit;0===n.length&&s&&this.selectUnit(s)}draw(){for(let t=0;t<this.grid.tiles.length;t++){const[e,i]=this.grid.getPositionByIndex(t);this.drawTile(e,i)}}toCanvasPosition(t,e){const[i,n]=this.viewportPosition,[s,o]=this.grid.getPosition(t-i,e-n);return[s*this.tileSize,o*this.tileSize]}moveViewport(t,e){const[i,n]=this.viewportPosition;var s,o;this.viewportPosition=this.grid.getPosition(i+t,n+e),s=this.layers,o=i=>{i.moveViewport(t,e)},Object.keys(s).forEach((t=>{o(s[t],t)}))}getTilePosition(t,e){const[i,n]=this.viewportPosition;return this.grid.getPosition(Math.floor(t/this.tileSize)+i,Math.floor(e/this.tileSize)+n)}placeTerrain(t,e,{id:i}){this.world.placeTerrain(t,e,i),this.drawTile(t,e)}drawBorders(t,e){this.layers.borders.clearTile(t,e);const i=O.axial.map((({dx:i,dy:n})=>!this.grid.get(t+i,e+n).influencedBy)),[n,s]=this.toCanvasPosition(t,e);this.layers.borders.drawTileBorders(n,s,i)}drawObject(t,e){const[i,n]=this.toCanvasPosition(t,e),{unit:s,city:o}=this.grid.get(t,e);this.layers.objects.clearTile(t,e),s&&o?this.layers.objects.drawCityWithGarrison(i,n):s?this.layers.objects.drawUnit(i,n,s.type):o&&this.layers.objects.drawHouse(i,n)}drawTile(t,e){const i=this.toCanvasPosition(t,e),n=this.grid.get(t,e),[s,o]=i;this.layers.terrain.drawTerrain(s,o,n.terrain),(n.city||n.unit)&&this.drawObject(t,e),n.influencedBy&&this.drawBorders(t,e)}skipTurnsUntilEvent(t=1e3){let e=t;for(let i=1;i<=t;i++){const t=this.world.turn();if(t.length>0){t.forEach((t=>{this.handleEvent(t)})),e=i;break}}return e}update({world:t,showGrid:e}){t!==this.world&&(this.world=t,this.viewportPosition=[0,0],this.layersContainer.innerHTML="",Object.assign(this.layersContainer.style,{width:this.width+"px",height:this.height+"px"}),this.createLayers(),this.draw());document.getElementById("layer-grid").style.display=e?"block":"none"}turn(){const t=this.world.turn();return t.forEach((t=>{this.handleEvent(t)})),t}placeUnit(t,e,{id:i}){this.world.placeUnit(t,e,{type:i}),this.drawObject(t,e)}placeCity(t,e,i){if(this.world.foundCity(t,e,i)){this.drawObject(t,e);for(const{dx:i,dy:n}of O.members)this.drawCapturedTileBorders(t+i,e+n)}}}Dt.DEFAULT_TILE_SIZE=32,Dt.LAYER_ID_PREFIX="layer-";const Nt=new TextEncoder,Lt=new TextDecoder("utf-8"),jt=(t,e)=>{if(!t)throw new Error("Serialized string must not be empty");const i=Math.pow(2,e),n=(t=>Nt.encode(t))(t);if(n.length>i)throw new Error(`Max string size exceeded. ${n.length} > ${i}`);return V(n.length-1,e).concat((t=>Y(t,8))(n))},kt=(t,e)=>{const i=J(t,e)+1;return(t=>{const{buffer:e}=new Uint8Array(t);return Lt.decode(e)})(tt(t,i))},zt=(t,e=0)=>{const i=Math.pow(2,t)+e-1;return{read:i=>J(i,t)+e,write:n=>{if(n>i)throw new Error("Overflow error");return V(n-e,t)}}},_t=(t,e)=>({name:t,read:i=>({[t]:e.read(i)}),write:t=>e.write(t)});function Ft(t,e,i={context:{},data:{}}){const n=Object.assign(Object.assign({},{context:{},data:{}}),i),{data:s}=n;for(const i of e){const e=i.read(t,n);"object"==typeof e&&Object.assign(s,e)}return s}function Ht(t,e,i={}){const n=[],s={data:t,context:i};for(const i of e){const e=t[i.name],o=i.write(e,s);for(const t of o)n.push(t)}return n}const Wt=(Qt=7,{read:t=>kt(t,Qt),write:t=>jt(t,Qt)});var Qt;const Gt=zt(7),Vt=zt(3,3),$t=(t,e)=>t===e?0:Z(F(t)),Yt=[{name:"id",read:(t,{context:e})=>({id:J(t,e.cityIdSize)}),write:(t,{context:e})=>V(t,e.cityIdSize)},_t("name",Wt),{write:(t,{data:i,context:n})=>Ht(function(t,i){const n=r(t.position,t.influencedPositions,i.width,i.height),[s,o,c,l]=function(t){const[e,i]=t[0];let n=e,s=i,o=e,r=i;for(const[e,i]of t)e<n&&(n=e),i<s&&(s=i),e>o&&(o=e),i>r&&(r=i);return[n,s,o,r]}(n),a=c-s+1,d=l-o+1,u=e(Math.abs(s),Math.abs(o),a),g=n.map((([t,i])=>e(t-s,i-o,a))),p=a*d,f=[],y=[];for(let e=0;e<p;e++){const i=g.indexOf(e),n=i>=0;if(f.push(n),n){const e=t.influencedPositions[i],n=h(t.assignmentsPositions,e);y.push(n)}}return{width:a,height:d,cityIndex:u,influence:f,assignments:y,influenceSize:t.influencedPositions.length}}(i,n.worldSize),qt),read:(t,{context:e})=>function(t,e,i){const o=[],{width:r,height:c}=t,l=r*c,[a,h]=s(t.cityIndex,r),[d,u]=[e[0]-a,e[1]-h];for(let e=0;e<l;e++)if(t.influence[e]){const[t,c]=s(e,r),[l,a]=n(t+d,c+u,i.width,i.height);o.push([l,a])}const g=[];for(let e=0;e<t.assignments.length;e++)t.assignments[e]&&g.push(o[e]);return{position:e,influencedPositions:o,assignmentsPositions:g}}(Ft(t,qt),e.position,e.worldSize)},{name:"growthProgress",write(t,{data:e}){const i=$t(e.assignmentsPositions.length,e.influencedPositions.length);return V(t,i)},read:(t,{data:e})=>({growthProgress:J(t,$t(e.assignmentsPositions.length,e.influencedPositions.length))})},_t("expandingProgress",Gt)],qt=[_t("width",Vt),_t("height",Vt),{name:"cityIndex",write:(t,{data:e})=>V(t,Z(e.width*e.height)),read:(t,{data:e})=>({cityIndex:J(t,Z(e.width*e.height))})},{name:"influence",read(t,{data:e,context:i}){const{booleans:n,count:s}=function(t,e){const i=function(t,e,i,n){const s=[];for(const o of t)if(n(o,i),s.push(o),s.length===e)return{booleans:s,stats:i};return{booleans:s,stats:i}}(t,e,{truesCount:0},K);return{booleans:i.booleans,count:i.stats.truesCount}}(t,e.width*e.height);return i.influenceSize=s,{influence:n}},write:t=>t},{name:"assignments",read:(t,{context:e})=>({assignments:X(t,e.influenceSize)}),write:t=>t}];function Jt(t,e,i,n){return Ft(t,Yt,{context:{cityIdSize:n,position:e,worldSize:i}})}const Kt=zt(3),Xt=zt(4),Zt=[_t("type",Kt),_t("movePoints",Xt),{name:"targetPosition",read(t,{context:{targetIndexSize:e,positionIndex:i,worldWidth:n}}){const o=J(t,e);return{targetPosition:o!==i?s(o,n):null,position:s(i,n)}},write(t,{data:i,context:{targetIndexSize:n,worldWidth:s}}){const[o,r]=null===t?i.position:t,c=e(o,r,s);return V(c,n)}}];function te(t,i=null){const{width:n,height:s}=t,o={worldWidth:n,targetIndexSize:ee(n,s)};if(null!==i){const[t,s]=i;o.positionIndex=e(t,s,n)}return o}function ee(t,e){return Z(t*e)}function ie(t,e,i){const n=te(i,e);return Ft(t,Zt,{context:n})}const ne=Z(252),se=Z(ut.MAX_TURN_NUMBER-1),oe=zt(3),re=zt(16);function ce(t,e,i,n){const[s,o]=t;return{city:s?Jt(t,e,i,n.cityIdSize):null,unit:o?ie(t,e,i):null,terrain:oe.read(t)}}function le(t,e,i){const n=oe.write(t.terrain),{city:s,unit:o}=t,r=[!!s,!!o];return s&&r.push(...function(t,e,i){return Ht(t,Yt,{worldSize:e,cityIdSize:i})}(s,e,i)),o&&r.push(...function(t,e){const i=te(e);return Ht(t,Zt,i)}(o,e)),r.concat(n)}var ae;!function(t){t[t.TRACE=0]="TRACE",t[t.DEBUG=1]="DEBUG",t[t.INFO=2]="INFO",t[t.WARN=3]="WARN",t[t.ERROR=4]="ERROR",t[t.OFF=5]="OFF"}(ae||(ae={}));const he=Object.assign({level:0},["trace","debug","info","warn","error","off"].reduce(((t,e,i)=>Object.assign(Object.assign({},t),{[e](t){this.level<=i&&console.log(t)}})),{})),de=zt(ne,13),ue=zt(se,1),ge=[{write:()=>re.write(1),read:t=>{const e=(t=>re.read(t))(t);he.info(`save version: ${e}`)}},_t("width",de),_t("height",de),_t("turnNumber",ue),{name:"nextCityId",write:(t,{context:e})=>(e.cityIdSize=(t=>t>0?Z(t-1):0)(t),V(e.cityIdSize,5)),read(t,{context:e}){e.cityIdSize=J(t,5)}},{name:"tiles",write:(t,{data:e,context:i})=>function(t,e,i){const n=[];return t.forEach((t=>{n.push(...le(t,e,i.cityIdSize))})),n}(t,e,i),read:(t,{context:e,data:i})=>function(t,e,i){const n=[],s=[],o=[];for(let r=0;r<e.height;r++)for(let c=0;c<e.width;c++){const l=ce(t,[c,r],e,i),{city:a,unit:h}=l;a&&(n.push(a),a.id>=e.nextCityId&&(e.nextCityId=a.id+1)),h&&o.push(h),s.push(l)}return{tiles:s,cities:n,units:o}}(t,i,e)}];function pe(t){const e=(t=>W(t,$))(t);return Ft(e,ge,{data:{nextCityId:0}})}function fe(t,e){const i=t.toString();if(i.length>=e)return i;const n=e-i.length;return"0".repeat(n)+i}const ye=t=>fe(t,2),me=t=>fe(t.getMilliseconds(),3),we=t=>`${((t,e="-")=>[t.getFullYear(),ye(t.getMonth()+1),ye(t.getDate())].join(e))(t)} ${((t,e=".")=>[ye(t.getHours()),ye(t.getMinutes()),ye(t.getSeconds())].join(e))(t)}.${me(t)}`,Te=t=>({turn(){t.turn()},skipTurns(){t.skipTurnsUntilEvent()},save(){const e=Ht(t.world,ge);const i=Array.from(function*(t){let e=0,i=0;for(const n of t)8===e&&(yield i,e=0,i=0),n&&(i+=Math.pow(2,e)),++e;e>0&&(yield i)}(e)),n=we(new Date),s=prompt("File Name",n);null!==s&&function(t,e){let i="";for(const t of e)i+=String.fromCharCode(t);const n=btoa(i),s=document.createElement("a");s.href="data:;base64,"+n,s.download=`${t}.save`,s.click()}(s||n,i)},load(t){gt.world=ut.fromData(pe(t))},newWorld(t,e){gt.world=ut.createEmptyWorld(t,e)}});function xe(t,e){return function(t,e,i){return(n,...s)=>{S(n)?(0,t[n])(...s):Object.assign(e,n),i(e)}}(Te(t),gt,e)}const Se=(()=>{const t=new Dt(gt.world),e=[t],i=function(t,e){const{update:i}=t;return i?(t.update=t=>{const n={};Object.keys(e).forEach((i=>{n[i]=e[i](t)})),i(Object.assign(Object.assign({},t),n))},t):t}((({label:t,value:e})=>{const i=P("span",e,{className:"value"});return{element:P("span",{className:"field"},[P("span",{className:"label"},`${t}:`,[" ",P("span",{className:""})]),i]),update({value:t}){i.innerText=t}}})({label:"Turn",value:t.world.turnNumber.toString()}),{value:t=>t.world.turnNumber});e.push(i);const n=xe(t,(i=>{i.tool&&t.clearSelection(),t.update(i),e.forEach((t=>{var e;null===(e=t.update)||void 0===e||e.call(t,i)}))})),s=P("div"),o=P("div",{id:"view"},[i.element,s]);t.mount(s),t.draw();const r=At({dispatch:n});e.push(r);return t.addMouseMoveHandler((e=>{if(null===e)return void r.update({info:null});const[i,n]=e;let s=t.world.grid.getIndexByPosition(i,n)+" ["+e.join("; ")+"]";const o=t.grid.get(i,n),{unit:c,city:l}=o;if(o.influencedBy&&(s+=" "+((t,e)=>e.assignments.isPositionOccupied(t)?`<b>${e.name}</b>`:e.name)(e,o.influencedBy)),c)s+=" "+R(c);else if(l)s+=" "+M(l);else if(t.selectedCity){const r=t.selectedCity.influence.getTilesToExpand().find((({position:t})=>a(t,e)));r?s+=" expansion cost: "+r.cost:null!==o.influencedBy&&o.influencedBy!==t.selectedCity&&t.selectedCity.influence.canSwap(i,n)&&(s+=" swappable")}r.update({info:s})})),document.addEventListener("keydown",(e=>{const{key:i}=e;if("Escape"===i)return e.preventDefault(),t.clearSelection(),void r.update({tool:null});const n=(t=>B[t]||null)(i);if(n){e.preventDefault();const[i,s]=n;t.moveViewport(i,s)}})),function(t,e,i){t.addEventListener("contextmenu",(t=>{t.preventDefault()})),t.addEventListener("mouseup",(t=>{t.preventDefault();const[n,s]=e(t);0===t.button?t.ctrlKey?i.onCtrlClick(n,s):i.onLeftClick(n,s):i.onRightClick(n,s)}))}(s,(e=>{const[i,n]=b(e);return t.getTilePosition(i,n)}),{onLeftClick(e,i){if(gt.tool)return t[gt.tool.name](e,i,gt.tool.options.selectedItem),void r.update({tool:null});t.onTileClick(e,i)},onRightClick(e,i){t.selectedUnit&&t.moveUnit(e,i)},onCtrlClick(e,i){gt.tool&&t[gt.tool.name](e,i,gt.tool.options.selectedItem)}}),o.append(r.element),{element:o}})();var Ce;Ce=()=>{document.body.appendChild(Se.element)},t.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGAAAABACAYAAADlNHIOAAAAAXNSR0IArs4c6QAAAs9JREFUeF7tmut1wyAMhZ0dskFX8dhepRtkh/a4jR3qw+NKQoj03PwGhO6HHgHfFv5CFbiFWqfxhQCCD4EVwFeyf+taYikey3Lavy/jD9PH8jjtfy53lf+qSU+lUvEP8SzriQCk4h8TR0JIxT/sayBoBcuJPwxCTvyREHLiayEQgCjufgcTQJL7r/qNSEMzANj9Zg240B9ZAw7T7IKeSmjE36dqa4Aic3JKTgEtAHZBhfMkjQQNgJr47q1orQUd0YrWCrCmFZUCQMR3g4CI7wkBEV8KgQAEpYkAKv3/iP8DBEAA2T9fpSCWprdmMmANEJxAj/8YBEAAcBeI/h+Qpgl4A4wA7IGGAJqV5zVghi6odAt6dUMKFpYBqQOeV9IIBDT9WC7jeBcUeBfUigK303/4zCfJejdEAHBC1b8HMAUFpyA+SSbfBElvQFN21nTBJ0k+SQoS7oRDrREwoUvvtSUCCOZFAAQQrECweUbAOwNY1/VsQ7dtI0wFTLVoqfiH3SAI+yFQ+6HQ7DrFZF+18Zz4QRBC/whePlBWaamaNAmA0K+ze30d/q4AQi8DC+IfSUCkqWhwmvwCawDyLq32C6gJXe2bNhrQBSHOq04iIHzrIUr1LGsCAG661zCJ+B4QXOyrAAQUYY3zPSG42RcDqInv1IpanO8BwdW+CAAifmcIPZy3QHC3PzOAns5rIAyxPysAD+clEIbZJ4B8j0YAvXrXzDrIoSMAAsgoMLALQk9gepo1c0qcobXWdT3nb9uGnpk/EYiE47nwZABye0eEQ3xurpOKn7TeCIR/AaAmYks8M4Cc+AIIegC7ESQKOryMWUS0zD10rK4RCqAFoYP4rVtH6wk2za+JD0aBLQII4FV4Swm/UZAJAKiUxRTECMC+gLA+Wc4NoJSGOuV/1gAgRH+GOD5Jup1g8Bui+SMAhcRxdQWQlowaOipAAI7iIkt/A/1UVFAPRnNeAAAAAElFTkSuQmCC",t.onload=Ce}();
