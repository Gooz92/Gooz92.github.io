!function(){"use strict";const t=()=>{},e=t=>t,i=()=>!0,n=()=>!1,s=t=>"string"==typeof t,o=t=>"function"==typeof t,r=t=>null===t||(t=>void 0===t)(t),a=(t,e)=>{const i=[];for(let n=0;n<t;n++){const t=e(n);i.push(t)}return i},l=t=>t.at(-1),c=(t,e=i)=>t.reduce(((t,i)=>e(i)?t+1:t),0),h=(t,e)=>{const i=t.indexOf(e);return-1!==i&&(d(t,i),!0)},d=(t,e)=>{t.splice(e,1)},u=t=>Array.isArray(t)?t:[t],p=t=>r(t)?null:s(t)?{type:0,text:t}:t,g=t=>{const e=[];for(const i of t)if(Array.isArray(i))e.push(...g(i));else{const t=p(i);e.push(t)}return e},f=(t,e)=>(t=>o(t.prototype?.render))(t)?((t,e)=>({type:3,Component:t,props:e,children:null}))(t,e):{type:2,component:t,props:e,children:g([t(e)])},m=(...t)=>{const[e]=t;if(s(e)){return((t,e)=>{const i=[],n={};for(const t of e)if(Array.isArray(t)){const e=g(t);i.push(...e)}else"object"==typeof t?Object.assign(n,t):i.push({type:0,text:t});return{tagName:t,type:1,children:i,attributes:n}})(e,t.slice(1))}return f(e,t[1])},y=(t,e)=>{Object.keys(t).forEach((i=>{e(t[i],i)}))},w=(t,e)=>{const i={};return y(t,((t,n)=>{const s=e(t,n);i[n]=s})),i},v=(t,e)=>({vNode:t,parentElement:e.parentElement,prevSibling:e.currentSibling,nextSibling:null,element:document.createTextNode(t.text)}),x=t=>{const e={vNode:null,parentElement:t.parentElement,prevSibling:t.currentSibling,nextSibling:null};return t.currentSibling&&(t.currentSibling.nextSibling=e),t.currentSibling=e,e},b=(t,e)=>{const i=document.createElement(t.tagName),n={vNode:t,parentElement:e.parentElement,prevSibling:e.currentSibling,nextSibling:null,element:i,children:[]},s=e.parentElement;e.parentElement=i;const r=e.currentSibling;return e.currentSibling=null,S(n,e),e.parentElement=s,r&&(r.nextSibling=n),e.currentSibling=n,y(t.attributes,((t,e)=>{"ref"===e?o(t)?t(i):t.value=i:i[e]=t})),n},P=(t,e)=>C(t,e,M),S=(t,e)=>C(t,e,U),C=(t,e,i)=>{t.children=t.vNode.children.map((t=>i(t,e)))},T=t=>{const e=new t.Component(t.props);return t.children=g(u(e.render())),{vNode:t,component:e,children:null}},I=(t,e)=>{const i=T(t);return S(i,e),i.component.$mount(i),i},E=(t,e)=>{const i={vNode:t,children:null};return S(i,e),i},M=(t,e)=>null===t?x(e):N[t.type](t,e),N=[v,b,(t,e)=>{const i={vNode:t,children:null};return P(i,e),i},(t,e)=>{const i=T(t);return P(i,e),i.component.$mount(i),i}],U=(t,e)=>null===t?x(e):B[t.type](t,e),B=[(t,e)=>{const i=v(t,e);return e.parentElement.appendChild(i.element),i},(t,e)=>{const i=b(t,e);return e.parentElement.appendChild(i.element),i},E,I],O=t=>Boolean(t.element),A=(t,e)=>{const i=[t];for(;i.length>0;){const t=i.shift();$(t)||(O(t)?e(t):i.push(...t.children))}return[]},D=t=>{const e=document.createDocumentFragment();return A(t,(({element:t})=>{e.appendChild(t)})),e},j=({element:t})=>{t.remove()},k=t=>{A(t,j)},R=t=>null===t.vNode||O(t),z=t=>{for(;!R(t);)t=t.children[0];return t},L=t=>{for(;!R(t);)t=l(t.children);return t},F=t=>{do{if(null===(t=t.nextSibling))return null}while(!O(t));return t.element},H=[(t,e)=>(t.element.textContent!==e.text&&(t.element.textContent=e.text,t.vNode=e),t),(t,e)=>t.vNode.tagName!==e.tagName?_(t,e):(((t,e)=>{Object.assign(t.element,e.attributes)})(t,e),Y(t,e.children),t),(t,e)=>t.vNode.component!==e.component?_(t,e):(Y(t,e.children),t),(t,e)=>{t.vNode.Component,e.Component,t.component.props=e.props;const i=g(u(t.component.render()));return Y(t,i),t}],W=(t,e)=>t.vNode===e?t:t.vNode.type!==e.type?_(t,e):((t,e)=>H[e.type](t,e))(t,e),_=(t,e)=>{const i=z(t),n=L(t),s=F(n);k(t);const o={parentElement:i.parentElement,currentSibling:i.prevSibling},r=M(e,o),a=D(r);return i.parentElement.insertBefore(a,s),o.currentSibling.nextSibling=n.nextSibling,r},$=t=>null===t.vNode,G=(t,e)=>{const i={parentElement:t.parentElement,currentSibling:t.prevSibling},n=M(e,i),s=F(t),o=D(n);return t.parentElement.insertBefore(o,s),t.nextSibling&&(i.currentSibling.nextSibling=t.nextSibling,t.nextSibling.prevSibling=i.currentSibling),n},X=t=>{k(t);const e=z(t),i=L(t),n={parentElement:e.parentElement,currentSibling:e.prevSibling},s=x(n);return n.currentSibling.nextSibling=i.nextSibling,s},Y=(t,e)=>{for(let i=0;i<t.children.length;i++){const n=t.children[i],s=e[i];if($(n)){if(null!==s){const e=G(n,s);t.children[i]=e,t.vNode.children[i]=e.vNode}}else if(null!==s){const e=W(n,s);t.children[i]=e,t.vNode.children[i]=e.vNode}else{const e=X(n);t.children[i]=e,t.vNode.children[i]=null}}};class K{constructor(t){this.props=t,this.node=null,this.state=this.getInitialState()}setState(t){let e=!1;if(y(t,((t,i)=>{Object.is(this.state[i],t)||(e=!0,this.state[i]=t)})),e&&this.isMounted){const t=this.render();((t,e)=>{const i=g(u(e));Y(t,i)})(this.node,t)}}getInitialState(){return{}}$mount(t){this.node=t,this.onMounted()}get isMounted(){return null!==this.node}onMounted(){}}const Q=new Image;var q=[{id:1,name:"worker",movePoints:6,military:!1},{id:2,name:"warrior",movePoints:6,military:!0},{id:3,name:"settler",movePoints:6,military:!1}];const V=[{id:1,name:"grassland",dryLand:!0},{id:2,name:"steppe",dryLand:!0},{id:3,name:"sea",dryLand:!1}],[J,Z,tt]=V,et=q,it=[{productId:1,cost:2},{productId:2,cost:5},{productId:3,cost:8}],nt=V[0],st=(t=nt)=>({city:null,unit:null,terrain:t}),ot=(t,e,i)=>e*i+t,rt=(t,e)=>{let i=t%e;return i<0&&(i+=e),~~i},at=(t,e,i,n)=>[rt(t,i),rt(e,n)],lt=(t,e)=>[t%e,Math.floor(t/e)],ct=(t,e,i)=>{const n=e-t,s=i/2;return Math.abs(n)<=s?n:n>0?n-i:i+n},ht=(t,e,i,n)=>e.map((e=>((t,e,i,n)=>{const[s,o]=t,[r,a]=e;return[ct(s,r,i),ct(o,a,n)]})(t,e,i,n))),dt=(t,e,i,n)=>{const s=Math.abs(t-i),o=Math.abs(e-n);return pt(s,o)},ut=2,pt=(t,e)=>3*Math.min(t,e)+ut*Math.abs(t-e),gt=(t,e)=>{if(t===e)return!0;if(!t||!e)return!1;const[i,n]=t,[s,o]=e;return i===s&&n===o},ft=(t,e)=>t.some((t=>gt(t,e))),mt=(t=>{const e=Math.floor(t/ut),i=[],n=t-2;for(let t=-e;t<=e;t++)for(let s=-e;s<=e;s++){if(0===s&&0===t)continue;const e=[s,t];for(let o=dt(0,0,s,t)-2;o<=n;o++){const t=i[o];t?t.push(e):i[o]=[e]}}return i})(7)[5],yt=([t,e],i)=>[t,2*i-e],wt=([t,e],i)=>[2*i-t,e],vt=([t,e,i,n])=>[i,e,t,n],xt=([t,e,i,n])=>[t,n,i,e],bt=(t,e)=>({position:yt(t.position,e),borders:vt(t.borders)}),Pt=(t,e)=>({position:wt(t.position,e),borders:xt(t.borders)});var St=((t,e,i)=>{const n={members:[]};return y(t,((t,i)=>{const s={name:i,...e(t)};n.members.push(s),n[i]=s})),i&&Object.assign(n,i(n)),n})({NORTH:[0,-1],NORTH_EAST:[1,-1],EAST:[1,0],SOUTH_EAST:[1,1],SOUTH:[0,1],SOUTH_WEST:[-1,1],WEST:[-1,0],NORTH_WEST:[-1,-1]},(t=>{const[e,i]=t;return{dx:e,dy:i,offset:t,isOrthogonal:0===e||0===i}}),(t=>({orthogonal:t.members.filter((t=>t.isOrthogonal)),diagonal:t.members.filter((t=>!t.isOrthogonal)),fromOffsets:(e,i)=>t.members.find((t=>t.dx===e&&t.dy===i))||null})));class Ct{constructor(t,e){this.width=t,this.height=e}getPosition(t,e){return at(t,e,this.width,this.height)}getPositionByIndex(t){return lt(t,this.width)}getIndexesByPositions(t){return t.map((([t,e])=>this.getIndexByPosition(t,e)))}getIndexByPosition(t,e){return ot(t,e,this.width)}getOffsets(t,e){const[i,n]=t,[s,o]=e;return[ct(i,s,this.width),ct(n,o,this.height)]}getDirection(t,e){const[i,n]=this.getOffsets(t,e);return St.fromOffsets(i,n)}getCirclePositions(t,e,i){const n=Math.floor(i/ut),s=[];for(let o=-n;o<=n;o++)for(let r=-n;r<=n;r++){const n=this.getPosition(t+r,e+o),[a,l]=n;this.getOctileDistance(a,l,t,e)<=i&&s.push(n)}const o=[t,e];return s.sort(((t,e)=>this.comparePositions(o,t,e)))}getNextLinePosition(t,e){const[i,n]=this.getOffsets(t,e),s=Math.sign(i),o=Math.sign(n),r=Math.abs(i),a=Math.abs(n);let l=r-a,[c,h]=t;const d=2*l;return d>-a&&(l-=a,c+=s),d<r&&(l+=r,h+=o),[c,h]}comparePositions(t,e,i){const[n,s]=this.getOffsets(t,e),[o,r]=this.getOffsets(t,i),a=pt(Math.abs(n),Math.abs(s)),l=pt(Math.abs(o),Math.abs(r));return a!==l?a-l:s!==r?s-r:n-o}sortPositions(t,e){return e.toSorted(((e,i)=>this.comparePositions(t,e,i)))}isAdjacentPositionsIndexes(t,e){const i=this.getPositionByIndex(t),n=this.getPositionByIndex(e);return this.isAdjacentPositions(i,n)}isAdjacentPositions(t,e){const[i,n]=this.getOffsets(t,e),s=Math.abs(i),o=Math.abs(n);return 1===s&&1===o||0===s&&1===o||1===s&&0===o}getOctileDistance(t,e,i,n){const[s,o]=this.getOffsets([t,e],[i,n]);return pt(Math.abs(s),Math.abs(o))}}class Tt extends Ct{constructor(t,e){super(e,t.length/e),this.tiles=t}get(t,e){const[i,n]=this.getPosition(t,e),s=this.getIndexByPosition(i,n);return this.tiles[s]}getTileFood(t,e){return(t=>t.terrain===J?2:1)(this.get(t,e))}influencedByCity(t,e,i){return this.get(t,e).influencedBy===i}addInfluence(t,e,i){this.get(t,e).influencedBy=i}}Tt.createTileFromTileData=t=>((t=nt)=>({...st(t),influencedBy:null}))(t.terrain),Tt.createFromTilesData=(t,e)=>new Tt(t.map(Tt.createTileFromTileData),e);const It=t=>10*t+(t-1)**2;var Et=["populationIncreased","bordersExpanded","unitCompleted","unitMoved","moveCanceled","combat","unitKilled","cityPillaged","cityDestroyed"].reduce(((t,e)=>({...t,[e]:t=>({type:e,payload:t})})),{});const Mt=(t,e)=>({index:0,buffer:[],*[Symbol.iterator](){for(;this.index<t.length;)0===this.buffer.length&&(this.buffer=e(t[this.index]),++this.index),yield this.buffer.shift();for(;this.buffer.length>0;)yield this.buffer.shift();throw new Error("Unexpected end of input")}}),Nt=t=>{let e=0;for(let i=0;i<t.length;i++)t[i]&&(e+=2**i);return e},Ut=(t,e,i)=>{const n=[];for(;t>0&&n.length<e;){const e=i(t%2==1);t=Math.floor(t/2),n.push(e)}const s=i(!1);for(;n.length<e;)n.push(s);return n},Bt=(t,i)=>Ut(t,i,e),Ot=t=>Bt(t,8),At=(t,i)=>((t,e,i)=>{const n=[];for(const s of t){const t=Ut(s,e,i);n.push(...t)}return n})(t,i,e);const Dt=(t,e)=>t<<15|e,jt=(t,e)=>{let i=0,n=0;if(0===e)return i;for(const s of t)if(s&&(i+=2**n),++n,n===e)return i;return i},kt=(t,e)=>{t&&++e.truesCount},Rt=(t,e,i,n)=>{const s=[];for(const o of t)if(n(o,i),s.push(o),s.length===e)return{booleans:s,stats:i};return{booleans:s,stats:i}},zt=(t,e)=>{const i=[];for(const n of t)if(i.push(n),i.length===e)return i;return i},Lt=t=>Math.ceil(Math.log2(t+1)),Ft=(t,e)=>((t,e,i)=>{const n=[];for(let s=0;s<e;s++){const e=zt(t,i),s=Nt(e);n.push(s)}return n})(t,e,8);class Ht{static getStartInfluencePositions(t,e,i=3){const[n,s]=t;return e.getCirclePositions(n,s,i).filter((([t,i])=>!e.get(t,i).influencedBy))}constructor(t,e){this.city=t,this.tileToExpand=null,this.positions=this.grid.sortPositions(t.position,e.influencedPositions),this.expandingProgress=e.expandingProgress,this.place()}getFreeTilesCount(){const[t,e]=this.city.position;return c(mt,(([i,n])=>{const{influencedBy:s}=this.grid.get(t+i,e+n);return null===s}))}getTileExpansionCost(t){const[e,i]=t;let n=0;for(const{dx:t,dy:s}of St.members){const o=e+t,r=i+s,{influencedBy:a}=this.grid.get(o,r);a&&(n+=6/this.grid.getOctileDistance(o,r,e,i))}const[s,o]=this.city.position,r=this.grid.getOctileDistance(s,o,e,i)-3;return Math.round(160/n+r**2)}getTilesToExpand(){const t=this.getNextFrontierPositions(),e=[];for(const i of t)if(this.canExpandToPosition(i)){const t=this.getTileExpansionCost(i);e.push({position:i,turnsToExpand:t/this.getExpandingPoints(),cost:t})}return e.sort(((t,e)=>this.compareTilesToExpand(t,e)))}compareTilesToExpand(t,e){const i=t.cost-e.cost;if(0!==i)return i;const[n,s]=t.position,[o,r]=e.position,a=this.grid.getTileFood(n,s);return this.grid.getTileFood(o,r)-a}getExpandingPoints(){return((t,e)=>{const i=Math.ceil(t/2);return e>=i?e-i+1:0})(this.positions.length,this.city.population)}expand(){const{position:t}=this.tileToExpand;this.tileToExpand=null;const[e,i]=t;return this.addTile(e,i),Et.bordersExpanded({city:this.city,position:t})}turn(){if(null===this.tileToExpand)return null;this.expandingProgress+=this.getExpandingPoints();const t=this.expandingProgress-this.tileToExpand.cost;return t>=0?(this.expandingProgress=t,this.expand()):null}place(){for(const[t,e]of this.positions)this.grid.addInfluence(t,e,this.city)}remove(){this.positions.forEach((([t,e])=>{this.grid.get(t,e).influencedBy=null}))}canExpandToPosition(t){const[e,i]=t;if(null!==this.grid.get(e,i).influencedBy)return!1;const n=this.city.position,[s,o]=this.grid.getNextLinePosition(t,n);if(!this.grid.influencedByCity(s,o,this.city))return!1;if(!St.diagonal.some((({dx:t,dy:n})=>this.grid.influencedByCity(e+t,i+n,this.city))))return!1;if(!St.orthogonal.some((({dx:t,dy:n})=>this.grid.influencedByCity(e+t,i+n,this.city))))return!1;const[r,a]=n;return this.grid.getOctileDistance(e,i,r,a)<=7}getFrontierPositions(){const t=[];for(const e of this.positions){const[i,n]=e;for(const{dx:s,dy:o}of St.orthogonal){const r=i+s,a=n+o,{influencedBy:l}=this.grid.get(r,a);null!==l||ft(t,e)||t.push(e)}}return t}getNextFrontierPositions(){const t=[];for(const[e,i]of this.positions)for(const{dx:n,dy:s}of St.orthogonal){const o=e+n,r=i+s,a=this.grid.getPosition(o,r),{influencedBy:l}=this.grid.get(o,r);null!==l||ft(t,a)||t.push(a)}return t}swap(t,e){const i=this.grid.get(t,e).influencedBy,n=this.positions.findIndex((([i,n])=>t===i&&e===n));d(this.positions,n),this.positions=this.grid.sortPositions(this.city.position,this.positions),i.influence.addTile(t,e)}canSwap(t,e){return this._canSwap(t,e,new Map)}_canSwap(t,e,i){const n=Dt(t,e);if(i.has(n))return i.get(n);const s=this.grid.get(t,e).influencedBy;if(null===s||s===this.city)return i.set(n,!1),!1;const[o,r]=this.city.position;if(this.grid.getOctileDistance(t,e,o,r)>7)return i.set(n,!1),!1;if(!s.assignments.hasFreeTiles())return i.set(n,!1),!1;const a=[!1,!1],l=[[],[]];for(const{dx:s,dy:o,isOrthogonal:r}of St.members){const c=t+s,h=e+o,{influencedBy:d}=this.grid.get(c,h),u=+r;if(d!==this.city){l[u].push([c,h]);continue}const p=+!r;if(a[u]=!0,a[p])return i.set(n,!0),!0}return a.every(((t,e)=>t||l[e].some((([t,e])=>this._canSwap(t,e,i)))))}addTile(t,e){this.grid.addInfluence(t,e,this.city);const{positions:i}=this;i.push([t,e]),this.positions=this.grid.sortPositions(this.city.position,i)}expandToTile(t,e){const i=[t,e];ft(this.positions,i)||this.addTile(t,e)}get grid(){return this.city.grid}}class Wt{static getDefaultPositions(t,e,i,n=1){const s=[];for(;n-- >0;){let n,o=0;for(let r=0;r<e.length;r++){const a=e[r];if(gt(a,t)||s.some((t=>gt(t,a))))continue;const[l,c]=a,h=i.getTileFood(l,c);h>o&&(o=h,n=a)}n&&s.push(n)}return s}recalculate(t=this.influence.city.population){this.positions=Wt.getDefaultPositions(this.influence.city.position,this.influence.positions,this.grid,t)}constructor(t,e,i){this.grid=t,this.influence=e,this.positions=i}isPositionOccupied(t){return gt(t,this.city.position)||ft(this.positions,t)}isPositionFree(t){return!this.isPositionOccupied(t)}hasFreeTiles(){return this.influence.positions.some((t=>this.isPositionFree(t)))}getFreeTilesCount(){return c(this.influence.positions,(t=>this.isPositionFree(t)))}getFoodPerTurn(){const[t,e]=this.influence.city.position,i=this.grid.getTileFood(t,e);return this.positions.reduce(((t,e)=>{if(!this.influence.positions.some((t=>gt(t,e))))return t;const[i,n]=e;return t+this.grid.getTileFood(i,n)}),i)}get city(){return this.influence.city}}const _t={population:1,expansionLevel:0};class $t{static found(t,e,i=0,n="",s={}){const o={..._t,...s},r=Ht.getStartInfluencePositions(e,t,o.expansionLevel+3),a=Wt.getDefaultPositions(e,r,t,o.population);return new $t(t,{position:e,project:null,influencedPositions:r,assignmentsPositions:a,growthProgress:0,expandingProgress:0,name:n,id:i})}constructor(t,e){this.grid=t,this.position=e.position,this.name=e.name,this.id=e.id,this.growthProgress=e.growthProgress,this.project=e.project;const[i,n]=e.position;t.get(i,n).city=this,this.influence=new Ht(this,e),this.assignments=new Wt(t,this.influence,e.assignmentsPositions),this.assignments.getFreeTilesCount()>0?this.foodBasketSize=It(this.population):this.foodBasketSize=0}turn(e=t){const i=this.updateGrowthProgress(),n=this.updateProjectProgress(e);return null!==n&&i.push(n),i}updateGrowthProgress(){const t=[],e=this.assignments.getFreeTilesCount();if(0===e)return t;const i=It(this.population);this.growthProgress+=this.foodSurplus;let n=this.population;const s=this.influence.turn();null!==s&&t.push(s);const o=this.growthProgress-i;if(o>=0){e>1?(this.growthProgress=o,this.foodBasketSize=It(this.population+1)):(this.growthProgress=0,this.foodBasketSize=0),++n;const i=Et.populationIncreased({city:this});t.push(i)}else this.growthProgress;return t.length>0&&this.assignments.recalculate(n),t}updateProjectProgress(t){const{project:e}=this;if(null===e)return null;const[i,n]=this.position,s=this.grid.getIndexByPosition(i,n),o=this.project.progress+1;if(!(o===this.project.type.cost))return this.project.progress=o,null;if(!!this.grid.tiles[s].unit)return null;const r=Et.unitCompleted({unitTypeId:this.project.type.productId,cityPositionIndex:s});return this.project=null,t(r.payload),r}setProject(t){null!==t?null!==this.project&&t.productId===this.project.type.productId||(this.project={type:t,progress:0}):this.project=null}get foodSurplus(){return this.assignments.getFoodPerTurn()-2*this.population}get population(){return this.assignments.positions.length}get influencedPositions(){return this.influence.positions}get assignmentsPositions(){return this.assignments.positions}get expandingProgress(){return this.influence.expandingProgress}remove(){const[t,e]=this.position;this.grid.get(t,e).city=null,this.influence.remove()}}class Gt{constructor(t){this.influence=t,this.tilesToExpand=t.getTilesToExpand(),this.tilesToExpandLeft=t.getFreeTilesCount()}get tileToExpand(){return this.influence.tileToExpand}set tileToExpand(t){this.influence.tileToExpand=t}}const Xt=(t,e)=>e.tileToExpand.turnsToExpand!==t.tileToExpand.turnsToExpand?e.tileToExpand.turnsToExpand<t.tileToExpand.turnsToExpand:e.tilesToExpandLeft<t.tilesToExpandLeft;class Yt{constructor(e,i=[],n=0){this.grid=e,this.unitCreationHandler=t,this.cities=Yt.createCities(e,i),this._nextCityId=n,this.updateTilesToExpand()}onUnitCreated(t){this.unitCreationHandler=t}updateTilesToExpand(){(t=>{const e=new Map;for(;t.length>0;){const i=t.shift();if(0===i.tilesToExpand.length)continue;const n=i.tilesToExpand.shift(),[s,o]=n.position,r=Dt(s,o),a=e.get(r);i.tileToExpand=n,a?Xt(a,i)?(a.tileToExpand=null,t.push(a),e.set(r,i)):(i.tileToExpand=null,t.push(i)):e.set(r,i)}})(this.cities.map((t=>(t.influence.tileToExpand=null,new Gt(t.influence)))))}turn(){const t=[];return this.cities.forEach((e=>{const i=e.turn(this.unitCreationHandler);t.push(...i)})),this.updateTilesToExpand(),t}addCity(t){this.cities.push(t),this.updateTilesToExpand(),++this._nextCityId}nextCityName(){return(t=>{const e=[];do{const i=t%26;t=Math.floor(t/26),e.push(String.fromCharCode(i+65))}while(t>0);return e.join("")})(this.nextCityId)}removeCity(t){h(this.cities,t),t.remove(),this.updateTilesToExpand()}foundCity(t,e,i){if(!this.canPlaceCity(t,e))return null;const n=$t.found(this.grid,[t,e],this.nextCityId,this.nextCityName(),i);return this.addCity(n),n}canPlaceCity(t,e){const i=this.grid.get(t,e);return!(!i.terrain.dryLand||0===i.unit?.playerId)&&this.cities.every((({position:[i,n]})=>this.grid.getOctileDistance(i,n,t,e)>=8))}captureRelativePosition(t,[e,i]){const[n,s]=t.position,[o,r]=this.grid.getPosition(n+e,s+i);this.captureTile(n,s,o,r)}captureTile(t,e,i,n){const{city:s}=this.grid.get(t,e);s.influence.expandToTile(i,n),this.updateTilesToExpand()}setProject(t,e){const{city:i}=this.grid.tiles[t];i.setProject(e)}get nextCityId(){return this._nextCityId}}Yt.createCities=(t,e)=>e.map((e=>new $t(t,e))).sort(((t,e)=>t.id-e.id));class Kt{constructor(t,e){this.grid=t,this.path=[];const{targetPosition:i,...n}=e;Object.assign(this,n);const[s,o]=e.position;t.get(s,o).unit=this}beforeTurn(){this.movePoints+=this.type.movePoints}cancelMove(){const t=this.grid.getPositionByIndex(l(this.path));return this.path=[],Et.moveCanceled({from:this.position,to:t})}getMoveCost(t,e){return this.grid.getDirection(t,e).isOrthogonal?2:3}isTilePassable(t){return this.grid.tiles[t].terrain.dryLand}getNextPathSegment(t){let e=this.position,i=0;const n=[],s=[];for(const o of t){if(!this.isTilePassable(o))break;const t=this.grid.getPositionByIndex(o),r=i+this.getMoveCost(e,t);if(r>this.movePoints)break;this.grid.tiles[o].unit?s.push(t):(s.length>0&&(n.push(...s),s.length=0),n.push(t)),i=r,e=t}return n.push(...s),{positions:n,cost:i}}moveByPath(t){const e=this.getNextPathSegment(t),{positions:i,cost:n}=e;if(0===i.length)return this.path=t.slice(),null;const s=l(i),[o,r]=s;if(this.grid.get(o,r).unit)return null;this.path=t.slice(i.length);const[a,c]=this.position;return this.grid.get(a,c).unit=null,this.grid.get(o,r).unit=this,this.movePoints-=n,i.unshift(this.position),this.position=s,Et.unitMoved({path:i})}getPositionIndex(){const[t,e]=this.position;return this.grid.getIndexByPosition(t,e)}get targetPosition(){return this.path.length>0?l(this.path):null}}Kt.DEFAULT_UNIT_TYPE=et[0],Kt.getDefaultData=(t,e)=>({playerId:1,position:[t,e],type:Kt.DEFAULT_UNIT_TYPE,movePoints:Kt.DEFAULT_UNIT_TYPE.movePoints,targetPosition:null});const Qt=(t,e,i)=>Math.floor(e+(i-e+1)*t),qt=(t,e)=>Qt(Math.random(),t,e),Vt=(t,e)=>((t,e,i)=>t<e?e:t>i?i:t)(t,0,e),Jt=2*Math.PI,Zt=t=>{let e=t[0],i=0;for(let n=1;n<t.length;n++){const s=t[n];s.f<e.f&&(e=s,i=n)}return d(t,i),e},te=t=>{const e=[];for(;t.previous;)e.unshift({position:t.position,positionIndex:t.positionIndex}),t=t.previous;return e};var ee;const ie=t=>(1664525*t+1013904223)%ne.PERIOD;class ne{constructor(t=ee.getDefaultSeed()){this.seed=t}next(){return this.seed=ie(this.seed),this.seed/ee.PERIOD}nextFloat(t,e){return t+(e-t)*this.next()}nextInt(t,e){if(1===arguments.length)return this.nextInt(0,t);const i=this.next();return Qt(i,t,e)}nextBoolean(t=.5){return this.next()<t}}ee=ne,ne.getDefaultSeed=()=>qt(0,ee.PERIOD),ne.PERIOD=2**32;const se=(t,e,i)=>{var n,s;return((t,e,i)=>Math.round(3*Math.E**((t-e)/200)*i))(t,e,(n=i(),(s=8)+(12-s)*n))},oe=(t,e,i,n)=>t<=i&&e<=n?i/t<n/e?re(t,e,i,n):ae(t,e,i,n):t<i?ae(t,e,i,n):e<n?re(t,e,i,n):[i,n],re=(t,e,i,n)=>[Math.round(Vt(i*e/n,t-1)),e],ae=(t,e,i,n)=>[t,Math.round(Vt(n*t/i,e-1))],le=[4,8,3,5,5,3,3],ce=le.map((t=>2**t-1)),he=(t,e)=>t.grid.getDirection(t.position,e.position),de=(t,e,i,n)=>{const s=((t,e,i)=>[i,t.getPositionIndex(),St.members.indexOf(he(t,e)),t.hitPoints,e.hitPoints,t.movePoints,e.movePoints])(t,e,i),o=(t=>{let e=0;for(let i=0;i<le.length;i++)e<<=le[i],e|=ie(t[i])&ce[i];return e})(s)^n,r=new ne(o);return((t,e,i)=>{const n=se(t,e,i),s=se(e,t,i);return oe(t,e,s,n)})(t.hitPoints,e.hitPoints,(()=>r.next()))};class ue extends Kt{constructor(t,e){const{hitPoints:i,combated:n,...s}=e;super(t,s),this.hitPoints=i,this.combated=n}combat(t,e,i){const n=de(this,t,e,i),[s,o]=n;return this.combated=!0,Et.combat({from:this.position,to:t.position,damage:n,attackedDestroyed:s>=this.hitPoints,defenderDestroyed:o>=t.hitPoints})}beforeTurn(){super.beforeTurn(),this.combated=!1}kill(t){return this.combated=!0,Et.unitKilled({attackerPosition:this.position,killedUnitPosition:t.position})}}const pe=t=>t.type.military,ge=t=>pe(t);class fe{constructor(t,e=[[],[]],i=0){var n;this.grid=t,this.combatSeed=i,this.movements=new Map,this.units=(n=t=>this.createUnit(t),e.map((t=>t.map(n))))}createUnit(t){const e=((t,e)=>pe(e)?new ue(t,e):new Kt(t,e))(this.grid,t);if(null!==t.targetPosition){const i=this.grid.getPositionByIndex(t.targetPosition);this.movements.set(e.targetPosition,e),e.path=this.findPath(e,i)}return e}findPath(t,e){return((t,e,n,s=i)=>{const[o,r]=e,[a,l]=n,c=t.getIndexByPosition(o,r),h=[{position:e,positionIndex:c,g:0,f:t.getOctileDistance(o,r,a,l),previous:null}],d=new Set([c]);for(;h.length>0;){const e=Zt(h),[i,n]=e.position;if(i===a&&n===l)return te(e);d.add(e.positionIndex);for(const{dx:o,dy:r,isOrthogonal:c}of St.members){const u=t.getPosition(i+o,n+r),[p,g]=u,f=t.getIndexByPosition(p,g);if(d.has(f))continue;if(!s(f))continue;const m=e.g+(c?2:3),y=t.getOctileDistance(p,g,a,l),w=m+y,v=h.find((t=>t.positionIndex===f));v?m<v.g&&(v.g=m,v.f=w,v.previous=e):h.push({previous:e,position:u,positionIndex:f,g:m,f:m+y})}}return[]})(this.grid,t.position,e,(e=>t.isTilePassable(e))).map((t=>t.positionIndex))}turnEnd(){const t=[],e=[];return((t,e)=>{for(let i=0;i<t.length;i++){const n=t[i];for(let t=0;t<n.length;t++)e(n[t])}})(this.units,(i=>{if(i.beforeTurn(),null!==i.targetPosition){const[n,s]=i.position,o=this.grid.getIndexByPosition(n,s),r=this.move([o,...i.path]);null===r?e.push(i.cancelMove()):t.push(r)}i.movePoints=Vt(i.movePoints,i.type.movePoints)})),{moves:t,canceledMoves:e}}canPlaceUnit(t,e,i){const n=this.grid.get(t,e);return!(null!==n.unit||!n.terrain.dryLand)&&(0!==i.playerId||!n.city)}placeUnit(t,e,i={}){if(!this.canPlaceUnit(t,e,i))return null;const n=Object.assign(Kt.getDefaultData(t,e),i);pe(n)&&(n.hitPoints=100);const s=this.createUnit(n);return this.units[s.playerId].push(s),s}combat(t,e,i){if(ge(e)){const n=t.combat(e,i,this.combatSeed),{damage:[s,o]}=n.payload;if(this.causeDamage(t,s),this.causeDamage(e,o)){const[i,n]=e.position,s=this.grid.getIndexByPosition(i,n);t.moveByPath([s])}else{const i=this.grid.getDirection(t.position,e.position);t.movePoints-=i.isOrthogonal?2:3}return n}const n=t.kill(e);this.removeUnit(e);const[s,o]=n.payload.killedUnitPosition,r=this.grid.getIndexByPosition(s,o);return t.moveByPath([r]),n}handleCombat(t,e,i,n){const s=[],o=this.grid.get(e,i),r=o.unit;if(r&&r.playerId!==t.playerId){const e=this.combat(t,r,n);s.push(e)}const a=o.city;if(0===t.playerId&&a&&(!o.unit||0===o.unit.playerId)){const e=this.pillageCity(t,a);s.push(e)}return s}moveUnit(t,e,i,n=0){const s=[e,i];if(gt(t.position,s))return this.cancelMove(t),[];const o=this.findPath(t,s);if(0===o.length)return[];if(((t,e)=>{if(1!==e.length||!ge(t))return!1;if(t.combated)return!1;const i=t.position,n=t.grid.getPositionByIndex(e[0]),s=t.grid.getDirection(i,n).isOrthogonal?ut:3;return t.movePoints>=s})(t,o)){const s=this.handleCombat(t,e,i,n);if(s.length>0)return s}const[r,a]=t.position,l=this.grid.getIndexByPosition(r,a);o.unshift(l);const c=this.move(o);return c?[c]:[]}pillageCity(t,e){return e.population>1?(e.assignments.recalculate(e.population-1),Et.cityPillaged({barbarianPosition:t.position})):Et.cityDestroyed({city:e,barbarian:t})}causeDamage(t,e){return t.hitPoints-=e,t.hitPoints<=0&&(this.removeUnit(t),!0)}move(t){const[e,...i]=t,n=i[0],{unit:s}=this.grid.tiles[e];if(this.movements.has(s.targetPosition)&&this.movements.delete(s.targetPosition),2===t.length){const t=this.movements.get(n);1===t?.path.length&&this.cancelMove(t)}const o=l(i),r=this.grid.tiles[o];return null!==r.unit||r.city&&0===s.playerId?null:(this.movements.set(o,s),s.moveByPath(i))}removeUnit(t){const[e,i]=t.position;this.grid.get(e,i).unit=null,this.movements.delete(t.targetPosition),h(this.units[t.playerId],t)}cancelMove(t){this.movements.delete(t.targetPosition),t.cancelMove()}}const me=t=>t.charAt(0).toUpperCase()+t.slice(1);class ye{static createEmptyWorldData(t,e,i=nt){const n=((t,e,i=nt)=>a(e*t,(()=>st(i))))(t,e,i);return this.fromTilesData(n,t)}static createEmptyWorld(t,e,i=nt){const n=this.createEmptyWorldData(t,e,i);return ye.fromData(n)}static fromTerrainMap(t,e,i){const n=t.map(st);return this.fromData(this.fromTilesData(n,e,i))}static fromData(t){const e=Tt.createFromTilesData(t.tiles,t.width);return new ye(e,t)}constructor(t,e){var i;this.eventHandlers=(i=this,{onCityDestroyed:({city:t,barbarian:e})=>{i.removeCity(t),i.removeUnit(e)},onCityPillaged:({barbarianPosition:[t,e]})=>{const{unit:n}=i.grid.get(t,e);i.removeUnit(n)}}),this.grid=t,this.turnNumber=e.turnNumber,this.citiesService=new Yt(t,e.cities,e.nextCityId),this.citiesService.onUnitCreated((({cityPositionIndex:t,unitTypeId:e})=>{this.unitCreationHandler(t,e)})),this.unitsService=new fe(t,e.units,e.combatSeed),this.mapSeed=e.mapSeed,this.playerId=e.playerId}unitCreationHandler(t,e){const i=et[e-1],[n,s]=this.grid.getPositionByIndex(t);this.placeUnit(n,s,{type:i})}turn(){return 0===this.playerId?(this.playerId=1,this.turnEnd()):(this.playerId=0,[])}turnEnd(){this.turnNumber===ye.MAX_TURN_NUMBER?(console.warn("Max turns reached"),this.turnNumber=1):++this.turnNumber;const t=this.citiesService.turn(),e=this.unitsService.turnEnd();return t.concat(e.moves,e.canceledMoves)}processEvents(t){return t.map((t=>{const e=this.eventHandlers[`on${me(t.type)}`];return e?.(t.payload),t}))}moveUnit(t,e,i){if(t.playerId!==this.playerId)return[];const n=this.unitsService.moveUnit(t,e,i,this.turnNumber);return this.processEvents(n)}placeTerrain(t,e,i){const n=this.grid.get(t,e);if(!((t,e)=>t.terrain!==e&&(e.dryLand||!t.city&&!t.unit))(n,i))return!1;n.terrain=i,this.mapSeed=null;const{influencedBy:s}=n;s&&s.assignments.recalculate();return St.orthogonal.some((({dx:i,dy:n})=>this.grid.get(t+i,e+n).influencedBy))&&this.citiesService.updateTilesToExpand(),!0}placeUnit(t,e,i={}){return this.unitsService.placeUnit(t,e,i)}removeUnit(t){this.unitsService.removeUnit(t)}removeCity(t){this.citiesService.removeCity(t)}foundCity(t,e,i){return this.citiesService.foundCity(t,e,i)}captureTile(t,e,i,n){this.citiesService.captureTile(t,e,i,n)}setCityProject(t,e){const i=null!==e?it.find((t=>t.productId===e)):null;this.citiesService.setProject(t,i)}get cities(){return this.citiesService.cities}get units(){return this.unitsService.units}get nextCityId(){return this.citiesService.nextCityId}get combatSeed(){return this.unitsService.combatSeed}get tiles(){return this.grid.tiles}get width(){return this.grid.width}get height(){return this.grid.height}}ye.MAX_TURN_NUMBER=65536,ye.fromTilesData=(t,e,i=null)=>({playerId:1,tiles:t,width:e,height:t.length/e,cities:[],units:[[],[]],turnNumber:1,nextCityId:0,mapSeed:i,combatSeed:qt(0,2147483647)});const we=new TextEncoder,ve=new TextDecoder("utf-8"),xe=(t,e)=>{if(!t)throw new Error("Serialized string must not be empty");const i=2**e,n=(t=>we.encode(t))(t);if(n.length>i)throw new Error(`Max string size exceeded. ${n.length} > ${i}`);return Bt(n.length-1,e).concat((t=>At(t,8))(n))},be=(t,e)=>{const i=jt(t,e)+1;return(t=>{const{buffer:e}=new Uint8Array(t);return ve.decode(e)})(Ft(t,i))},Pe=(t,e=0)=>{const i=2**t+e-1;return{read:i=>jt(i,t)+e,write:n=>{if(n>i)throw new Error("Overflow error");return Bt(n-e,t)}}},Se=(t,e)=>({name:t,read:i=>({[t]:e.read(i)}),write:t=>e.write(t)}),Ce=(t,e,i={context:{},data:{}})=>{const n={context:{},data:{},...i},{data:s}=n;for(const i of e){const e=i.read(t,n);"object"==typeof e&&Object.assign(s,e)}return s},Te=(t,e,i={})=>{const n=[],s={data:t,context:i};for(const i of e){const e=t[i.name],o=i.write(e,s);for(const t of o)n.push(t)}return n},Ie=(Ee=7,{read:t=>be(t,Ee),write:t=>xe(t,Ee)});var Ee;const Me=Pe(7),Ne=Pe(3,3),Ue=Pe(3),Be=(t,e)=>t===e?0:Lt(It(t)),Oe=[{name:"id",read:(t,{context:e})=>({id:jt(t,e.cityIdSize)}),write:(t,{context:e})=>Bt(t,e.cityIdSize)},Se("name",Ie),{write(t,{data:e,context:i}){const n=((t,e)=>{const i=ht(t.position,t.influencedPositions,e.width,e.height),[n,s,o,r]=(t=>{const[e,i]=t[0];let n=e,s=i,o=e,r=i;for(const[e,i]of t)e<n&&(n=e),i<s&&(s=i),e>o&&(o=e),i>r&&(r=i);return[n,s,o,r]})(i),a=o-n+1,l=r-s+1,c=ot(Math.abs(n),Math.abs(s),a),h=i.map((([t,e])=>ot(t-n,e-s,a))),d=a*l,u=[],p=[];for(let e=0;e<d;e++){const i=h.indexOf(e),n=i>=0;if(u.push(n),n){const e=t.influencedPositions[i],n=ft(t.assignmentsPositions,e);p.push(n)}}return{width:a,height:l,cityIndex:c,influence:u,assignments:p,influenceSize:t.influencedPositions.length}})(e,i.worldSize);return Te(n,Ae)},read:(t,{context:e})=>((t,e,i)=>{const n=[],{width:s,height:o}=t,r=s*o,[a,l]=lt(t.cityIndex,s),[c,h]=[e[0]-a,e[1]-l];for(let e=0;e<r;e++)if(t.influence[e]){const[t,o]=lt(e,s),[r,a]=at(t+c,o+h,i.width,i.height);n.push([r,a])}const d=[];for(let e=0;e<t.assignments.length;e++)t.assignments[e]&&d.push(n[e]);return{position:e,influencedPositions:n,assignmentsPositions:d}})(Ce(t,Ae),e.position,e.worldSize)},{name:"project",read:t=>{const e=Ue.read(t);if(0===e)return{project:null};const i=it[e-1],n=Lt(i.cost);return{project:{type:i,progress:jt(t,n)}}},write:t=>{if(null===t)return a(3,n);const e=Lt(t.type.cost);return Ue.write(t.type.productId).concat(Bt(t.progress,e))}},{name:"growthProgress",write(t,{data:e}){const i=Be(e.assignmentsPositions.length,e.influencedPositions.length);return Bt(t,i)},read(t,{data:e}){const i=Be(e.assignmentsPositions.length,e.influencedPositions.length);return{growthProgress:jt(t,i)}}},Se("expandingProgress",Me)],Ae=[Se("width",Ne),Se("height",Ne),{name:"cityIndex",write:(t,{data:e})=>Bt(t,Lt(e.width*e.height)),read:(t,{data:e})=>({cityIndex:jt(t,Lt(e.width*e.height))})},{name:"influence",read(t,{data:e,context:i}){const{booleans:n,count:s}=((t,e)=>{const i=Rt(t,e,{truesCount:0},kt);return{booleans:i.booleans,count:i.stats.truesCount}})(t,e.width*e.height);return i.influenceSize=s,{influence:n}},write:t=>t},{name:"assignments",read:(t,{context:e})=>({assignments:zt(t,e.influenceSize)}),write:t=>t}],De=(t,e,i,n)=>Ce(t,Oe,{context:{cityIdSize:n,position:e,worldSize:i}}),je=Pe(3),ke=Pe(4),Re=[Se("playerId",Pe(1)),{name:"type",read:t=>{const e=je.read(t);return{type:et[e]}},write:t=>je.write(t.id-1)},Se("movePoints",ke),{name:"targetPosition",read(t,{context:{targetIndexSize:e,positionIndex:i,worldWidth:n}}){const s=jt(t,e);return{targetPosition:s!==i?s:null,position:lt(i,n)}},write(t,{data:e,context:{targetIndexSize:i,worldWidth:n}}){const s=((t,e,i)=>{if(null===t){const[t,n]=e;return ot(t,n,i)}return t})(t,e.position,n);return Bt(s,i)}}],ze=(t,e=null)=>{const{width:i,height:n}=t,s={worldWidth:i,targetIndexSize:Le(i,n)};if(null!==e){const[t,n]=e;s.positionIndex=ot(t,n,i)}return s},Le=(t,e)=>Lt(t*e),Fe=Pe(7,1),He=(t,e,i)=>{const n=ze(i,e),s=Ce(t,Re,{context:n});return pe(s)&&(s.hitPoints=Fe.read(t),s.combated=(t=>{const[e]=t;return e})(t)),s},We=265,_e=(t,e)=>String(t).padStart(e,"0"),$e=new RegExp("^[\\da-f]{8}$"),Ge=t=>(t=>$e.test(t))(t)?parseInt(t,16):null,Xe=t=>{return e=8,t.toString(16).padStart(e,"0");var e},Ye=()=>Xe(Ke()),Ke=()=>ne.getDefaultSeed(),Qe=([t,e],[i,n])=>t*i+e*n,qe=(t,e,i)=>{return t+(6*(n=i)**2-15*n+10)*n**3*(e-t);var n},Ve=t=>((t,e)=>[t*Math.cos(e),t*Math.sin(e)])(1,t),Je=(t,e,i,n)=>{const s=Math.ceil(t/i)+1,o=Math.ceil(e/i)+1,r=new ne(n),l=a(s*o,(()=>{const t=r.nextFloat(0,Jt);return Ve(t)})),c=(t,e)=>{const i=ot(t,e,s);return l[i]};return(t,e)=>.5+.5*((t,e,i)=>{const n=Math.floor(t),s=Math.floor(e),o=t-n,r=e-s,a=Qe([o,r],i(n,s)),l=Qe([o-1,r],i(n+1,s)),c=Qe([o-1,r-1],i(n+1,s+1)),h=Qe([o,r-1],i(n,s+1)),d=qe(a,l,o),u=qe(h,c,o);return qe(d,u,r)})(t/i,e/i,c)},Ze=(t,e,i,s)=>{const o=t.map(n),r=new Ct(e,t.length/e),a=[i],l=[s],c=new Set([i,s]);for(;a.length>0||l.length>0;){if(a.length>0){const e=ei(a,t),[i,n]=r.getPositionByIndex(e);for(const{dx:t,dy:e}of St.orthogonal){const[s,o]=r.getPosition(i+t,n+e),l=r.getIndexByPosition(s,o);c.has(l)||(a.push(l),c.add(l))}}if(l.length>0){const e=ti(l,t),[i,n]=r.getPositionByIndex(e);o[e]=!0;for(const{dx:t,dy:e}of St.orthogonal){const[s,o]=r.getPosition(i+t,n+e),a=r.getIndexByPosition(s,o);c.has(a)||(l.push(a),c.add(a))}}}return o},ti=(t,e)=>{let i=t[0],n=0;for(let s=1;s<t.length;s++)e[t[s]]>e[i]&&(i=t[s],n=s);return d(t,n),i},ei=(t,e)=>{let i=t[0],n=0;for(let s=1;s<t.length;s++)e[t[s]]<e[i]&&(i=t[s],n=s);return d(t,n),i},ii=(t,e,i)=>{const n=((t,e,i,n)=>{const s=[],o=(t-1)/2,r=(e-1)/2,a=Je(t,e,i,n);let l,c,h=Number.POSITIVE_INFINITY,d=Number.NEGATIVE_INFINITY;for(let i=0;i<e;i++)for(let n=0;n<t;n++){if(n<3||n>t-3||i<2||i>e-2){s.push(0);continue}const u=a(n,i)*(1-Math.sqrt(((o-n)/o)**2+((r-i)/r)**2)/Math.SQRT2);u<h&&(h=u,l=ot(n,i,t)),u>d&&(d=u,c=ot(n,i,t)),s.push(u)}return Ze(s,t,l,c)})(t,e,7,i),s=((t,e,i)=>{const n=t.length/e,s=Je(e,n,3,i),o=(e-1)/2,r=(n-1)/2,a=[];for(let i=0;i<n;i++)for(let n=0;n<e;n++){const l=ot(n,i,e),c=s(n,i),h=1-Math.sqrt(.3*((o-n)/o)**2+.7*((r-i)/r)**2)/Math.SQRT2;a.push(t[l]&&(c*h)**2>.2)}return a})(n,t,i);return n.map(((t,e)=>t?s[e]?Z:J:tt))},ni=Lt(252),si=Lt(ye.MAX_TURN_NUMBER-1),oi=Lt(2**32-1),ri=(t,e,i,n)=>{const[s,o]=t;return{city:s?De(t,e,i,n.cityIdSize):null,unit:o?He(t,e,i):null,terrain:V[jt(t,3)]}},ai=(t,e,i)=>{const n=Bt(t.terrain.id-1,3),{city:s,unit:o}=t,r=[!!s,!!o];return s&&r.push(...((t,e,i)=>Te(t,Oe,{worldSize:e,cityIdSize:i}))(s,e,i)),o&&r.push(...((t,e)=>{const i=ze(e),n=Te(t,Re,i);return pe(t)&&(n.push(...Fe.write(t.hitPoints)),n.push(t.combated)),n})(o,e)),r.concat(n)},li=Pe(ni,13),ci=Pe(si,1),hi=Pe(31),di=[Se("width",li),Se("height",li),Se("turnNumber",ci),Se("playerId",Pe(1)),Se("combatSeed",hi),{name:"mapSeed",write:t=>null===t?[!1]:[!0,...Bt(t,oi)],read(t){const[e]=t;return{mapSeed:e?jt(t,oi):null}}},{name:"nextCityId",write:(t,{context:e})=>(e.cityIdSize=(t=>t>0?Lt(t-1):0)(t),Bt(e.cityIdSize,5)),read(t,{context:e}){e.cityIdSize=jt(t,5)}},{name:"tiles",write:(t,{data:e,context:i})=>((t,e,i)=>{const n=[];return t.forEach((t=>{n.push(...ai(t,e,i.cityIdSize))})),n})(t,e,i),read:(t,{context:e,data:i})=>((t,e,i)=>{const n=[],s=[],o=[[],[]];for(let r=0;r<e.height;r++)for(let a=0;a<e.width;a++){const l=ri(t,[a,r],e,i),{city:c,unit:h}=l;c&&(n.push(c),c.id>=e.nextCityId&&(e.nextCityId=c.id+1)),h&&o[h.playerId].push(h),s.push(l)}return{tiles:s,cities:n,units:o}})(t,i,e)}],ui=t=>{const e=(t=>Mt(t,Ot))(t);return Ce(e,di,{data:{nextCityId:0}})},pi=(t,e)=>{for(const i in e)"style"===i?Object.assign(t.style,e.style):i in t?t[i]=e[i]:t.setAttribute(i,e[i])},gi=(t,...e)=>{const i=document.createElement(t);return((t,...e)=>{for(const i of e)Array.isArray(i)?t.append(...i):s(i)?t.innerText=i:pi(t,i)})(i,...e),i},fi=(...t)=>{const[e,...i]=t;return s(e)?gi(e,...i):(t=>{const e=document.createDocumentFragment();return e.append(...t),e})(t)},mi=fi,yi=[[[13,3],[9,7],[15,13],[3,25],[7,29],[19,17],[25,23],[29,19]],[[28,4],[17,10],[8,22],[5,19],[3,21],[6,24],[3,27],[5,29],[8,26],[11,29],[13,27],[10,24],[22,15]],[[5,5],[27,5],[18,10],[27,16],[8,16],[8,28],[5,28]]],wi=["#da1e28","#006400"];class vi{constructor(t,e){this.view=t,this.context=e}drawIcon(t,e,i,n){const s=yi[i];((t,[e,i],n,s)=>{t.fillStyle=s;const[[o,r]]=n;t.beginPath(),t.moveTo(e+o,i+r);for(let s=1;s<n.length;s++){const[o,r]=n[s];t.lineTo(e+o,i+r)}t.closePath(),t.stroke(),t.fill()})(this.context,[t,e],s,wi[n])}drawSprite(t,e,i){const{tileSize:n}=this.view,s=Q.width/n,[o,r]=lt(t,s),a=o*n,l=r*n;this.context.drawImage(Q,a,l,n,n,e,i,n,n)}clearTile(t,e){const[i,n]=this.view.toCanvasPosition(t,e),{tileSize:s}=this.view;this.context.clearRect(i,n,s,s)}clear(){this.context.clearRect(0,0,this.view.width,this.view.height)}refresh(){(t=>{const e=t.getImageData(0,0,1,1);t.putImageData(e,0,0)})(this.context)}moveViewport(t,e){const{context:i}=this,{width:n,height:s,tileSize:o}=this.view;if(0!==t){const e=t*o,r=t>0?e:n+e,a=i.getImageData(0,0,r,s),l=i.getImageData(r,0,n-r,s);i.putImageData(a,n-r,0),i.putImageData(l,0,0)}if(0!==e){const t=e*o,r=e>0?t:s+t,a=i.getImageData(0,0,n,r),l=i.getImageData(0,r,n,s-r);i.putImageData(a,0,s-r),i.putImageData(l,0,0)}}}const xi={grassland:"#388E3C",steppe:"#88C34A",sea:"#0090c4"};class bi extends vi{drawGrid(){this.context.fillStyle=bi.GRID_COLOR;const{tileSize:t}=this.view,{width:e,height:i}=this.context.canvas;for(let n=t;n<e;n+=this.view.tileSize)this.context.fillRect(n,0,1,i);for(let n=t;n<i;n+=this.view.tileSize)this.context.fillRect(0,n,e,1)}moveViewport(){}}bi.GRID_COLOR="#555";const Pi=(t,e)=>((t,e,i)=>{const n=Math.floor(i/2),s=t-n,o=[];let r=t;for(let a=e-n;a<e;a++){const n=Math.abs(a-e);let l=!0;for(let c=s;c<t;c++){const s=r,h=Math.abs(c-t),d=pt(h,n);if(d!==i&&d!==i-1)continue;let u;c<s?(u=l?[!0,!1,!1,!0]:[!0,!1,!1,!1],r=c):u=c===s?[!1,!1,!1,!0]:[!0,!1,!1,!1],l=!1;const p={position:[c,a],borders:u},g=Pt(p,t),f=bt(g,e),m=Pt(f,t);o.push(p,g,f,m),l=!1}}const a={position:[t,e-n],borders:i%2==0?[!0,!0,!1,!0]:[!0,!1,!1,!1]},l={position:[t-n,e],borders:i%2==0?[!0,!1,!0,!0]:[!1,!1,!1,!0]},c=bt(a,e),h=Pt(l,t);return o.push(a,l,c,h),o})(t,e,7);class Si extends vi{constructor(t,e,i){super(t,e),this.bordersRenderer=i,this.context.fillStyle=Si.BORDERS_COLOR}drawTileBorders(t,e,i){this.bordersRenderer(this.context,t,e,i)}}Si.BORDERS_COLOR="#000";var Ci={terrain:class extends vi{drawTerrain(t,e,i){this.context.fillStyle=xi[i];const{tileSize:n}=this.view;this.context.fillRect(t,e,n,n)}},grid:bi,borders:Si,objects:class extends vi{constructor(t,e){super(t,e),this.animations=this.createShakingAnimations()}createShakingAnimations(){const t={vertical:{maxOffset:e=3,getOffsets:t=>[t,0]},horizontal:{maxOffset:e,getOffsets:t=>[0,t]},mainDiagonal:{maxOffset:i=3,getOffsets:t=>[t,t]},antiDiagonal:{maxOffset:i,getOffsets:t=>[-t,t]}};var e,i;return w(t,(t=>((t,e,{maxOffset:i,getOffsets:n})=>{const s=4*i*e-1;return(e,o,r)=>{const a=o*t,l=r*t,c=e.getImageData(a,l,t,t),h=(s,o,r,d)=>{const u=Math.abs(o)===i?-r:r,p=o+u,[g,f]=n(p);e.clearRect(a,l,t,t),e.putImageData(c,a+g,l+f),s>0?requestAnimationFrame((()=>h(s-1,p,u,d))):d()};return new Promise((t=>{h(s,0,1,t)}))}})(this.view.tileSize,3,t)))}drawUnit(t,e,{type:{id:i},playerId:n}){this.drawIcon(t,e,i-1,n)}drawHouse(t,e){this.drawSprite(1,t,e)}drawCityWithGarrison(t,e){this.drawSprite(2,t,e)}getAnimation(t,e){return 0===t?this.animations.horizontal:0===e?this.animations.vertical:t===e?this.animations.mainDiagonal:this.animations.antiDiagonal}shake(t,e,i,n){return this.getAnimation(i,n)(this.context,t,e)}},selection:class extends vi{constructor(t,e,i){super(t,e),this.borderRenderer=i}drawMaxCityBorders([t,e]){this.context.fillStyle="#333";Pi(t,e).forEach((t=>{const[e,i]=this.view.toCanvasPosition(...t.position);this.borderRenderer(this.context,e,i,t.borders)}))}clearMaxCityMaxBorders([t,e]){Pi(t,e).forEach((({position:[t,e]})=>{this.clearTile(t,e)}))}drawCitizenDistribution(t){for(const[e,i]of t.assignmentsPositions)this.drawCitizen(e,i)}clearCitizenDistribution(t){for(const[e,i]of t.influencedPositions)this.clearTile(e,i)}drawCitizen(t,e){const[i,n]=this.view.toCanvasPosition(t,e);this.drawSprite(0,i,n)}drawPath(t){this.context.fillStyle="#5af";for(let e=0;e<t.length;e++){const i=t[e],[n,s]=this.view.grid.getPositionByIndex(i),[o,r]=this.view.toCanvasPosition(n,s);this.drawPathNode(o,r)}}drawPathNode(t,e){const i=this.view.tileSize/2,n=t+i,s=e+i;this.context.beginPath(),this.context.arc(n,s,4,0,2*Math.PI,!1),this.context.closePath(),this.context.fill()}drawUnitSelection(t,e,i=[]){i.length>0&&this.drawPath(i);const[n,s]=this.view.toCanvasPosition(t,e);this.context.strokeStyle="#000",this.context.beginPath(),this.context.rect(n+2,s+2,this.view.tileSize-3,this.view.tileSize-3),this.context.closePath(),this.context.stroke()}clearPath(t){t.forEach((t=>{const[e,i]=this.view.grid.getPositionByIndex(t);this.clearTile(e,i)}))}clearUnitSelection(t,e,i){super.clearTile(t,e),this.clearPath(i)}drawCitySelection(t){this.drawCitizenDistribution(t),this.drawMaxCityBorders(t.position)}clearCitySelection(t){this.clearMaxCityMaxBorders(t.position),this.clearCitizenDistribution(t)}}};class Ti{static getLayerId(t){return Ti.LAYER_ID_PREFIX+t}constructor(t,e,i=Ti.DEFAULT_TILE_SIZE){var n;this.world=t,this.selectionHandlers=e,this.tileSize=i,this.selectedUnit=null,this.selectedCity=null,this.viewportPosition=[0,0],this.selectors=[({unit:t})=>this.selectUnit(t),({city:t})=>this.selectCity(t),()=>this.clearSelection()],this.eventHandlers=(n=this,{onPopulationIncreased:({city:t})=>{n.selectedCity?.id===t.id&&n.layers.selection.drawCitizenDistribution(t)},onBordersExpanded:({city:t,position:e})=>{const[i,s]=e;n.drawCapturedTileBorders(i,s),n.selectedCity?.id===t.id&&n.refreshCitySelection()},onUnitMoved:({path:t})=>{const[e,i]=t[0],[s,o]=l(t),{unit:r}=n.grid.get(s,o);n.drawObject(e,i),n.drawObject(s,o),n.selectedUnit===r&&(n.layers.selection.clear(),n.layers.selection.drawUnitSelection(s,o,r.path))},onMoveCanceled:({from:[t,e]})=>{const{unit:i}=n.grid.get(t,e);n.selectedUnit===i&&(n.layers.selection.clear(),n.layers.selection.drawUnitSelection(t,e,i.path))},onUnitCompleted:({cityPositionIndex:t})=>{const[e,i]=n.grid.getPositionByIndex(t);n.drawObject(e,i)},onUnitKilled:({attackerPosition:[t,e],killedUnitPosition:[i,s]})=>{n.drawObject(t,e),n.drawObject(i,s),n.layers.selection.clear(),n.layers.selection.drawUnitSelection(i,s)},onCombat:async({from:t,from:[e,i],to:s,to:[o,r],attackedDestroyed:a,defenderDestroyed:l})=>{const[c,h]=n.grid.getOffsets(t,s);await Promise.allSettled([n.layers.objects.shake(e,i,c,h),n.layers.objects.shake(o,r,c,h)]),a?(n.drawObject(e,i),n.unselectUnit()):l&&(n.drawObject(e,i),n.drawObject(o,r),n.layers.selection.clear(),n.layers.selection.drawUnitSelection(o,r))},onCityDestroyed:({city:t,barbarian:{position:[e,i]}})=>{n.clearCity(t),n.drawObject(e,i),n.clearUnitSelection()},onCityPillaged:({barbarianPosition:[t,e]})=>{n.drawObject(t,e),n.clearUnitSelection()}}),this.refresh=()=>{y(this.layers,(t=>{t.refresh()}))},this.bordersRender=(t=>{const e=(t=>[[0,0,t,1],[t-1,0,1,t],[0,t-1,t,1],[0,0,1,t]])(t);return(t,i,n,s)=>{e.filter(((t,e)=>s[e])).forEach((([e,s,o,r])=>{t.fillRect(i+e,s+n,o,r)}))}})(i)}get grid(){return this.world.grid}get width(){return this.world.width*this.tileSize}get height(){return this.world.height*this.tileSize}async handleEvent(t){const e=`on${me(t.type)}`,i=this.eventHandlers[e];i?await i(t.payload):console.warn(`'${e}' event handler not defined`)}async handleEvents(t){for(const e of t)await this.handleEvent(e)}createLayer(t){const e=mi("canvas",{id:Ti.getLayerId(t),width:this.width,height:this.height});return this.layersContainer.appendChild(e),e.getContext("2d",{willReadFrequently:!0})}createLayers(){this.layers={};for(const[t,e]of Object.entries(Ci)){const i=this.createLayer(t);this.layers[t]=new e(this,i,this.bordersRender)}this.layers.grid.drawGrid()}mount(t){var e;this.layersContainer=mi("div",{id:"layers",style:{width:this.width+"px",height:this.height+"px"}}),this.createLayers(),t.appendChild(this.layersContainer),e=this.refresh,document.addEventListener("visibilitychange",(()=>{"visible"===document.visibilityState&&e()}))}canCapture(t,e){return this.selectedCity.influence.canExpandToPosition([t,e])}drawCapturedTileBorders(t,e){this.drawBorders(t,e);for(const{dx:i,dy:n}of St.orthogonal){const s=t+i,o=e+n;this.grid.get(s,o).influencedBy&&this.drawBorders(t+i,e+n)}}captureTile(t,e){const[i,n]=this.selectedCity.position;this.world.captureTile(i,n,t,e),this.drawCapturedTileBorders(t,e)}selectCity(t){const e=!!t;return e&&(this.clearSelection(),this.selectedCity=t,this.drawCitySelection(),this.selectionHandlers.onCitySelected(t)),e}selectUnit(t){const e=!!t;if(e){this.clearSelection(),this.selectedUnit=t;const[e,i]=t.position;this.layers.selection.drawUnitSelection(e,i,t.path)}return e}select(t,e=!0){for(let i=e?0:1;i<this.selectors.length;i++){if((0,this.selectors[i])(t))break}}onTileClick(t,e){if(this.selectedCity&&this.canCapture(t,e))return void this.captureTile(t,e);const i=this.selectedUnit||this.selectedCity,n=!gt(i?.position,[t,e]),s=this.grid.get(t,e);this.select(s,n)}drawCitySelection(){this.layers.selection.drawCitySelection(this.selectedCity);for(const[t,e]of this.selectedCity.assignmentsPositions){const{unit:i}=this.grid.get(t,e);i&&this.layers.objects.clearTile(t,e)}}clearSelection(){this.unselectUnit(),this.unselectCity()}refreshCitySelection(){this.clearCitySelection(),this.drawCitySelection()}unselectCity(){null!==this.selectedCity&&(this.clearCitySelection(),this.selectedCity=null)}clearCitySelection(){this.selectionHandlers.onClearSelection(),this.layers.selection.clearCitySelection(this.selectedCity);for(const[t,e]of this.selectedCity.assignmentsPositions){const{unit:i}=this.grid.get(t,e);if(i){const[n,s]=this.toCanvasPosition(t,e);this.layers.objects.drawUnit(n,s,i)}}}unselectUnit(){this.selectedUnit&&(this.clearUnitSelection(),this.selectedUnit=null)}clearUnitSelection(){this.selectionHandlers.onClearSelection();const[t,e]=this.selectedUnit.position;this.layers.selection.clearUnitSelection(t,e,this.selectedUnit.path),this.selectedUnit=null}changeCityProject(t){const[e,i]=this.selectedCity.position,n=this.grid.getIndexByPosition(e,i);this.world.setCityProject(n,t)}async moveUnit(t,e){const i=this.world.moveUnit(this.selectedUnit,t,e);i.length>0?await this.handleEvents(i):(this.layers.selection.clear(),this.selectUnit(this.selectedUnit))}draw(){for(let t=0;t<this.grid.tiles.length;t++){const[e,i]=this.grid.getPositionByIndex(t);this.drawTile(e,i)}}toCanvasPosition(t,e){const[i,n]=this.viewportPosition,[s,o]=this.grid.getPosition(t-i,e-n);return[s*this.tileSize,o*this.tileSize]}moveViewport(t,e){const[i,n]=this.viewportPosition;this.viewportPosition=this.grid.getPosition(i+t,n+e),y(this.layers,(i=>{i.moveViewport(t,e)}))}removeSelectedUnit(){if(this.selectedUnit){const[t,e]=this.selectedUnit.position;this.world.removeUnit(this.selectedUnit),this.drawObject(t,e),this.clearUnitSelection()}}clearCity(t){const{position:[e,i],influence:n}=t;this.drawObject(e,i),n.getFrontierPositions().forEach((([t,e])=>{this.layers.borders.clearTile(t,e);for(const{dx:i,dy:n}of St.members){const s=t+i,o=e+n;this.grid.get(s,o).influencedBy&&this.drawBorders(s,o)}}))}removeSelectedCity(){this.selectedCity&&(this.clearCity(this.selectedCity),this.unselectCity())}placeTerrain(t,e,i){const n=this.world.placeTerrain(t,e,V[i-1]);return n&&(this.drawTile(t,e),this.selectedCity&&this.refreshCitySelection()),n}drawBorders(t,e){this.layers.borders.clearTile(t,e);const i=St.orthogonal.map((({dx:i,dy:n})=>!this.grid.get(t+i,e+n).influencedBy)),[n,s]=this.toCanvasPosition(t,e);this.layers.borders.drawTileBorders(n,s,i)}drawObject(t,e){const[i,n]=this.toCanvasPosition(t,e),{unit:s,city:o}=this.grid.get(t,e);this.layers.objects.clearTile(t,e),s&&o?this.layers.objects.drawCityWithGarrison(i,n):s?this.layers.objects.drawUnit(i,n,s):o&&this.layers.objects.drawHouse(i,n)}drawTile(t,e){const i=this.toCanvasPosition(t,e),n=this.grid.get(t,e),[s,o]=i;this.layers.terrain.drawTerrain(s,o,n.terrain.name),(n.city||n.unit)&&this.drawObject(t,e),n.influencedBy&&this.drawBorders(t,e)}skipTurnsUntilEvent(t=1e3){let e=t;for(let i=1;i<=t;i++){const t=this.world.turn();if(t.length>0){t.forEach((t=>{this.handleEvent(t)})),e=i;break}}return e}update(t){this.world=t,this.viewportPosition=[0,0],this.layersContainer.innerHTML="",Object.assign(this.layersContainer.style,{width:this.width+"px",height:this.height+"px"}),this.createLayers(),this.draw()}setGridShown(t){document.getElementById("layer-grid").style.display=t?"block":"none"}turn(){const t=this.world.turn();return t.forEach((t=>{this.handleEvent(t)})),t}placeUnit(t,e,i){const n=i<=et.length?{type:et[i-1],playerId:1}:{type:et[1],playerId:0};this.world.placeUnit(t,e,n),this.drawObject(t,e)}placeCity(t,e,i){if(this.world.foundCity(t,e,i)){this.drawObject(t,e);for(const{dx:i,dy:n}of St.members)this.drawCapturedTileBorders(t+i,e+n)}}getViewportPosition(){return this.viewportPosition}}Ti.DEFAULT_TILE_SIZE=32,Ti.LAYER_ID_PREFIX="layer-";const Ii=t=>_e(t,2),Ei=t=>{return e=t.getMilliseconds(),_e(e,3);var e},Mi=t=>`${((t,e="-")=>[t.getFullYear(),Ii(t.getMonth()+1),Ii(t.getDate())].join(e))(t)} ${((t,e=".")=>[Ii(t.getHours()),Ii(t.getMinutes()),Ii(t.getSeconds())].join(e))(t)}.${Ei(t)}`,Ni=t=>e=>((t,e)=>{const i=[];for(const n of e){const e=n.label||n.field,s=n.get?n.get(t):t[n.field];if(!r(s)){const t=`${e}: ${s}`;i.push(t)}}return i.join("; ")})(e,t),Ui="-",Bi=[{label:"move points",field:"movePoints"},{label:"hit points",get:t=>pe(t)?t.hitPoints:null}],Oi=Ni([{field:"id"},{field:"name"},{field:"population"},{label:"project",get:t=>{if(null===t.project)return Ui;var e;var i;return`${e=t.project.type.productId,et[e-1].name} (${(i=t.project).progress+"/"+i.type.cost})`}},{label:"grow progress",get:t=>t.foodBasketSize>0?t.growthProgress+"/"+t.foodBasketSize:Ui},{label:"food surplus",field:"foodSurplus"},{label:"free tiles",get:t=>t.assignments.getFreeTilesCount()},{label:"expanding progress",get:t=>{const{tileToExpand:e}=t.influence;return e?t.influence.expandingProgress+"/"+e.cost:Ui}},{label:"growth to",get:t=>{const{tileToExpand:e}=t.influence;return e?e.position.join(", "):Ui}}]),Ai=Ni(Bi),Di=t=>{const e=Mi(new Date),i=prompt("File Name",e);if(null!==i){const n=Te(t,di),s=new Uint8Array(function*(t){let e=0,i=0;for(const n of t)8===e&&(yield i,e=0,i=0),n&&(i+=2**e),++e;e>0&&(yield i)}(n));((t,e)=>{const i=new Blob([e],{type:"application/octet-stream"}),n=URL.createObjectURL(i),s=fi("a",{href:n,download:`${t}.save`});document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(n)})(i||e,s)}},ji=({content:t})=>[m("div",{className:"backdrop"}),m("div",{className:"modal-wrapper"},[t])];var ki;class Ri extends K{onMounted(){ki.instance=this,document.addEventListener("keydown",(({key:t})=>{"Escape"===t&&this.closeModal()}))}showModal(t){this.setState({modal:t})}closeModal(){this.setState({modal:null})}render(){return this.state.modal?m(ji,{content:this.state.modal}):null}}ki=Ri,Ri.showModal=t=>{ki.instance.showModal(t)},Ri.closeModal=()=>{ki.instance.closeModal()};const zi=({label:t,value:e})=>m("span",{className:"field"},[m("span",`${t}: `,{className:"label"}),m("span",e,{className:"value"})]);class Li extends K{constructor(){super(...arguments),this.fileInputRef={value:null},this.fileReader=new FileReader,this.loadFile=()=>{this.fileInputRef.value.click()}}onMounted(){this.fileReader.addEventListener("loadend",(t=>{const e=new Uint8Array(t.target.result);this.props.onLoad(e)}))}render(){return m("div",{className:"save-load"},[m("button","Save",{onclick:this.props.onSave}),m("button","Load",{onclick:this.loadFile}),m("input",{type:"file",ref:this.fileInputRef,onchange:t=>{const e=t.target;this.fileReader.readAsArrayBuffer(e.files[0]),e.value=null},style:{display:"none"}})])}}const Fi=({turn:t,mapSeed:e,playerName:i,onSave:n,onLoad:s,onNewWorld:o})=>{return m("div",{className:"top-panel"},[m(zi,{label:"Turn",value:`${t} (${i})`}),m(zi,{label:"Map Seed",value:(r=e,"number"==typeof r?Xe(e):"-")}),m(Li,{onSave:n,onLoad:s}),m("button","New World",{onclick:o})]);var r},Hi=["Width","Height"],Wi=(t,e,i)=>{const n=[];return t.forEach(((t,s)=>{if(t<e){const t=Hi[s];n.push(`${t} must be >= ${e}`)}else if(t>i){const t=Hi[s];n.push(`World ${t} must be <= ${i}`)}})),n},_i=({items:t,onChange:e,selectedItem:i=t[0],disabled:n=!1})=>m("select",{disabled:n,selectedIndex:t.indexOf(i),onchange:i=>{const n=t[i.target.selectedIndex];e(n)}},t.map((t=>m("option",t.name,{value:t.id})))),$i=({label:t,disabled:e,items:i,selectedItem:n,onChange:s})=>[m("span",{className:"label"},`${t}: `),m(_i,{disabled:e,items:i,selectedItem:n,onChange:s})],Gi=({value:t,onChange:e})=>m("div",{className:"seed-field"},[m("label","Seed: "),m("input",{type:"text",value:t,oninput:t=>{e(t.target.value)}}),m("button","↻",{type:"button",onclick:()=>{const t=Ye();e(t)}})]),Xi=({value:t,min:e,max:i,required:n,onChange:s})=>m("input",{value:t,min:e,max:i,step:1,required:n,type:"number",onchange:t=>{const e=t.target;s(Math.floor(+e.value))}}),Yi=({width:t,height:e,min:i,max:n,onWidthChange:s,onHeightChange:o})=>m("div",[m("span","Size: "),m(Xi,{min:i,max:n,value:t,onChange:s,required:!0}),m("span",{className:"size-inputs-separator"},"x"),m(Xi,{min:i,max:n,value:e,onChange:o,required:!0})]),Ki=({name:t,options:e,onChange:i,value:n})=>m("div",e.map((e=>{const o=s(e)?{id:e,name:e}:e;return[m("input",{type:"radio",name:t,id:o.id,value:o.id,onchange:()=>{i(e)},checked:n===e}),m("label",o.name,{htmlFor:o.id})]})));class Qi extends K{constructor(){super(...arguments),this.handleSubmit=t=>{t.preventDefault();const{width:e,height:i}=this.state;this.setState({errors:[]}),this.state.isEmpty?this.onCreateEmptyWorld(e,i,this.state.terrain):this.onGenerateWorld(e,i,this.state.seed)},this.cancel=()=>{Ri.closeModal()},this.getChangeHandler=t=>e=>{this.setState({[t]:e})},this.toggleEmpty=()=>{this.setState({isEmpty:!this.state.isEmpty})}}getInitialState(){return{width:40,height:20,seed:Ye(),terrain:V[0],errors:[],isEmpty:!0}}onCreateEmptyWorld(t,e,i){const n=Wi([t,e],13,We);0===n.length?(this.props.onCreateEmptyWorld(t,e,i),Ri.closeModal()):this.setState({errors:n})}onGenerateWorld(t,e,i){const n=Wi([t,e],13,We),s=Ge(i);null===s&&n.push("Invalid seed"),0===n.length?(this.props.onGenerateWorld(t,e,s),Ri.closeModal()):this.setState({errors:n})}render(){return m("div",{className:"modal create-world"},[m("div",{className:"form-row"},[m(Ki,{name:"options",options:["empty","generate"],value:this.state.isEmpty?"empty":"generate",onChange:t=>{this.setState({isEmpty:"empty"===t})}})]),m("form",{onsubmit:this.handleSubmit},[m("div",{className:"form-row"},[m(Yi,{width:this.state.width,height:this.state.height,min:13,max:We,onWidthChange:this.getChangeHandler("width"),onHeightChange:this.getChangeHandler("height")})]),m("div",{className:"form-row"},[this.state.isEmpty?m($i,{label:"Terrain",items:V,selectedItem:this.state.terrain,onChange:this.getChangeHandler("terrain")}):m(Gi,{value:this.state.seed,onChange:this.getChangeHandler("seed")})]),this.state.errors.length>0?m("ul",{className:"errors"},this.state.errors.map((t=>m("li",t)))):null,m("div",{className:"modal-buttons"},[m("button","Cancel",{type:"button",onclick:this.cancel}),m("button","Create")])])])}}const qi=({checked:t=!1,label:e,id:i=e,onChange:n})=>m("div",{className:"labeled-checkbox"},[m("input",{type:"checkbox",id:i,checked:t,onchange:t=>{const e=t.target;n(e.checked)}}),m("label",e,{htmlFor:i})]);class Vi extends K{constructor(){super(...arguments),this.checked=!1}render(){return m("div",{className:"controls-group"},[m("button",this.props.buttonText,{onclick:()=>{this.props.onPress(this.checked)}}),m(qi,{label:this.props.optionName,checked:this.checked,onChange:t=>{this.checked=t}})])}}const Ji=({onToggle:t,items:e,selectedItem:i,onItemSelected:n,selected:s})=>m("div",{className:"toggled-dropdown"},[m("input",{type:"checkbox",checked:s,onchange:()=>{t(!s)}}),m(_i,{items:e,selectedItem:i,disabled:!s,onChange:n})]);class Zi extends K{constructor(){super(...arguments),this.selectedItem=this.props.tool.items[0]}render(){return m(Ji,{selected:this.props.selected,items:this.props.tool.items,selectedItem:this.selectedItem,onItemSelected:t=>{this.selectedItem=t,this.props.onChange(t)},onToggle:t=>{this.props.onChange(t?this.selectedItem:null)}})}}const tn=({tool:t,selectedTool:e,onChange:i})=>{const n=t.id===e?.id;return(t=>Boolean(t.items))(t)?m(Zi,{selected:n,tool:t,onChange:e=>{i(e?{id:t.id,option:e.id}:null)}}):m(qi,{checked:n,label:t.label,onChange:e=>{i(e?t:null)}})},en=({tools:t,onChange:e,selectedTool:i})=>m("div",{className:"controls-group"},t.map((t=>m(tn,{tool:t,selectedTool:i,onChange:e})))),nn={...et[1],id:et.length+1,name:"barbarian"},sn=[...et,nn],on=[{id:"placeTerrain",items:V},{id:"placeUnit",items:sn},{id:"placeCity",label:"City"}],rn={id:0,name:"-"},an=[rn,...it.map(((t,e)=>({id:t.productId,name:`${et[e].name} (${t.cost})`})))],ln=({onChange:t,selectedProject:e})=>{const i=null===e?rn:an.find((t=>t.id===e.productId));return m("div",{className:"controls-group labeled"},[m($i,{label:"City Project",disabled:!1,onChange:e=>{const i=e!==rn?it.find((t=>t.productId===e.id)):null;t(i)},selectedItem:i,items:an})])},cn=({onTurn:t,onSkipTurns:e,onToggleGrid:i,onToolSelected:n,onCityProjectChanged:s,selectedTool:o,selectedCity:r,gridShown:a,tileInfo:l})=>m("div",{className:"bottom-panel"},[m("div",{className:"controls-panel"},[m(qi,{label:"Grid",checked:a,onChange:i}),m(Vi,{optionName:"Skip Silent Turns",buttonText:"Turn",onPress:i=>{i?e():t()}}),m(en,{tools:on,onChange:n,selectedTool:o}),r?m(ln,{onChange:s,selectedProject:r.project?r.project.type:null}):null]),m("span",{innerHTML:l??"-"})]),hn=t=>{const{offsetX:e,offsetY:i}=t,{clientWidth:n,clientHeight:s}=t.target,o=s-1;return[Vt(e,n-1),Vt(i,o)]},dn=(e,i)=>{((t,e)=>{y(e,((e,i)=>{((t,e,i)=>{t.addEventListener(e,(t=>{t.preventDefault(),i(t)}))})(t,i,e)}))})(i,{contextmenu:t,mouseup:t=>{const i=hn(t);0===t.button?t.ctrlKey?e.onCtrlClick(i):e.onLeftClick(i):e.onRightClick(i)},mousemove:t=>{const i=hn(t);e.onMove(i)},mouseleave:()=>{e.onLeave()}})},un=(t,e)=>{let i=null;return{onMove:n=>{const s=e(n);gt(s,i)||(t.onMove(s),i=s)},onLeave:()=>{t.onLeave(),i=null}}},pn=({element:t,getTilePosition:e,...i})=>{const n=((t,e)=>{const{onLeave:i,onMove:n,...s}=t,o=w(s,(t=>((t,e)=>i=>{t(e(i))})(t,e)));return{...o,...un({onMove:n,onLeave:i},e)}})(i,e);dn(n,t)},gn={ArrowLeft:St.WEST.offset,ArrowUp:St.NORTH.offset,ArrowRight:St.EAST.offset,ArrowDown:St.SOUTH.offset},fn=["barbarians","player"];class mn extends K{constructor(){super(...arguments),this.view=new Ti(ye.createEmptyWorld(40,20),{onClearSelection:()=>{this.setState({selectedCity:null})},onCitySelected:t=>{this.setState({selectedCity:t})}}),this.viewContainerRef={value:null},this.saveWorld=()=>{Di(this.view.world)},this.loadWorld=t=>{const e=ye.fromData(ui(t));this.updateWorld(e)},this.createWorld=()=>{Ri.showModal(m(Qi,{onCreateEmptyWorld:(t,e,i)=>{const n=ye.createEmptyWorld(t,e,i);this.updateWorld(n)},onGenerateWorld:(t,e,i)=>{const n=ii(t,e,i),s=ye.fromTerrainMap(n,t,i);this.updateWorld(s)}}))},this.onToggleGrid=()=>{const t=!this.state.gridShow;this.view.setGridShown(t),this.setState({gridShow:t})},this.onTurn=()=>{this.view.turn(),this.setState({turn:this.view.world.turnNumber,playerName:this.getPlayerName()})},this.skipTurns=()=>{this.view.skipTurnsUntilEvent(),this.setState({turn:this.view.world.turnNumber,playerName:this.getPlayerName()})},this.onToolSelected=t=>{this.setState({selectedTool:t})},this.onCityProjectChanged=t=>{this.view.changeCityProject(t?.productId??null)}}getPlayerName(){return this.view?fn[this.view.world.playerId]:fn[1]}getInitialState(){return{turn:1,gridShow:!0,mapSeed:null,selectedTool:null,selectedCity:null,playerName:this.getPlayerName()}}onMounted(){this.view.mount(this.viewContainerRef.value),this.view.draw(),this.addMouseHandlers(),this.addKeyHandlers()}addMouseHandlers(){pn({element:this.view.layersContainer,getTilePosition:([t,e])=>{const[i,n]=this.view.getViewportPosition();return this.view.grid.getPosition(Math.floor(t/this.view.tileSize)+i,Math.floor(e/this.view.tileSize)+n)},onLeftClick:([t,e])=>{this.state.selectedTool?(this.applyTool(t,e),this.setState({selectedTool:null})):this.view.onTileClick(t,e)},onRightClick:([t,e])=>{this.view.selectedUnit&&this.view.moveUnit(t,e)},onCtrlClick:([t,e])=>{this.state.selectedTool&&this.applyTool(t,e)},onMove:t=>{const e=this.getTileInfo(t);this.setState({tileInfo:e})},onLeave:()=>{this.setState({tileInfo:null})}})}addKeyHandlers(){(({element:t,...e})=>{t.addEventListener("keydown",(({key:t})=>{if(t.startsWith("Arrow")){const i=gn[t];e.onArrow(i)}else e[`on${t}`]?.()}))})({element:document,onEscape:()=>{this.view.clearSelection(),this.setState({selectedTool:null})},onArrow:([t,e])=>{this.view.moveViewport(t,e)},onDelete:()=>{this.view.removeSelectedUnit(),this.view.removeSelectedCity()}})}getTileInfo(t){return((t,e)=>{const[i,n]=e,s=[t.world.grid.getIndexByPosition(i,n),`[${e.join("; ")}]`],o=t.grid.get(i,n),{unit:r,city:a}=o;if(o.influencedBy&&s.push(((t,e)=>e.assignments.isPositionOccupied(t)?`<b>${e.name}</b>`:e.name)(e,o.influencedBy)),r)s.push(Ai(r));else if(a)s.push(Oi(a));else if(t.selectedCity){const r=t.selectedCity.influence.getTilesToExpand().find((({position:t})=>gt(t,e)));r?s.push(`expansion cost: ${r.cost}`):null!==o.influencedBy&&o.influencedBy!==t.selectedCity&&t.selectedCity.influence.canSwap(i,n)&&s.push("swappable")}return s.join(" ")})(this.view,t)}applyTool(t,e){const{selectedTool:i}=this.state,n=i.id,s=this.view[n](t,e,i.option);s&&this[`on${me(n)}`]?.(s)}onPlaceTerrain(){this.setState({mapSeed:this.view.world.mapSeed})}updateWorld(t){this.view.update(t),this.setState({turn:this.view.world.turnNumber,mapSeed:this.view.world.mapSeed,playerName:this.getPlayerName()})}render(){return[m("div",{className:"main"},[m(Fi,{turn:this.state.turn,mapSeed:this.state.mapSeed,playerName:this.state.playerName,onSave:this.saveWorld,onLoad:this.loadWorld,onNewWorld:this.createWorld}),m("div",{ref:this.viewContainerRef}),m(cn,{gridShown:this.state.gridShow,onToggleGrid:this.onToggleGrid,onTurn:this.onTurn,onSkipTurns:this.skipTurns,onToolSelected:this.onToolSelected,onCityProjectChanged:this.onCityProjectChanged,selectedTool:this.state.selectedTool,selectedCity:this.state.selectedCity,tileInfo:this.state.tileInfo})]),m(Ri,{})]}}var yn;yn=()=>{((t,e,i)=>{const n=f(t,e),s={parentElement:i,currentSibling:null};3===n.type?I(n,s):E(n,s)})(mn,{},document.body)},Q.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGAAAAAgCAYAAADtwH1UAAAAAXNSR0IArs4c6QAAAZFJREFUaEPtmluuwyAMRNutsXC21qtUSkojHsPYxtzK/cYMnmMDRXk+4ufqwNNVPcQfAcC5CEQAUkqvc/05Z9Fczj64ydOmleY7QziKgM5DwXmRPrXwmvlOEK4OdIIg1v/PAMrkT/5UPmQXqOhTC96gA2rJr4Sgpk8BODJ1PAN6ya+AoKpPA7hDWHQLQpK3hKCuLwJA7p1s2EzyFhBM9CkADmcAk7wmBDP9aQA9842uopLkNSCY6k8BQMxXhqCRvASCuf7OADSTZyAs0d8VgEXyMxCW6QeA+p0sALB3VSAOKboAABjJDgkAgHNoBZZmMjGtpUBzpZSu+JwzkNZ7yFcBINVwTbzwGooYUFs7G3c3bzhPaX5x9UYg/ASAXuGMzEOKrjtHzfwJCDyA1ivoHbvCw5zEREnsmcq+AEYQFMw/JKTv7WbxveoHu0DWAQHgc/C2NvzBgRwAgJOy2UHRAdgXEL+9BbW2IaX9P84AoEXfQww/zDKrYPDzlb23IBRQjBs7gPwpGc8SI2gHAgBtnU7gHxo8viHzg01RAAAAAElFTkSuQmCC",Q.onload=yn}();
