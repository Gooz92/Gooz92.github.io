!function(){"use strict";const t=new Image;class e{constructor(t){this.props=t}}const i=()=>{},s=t=>t,n=()=>!0,o=()=>!1,r=t=>"string"==typeof t,c=t=>null===t||(t=>void 0===t)(t);function l(t,e){for(const i in e)"style"===i?Object.assign(t.style,e.style):i in t?t[i]=e[i]:t.setAttribute(i,e[i])}const a=(t,...e)=>{const i=document.createElement(t);return((t,...e)=>{for(const i of e)Array.isArray(i)?t.append(...i):r(i)?t.innerText=i:l(t,i)})(i,...e),i},h=(...t)=>{const[e,...i]=t;return r(e)?a(e,...i):(t=>{const e=document.createDocumentFragment();return e.append(...t),e})(t)};function d(t,e){const i=[];for(let s=0;s<t;s++){const t=e(s);i.push(t)}return i}const u=t=>t[t.length-1],p=(t,e=n)=>t.reduce(((t,i)=>e(i)?t+1:t),0);const g=(t,e)=>{t.splice(e,1)};var f=[{id:1,name:"worker",movePoints:6},{id:2,name:"warrior",movePoints:6},{id:3,name:"settler",movePoints:6}];const w=[{id:1,name:"grassland",dryLand:!0},{id:2,name:"steppe",dryLand:!0},{id:3,name:"sea",dryLand:!1}],[y,m,x]=w,v=f,P=[{productId:1,cost:2},{productId:2,cost:5},{productId:3,cost:8}],T=w[0],S=(t=T)=>({city:null,unit:null,terrain:t}),C=(t,e,i)=>e*i+t;function b(t,e){let i=t%e;return i<0&&(i+=e),~~i}const I=(t,e,i,s)=>[b(t,i),b(e,s)],E=(t,e)=>[t%e,Math.floor(t/e)];function M(t,e,i){const s=e-t,n=i/2;return Math.abs(s)<=n?s:s>0?s-i:i+s}const A=(t,e,i,s)=>e.map((e=>function(t,e,i,s){const[n,o]=t,[r,c]=e;return[M(n,r,i),M(o,c,s)]}(t,e,i,s)));B.DIAGONAL_MOVE_COST=3,B.AXIAL_MOVE_COST=2;const O=(t,e)=>B.DIAGONAL_MOVE_COST*Math.min(t,e)+B.AXIAL_MOVE_COST*Math.abs(t-e);function B(t,e,i,s){const n=Math.abs(t-i),o=Math.abs(e-s);return O(n,o)}const U=(t,e)=>{if(t===e)return!0;if(!t||!e)return!1;const[i,s]=t,[n,o]=e;return i===n&&s===o},j=(t,e)=>t.some((t=>U(t,e))),k=function(t){const e=Math.floor(t/B.AXIAL_MOVE_COST),i=[],s=t-2;for(let t=-e;t<=e;t++)for(let n=-e;n<=e;n++){if(0===n&&0===t)continue;const e=[n,t];for(let o=B(0,0,n,t)-2;o<=s;o++){const t=i[o];t?t.push(e):i[o]=[e]}}return i}(7)[5],D=([t,e],i)=>[t,2*i-e],N=([t,e],i)=>[2*i-t,e],L=([t,e,i,s])=>[i,e,t,s],R=([t,e,i,s])=>[t,s,i,e],F=(t,e)=>({position:D(t.position,e),borders:L(t.borders)}),z=(t,e)=>({position:N(t.position,e),borders:R(t.borders)});class _{constructor(t,e){this.width=t,this.height=e}getPosition(t,e){return I(t,e,this.width,this.height)}getPositionByIndex(t){return E(t,this.width)}getIndexesByPositions(t){return t.map((([t,e])=>this.getIndexByPosition(t,e)))}getIndexByPosition(t,e){return C(t,e,this.width)}getOffsets(t,e){const[i,s]=t,[n,o]=e;return[M(i,n,this.width),M(s,o,this.height)]}getCirclePositions(t,e,i){const s=Math.floor(i/B.AXIAL_MOVE_COST),n=[];for(let o=-s;o<=s;o++)for(let r=-s;r<=s;r++){const s=this.getPosition(t+r,e+o),[c,l]=s;this.getOctileDistance(c,l,t,e)<=i&&n.push(s)}const o=[t,e];return n.sort(((t,e)=>this.comparePositions(o,t,e)))}getNextLinePosition(t,e){const[i,s]=this.getOffsets(t,e),n=Math.sign(i),o=Math.sign(s),r=Math.abs(i),c=Math.abs(s);let l=r-c,[a,h]=t;const d=2*l;return d>-c&&(l-=c,a+=n),d<r&&(l+=r,h+=o),[a,h]}comparePositions(t,e,i){const[s,n]=this.getOffsets(t,e),[o,r]=this.getOffsets(t,i),c=O(Math.abs(s),Math.abs(n)),l=O(Math.abs(o),Math.abs(r));return c!==l?c-l:n!==r?n-r:s-o}sortPositions(t,e){return i=(e,i)=>this.comparePositions(t,e,i),e.slice().sort(i);var i}isAdjacentPositionsIndexes(t,e){const i=this.getPositionByIndex(t),s=this.getPositionByIndex(e);return this.isAdjacentPositions(i,s)}isAdjacentPositions(t,e){const[i,s]=this.getOffsets(t,e),n=Math.abs(i),o=Math.abs(s);return 1===n&&1===o||0===n&&1===o||1===n&&0===o}getOctileDistance(t,e,i,s){const[n,o]=this.getOffsets([t,e],[i,s]);return O(Math.abs(n),Math.abs(o))}}class H extends _{constructor(t,e){super(e,t.length/e),this.tiles=t}get(t,e){const[i,s]=this.getPosition(t,e),n=this.getIndexByPosition(i,s);return this.tiles[n]}getTileFood(t,e){return(t=>t.terrain===y?2:1)(this.get(t,e))}isTilePassable(t,e){return(t=>t.terrain.dryLand)(this.get(t,e))}influencedByCity(t,e,i){return this.get(t,e).influencedBy===i}addInfluence(t,e,i){this.get(t,e).influencedBy=i}}H.createTileFromTileData=t=>((t=T)=>Object.assign(Object.assign({},S(t)),{influencedBy:null}))(t.terrain),H.createFromTilesData=(t,e)=>new H(t.map(H.createTileFromTileData),e);const W=t=>10*t+Math.pow(t-1,2),G={NORTH:[0,-1],NORTH_EAST:[1,-1],EAST:[1,0],SOUTH_EAST:[1,1],SOUTH:[0,1],SOUTH_WEST:[-1,1],WEST:[-1,0],NORTH_WEST:[-1,-1]};class Q{static $(t){const[e,i]=G[t];return new Q(t,e,i)}constructor(t,e,i){this.name=t,this.dx=e,this.dy=i,this.isAxial=0===e||0===i,this.offset=[e,i];(this.isAxial?Q.axial:Q.diagonal).push(this),Q.members.push(this)}}Q.members=[],Q.axial=[],Q.diagonal=[],Q.NORTH=Q.$("NORTH"),Q.NORTH_EAST=Q.$("NORTH_EAST"),Q.EAST=Q.$("EAST"),Q.SOUTH_EAST=Q.$("SOUTH_EAST"),Q.SOUTH=Q.$("SOUTH"),Q.SOUTH_WEST=Q.$("SOUTH_WEST"),Q.WEST=Q.$("WEST"),Q.NORTH_WEST=Q.$("NORTH_WEST"),Q.fromCoordinates=(t,e,i,s)=>Q.fromOffsets(i-t,s-e),Q.fromOffsets=(t,e)=>Q.members.find((i=>i.dx===t&&i.dy===e))||null;var $=["populationIncreased","bordersExpanded","unitCompleted","unitMoved","moveCanceled"].reduce(((t,e)=>Object.assign(Object.assign({},t),{[e]:t=>({type:e,payload:t})})),{});const V=(t,e)=>({index:0,buffer:[],*[Symbol.iterator](){for(;this.index<t.length;)0===this.buffer.length&&(this.buffer=e(t[this.index]),++this.index),yield this.buffer.shift();for(;this.buffer.length>0;)yield this.buffer.shift();throw new Error("Unexpected end of input")}});const q=function(t){let e=0;for(let i=0;i<t.length;i++)t[i]&&(e+=Math.pow(2,i));return e};function J(t,e,i){const s=[];for(;t>0&&s.length<e;){const e=i(t%2==1);t=Math.floor(t/2),s.push(e)}const n=i(!1);for(;s.length<e;)s.push(n);return s}const X=(t,e)=>J(t,e,s),Y=t=>X(t,8);const K=(t,e)=>function(t,e,i){const s=[];for(const n of t){const t=J(n,e,i);s.push(...t)}return s}(t,e,s);const Z=(t,e)=>t<<15|e;function tt(t,e){let i=0,s=0;if(0===e)return i;for(const n of t)if(n&&(i+=Math.pow(2,s)),++s,s===e)return i;return i}const et=(t,e)=>{t&&++e.truesCount};function it(t,e){const i=[];for(const s of t)if(i.push(s),i.length===e)return i;return i}const st=t=>Math.ceil(Math.log2(t+1));const nt=(t,e)=>function(t,e,i){const s=[];for(let n=0;n<e;n++){const e=it(t,i),n=q(e);s.push(n)}return s}(t,e,8);class ot{static getStartInfluencePositions(t,e,i=3){const[s,n]=t;return e.getCirclePositions(s,n,i).filter((([t,i])=>!e.get(t,i).influencedBy))}constructor(t,e){this.city=t,this.tileToExpand=null,this.positions=this.grid.sortPositions(t.position,e.influencedPositions),this.expandingProgress=e.expandingProgress,this.place()}getFreeTilesCount(){const[t,e]=this.city.position;return p(k,(([i,s])=>{const{influencedBy:n}=this.grid.get(t+i,e+s);return null===n}))}getTileExpansionCost(t){const[e,i]=t;let s=0;for(const{dx:t,dy:n}of Q.members){const o=e+t,r=i+n,{influencedBy:c}=this.grid.get(o,r);c&&(s+=6/this.grid.getOctileDistance(o,r,e,i))}const[n,o]=this.city.position,r=this.grid.getOctileDistance(n,o,e,i)-3;return Math.round(160/s+Math.pow(r,2))}getTilesToExpand(){const t=this.getNextFrontierPositions(),e=[];for(const i of t)if(this.canExpandToPosition(i)){const t=this.getTileExpansionCost(i);e.push({position:i,turnsToExpand:t/this.getExpandingPoints(),cost:t})}return e.sort(((t,e)=>this.compareTilesToExpand(t,e)))}compareTilesToExpand(t,e){const i=t.cost-e.cost;if(0!==i)return i;const[s,n]=t.position,[o,r]=e.position,c=this.grid.getTileFood(s,n);return this.grid.getTileFood(o,r)-c}getExpandingPoints(){return((t,e)=>{const i=Math.ceil(t/2);return e>=i?e-i+1:0})(this.positions.length,this.city.population)}expand(){const{position:t}=this.tileToExpand;this.tileToExpand=null;const[e,i]=t;return this.addTile(e,i),$.bordersExpanded({city:this.city,position:t})}turn(){if(null===this.tileToExpand)return null;this.expandingProgress+=this.getExpandingPoints();const t=this.expandingProgress-this.tileToExpand.cost;return t>=0?(this.expandingProgress=t,this.expand()):null}place(){for(const[t,e]of this.positions)this.grid.addInfluence(t,e,this.city)}remove(){this.positions.forEach((([t,e])=>{this.grid.get(t,e).influencedBy=null}))}canExpandToPosition(t){const[e,i]=t;if(null!==this.grid.get(e,i).influencedBy)return!1;const[s,n]=this.grid.getNextLinePosition(t,this.city.position);if(!this.grid.influencedByCity(s,n,this.city))return!1;if(!Q.diagonal.some((({dx:t,dy:s})=>this.grid.influencedByCity(e+t,i+s,this.city))))return!1;if(!Q.axial.some((({dx:t,dy:s})=>this.grid.influencedByCity(e+t,i+s,this.city))))return!1;const[o,r]=this.city.position;return this.grid.getOctileDistance(e,i,o,r)<=7}getNextFrontierPositions(){const t=[];for(const[e,i]of this.positions)for(const{dx:s,dy:n}of Q.axial){const o=e+s,r=i+n,c=this.grid.getPosition(o,r),{influencedBy:l}=this.grid.get(o,r);null!==l||j(t,c)||t.push(c)}return t}swap(t,e){const i=this.grid.get(t,e).influencedBy,s=this.positions.findIndex((([i,s])=>t===i&&e===s));g(this.positions,s),this.positions=this.grid.sortPositions(this.city.position,this.positions),i.influence.addTile(t,e)}canSwap(t,e){return this._canSwap(t,e,new Map)}_canSwap(t,e,i){const s=Z(t,e);if(i.has(s))return i.get(s);const n=this.grid.get(t,e).influencedBy;if(null===n||n===this.city)return i.set(s,!1),!1;const[o,r]=this.city.position;if(this.grid.getOctileDistance(t,e,o,r)>7)return i.set(s,!1),!1;if(!n.assignments.hasFreeTiles())return i.set(s,!1),!1;const c=[!1,!1],l=[[],[]];for(const{dx:n,dy:o,isAxial:r}of Q.members){const a=t+n,h=e+o,{influencedBy:d}=this.grid.get(a,h),u=+r;if(d!==this.city){l[u].push([a,h]);continue}const p=+!r;if(c[u]=!0,c[p])return i.set(s,!0),!0}return c.every(((t,e)=>t||l[e].some((([t,e])=>this._canSwap(t,e,i)))))}addTile(t,e){this.grid.addInfluence(t,e,this.city);const{positions:i}=this;i.push([t,e]),this.positions=this.grid.sortPositions(this.city.position,i)}expandToTile(t,e){const i=[t,e];j(this.positions,i)||this.addTile(t,e)}get grid(){return this.city.grid}}class rt{static getDefaultPositions(t,e,i,s=1){const n=[];for(;s-- >0;){let s,o=0;for(let r=0;r<e.length;r++){const c=e[r];if(U(c,t)||n.some((t=>U(t,c))))continue;const[l,a]=c,h=i.getTileFood(l,a);h>o&&(o=h,s=c)}s&&n.push(s)}return n}recalculate(t=this.influence.city.population){this.positions=rt.getDefaultPositions(this.influence.city.position,this.influence.positions,this.grid,t)}constructor(t,e,i){this.grid=t,this.influence=e,this.positions=i}isPositionOccupied(t){return U(t,this.city.position)||j(this.positions,t)}isPositionFree(t){return!this.isPositionOccupied(t)}hasFreeTiles(){return this.influence.positions.some((t=>this.isPositionFree(t)))}getFreeTilesCount(){return p(this.influence.positions,(t=>this.isPositionFree(t)))}getFoodPerTurn(){const[t,e]=this.influence.city.position,i=this.grid.getTileFood(t,e);return this.positions.reduce(((t,e)=>{if(!this.influence.positions.some((t=>U(t,e))))return t;const[i,s]=e;return t+this.grid.getTileFood(i,s)}),i)}get city(){return this.influence.city}}const ct={population:1,expansionLevel:0};class lt{static found(t,e,i=0,s="",n={}){const o=Object.assign(Object.assign({},ct),n),r=ot.getStartInfluencePositions(e,t,o.expansionLevel+3),c=rt.getDefaultPositions(e,r,t,o.population);return new lt(t,{position:e,project:null,influencedPositions:r,assignmentsPositions:c,growthProgress:0,expandingProgress:0,name:s,id:i})}constructor(t,e){this.grid=t,this.position=e.position,this.name=e.name,this.id=e.id,this.growthProgress=e.growthProgress,this.project=e.project;const[i,s]=e.position;t.get(i,s).city=this,this.influence=new ot(this,e),this.assignments=new rt(t,this.influence,e.assignmentsPositions),this.assignments.getFreeTilesCount()>0?this.foodBasketSize=W(this.population):this.foodBasketSize=0}turn(t=i){const e=this.updateGrowthProgress(),s=this.updateProjectProgress(t);return null!==s&&e.push(s),e}updateGrowthProgress(){const t=[],e=this.assignments.getFreeTilesCount();if(0===e)return t;const i=W(this.population);this.growthProgress+=this.foodSurplus;let s=this.population;const n=this.influence.turn();null!==n&&t.push(n);const o=this.growthProgress-i;if(o>=0){e>1?(this.growthProgress=o,this.foodBasketSize=W(this.population+1)):(this.growthProgress=0,this.foodBasketSize=0),++s;const i=$.populationIncreased({city:this});t.push(i)}else this.growthProgress;return t.length>0&&this.assignments.recalculate(s),t}updateProjectProgress(t){const{project:e}=this;if(null===e)return null;const[i,s]=this.position,n=this.grid.getIndexByPosition(i,s),o=this.project.progress+1;if(!(o===this.project.type.cost))return this.project.progress=o,null;if(!!this.grid.tiles[n].unit)return null;const r=$.unitCompleted({unitTypeId:this.project.type.productId,cityPositionIndex:n});return this.project=null,t(r.payload),r}setProject(t){null!==t?null!==this.project&&t.productId===this.project.type.productId||(this.project={type:t,progress:0}):this.project=null}get foodSurplus(){return this.assignments.getFoodPerTurn()-2*this.population}get population(){return this.assignments.positions.length}get influencedPositions(){return this.influence.positions}get assignmentsPositions(){return this.assignments.positions}get expandingProgress(){return this.influence.expandingProgress}remove(){this.influence.remove()}}class at{constructor(t){this.influence=t,this.tilesToExpand=t.getTilesToExpand(),this.tilesToExpandLeft=t.getFreeTilesCount()}get tileToExpand(){return this.influence.tileToExpand}set tileToExpand(t){this.influence.tileToExpand=t}}const ht=(t,e)=>e.tileToExpand.turnsToExpand!==t.tileToExpand.turnsToExpand?e.tileToExpand.turnsToExpand<t.tileToExpand.turnsToExpand:e.tilesToExpandLeft<t.tilesToExpandLeft;class dt{constructor(t,e=[],s=0){this.grid=t,this.unitCreationHandler=i,this.cities=dt.createCities(t,e),this._nextCityId=s,this.updateTilesToExpand()}onUnitCreated(t){this.unitCreationHandler=t}updateTilesToExpand(){(t=>{const e=new Map;for(;t.length>0;){const i=t.shift();if(0===i.tilesToExpand.length)continue;const s=i.tilesToExpand.shift(),[n,o]=s.position,r=Z(n,o),c=e.get(r);i.tileToExpand=s,c?ht(c,i)?(c.tileToExpand=null,t.push(c),e.set(r,i)):(i.tileToExpand=null,t.push(i)):e.set(r,i)}})(this.cities.map((t=>(t.influence.tileToExpand=null,new at(t.influence)))))}turn(){const t=[];return this.cities.forEach((e=>{const i=e.turn(this.unitCreationHandler);t.push(...i)})),this.updateTilesToExpand(),t}addCity(t){this.cities.push(t),this.updateTilesToExpand(),++this._nextCityId}nextCityName(){return(t=>{const e=[];do{const i=t%26;t=Math.floor(t/26),e.push(String.fromCharCode(i+65))}while(t>0);return e.join("")})(this.nextCityId)}foundCity(t,e,i){if(!this.canPlaceCity(t,e))return null;const s=lt.found(this.grid,[t,e],this.nextCityId,this.nextCityName(),i);return this.addCity(s),s}canPlaceCity(t,e){return!!this.grid.get(t,e).terrain.dryLand&&this.cities.every((({position:[i,s]})=>this.grid.getOctileDistance(i,s,t,e)>=8))}captureRelativePosition(t,[e,i]){const[s,n]=t.position,[o,r]=this.grid.getPosition(s+e,n+i);this.captureTile(s,n,o,r)}captureTile(t,e,i,s){const{city:n}=this.grid.get(t,e);n.influence.expandToTile(i,s),this.updateTilesToExpand()}setProject(t,e){const{city:i}=this.grid.tiles[t];i.setProject(e)}get nextCityId(){return this._nextCityId}}function ut(t,e){var i={};for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&e.indexOf(s)<0&&(i[s]=t[s]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(s=Object.getOwnPropertySymbols(t);n<s.length;n++)e.indexOf(s[n])<0&&Object.prototype.propertyIsEnumerable.call(t,s[n])&&(i[s[n]]=t[s[n]])}return i}dt.createCities=(t,e)=>e.map((e=>new lt(t,e))).sort(((t,e)=>t.id-e.id));class pt{constructor(t,e){this.grid=t,this.path=[];const i=ut(e,["targetPosition"]);Object.assign(this,i);const[s,n]=e.position;t.get(s,n).unit=this}beforeTurn(){this.movePoints+=this.type.movePoints}cancelMove(){const t=this.grid.getPositionByIndex(u(this.path));return this.path=[],$.moveCanceled({from:this.position,to:t})}hasEnoughPointsToMove(){const t=this.grid.getPositionByIndex(this.path[0]);return this.getMoveCost(this.position,t)<=this.movePoints}getMoveCost(t,e){const[i,s]=this.grid.getOffsets(t,e);return Q.fromOffsets(i,s).isAxial?2:3}isNextTurnPathPassable(){let t=0,e=0,i=this.position;for(;t<this.path.length;){const s=this.path[t],n=this.grid.getPositionByIndex(s);if(e+=this.getMoveCost(i,n),e>this.movePoints)return!0;if(!this.grid.tiles[s].terrain.dryLand)return!1;++t,i=n}return!0}moveByPath(t=this.path){const e=[this.position];let i=0,s=0;for(;e.length-1<t.length;){const n=t[e.length-1],o=this.grid.getPositionByIndex(n),r=u(e),c=s+this.getMoveCost(r,o);if(c>this.movePoints){e.length>1&&this.grid.tiles[t[e.length-2]].unit&&(e.pop(),s=i);break}e.push(o),i=s,s=c}if(this.path=t.slice(e.length-1),1===e.length)return null;this.movePoints-=s;const[n,o]=this.position;this.position=u(e);const[r,c]=this.position;this.grid.get(r,c).unit=this;const l=this.grid.get(n,o);return l.unit===this&&(l.unit=null),e.length>0?$.unitMoved({path:e}):null}get targetPosition(){return this.path.length>0?u(this.path):null}}pt.DEFAULT_UNIT_TYPE=v[0],pt.getDefaultData=(t,e)=>({position:[t,e],type:pt.DEFAULT_UNIT_TYPE,movePoints:pt.DEFAULT_UNIT_TYPE.movePoints,targetPosition:null});const gt=(t,e,i)=>Math.floor(t+(e-t+1)*i),ft=(t,e)=>((t,e,i)=>t<e?e:t>i?i:t)(t,0,e),wt=2*Math.PI,yt=t=>{let e=t[0],i=0;for(let s=1;s<t.length;s++){const n=t[s];n.f<e.f&&(e=n,i=s)}return g(t,i),e},mt=t=>{const e=[];for(;t.previous;)e.unshift({position:t.position,positionIndex:t.positionIndex}),t=t.previous;return e};class xt{constructor(t,e=[]){this.grid=t,this.movements=new Map,this.units=[],this.isTilePassable=(t,e)=>this.grid.isTilePassable(t,e),this.createUnits(e)}createUnits(t){t.forEach((t=>{const e=this.addUnit(t);if(null!==t.targetPosition){const i=this.grid.getPositionByIndex(t.targetPosition);this.movements.set(e.targetPosition,e),e.path=this.findPath(e,i)}}))}findPath(t,e){return((t,e,i,s=n)=>{const[o,r]=e,[c,l]=i,a=t.getIndexByPosition(o,r),h=[{position:e,positionIndex:a,g:0,f:t.getOctileDistance(o,r,c,l),previous:null}],d=new Set([a]);for(;h.length>0;){const e=yt(h),[i,n]=e.position;if(i===c&&n===l)return mt(e);d.add(e.positionIndex);for(const{dx:o,dy:r,isAxial:a}of Q.members){const u=t.getPosition(i+o,n+r),[p,g]=u,f=t.getIndexByPosition(p,g);if(d.has(f))continue;if(!s(p,g))continue;const w=e.g+(a?2:3),y=t.getOctileDistance(p,g,c,l),m=w+y,x=h.find((t=>t.positionIndex===f));x?w<x.g&&(x.g=w,x.f=m,x.previous=e):h.push({previous:e,position:u,positionIndex:f,g:w,f:w+y})}}return[]})(this.grid,t.position,e,this.isTilePassable).map((t=>t.positionIndex))}turn(){const t=[];this.units.forEach((t=>{t.beforeTurn()}));const e=[];for(const i of this.units)if(null!==i.targetPosition){const[s,n]=i.position,o=this.grid.getIndexByPosition(s,n),r=this.move([o,...i.path]),c=r.map((({payload:{path:t}})=>{const[e,i]=u(t);return this.grid.get(e,i).unit}));e.push(...c),t.push(...r)}const i=[];return this.units.forEach((t=>{t.movePoints=ft(t.movePoints,t.type.movePoints),null===t.targetPosition||e.includes(t)||i.push(t.cancelMove())})),{moves:t,canceledMoved:i}}addUnit(t){const e=new pt(this.grid,t);return this.units.push(e),e}placeUnit(t,e,i={}){const s=this.grid.get(t,e);if(null!==s.unit||!s.terrain.dryLand)return null;const n=Object.assign(pt.getDefaultData(t,e),i);return this.addUnit(n)}moveUnit(t,e,i){const s=[e,i];if(U(t.position,s))return this.cancelMove(t),[];const n=this.findPath(t,s);if(0===n.length)return[];const[o,r]=t.position,c=this.grid.getIndexByPosition(o,r);return n.unshift(c),this.move(n)}move(t){const[e,...i]=t,s=i[0],{unit:n}=this.grid.tiles[e];if(this.movements.has(n.targetPosition)&&this.movements.delete(n.targetPosition),2===t.length){const t=this.movements.get(s);t&&1===t.path.length&&this.cancelMove(t)}const o=u(i);n.path=i,this.movements.set(o,n);const r=this.getMoveChain(n,!0);return r.isLoop||null===this.grid.tiles[o].unit?this.moveUnits(r.units):[]}removeUnit(t){const[e,i]=t.position,s=this.grid.getIndexByPosition(e,i);this.grid.tiles[s].unit=null,this.movements.delete(t.targetPosition),function(t,e){const i=t.indexOf(e);-1!==i&&g(t,i)}(this.units,t)}moveUnits(t){return t.map((t=>(this.movements.delete(t.targetPosition),t.moveByPath())))}cancelMove(t){const{units:e}=this.getMoveChain(t,!1);this.chancelUnitsMoves(e)}chancelUnitsMoves(t){t.forEach((t=>{null!==t.targetPosition&&(this.movements.delete(t.targetPosition),t.cancelMove())}))}getMoveChain(t,e){const i=[],s=[];for(;!c(null==t?void 0:t.targetPosition)&&(!e||t.hasEnoughPointsToMove()&&t.isNextTurnPathPassable());){const[e,n]=t.position,o=this.grid.getIndexByPosition(e,n);if(i.includes(o))return{units:s,isLoop:!0};s.push(t),i.push(o),t=this.movements.get(o)}return{units:s,isLoop:!1}}}class vt{static createEmptyWorldData(t,e){const i=((t,e)=>d(e*t,(()=>S())))(t,e);return this.fromMap(i,t)}static createEmptyWorld(t,e){const i=this.createEmptyWorldData(t,e);return vt.fromData(i)}static fromDryLandBitMap(t,e,i){const s=t.map((t=>S(t?y:x)));return this.fromData(this.fromMap(s,e,i))}static fromData(t){const e=H.createFromTilesData(t.tiles,t.width);return new vt(e,t)}constructor(t,e){this.grid=t,this.turnNumber=e.turnNumber,this.citiesService=new dt(t,e.cities,e.nextCityId),this.citiesService.onUnitCreated((t=>{this.unitCreationHandler(t)})),this.unitsService=new xt(t,e.units),this.mapSeed=e.mapSeed}unitCreationHandler({cityPositionIndex:t,unitTypeId:e}){const i=v[e-1],[s,n]=this.grid.getPositionByIndex(t);this.placeUnit(s,n,{type:i})}turn(){this.turnNumber===vt.MAX_TURN_NUMBER&&(console.warn("Max turns reached"),this.turnNumber=1);const t=this.citiesService.turn(),e=this.unitsService.turn();return++this.turnNumber,t.concat(e.moves,e.canceledMoved)}moveUnit(t,e,i){return this.unitsService.moveUnit(t,e,i)}placeTerrain(t,e,i){const s=this.grid.get(t,e);if(!((t,e)=>t.terrain!==e&&(e.dryLand||!t.city&&!t.unit))(s,i))return!1;s.terrain=i,this.mapSeed=null;const{influencedBy:n}=s;return n&&n.assignments.recalculate(),Q.axial.some((({dx:i,dy:s})=>this.grid.get(t+i,e+s).influencedBy))&&this.citiesService.updateTilesToExpand(),!0}placeUnit(t,e,i={}){return this.unitsService.placeUnit(t,e,i)}removeUnit(t){this.unitsService.removeUnit(t)}foundCity(t,e,i){return this.citiesService.foundCity(t,e,i)}captureTile(t,e,i,s){this.citiesService.captureTile(t,e,i,s)}setCityProject(t,e){const i=null!==e?P.find((t=>t.productId===e)):null;this.citiesService.setProject(t,i)}get cities(){return this.citiesService.cities}get units(){return this.unitsService.units}get nextCityId(){return this.citiesService.nextCityId}get tiles(){return this.grid.tiles}get width(){return this.grid.width}get height(){return this.grid.height}}vt.MAX_TURN_NUMBER=Math.pow(2,16),vt.fromMap=(t,e,i=null)=>({tiles:t,width:e,height:t.length/e,cities:[],units:[],turnNumber:1,nextCityId:0,mapSeed:i});class Pt{constructor(t,e){this.view=t,this.context=e}drawSprite(e,i,s){const{tileSize:n}=this.view,o=t.width/n,[r,c]=E(e,o),l=r*n,a=c*n;this.context.drawImage(t,l,a,n,n,i,s,n,n)}clearTile(t,e){const[i,s]=this.view.toCanvasPosition(t,e),{tileSize:n}=this.view;this.context.clearRect(i,s,n,n)}clear(){this.context.clearRect(0,0,this.view.width,this.view.height)}moveViewport(t,e){const{context:i}=this,{width:s,height:n,tileSize:o}=this.view;if(0!==t){const e=t*o,r=t>0?e:s+e,c=i.getImageData(0,0,r,n),l=i.getImageData(r,0,s-r,n);i.putImageData(c,s-r,0),i.putImageData(l,0,0)}if(0!==e){const t=e*o,r=e>0?t:n+t,c=i.getImageData(0,0,s,r),l=i.getImageData(0,r,s,n-r);i.putImageData(c,0,n-r),i.putImageData(l,0,0)}}}const Tt={grassland:"#388E3C",steppe:"#88C34A",sea:"#0090c4"};class St extends Pt{drawGrid(){this.context.fillStyle=St.GRID_COLOR;const{tileSize:t}=this.view,{width:e,height:i}=this.context.canvas;for(let s=t;s<e;s+=this.view.tileSize)this.context.fillRect(s,0,1,i);for(let s=t;s<i;s+=this.view.tileSize)this.context.fillRect(0,s,e,1)}moveViewport(){}}St.GRID_COLOR="#555";const Ct=(t,e)=>function(t,e,i){const s=Math.floor(i/2),n=t-s,o=[];let r=t;for(let c=e-s;c<e;c++){const s=Math.abs(c-e);let l=!0;for(let a=n;a<t;a++){const n=r,h=Math.abs(a-t),d=O(h,s);if(d!==i&&d!==i-1)continue;let u;a<n?(u=l?[!0,!1,!1,!0]:[!0,!1,!1,!1],r=a):u=a===n?[!1,!1,!1,!0]:[!0,!1,!1,!1],l=!1;const p={position:[a,c],borders:u},g=z(p,t),f=F(g,e),w=z(f,t);o.push(p,g,f,w),l=!1}}const c={position:[t,e-s],borders:i%2==0?[!0,!0,!1,!0]:[!0,!1,!1,!1]},l={position:[t-s,e],borders:i%2==0?[!0,!1,!0,!0]:[!1,!1,!1,!0]},a=F(c,e),h=z(l,t);return o.push(c,l,a,h),o}(t,e,7);class bt extends Pt{constructor(t,e,i){super(t,e),this.bordersRenderer=i,this.context.fillStyle=bt.BORDERS_COLOR}drawTileBorders(t,e,i){this.bordersRenderer(this.context,t,e,i)}}bt.BORDERS_COLOR="#000";var It={terrain:class extends Pt{drawTerrain(t,e,i){this.context.fillStyle=Tt[i];const{tileSize:s}=this.view;this.context.fillRect(t,e,s,s)}},grid:St,borders:bt,objects:class extends Pt{drawUnit(t,e,i){this.drawSprite(i-1,t,e)}drawHouse(t,e){this.drawSprite(4,t,e)}drawCityWithGarrison(t,e){this.drawSprite(5,t,e)}},selection:class extends Pt{constructor(t,e,i){super(t,e),this.borderRenderer=i}drawMaxCityBorders([t,e]){this.context.fillStyle="#333";Ct(t,e).forEach((t=>{const[e,i]=this.view.toCanvasPosition(...t.position);this.borderRenderer(this.context,e,i,t.borders)}))}clearMaxCityMaxBorders([t,e]){Ct(t,e).forEach((({position:[t,e]})=>{this.clearTile(t,e)}))}drawCitizenDistribution(t){for(const[e,i]of t.assignmentsPositions)this.drawCitizen(e,i)}clearCitizenDistribution(t){for(const[e,i]of t.influencedPositions)this.clearTile(e,i)}drawCitizen(t,e){const[i,s]=this.view.toCanvasPosition(t,e);this.drawSprite(3,i,s)}drawPath(t){this.context.fillStyle="#5af";for(let e=0;e<t.length;e++){const i=t[e],[s,n]=this.view.grid.getPositionByIndex(i),[o,r]=this.view.toCanvasPosition(s,n);this.drawPathNode(o,r)}}drawPathNode(t,e){const i=this.view.tileSize/2,s=t+i,n=e+i;this.context.beginPath(),this.context.arc(s,n,4,0,2*Math.PI,!1),this.context.closePath(),this.context.fill()}drawUnitSelection(t,e,i){i.length>0&&this.drawPath(i);const[s,n]=this.view.toCanvasPosition(t,e);this.context.strokeStyle="#000",this.context.beginPath(),this.context.rect(s+2,n+2,this.view.tileSize-3,this.view.tileSize-3),this.context.closePath(),this.context.stroke()}clearPath(t){t.forEach((t=>{const[e,i]=this.view.grid.getPositionByIndex(t);this.clearTile(e,i)}))}clearUnitSelection(t,e,i){super.clearTile(t,e),this.clearPath(i)}drawCitySelection(t){this.drawCitizenDistribution(t),this.drawMaxCityBorders(t.position)}clearCitySelection(t){this.clearMaxCityMaxBorders(t.position),this.clearCitizenDistribution(t)}}};function Et(t,e){Object.keys(t).forEach((i=>{e(t[i],i)}))}const Mt=t=>t.charAt(0).toUpperCase()+t.slice(1);class At{static getLayerId(t){return At.LAYER_ID_PREFIX+t}constructor(t,e,i=At.DEFAULT_TILE_SIZE){this.world=t,this.selectionHandlers=e,this.tileSize=i,this.selectedUnit=null,this.selectedCity=null,this.viewportPosition=[0,0],this.selectors=[({unit:t})=>this.selectUnit(t),({city:t})=>this.selectCity(t),()=>this.clearSelection()],this.eventHandlers={onPopulationIncreased:({city:t})=>{var e;(null===(e=this.selectedCity)||void 0===e?void 0:e.id)===t.id&&this.layers.selection.drawCitizenDistribution(t)},onBordersExpanded:({city:t,position:e})=>{var i;const[s,n]=e;this.drawCapturedTileBorders(s,n),(null===(i=this.selectedCity)||void 0===i?void 0:i.id)===t.id&&this.refreshCitySelection()},onUnitMoved:({path:t})=>{const[e,i]=t[0],[s,n]=u(t),{unit:o}=this.grid.get(s,n),r=this.grid.get(e,i);null===r.unit&&null===r.city?this.layers.objects.clearTile(e,i):this.drawObject(e,i),this.drawObject(s,n),this.selectedUnit===o&&(this.layers.selection.clear(),this.layers.selection.drawUnitSelection(s,n,o.path))},onMoveCanceled:({from:[t,e]})=>{const{unit:i}=this.grid.get(t,e);this.selectedUnit===i&&(this.layers.selection.clear(),this.layers.selection.drawUnitSelection(t,e,i.path))},onUnitCompleted:({cityPositionIndex:t})=>{const[e,i]=this.grid.getPositionByIndex(t);this.drawObject(e,i)}},this.bordersRender=function(t){const e=(t=>[[0,0,t,1],[t-1,0,1,t],[0,t-1,t,1],[0,0,1,t]])(t);return(t,i,s,n)=>{e.filter(((t,e)=>n[e])).forEach((([e,n,o,r])=>{t.fillRect(i+e,n+s,o,r)}))}}(i)}get grid(){return this.world.grid}get width(){return this.world.width*this.tileSize}get height(){return this.world.height*this.tileSize}handleEvent(t){this.eventHandlers[`on${Mt(t.type)}`](t.payload)}createLayer(t){const e=h("canvas",{id:At.getLayerId(t),width:this.width,height:this.height});return this.layersContainer.appendChild(e),e.getContext("2d",{willReadFrequently:!0})}createLayers(){this.layers={};for(const[t,e]of Object.entries(It)){const i=this.createLayer(t);this.layers[t]=new e(this,i,this.bordersRender)}this.layers.grid.drawGrid()}mount(t){this.layersContainer=h("div",{id:"layers",style:{width:this.width+"px",height:this.height+"px"}}),this.createLayers(),t.appendChild(this.layersContainer)}canCapture(t,e){return this.selectedCity.influence.canExpandToPosition([t,e])}drawCapturedTileBorders(t,e){this.drawBorders(t,e);for(const{dx:i,dy:s}of Q.axial){const n=t+i,o=e+s;this.grid.get(n,o).influencedBy&&this.drawBorders(t+i,e+s)}}captureTile(t,e){const[i,s]=this.selectedCity.position;this.world.captureTile(i,s,t,e),this.drawCapturedTileBorders(t,e)}selectCity(t){const e=!!t;return e&&(this.clearSelection(),this.selectedCity=t,this.drawCitySelection(),this.selectionHandlers.onCitySelected(t)),e}selectUnit(t){const e=!!t;if(e){this.clearSelection(),this.selectedUnit=t;const[e,i]=t.position;this.layers.selection.drawUnitSelection(e,i,t.path)}return e}select(t,e=!0){for(let i=e?0:1;i<this.selectors.length;i++){if((0,this.selectors[i])(t))break}}onTileClick(t,e){if(this.selectedCity&&this.canCapture(t,e))return void this.captureTile(t,e);const i=this.selectedUnit||this.selectedCity,s=!U(null==i?void 0:i.position,[t,e]),n=this.grid.get(t,e);this.select(n,s)}drawCitySelection(){this.layers.selection.drawCitySelection(this.selectedCity);for(const[t,e]of this.selectedCity.assignmentsPositions){const{unit:i}=this.grid.get(t,e);i&&this.layers.objects.clearTile(t,e)}}clearSelection(){this.unselectUnit(),this.unselectCity()}refreshCitySelection(){this.clearCitySelection(),this.drawCitySelection()}unselectCity(){null!==this.selectedCity&&(this.clearCitySelection(),this.selectedCity=null)}clearCitySelection(){this.selectionHandlers.onClearSelection(),this.layers.selection.clearCitySelection(this.selectedCity);for(const[t,e]of this.selectedCity.assignmentsPositions){const{unit:i}=this.grid.get(t,e);if(i){const[s,n]=this.toCanvasPosition(t,e);this.layers.objects.drawUnit(s,n,i.type.id)}}}unselectUnit(){this.selectedUnit&&(this.clearUnitSelection(),this.selectedUnit=null)}clearUnitSelection(){this.selectionHandlers.onClearSelection();const[t,e]=this.selectedUnit.position;this.layers.selection.clearUnitSelection(t,e,this.selectedUnit.path),this.selectedUnit=null}changeCityProject(t){const[e,i]=this.selectedCity.position,s=this.grid.getIndexByPosition(e,i);this.world.setCityProject(s,t)}moveUnit(t,e){const i=this.selectedUnit,s=this.world.grid.get(t,e).unit;if(s&&s!==i&&!this.grid.isAdjacentPositions(i.position,[t,e]))return;const n=this.world.moveUnit(i,t,e);if(n.forEach((t=>{this.handleEvent(t)})),0===n.length){const t=s||i;this.layers.selection.clear(),this.selectUnit(t)}}draw(){for(let t=0;t<this.grid.tiles.length;t++){const[e,i]=this.grid.getPositionByIndex(t);this.drawTile(e,i)}}toCanvasPosition(t,e){const[i,s]=this.viewportPosition,[n,o]=this.grid.getPosition(t-i,e-s);return[n*this.tileSize,o*this.tileSize]}moveViewport(t,e){const[i,s]=this.viewportPosition;this.viewportPosition=this.grid.getPosition(i+t,s+e),Et(this.layers,(i=>{i.moveViewport(t,e)}))}removeSelectedUnit(){if(this.selectedUnit){const[t,e]=this.selectedUnit.position;this.world.removeUnit(this.selectedUnit),this.drawObject(t,e),this.clearUnitSelection()}}placeTerrain(t,e,i){const s=this.world.placeTerrain(t,e,w[i-1]);return s&&this.drawTile(t,e),s}drawBorders(t,e){this.layers.borders.clearTile(t,e);const i=Q.axial.map((({dx:i,dy:s})=>!this.grid.get(t+i,e+s).influencedBy)),[s,n]=this.toCanvasPosition(t,e);this.layers.borders.drawTileBorders(s,n,i)}drawObject(t,e){const[i,s]=this.toCanvasPosition(t,e),{unit:n,city:o}=this.grid.get(t,e);this.layers.objects.clearTile(t,e),n&&o?this.layers.objects.drawCityWithGarrison(i,s):n?this.layers.objects.drawUnit(i,s,n.type.id):o&&this.layers.objects.drawHouse(i,s)}drawTile(t,e){const i=this.toCanvasPosition(t,e),s=this.grid.get(t,e),[n,o]=i;this.layers.terrain.drawTerrain(n,o,s.terrain.name),(s.city||s.unit)&&this.drawObject(t,e),s.influencedBy&&this.drawBorders(t,e)}skipTurnsUntilEvent(t=1e3){let e=t;for(let i=1;i<=t;i++){const t=this.world.turn();if(t.length>0){t.forEach((t=>{this.handleEvent(t)})),e=i;break}}return e}update(t){this.world=t,this.viewportPosition=[0,0],this.layersContainer.innerHTML="",Object.assign(this.layersContainer.style,{width:this.width+"px",height:this.height+"px"}),this.createLayers(),this.draw()}setGridShown(t){document.getElementById("layer-grid").style.display=t?"block":"none"}turn(){const t=this.world.turn();return t.forEach((t=>{this.handleEvent(t)})),t}placeUnit(t,e,i){this.world.placeUnit(t,e,{type:v[i-1]}),this.drawObject(t,e)}placeCity(t,e,i){if(this.world.foundCity(t,e,i)){this.drawObject(t,e);for(const{dx:i,dy:s}of Q.members)this.drawCapturedTileBorders(t+i,e+s)}}getViewportPosition(){return this.viewportPosition}}At.DEFAULT_TILE_SIZE=32,At.LAYER_ID_PREFIX="layer-";let Ot=0;const Bt=()=>"checkbox-"+Ot++;class Ut extends e{constructor(t){const{checked:e=!1,id:i=Bt()}=t;super(Object.assign(Object.assign({},t),{checked:e,id:i}))}render(){return h("div",{className:"labeled-checkbox"},[this.checkBox=h("input",{type:"checkbox",id:this.props.id,checked:this.props.checked,onchange:t=>{const e=t.target;this.props.checked=e.checked,this.props.onChange(e.checked)}}),h("label",this.props.label,{htmlFor:this.props.id})])}get selected(){return this.props.checked}set selected(t){this.props.checked=t,this.checkBox.checked=t}}class jt extends e{constructor(){super(...arguments),this.components=[]}onToolSelected(t){for(const e of this.components)e.selected=e===t}clearToolSelection(){this.props.onChange(null);for(const t of this.components)t.selected=!1}render(){return h("div",{className:"controls-group"},this.props.tools.map((t=>{const e=t.createComponent({onSelect:t=>{this.props.onChange(t),this.onToolSelected(e)},onUnselect:()=>{this.props.onChange(null)}});return this.components.push(e),e.render()})))}}class kt extends e{render(){return this.element=h("select",{disabled:this.props.disabled,onchange:()=>{const t=this.props.items[this.element.selectedIndex];this.props.onChange(t)}},this.props.items.map((t=>h("option",t.name,{value:t.id.toString()}))))}set selectedItemId(t){this.element.selectedIndex=this.props.items.findIndex((e=>e.id===t))}set disabled(t){this.props.disabled=t,this.element.disabled=t}}class Dt extends e{render(){return this.dropdown=new kt({disabled:!0,items:[{id:0,name:"-"}].concat(P.map(((t,e)=>({id:t.productId,name:`${v[e].name} (${t.cost})`})))),onChange:this.props.onChange}),h("div",{className:"controls-group labeled"},[h("span","City Project:",{className:"label"}),this.dropdown.render()])}set projectId(t){this.dropdown.disabled=!1,this.dropdown.selectedItemId=t}disable(){this.dropdown.selectedItemId=0,this.dropdown.disabled=!0}}class Nt extends e{constructor(){super(...arguments),this.skipSilentTurns=!1,this.skipSilentTurnsCheckBox=new Ut({label:"Skip Silent Turns",onChange:t=>{this.skipSilentTurns=t}})}render(){return h("div",{className:"controls-group"},[h("button","Turn",{onclick:()=>{this.props.onTurn(this.skipSilentTurns)}}),this.skipSilentTurnsCheckBox.render()])}}class Lt extends e{render(){return this.showGridComponent=new Ut({label:"Grid",checked:this.props.gridShown,onChange:this.props.onToggleGrid}),this.toolsPanel=new jt({tools:this.props.tools,onChange:t=>{this.props.onToolSelected(t)}}),this.projectSelector=new Dt({onChange:this.props.onCityProjectChanged}),this.nextTurn=new Nt({onTurn:t=>{t?this.props.onSkipTurns():this.props.onTurn()}}),h("div",{className:"bottom-panel"},[h("div",{className:"controls-panel"},[this.showGridComponent.render(),this.nextTurn.render(),this.toolsPanel.render(),this.projectSelector.render()]),this.infoSpan=h("span","-")])}clearToolSelection(){this.toolsPanel.clearToolSelection()}set info(t){this.infoSpan.innerHTML=t||"-"}set cityProject(t){this.projectSelector.projectId=t}unselectCity(){this.projectSelector.disable()}}const Rt=new TextEncoder,Ft=new TextDecoder("utf-8"),zt=(t,e)=>{if(!t)throw new Error("Serialized string must not be empty");const i=Math.pow(2,e),s=(t=>Rt.encode(t))(t);if(s.length>i)throw new Error(`Max string size exceeded. ${s.length} > ${i}`);return X(s.length-1,e).concat((t=>K(t,8))(s))},_t=(t,e)=>{const i=tt(t,e)+1;return(t=>{const{buffer:e}=new Uint8Array(t);return Ft.decode(e)})(nt(t,i))},Ht=(t,e=0)=>{const i=Math.pow(2,t)+e-1;return{read:i=>tt(i,t)+e,write:s=>{if(s>i)throw new Error("Overflow error");return X(s-e,t)}}},Wt=(t,e)=>({name:t,read:i=>({[t]:e.read(i)}),write:t=>e.write(t)}),Gt=()=>({context:{},data:{}});function Qt(t,e,i=Gt()){const s=Object.assign(Object.assign({},Gt()),i),{data:n}=s;for(const i of e){const e=i.read(t,s);"object"==typeof e&&Object.assign(n,e)}return n}function $t(t,e,i={}){const s=[],n={data:t,context:i};for(const i of e){const e=t[i.name],o=i.write(e,n);for(const t of o)s.push(t)}return s}const Vt=(qt=7,{read:t=>_t(t,qt),write:t=>zt(t,qt)});var qt;const Jt=Ht(7),Xt=Ht(3,3),Yt=Ht(3),Kt=(t,e)=>t===e?0:st(W(t)),Zt=[{name:"id",read:(t,{context:e})=>({id:tt(t,e.cityIdSize)}),write:(t,{context:e})=>X(t,e.cityIdSize)},Wt("name",Vt),{write:(t,{data:e,context:i})=>$t(function(t,e){const i=A(t.position,t.influencedPositions,e.width,e.height),[s,n,o,r]=function(t){const[e,i]=t[0];let s=e,n=i,o=e,r=i;for(const[e,i]of t)e<s&&(s=e),i<n&&(n=i),e>o&&(o=e),i>r&&(r=i);return[s,n,o,r]}(i),c=o-s+1,l=r-n+1,a=C(Math.abs(s),Math.abs(n),c),h=i.map((([t,e])=>C(t-s,e-n,c))),d=c*l,u=[],p=[];for(let e=0;e<d;e++){const i=h.indexOf(e),s=i>=0;if(u.push(s),s){const e=t.influencedPositions[i],s=j(t.assignmentsPositions,e);p.push(s)}}return{width:c,height:l,cityIndex:a,influence:u,assignments:p,influenceSize:t.influencedPositions.length}}(e,i.worldSize),te),read:(t,{context:e})=>function(t,e,i){const s=[],{width:n,height:o}=t,r=n*o,[c,l]=E(t.cityIndex,n),[a,h]=[e[0]-c,e[1]-l];for(let e=0;e<r;e++)if(t.influence[e]){const[t,o]=E(e,n),[r,c]=I(t+a,o+h,i.width,i.height);s.push([r,c])}const d=[];for(let e=0;e<t.assignments.length;e++)t.assignments[e]&&d.push(s[e]);return{position:e,influencedPositions:s,assignmentsPositions:d}}(Qt(t,te),e.position,e.worldSize)},{name:"project",read:t=>{const e=Yt.read(t);if(0===e)return{project:null};const i=P[e-1];return{project:{type:i,progress:tt(t,st(i.cost))}}},write:t=>{if(null===t)return d(3,o);const e=st(t.type.cost);return Yt.write(t.type.productId).concat(X(t.progress,e))}},{name:"growthProgress",write(t,{data:e}){const i=Kt(e.assignmentsPositions.length,e.influencedPositions.length);return X(t,i)},read:(t,{data:e})=>({growthProgress:tt(t,Kt(e.assignmentsPositions.length,e.influencedPositions.length))})},Wt("expandingProgress",Jt)],te=[Wt("width",Xt),Wt("height",Xt),{name:"cityIndex",write:(t,{data:e})=>X(t,st(e.width*e.height)),read:(t,{data:e})=>({cityIndex:tt(t,st(e.width*e.height))})},{name:"influence",read(t,{data:e,context:i}){const{booleans:s,count:n}=function(t,e){const i=function(t,e,i,s){const n=[];for(const o of t)if(s(o,i),n.push(o),n.length===e)return{booleans:n,stats:i};return{booleans:n,stats:i}}(t,e,{truesCount:0},et);return{booleans:i.booleans,count:i.stats.truesCount}}(t,e.width*e.height);return i.influenceSize=n,{influence:s}},write:t=>t},{name:"assignments",read:(t,{context:e})=>({assignments:it(t,e.influenceSize)}),write:t=>t}];function ee(t,e,i,s){return Qt(t,Zt,{context:{cityIdSize:s,position:e,worldSize:i}})}const ie=Ht(3),se=Ht(4),ne=[{name:"type",read:t=>{const e=ie.read(t);return{type:v[e]}},write:t=>ie.write(t.id-1)},Wt("movePoints",se),{name:"targetPosition",read(t,{context:{targetIndexSize:e,positionIndex:i,worldWidth:s}}){const n=tt(t,e);return{targetPosition:n!==i?n:null,position:E(i,s)}},write(t,{data:e,context:{targetIndexSize:i,worldWidth:s}}){const n=((t,e,i)=>{if(null===t){const[t,s]=e;return C(t,s,i)}return t})(t,e.position,s);return X(n,i)}}];function oe(t,e=null){const{width:i,height:s}=t,n={worldWidth:i,targetIndexSize:re(i,s)};if(null!==e){const[t,s]=e;n.positionIndex=C(t,s,i)}return n}function re(t,e){return st(t*e)}function ce(t,e,i){const s=oe(i,e);return Qt(t,ne,{context:s})}var le;class ae{constructor(t=le.getDefaultSeed()){this.seed=t}next(){return this.seed=(1664525*this.seed+1013904223)%le.PERIOD,this.seed/le.PERIOD}nextFloat(t,e){return t+(e-t)*this.next()}nextInt(t,e){if(1===arguments.length)return this.nextInt(0,t);const i=this.next();return gt(t,e,i)}nextBoolean(t=.5){return this.next()<t}}le=ae,ae.getDefaultSeed=()=>{return t=0,e=le.PERIOD,gt(t,e,Math.random());var t,e},ae.PERIOD=Math.pow(2,32);const he=([t,e],[i,s])=>t*i+e*s,de=(t,e,i)=>{return t+(s=i,(6*Math.pow(s,2)-15*s+10)*Math.pow(s,3)*(e-t));var s},ue=t=>((t,e)=>[t*Math.cos(e),t*Math.sin(e)])(1,t),pe=(t,e,i,s)=>{const n=Math.ceil(t/i)+1,o=Math.ceil(e/i)+1,r=new ae(s),c=d(n*o,(()=>{const t=r.nextFloat(0,wt);return ue(t)})),l=(t,e)=>{const i=C(t,e,n);return c[i]};return(t,e)=>.5+.5*((t,e,i)=>{const s=Math.floor(t),n=Math.floor(e),o=t-s,r=e-n,c=he([o,r],i(s,n)),l=he([o-1,r],i(s+1,n)),a=he([o-1,r-1],i(s+1,n+1)),h=he([o,r-1],i(s,n+1)),d=de(c,l,o),u=de(h,a,o);return de(d,u,r)})(t/i,e/i,l)},ge=(t,e,i,s)=>{const n=t.map(o),r=new _(e,t.length/e),c=[i],l=[s],a=new Set([i,s]);for(;c.length>0||l.length>0;){if(c.length>0){const e=we(c,t),[i,s]=r.getPositionByIndex(e);for(const{dx:t,dy:e}of Q.axial){const[n,o]=r.getPosition(i+t,s+e),l=r.getIndexByPosition(n,o);a.has(l)||(c.push(l),a.add(l))}}if(l.length>0){const e=fe(l,t),[i,s]=r.getPositionByIndex(e);n[e]=!0;for(const{dx:t,dy:e}of Q.axial){const[n,o]=r.getPosition(i+t,s+e),c=r.getIndexByPosition(n,o);a.has(c)||(l.push(c),a.add(c))}}}return n},fe=(t,e)=>{let i=t[0],s=0;for(let n=1;n<t.length;n++)e[t[n]]>e[i]&&(i=t[n],s=n);return g(t,s),i},we=(t,e)=>{let i=t[0],s=0;for(let n=1;n<t.length;n++)e[t[n]]<e[i]&&(i=t[n],s=n);return g(t,s),i},ye=Math.pow(2,32)-1,me=new RegExp("^[\\da-f]{8}$","i"),xe=t=>(t=>me.test(t))(t)?parseInt(t,16):null,ve=t=>((t,e)=>{const i=t.toString(16),s=e-i.length;return"0".repeat(s)+i})(t,8),Pe=st(252),Te=3,Se=st(vt.MAX_TURN_NUMBER-1),Ce=st(ye);function be(t,e,i,s){const[n,o]=t;return{city:n?ee(t,e,i,s.cityIdSize):null,unit:o?ce(t,e,i):null,terrain:w[tt(t,Te)]}}function Ie(t,e,i){const s=X(t.terrain.id-1,Te),{city:n,unit:o}=t,r=[!!n,!!o];return n&&r.push(...function(t,e,i){return $t(t,Zt,{worldSize:e,cityIdSize:i})}(n,e,i)),o&&r.push(...function(t,e){const i=oe(e);return $t(t,ne,i)}(o,e)),r.concat(s)}const Ee=Ht(Pe,13),Me=Ht(Se,1),Ae=[Wt("width",Ee),Wt("height",Ee),Wt("turnNumber",Me),{name:"mapSeed",write:t=>null===t?[!1]:[!0,...X(t,Ce)],read(t){const[e]=t;return{mapSeed:e?tt(t,Ce):null}}},{name:"nextCityId",write:(t,{context:e})=>(e.cityIdSize=(t=>t>0?st(t-1):0)(t),X(e.cityIdSize,5)),read(t,{context:e}){e.cityIdSize=tt(t,5)}},{name:"tiles",write:(t,{data:e,context:i})=>function(t,e,i){const s=[];return t.forEach((t=>{s.push(...Ie(t,e,i.cityIdSize))})),s}(t,e,i),read:(t,{context:e,data:i})=>function(t,e,i){const s=[],n=[],o=[];for(let r=0;r<e.height;r++)for(let c=0;c<e.width;c++){const l=be(t,[c,r],e,i),{city:a,unit:h}=l;a&&(s.push(a),a.id>=e.nextCityId&&(e.nextCityId=a.id+1)),h&&o.push(h),n.push(l)}return{tiles:n,cities:s,units:o}}(t,i,e)}];function Oe(t){const e=(t=>V(t,Y))(t);return Qt(e,Ae,{data:{nextCityId:0}})}function Be(t,e){const i=t.toString();if(i.length>=e)return i;const s=e-i.length;return"0".repeat(s)+i}const Ue=t=>Be(t,2),je=t=>Be(t.getMilliseconds(),3),ke=t=>`${((t,e="-")=>[t.getFullYear(),Ue(t.getMonth()+1),Ue(t.getDate())].join(e))(t)} ${((t,e=".")=>[Ue(t.getHours()),Ue(t.getMinutes()),Ue(t.getSeconds())].join(e))(t)}.${je(t)}`,De=/^\s*([1-9]\d*)[^\d]+([1-9]\d*)\s*$/,Ne=["width","height"],Le=(t,e,i,s)=>{const n=(t=>{const e=De.exec(t);return e?[+e[1],+e[2]]:null})(t);if(null===n)return s(`Invalid world size: '${t}'`),null;const o=((t,e,i)=>{const s=[];return t.forEach(((t,n)=>{if(t<e){const t=Ne[n];s.push(`World ${t} must be equal or greater than ${e}`)}else if(t>i){const t=Ne[n];s.push(`World ${t} must be equal or less than ${i}`)}})),s})(n,e,i);return o.length>0?(s(o.join("\n")),null):n};class Re extends e{render(){return this.dropdown=new kt({items:this.props.items,disabled:!this.props.selected,onChange:this.props.onItemSelected}),h("div",{className:"toggled-dropdown"},[this.checkbox=h("input",{type:"checkbox",onchange:()=>{this.props.onToggle(this.checkbox.checked),this.selected=this.checkbox.checked}}),this.dropdown.render()])}get selected(){return this.props.selected}set selected(t){this.props.selected=t,this.checkbox.checked=t,this.dropdown.disabled=!t}}const Fe=(t,e)=>({id:t,createComponent:({onSelect:i,onUnselect:s})=>{let n=e[0].id;return new Re({items:e,selected:!1,onToggle:e=>{e?i({id:t,option:n}):s()},onItemSelected:e=>{n=e.id,i({id:t,option:n})}})}}),ze=[Fe("placeTerrain",w),Fe("placeUnit",v),((t,e)=>({id:t,createComponent:({onSelect:i,onUnselect:s})=>new Ut({label:e,onChange:e=>{e?i({id:t,option:null}):s()}})}))("placeCity","City")],_e=t=>{const{offsetX:e,offsetY:i}=t,{clientWidth:s,clientHeight:n}=t.target,o=n-1;return[ft(e,s-1),ft(i,o)]},He=(t,e)=>{((t,e)=>{Et(e,((e,i)=>{((t,e,i)=>{t.addEventListener(e,(t=>{t.preventDefault(),i(t)}))})(t,i,e)}))})(e,{contextmenu:i,mouseup:e=>{const i=_e(e);0===e.button?e.ctrlKey?t.onCtrlClick(i):t.onLeftClick(i):t.onRightClick(i)},mousemove:e=>{const i=_e(e);t.onMove(i)},mouseleave:()=>{t.onLeave()}})},We=(t,e)=>{const{onLeave:i,onMove:s}=t,n=function(t,e){const i={};return Et(t,((t,s)=>{const n=e(t,s);i[s]=n})),i}(ut(t,["onLeave","onMove"]),(t=>((t,e)=>i=>{t(e(i))})(t,e)));return Object.assign(Object.assign({},n),((t,e)=>{let i=null;return{onMove:s=>{const n=e(s);U(n,i)||(t.onMove(n),i=n)},onLeave:()=>{t.onLeave(),i=null}}})({onMove:s,onLeave:i},e))},Ge=t=>e=>((t,e)=>{const i=[];for(const s of e){const e=s.label||s.field,n=s.get?s.get(t):t[s.field];if(!c(n)){const t=`${e}: ${n}`;i.push(t)}}return i.join("; ")})(e,t),Qe="-",$e=Ge([{field:"id"},{field:"name"},{field:"population"},{label:"project",get:t=>{return null!==t.project?`${i=t.project.type.productId,v[i-1].name} (${e=t.project,e.progress+"/"+e.type.cost})`:Qe;var e,i}},{label:"grow progress",get:t=>t.foodBasketSize>0?t.growthProgress+"/"+t.foodBasketSize:Qe},{label:"food surplus",field:"foodSurplus"},{label:"free tiles",get:t=>t.assignments.getFreeTilesCount()},{label:"expanding progress",get:t=>{const{tileToExpand:e}=t.influence;return e?t.influence.expandingProgress+"/"+e.cost:Qe}},{label:"growth to",get:t=>{const{tileToExpand:e}=t.influence;return e?e.position.join(", "):Qe}}]),Ve=Ge([{label:"move points",field:"movePoints"}]),qe={ArrowLeft:Q.WEST.offset,ArrowUp:Q.NORTH.offset,ArrowRight:Q.EAST.offset,ArrowDown:Q.SOUTH.offset};class Je extends e{render(){return h("span",{className:"field"},[h("span",`${this.props.label}: `,{className:"label"}),this.valueSpan=h("span",this.props.value,{className:"value"})])}set value(t){this.props.value=t,this.valueSpan.innerText=t}}class Xe extends e{constructor(t){super(t),this.fileReader=new FileReader,this.loadFile=()=>{this.fileInput.click()},this.fileReader.addEventListener("loadend",(t=>{const e=new Uint8Array(t.target.result);this.props.onLoad(e)}))}render(){return h("div",[h("button","Save",{onclick:this.props.onSave}),h("button","Load",{onclick:this.loadFile}),this.fileInput=h("input",{type:"file",onchange:t=>{const e=t.target;this.fileReader.readAsArrayBuffer(e.files[0]),e.value=null},style:{display:"none"}})])}}class Ye extends e{render(){return this.turnField=new Je({label:"Turn",value:String(this.props.turn)}),this.mapSeedField=new Je({label:"Map Seed",value:null===this.props.mapSeed?"-":String(this.props.mapSeed)}),this.saveLoadComponent=new Xe({onSave:this.props.onSave,onLoad:this.props.onLoad}),h("div",{className:"top-panel"},[this.turnField.render(),this.mapSeedField.render(),this.saveLoadComponent.render(),h("button","New World",{onclick:this.props.onNewWorld}),h("button","Generate World",{onclick:this.props.onGenerateWorld})])}set turnNumber(t){this.turnField.value=String(t)}set mapSeed(t){this.mapSeedField.value="number"==typeof t?ve(t):"-"}}const Ke=t=>{const e=ke(new Date),i=prompt("File Name",e);if(null!==i){const s=$t(t,Ae),n=Array.from(function*(t){let e=0,i=0;for(const s of t)8===e&&(yield i,e=0,i=0),s&&(i+=Math.pow(2,e)),++e;e>0&&(yield i)}(s));!function(t,e){let i="";for(const t of e)i+=String.fromCharCode(t);const s=btoa(i),n=document.createElement("a");n.href="data:;base64,"+s,n.download=`${t}.save`,n.click()}(i||e,n)}};class Ze extends e{constructor(){super({}),this.viewContainer=h("div"),this.view=new At(vt.createEmptyWorld(40,20),{onClearSelection:()=>{this.bottomPanel.unselectCity()},onCitySelected:t=>{this.bottomPanel.cityProject=t.project?t.project.type.productId:0}}),this.bottomPanel=new Lt({gridShown:!0,onToggleGrid:t=>this.view.setGridShown(t),onTurn:()=>{this.turn()},onSkipTurns:()=>{this.skipTurns()},onCityProjectChanged:t=>{this.view.changeCityProject(t.id)},onToolSelected:t=>{this.selectedTool=t,this.view.clearSelection()},tools:ze}),this.addKeyHandlers()}addKeyHandlers(){(t=>{var{element:e}=t,i=ut(t,["element"]);e.addEventListener("keydown",(({key:t})=>{var e;if(t.startsWith("Arrow")){const e=qe[t];i.onArrow(e)}else null===(e=i[`on${t}`])||void 0===e||e.call(i)}))})({element:document,onEscape:()=>{this.view.clearSelection(),this.bottomPanel.clearToolSelection()},onArrow:([t,e])=>{this.view.moveViewport(t,e)},onDelete:()=>{this.view.removeSelectedUnit()}})}onPlaceTerrain(){this.updateWorld(this.view.world)}applyTool(t,e){var i;const s=this.view[this.selectedTool.id](t,e,this.selectedTool.option);s&&(null===(i=this[`on${Mt(this.selectedTool.id)}`])||void 0===i||i.call(this,s))}addMouseHandlers(){(t=>{var{element:e,getTilePosition:i}=t,s=ut(t,["element","getTilePosition"]);const n=We(s,i);He(n,e)})({element:this.view.layersContainer,getTilePosition:([t,e])=>{const[i,s]=this.view.getViewportPosition();return this.view.grid.getPosition(Math.floor(t/this.view.tileSize)+i,Math.floor(e/this.view.tileSize)+s)},onLeftClick:([t,e])=>{if(this.selectedTool)return this.applyTool(t,e),void this.bottomPanel.clearToolSelection();this.view.onTileClick(t,e)},onRightClick:([t,e])=>{this.view.selectedUnit&&this.view.moveUnit(t,e)},onCtrlClick:([t,e])=>{this.selectedTool&&this.applyTool(t,e)},onMove:t=>{this.bottomPanel.info=this.getTileInfo(t)},onLeave:()=>{this.bottomPanel.info=null}})}getTileInfo(t){const[e,i]=t;let s=this.view.world.grid.getIndexByPosition(e,i)+" ["+t.join("; ")+"]";const n=this.view.grid.get(e,i),{unit:o,city:r}=n;if(n.influencedBy&&(s+=" "+((t,e)=>e.assignments.isPositionOccupied(t)?`<b>${e.name}</b>`:e.name)(t,n.influencedBy)),o)s+=" "+Ve(o);else if(r)s+=" "+$e(r);else if(this.view.selectedCity){const o=this.view.selectedCity.influence.getTilesToExpand().find((({position:e})=>U(e,t)));o?s+=" expansion cost: "+o.cost:null!==n.influencedBy&&n.influencedBy!==this.view.selectedCity&&this.view.selectedCity.influence.canSwap(e,i)&&(s+=" swappable")}return s}updateWorld(t){this.view.update(t),this.topPanel.turnNumber=this.view.world.turnNumber,this.topPanel.mapSeed=this.view.world.mapSeed}turn(){this.view.turn(),this.topPanel.turnNumber=this.view.world.turnNumber}skipTurns(){this.view.skipTurnsUntilEvent(),this.topPanel.turnNumber=this.view.world.turnNumber}render(){return this.view.mount(this.viewContainer),this.view.draw(),this.addMouseHandlers(),this.topPanel=new Ye({onSave:()=>{Ke(this.view.world)},onLoad:t=>{const e=vt.fromData(Oe(t));this.updateWorld(e)},onNewWorld:()=>{const t=prompt("New world size:");if(null===t)return;const e=Le(t,13,265,(t=>{alert(t)}));if(null!==e){const[t,i]=e,s=vt.createEmptyWorld(t,i);this.updateWorld(s)}},onGenerateWorld:()=>{const t=prompt("Map Seed:",ve(ae.getDefaultSeed()));if(null===t)return;const e=xe(t);if(null===e)alert(`Invalid seed: '${t}'`);else{const t=((t,e,i,s)=>{const n=[],o=(t-1)/2,r=(e-1)/2,c=pe(t,e,i,s);let l,a,h=Number.POSITIVE_INFINITY,d=Number.NEGATIVE_INFINITY;for(let i=0;i<e;i++)for(let s=0;s<t;s++){if(s<3||s>t-3||i<2||i>e-2){n.push(0);continue}const u=c(s,i)*(1-Math.sqrt(Math.pow((o-s)/o,2)+Math.pow((r-i)/r,2))/Math.SQRT2);u<h&&(h=u,l=C(s,i,t)),u>d&&(d=u,a=C(s,i,t)),n.push(u)}return ge(n,t,l,a)})(40,20,7,e),i=vt.fromDryLandBitMap(t,40,e);this.updateWorld(i)}},turn:1,mapSeed:null}),h("div",{id:"view"},[this.topPanel.render(),this.viewContainer,this.bottomPanel.render()])}}var ti;ti=()=>{const t=new Ze;document.body.appendChild(t.render())},t.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGAAAABACAYAAADlNHIOAAAAAXNSR0IArs4c6QAAAs5JREFUeF7tm0lywyAQRfEZvM9hdHAdJnufISm5ChmrGD49gGz9bNPQ8F/TzSDfAv+mKnCb6p3OAwFMDgIVgJ/w+Ivj/w13VV8SHR4h7P7vYUow7f6D0L9YtFT8GRBS8aP/wRBS8eMQuvXsbrB5yok/EkJO/MEQcuKLIBCAJPclqS/TvEvTLuPojCvgVXumACiloZGF+NI1ILcSRoof/V96FyRLnWx1VIA1QBYT83ZBtQI8Yita24IO2orWxO/einatAER8TwiI+M4QEPG7IBBAXwoiAFQvp2sJAiAAUAGPcwFrQHL93OJAANj1OItwK5Le/88agOrFIuzwQnb5GtB6jPE8hOUu4EqrwSn6ozskDcGpHTZMJ8v3gMnvAQRAAMU04Jx+kDTUlVW6jPkkuSfiedfRNQgeh69SoeWT5OHzlJHi80kSPQ3RrqmAqAY0e6UBrAABwFL5GBKAj65wrwQAS+VjSAA+usK9qgAsy7IfSNZ1VfUFj/jLDMWipeJHTSZB2IJAPA8Dnir/ooHnxJ8EQf0LFSUAtf9PBmDyCxUFABP/nwrA7DJMCMDMvwjANuiJNcD0RUoAwNS/GMARwqACjEw+aqqaWwGMuX+PQQqCCmrSM3kPCC7+RQAm7IIkk7eE4Oa/G0BNfKetqGbyFhBc/XcBQMQ3hmAxeQ0Ed/9nBmA5eQmEIf7PCsBj8j0QhvkngPwGjACgjanMCAk6ApBpC7UiAEAmNAJTMSVtSkOB+lqWZW+/riswrafJWwAg0bB3PHAbigiQG7u03VG8Zj+p+MnWG4HwFQBqgdMSDwm6ah858TsgyAGUbkGP2A0u5jQiatrGqZwXQAuCgfibC+19u1v7WvSDq0C3AgjgVXhLCb9RkAkAqJTFFcQVgH0B8d0pqJSGjPI/awCwRJ8mjh9muUUw+A3RuVMQCoh2bQWQQ0m7F1qIFSAAsXQ2Df8B3W5UUCMxzBcAAAAASUVORK5CYIIA",t.onload=ti}();
